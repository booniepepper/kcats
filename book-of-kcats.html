<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-08-07 Mon 18:57 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The kcats Programming Language</title>
<meta name="author" content="Skyrod Vactai" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>
<style> pre.src { background: black; color: white; } #content { max-width: 1000px } </style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.js"></script>
<script type="text/javascript" src="https://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>
<link rel="stylesheet" type="text/css" href="docs-custom.css"/>
</head>
<body>
<div id="content" class="content">
<h1 class="title">The kcats Programming Language</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org44e48d7">1. Benefits</a>
<ul>
<li><a href="#org4789bac">1.1. Easy for a beginner programmer to learn</a>
<ul>
<li><a href="#orgb8726d9">1.1.1. Extremely simple syntax</a></li>
<li><a href="#org5444968">1.1.2. A few simple concepts</a></li>
<li><a href="#org96a380a">1.1.3. Easily accessible documentation</a>
<ul>
<li><a href="#orgc40dca4">1.1.3.1. Documentation as data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org96095e0">1.2. Powerful</a></li>
<li><a href="#orgca2a0e1">1.3. Get straight to the point</a></li>
<li><a href="#orgda2541f">1.4. Useful for general programming</a></li>
<li><a href="#orgeebddc6">1.5. Tooling is easy to build</a></li>
<li><a href="#orgc77da77">1.6. Portable</a></li>
<li><a href="#org5cf1055">1.7. Features</a></li>
</ul>
</li>
<li><a href="#org41d4bf0">2. How it works</a>
<ul>
<li><a href="#org2251359">2.1. Defining some terms</a>
<ul>
<li><a href="#orgeced439">2.1.1. Basics</a></li>
<li><a href="#orgde2b4ca">2.1.2. Programs that write programs</a></li>
<li><a href="#orgdf3f711">2.1.3. Data types</a>
<ul>
<li><a href="#orgcae89d9">2.1.3.1. Types</a></li>
<li><a href="#orgd632f75">2.1.3.2. Traits</a></li>
<li><a href="#org3e8c316">2.1.3.3. Promotion</a></li>
</ul>
</li>
<li><a href="#orgfc226f6">2.1.4. Error handling</a></li>
<li><a href="#org396cc5c">2.1.5. Generators</a></li>
<li><a href="#orgc0a3720">2.1.6. Coordination and Input/Output</a>
<ul>
<li><a href="#orge9eeff4">2.1.6.1. Basics</a></li>
<li><a href="#orgd36f722">2.1.6.2. Input/output</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#org14758ca">3. Implementations</a></li>
<li><a href="#org9a4cf30">4. Using</a>
<ul>
<li><a href="#org9c619e7">4.1. Building</a>
<ul>
<li><a href="#org6d2e2a8">4.1.1. Dependencies</a></li>
<li><a href="#orgcee8e86">4.1.2. Creating the source</a></li>
<li><a href="#org930e7d9">4.1.3. Building and Running</a></li>
</ul>
</li>
<li><a href="#orgf3ec124">4.2. Debugging</a>
<ul>
<li><a href="#org98aec0a">4.2.1. Overview</a></li>
</ul>
</li>
<li><a href="#org52cd5d9">4.3. Developing</a>
<ul>
<li><a href="#orgd4bff57">4.3.1. Browsing the source</a></li>
<li><a href="#orga568095">4.3.2. Emacs</a>
<ul>
<li><a href="#orga79a0bb">4.3.2.1. major mode</a></li>
<li><a href="#orgab78f26">4.3.2.2. org-babel mode</a></li>
<li><a href="#orgb0be41e">4.3.2.3. Repl mode</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgef70a61">4.4. Get started using introspection</a>
<ul>
<li><a href="#org7897a5a">4.4.1. Overview</a></li>
<li><a href="#org03eed43">4.4.2. What words or functions are available?</a></li>
<li><a href="#org58e946a">4.4.3. What inputs/outputs does a particular function have?</a></li>
<li><a href="#org58d35de">4.4.4. What are some example usages of a function?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgc95027e">5. Example programs</a>
<ul>
<li><a href="#org1cc9734">5.1. Factorial</a>
<ul>
<li><a href="#org42a791b">5.1.1. Recursive with recur</a></li>
<li><a href="#org53ea43f">5.1.2. Using range</a></li>
<li><a href="#org5b0aa2b">5.1.3. Plain loop</a></li>
</ul>
</li>
<li><a href="#org98862a6">5.2. Jensen's Device</a></li>
<li><a href="#org27710a7">5.3. Fibonacci</a></li>
<li><a href="#org80a3d44">5.4. Prime factors</a></li>
<li><a href="#org88434b1">5.5. bidirectional comms from a socket</a></li>
<li><a href="#orgcfd1830">5.6. Write string to a file</a></li>
<li><a href="#orgfb9be63">5.7. Search the dictionary</a></li>
<li><a href="#org5e7c406">5.8. Copy data from one file to another</a></li>
<li><a href="#orgf66155f">5.9. List the steps of program execution</a></li>
</ul>
</li>
<li><a href="#org492eb7a">6. Contributing</a>
<ul>
<li><a href="#org87c236e">6.1. Bug reports</a></li>
</ul>
</li>
<li><a href="#org1ab1c0f">7. Issues</a>
<ul>
<li><a href="#org25ed2b9">7.1. <span class="done DONE">DONE</span> Build without using emacs interactively</a></li>
<li><a href="#org4fe25a7">7.2. <span class="done DONE">DONE</span> Remove platform interop from lexicon</a></li>
<li><a href="#org6bde354">7.3. <span class="done DONE">DONE</span> 'unassign' doesn't take a keylist, only a single key</a></li>
<li><a href="#orged84c58">7.4. <span class="done DONE">DONE</span> More support for nested/related envs</a></li>
<li><a href="#org76b0d38">7.5. <span class="todo TODO">TODO</span> Graphical environment browser/editor</a></li>
<li><a href="#org9453617">7.6. <span class="todo TODO">TODO</span> Code distribution method</a>
<ul>
<li><a href="#org721fcf7">7.6.1. Durability</a>
<ul>
<li><a href="#orgf6acc97">7.6.1.1. Possible dynamic sql db</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org04558e2">7.7. <span class="done DONE">DONE</span> Clean up all the vector conversion</a></li>
<li><a href="#org15c119f">7.8. <span class="done DONE">DONE</span> org-babel-execute for kcats</a></li>
<li><a href="#orgbae1623">7.9. <span class="todo INPROGRESS">INPROGRESS</span> At least one example for each word in lexicon</a></li>
<li><a href="#orgd3ca719">7.10. <span class="todo TODO">TODO</span> Prime number sieve example</a></li>
</ul>
</li>
<li><a href="#org36b5266">8. Roadmap Notes</a>
<ul>
<li><a href="#org0fde90c">8.1. Higher level persistence abstraction</a></li>
<li><a href="#org0cfd9f8">8.2. DHT of hash:content</a></li>
<li><a href="#orgd0f2f31">8.3. File distribution</a></li>
<li><a href="#orge16b163">8.4. Object construction, caching</a>
<ul>
<li><a href="#org6c4abd6">8.4.1. Platform specific definitions</a></li>
</ul>
</li>
<li><a href="#org0fbebc1">8.5. Adjectives and other parts of speech</a></li>
<li><a href="#orgc904dcc">8.6. Contextual words</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
<img src="./kcats.png" alt="kcats.png" />
<img src="./kcats-repl.gif" alt="kcats-repl.gif" />
</p>
<div id="outline-container-org44e48d7" class="outline-2">
<h2 id="org44e48d7"><span class="section-number-2">1.</span> Benefits</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org4789bac" class="outline-3">
<h3 id="org4789bac"><span class="section-number-3">1.1.</span> Easy for a beginner programmer to learn</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-orgb8726d9" class="outline-4">
<h4 id="orgb8726d9"><span class="section-number-4">1.1.1.</span> Extremely simple syntax</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
It's just english words, numbers, text, and quotation marks. No other
symbols. Quotations are marked with square brackets <code>[</code> and <code>]</code>.
</p>

<p>
Formatting like indentation and whitespace are for human readability
purposes only. The language doesn't care - a whole program can be
written on a single line if you want.
</p>
</div>
</div>

<div id="outline-container-org5444968" class="outline-4">
<h4 id="org5444968"><span class="section-number-4">1.1.2.</span> A few simple concepts</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
The language is designed to require learning as few concepts as
possible. 
</p>

<ul class="org-ul">
<li>Stacks</li>
<li>Primitive datatypes (numbers, strings, bytes)</li>
<li>Lists</li>
<li>Functions</li>
<li>Pipes</li>
</ul>

<p>
All of these are combined in various ways to achieve any type of
expression, the same way a few types of lego bricks can be combined to
make any object.<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>
</p>
</div>
</div>
<div id="outline-container-org96a380a" class="outline-4">
<h4 id="org96a380a"><span class="section-number-4">1.1.3.</span> Easily accessible documentation</h4>
<div class="outline-text-4" id="text-1-1-3">
</div>
<div id="outline-container-orgc40dca4" class="outline-5">
<h5 id="orgc40dca4"><span class="section-number-5">1.1.3.1.</span> Documentation as data</h5>
<div class="outline-text-5" id="text-1-1-3-1">
<p>
The standard library documentation is built into the system and can be
processed with the language itself. See <a href="#orgef70a61">4.4</a>
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-org96095e0" class="outline-3">
<h3 id="org96095e0"><span class="section-number-3">1.2.</span> Powerful</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Kcats' metaprogramming (programs that write programs) facilities allow
you to express yourself succinctly and without repetition.
</p>
</div>
</div>
<div id="outline-container-orgca2a0e1" class="outline-3">
<h3 id="orgca2a0e1"><span class="section-number-3">1.3.</span> Get straight to the point</h3>
<div class="outline-text-3" id="text-1-3">
<p>
There is zero ceremony. A program can easily be a single line
consisting of a few words:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"contacts.txt"</span> slurp read <span class="org-kcats-brackets">[[</span>age<span class="org-kcats-brackets">]</span> lookup 21 &gt;=<span class="org-kcats-brackets">]</span> <span class="org-function-name">filter</span>  
</pre>
</div>

<p>
That reads a database file of contacts, and prints only those contacts
at least 21 years old. The program is 8 words.
</p>

<p>
You don't need a "main" method, or class declaration or any other
boilerplate.  You only need to specify what the program is actually
supposed to <b>do</b>.
</p>
</div>
</div>
<div id="outline-container-orgda2541f" class="outline-3">
<h3 id="orgda2541f"><span class="section-number-3">1.4.</span> Useful for general programming</h3>
<div class="outline-text-3" id="text-1-4">
<p>
The language can handle various types of programming tasks, including
API client/server, networking applications, embedded scripting, etc.
</p>
</div>
</div>
<div id="outline-container-orgeebddc6" class="outline-3">
<h3 id="orgeebddc6"><span class="section-number-3">1.5.</span> Tooling is easy to build</h3>
<div class="outline-text-3" id="text-1-5">
<ul class="org-ul">
<li>Debuggers</li>
<li>IDEs</li>
</ul>

<p>
Wherever possible, tooling is baked into the language.
</p>
</div>
</div>
<div id="outline-container-orgc77da77" class="outline-3">
<h3 id="orgc77da77"><span class="section-number-3">1.6.</span> Portable</h3>
<div class="outline-text-3" id="text-1-6">
<p>
Everything is a value<sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup> and serializable (you can send anything
to a remote interpreter, even one that is not the same implementation,
and have it understand the value it received).
</p>
</div>
</div>
<div id="outline-container-org5cf1055" class="outline-3">
<h3 id="org5cf1055"><span class="section-number-3">1.7.</span> Features</h3>
<div class="outline-text-3" id="text-1-7">
<ul class="org-ul">
<li class="on"><code>[X]</code> Automatic memory management</li>
<li class="on"><code>[X]</code> Multithreading</li>
<li class="on"><code>[X]</code> Error handling</li>
<li class="on"><code>[X]</code> Metaprogramming</li>
<li class="on"><code>[X]</code> Channels/CSPs</li>
<li class="on"><code>[X]</code> Introspection</li>
<li class="on"><code>[X]</code> Filesystem I/O</li>
<li class="on"><code>[X]</code> TCP/IP Socket I/O</li>
<li class="on"><code>[X]</code> Generators</li>
<li class="on"><code>[X]</code> Sequence library</li>
<li class="on"><code>[X]</code> Cryptographic primitives</li>
<li class="on"><code>[X]</code> Builtin debugging tools</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org41d4bf0" class="outline-2">
<h2 id="org41d4bf0"><span class="section-number-2">2.</span> How it works</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org2251359" class="outline-3">
<h3 id="org2251359"><span class="section-number-3">2.1.</span> Defining some terms</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Kcats uses the following concepts - anyone who wants to learn the
language should be familiar with them. These terms will be used
throughout this document.
</p>
<dl class="org-dl">
<dt>stack</dt><dd>A first-in, first-out structure. This is where the program
stores all the data it needs to manipulate.</dd>
<dt>item</dt><dd>A value - could be a number, string, list, etc.</dd>
<dt>list</dt><dd>One or more items bound up together.</dd>
<dt>program</dt><dd>a list of instructions intended to be carried out by a
machine.</dd>
<dt>word</dt><dd>causes the program to do something, usually taking some
items from the top of the stack and using them to create new
stack items. Other words may only place themselves on the stack.</dd>
<dt>axiom word</dt><dd>A word not defined in terms of other words.</dd>
<dt>definition</dt><dd>what exactly a word is supposed to do, represented
either in the base language for axiom words, or as a
program.</dd>
<dt>dictionary</dt><dd>a list of available words and their definitions.</dd>
<dt>expression</dt><dd>The part of the program that hasn't been executed yet.</dd>
<dt>environment</dt><dd>the entire state of an executing program. Note that
applications will normally be composed of multiple environments that
coordinate with each other.</dd>
<dt>pipe</dt><dd>A method to communicate between environments, and to the
outside world. Values are put into pipes and emerge in some other
somewhere else (another environment, a file, a socket, etc).</dd>
</dl>
</div>
<div id="outline-container-orgeced439" class="outline-4">
<h4 id="orgeced439"><span class="section-number-4">2.1.1.</span> Basics</h4>
<div class="outline-text-4" id="text-2-1-1">
<p>
Kcats is a stack-based language. The idea is you put data onto a
stack, and then words (functions) operate on the items near the top of
the stack (which might remove, replace, or add new items). 
</p>

<p>
The stack takes the place of variables in other programming
languages.  
</p>

<p>
For example, if we mentally execute the program below, we first put <code>1</code>
onto the stack. Then we put <code>2</code> onto the stack (so that <code>2</code> is on top and
<code>1</code> is beneath it). Then we put the word <code>+</code> onto the stack and it will
consume the <code>2</code> and the <code>1</code> and replace them with the sum, which is <code>3</code>.
</p>
<div class="org-src-container">
<pre class="src src-kcats">1 2 +
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">3
</pre>
</div>

<p>
Multiple steps are accomplished just by adding more words (and
possibly more data). For example, in the program below we can add <code>1</code>
and <code>2</code> (leaving <code>3</code> on the stack), and then put <code>5</code> and <code>*</code> on the stack
(the <code>*</code> consumes the <code>5</code> and <code>3</code>, leaving <code>15</code>):
</p>

<div class="org-src-container">
<pre class="src src-kcats">1 2 + 5 *
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">15
</pre>
</div>

<p>
Here's how it would look step by step (where the <code>|</code> separates the
program that hasn't run yet - on the right, from the stack on the
left). The stack's top item is just to the left of the <code>|</code>.
</p>

<div class="org-src-container">
<pre class="src src-kcats">    | 1 2 + 5 * 
  1 | 2 + 5 * 
1 2 | + 5 *
  3 | 5 *
3 5 | *
 15 |  
</pre>
</div>

<p>
When there is nothing remaining to the right of the <code>|</code>, the program
is finished. The result is what is left on the stack (in this case
<code>15</code>).
</p>

<p>
Notice that when the program finishes with multiple items still on the
stack, they're printed with the top of the stack <b>first</b>, because we're
most interested in the top items. 
</p>

<div class="org-src-container">
<pre class="src src-kcats">1 2 3
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">3 2 1
</pre>
</div>

<p>
Words can also operate on lists (which are denoted with square
brackets, like <code>[1 2 3]</code>). Lists are like other data, they don't do
anything except put themselves onto the stack. You can see below the
word <code>join</code> combines two lists.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>4 5<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 2 3 4 5<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgde2b4ca" class="outline-4">
<h4 id="orgde2b4ca"><span class="section-number-4">2.1.2.</span> Programs that write programs</h4>
<div class="outline-text-4" id="text-2-1-2">
<p>
The most important expressive feature of kcats is that you can
manipulate programs exactly the same way as you can any other data.
</p>

<p>
One thing you can do with a list, is treat it like a program and
<code>execute</code> it. Notice that on the 5th and 6th line below, the word
<code>execute</code> takes the list from the top of the stack on the left, and
puts its contents back on the right, making it part of the program
remaining to be run!
</p>
<div class="org-src-container">
<pre class="src src-kcats">            | 4 5 6 <span class="org-kcats-brackets">[</span>* +<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">execute</span>
          4 | 5 6 <span class="org-kcats-brackets">[</span>* +<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">execute</span>
        4 5 | 6 <span class="org-kcats-brackets">[</span>* +<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">execute</span>
      4 5 6 | <span class="org-kcats-brackets">[</span>* +<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">execute</span>
4 5 6 <span class="org-kcats-brackets">[</span>* +<span class="org-kcats-brackets">]</span> | <span class="org-preprocessor">execute</span>
      4 5 6 | * +
       4 30 | +
         34 |
</pre>
</div>
<p>
Note that, when <code>* +</code> gets moved back to the expression,
there wasn't anything else in the expression. But often there would be
something there. <code>* +</code> would have gone in <b>front</b> of anything
else that was there and been executed first. In other words, the
expression acts just like a stack - the last thing in is the first
thing out.
</p>

<p>
The same way we used <code>join</code> to combine two lists, we can combine two
small programs into one, and then <code>execute</code> it:
</p>

<div class="org-src-container">
<pre class="src src-kcats">4 5 6 <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>*<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span> <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">44
</pre>
</div>

<p>
Note that words inside lists don't perform any action when the list is
put on the stack. You can think of it as a quotation - a message being
being passed along, not acted upon.
</p>
</div>
</div>

<div id="outline-container-orgdf3f711" class="outline-4">
<h4 id="orgdf3f711"><span class="section-number-4">2.1.3.</span> Data types</h4>
<div class="outline-text-4" id="text-2-1-3">
</div>
<div id="outline-container-orgcae89d9" class="outline-5">
<h5 id="orgcae89d9"><span class="section-number-5">2.1.3.1.</span> Types</h5>
<div class="outline-text-5" id="text-2-1-3-1">
</div>
<ol class="org-ol">
<li><a id="org198f826"></a>Words<br />
<div class="outline-text-6" id="text-2-1-3-1-1">
<p>
In kcats, words have two main types
</p>
<ul class="org-ul">
<li>verbs, which result in actions being performed, and are defined in
the dictionary</li>
<li>nouns or adjectives, which are used as labels or names for things,
and are not in the dictionary.</li>
</ul>

<p>
The first type, verbs, are used directly in the execution of programs,
like <code>clone</code> and <code>swap</code>:
</p>

<div class="org-src-container">
<pre class="src src-kcats">1 <span class="org-builtin">clone</span> 2 <span class="org-builtin">swap</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">1 2 1
</pre>
</div>

<p>
The second type are used inside lists, often as field names. These
words are never executed, they're used more like you'd use strings or
keywords in other programming languages.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo bar baz<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>quux<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> <span class="org-function-name">put</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo bar baz quux<span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
Note the use of <code>unwrap</code> here. What's wrong with just trying to <code>put</code>
<code>quux</code> directly into the list? The problem is when kcats encounters a
word during execution, it checks the dictionary to see what to do. If
the word isn't isn't in the dictionary, that's an error.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo bar baz<span class="org-kcats-brackets">]</span> quux <span class="org-function-name">put</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>quux<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"word is not defined"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>quux <span class="org-function-name">put</span><span class="org-kcats-brackets">]]]</span>
<span class="org-kcats-brackets">[</span>foo bar baz<span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
What we want is to get <code>quux</code> onto the stack by itself without actually
executing it. We can do that with <code>[quux] unwrap</code>. The word <code>unwrap</code> does
just what it says, removes the list wrapper and leaves a bare word on
the stack. Another way to go about this is to use <code>join</code> so we don't
need <code>unwrap</code>:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo bar baz<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>quux<span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>foo bar baz quux<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</li>

<li><a id="org4a55332"></a>Booleans<br />
<div class="outline-text-6" id="text-2-1-3-1-2">
<p>
Kcats doesn't have traditional boolean values <code>true</code> and <code>false</code>. In
kcats decision making, an empty list <code>[]</code> acts like <code>false</code>, and
anything else acts like <code>true</code>.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span><span class="org-string">"yes"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-string">"no"</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">branch</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-string">"no"</span>
</pre>
</div>
<p>
versus
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"anything"</span> <span class="org-kcats-brackets">[</span><span class="org-string">"yes"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-string">"no"</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">branch</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-string">"yes"</span>
</pre>
</div>

<p>
Some words will return the word <code>true</code>, but it's not really a boolean,
it's just the word <code>true</code> which has no special meaning other than that
it's an arbitrary truthy value (remember anything that's not an empty
list is "truthy", so any word, including the word <code>true</code> is truthy). For
convenience, <code>true</code> is in the dictionary, so you do not have to quote
it. It evaluates to itself.
</p>

<div class="org-src-container">
<pre class="src src-kcats">3 odd?
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-keyword">true</span>
</pre>
</div>

<p>
There are some extra words defined for your convenience: <code>nothing</code> and
<code>false</code>. Both of them evaluate to <code>[]</code>. Using them instead of the empty
list can help with readability.
</p>
</div>
</li>

<li><a id="orgb29dc06"></a>Strings<br />
<div class="outline-text-6" id="text-2-1-3-1-3">
<p>
Strings work much like in other programming languages (except there
are fewer library functions).
</p>
</div>
</li>
<li><a id="org83c2ad7"></a>Bytes (byte array)<br />
<div class="outline-text-6" id="text-2-1-3-1-4">
<p>
Byte arrays are a sort of "lowest common denominator" data format. 
</p>
</div>
</li>
<li><a id="orgdc94e5c"></a>Numbers<br />
<div class="outline-text-6" id="text-2-1-3-1-5">
<p>
Integers and floats are supported (64 bit). 
</p>
</div>
</li>
<li><a id="orgbdc1911"></a>Lists<br />
<div class="outline-text-6" id="text-2-1-3-1-6">
<p>
Lists are just multiple items bound up into a single unit, where their
order is maintained.
</p>
</div>

<ol class="org-ol">
<li><a id="orga52fab4"></a>Comprehension<br />
<div class="outline-text-7" id="text-2-1-3-1-6-1">
<p>
See the word <code>step</code>, which runs the same program on each item in a list.
</p>

<div class="org-src-container">
<pre class="src src-kcats">0 <span class="org-kcats-brackets">[</span>12 6 13 7 5<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span> 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">43
</pre>
</div>

<p>
Similar to <code>step</code>, but more strict, is <code>map</code>, which only allows the
program to work on a given item and can't mess with the rest of the
stack. Use that to transform each item in a list, in the same way (in
this case showing the remainder when dividing by 5).
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>12 6 13 7 5<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 mod<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>2 1 3 2 0<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</li>
</ol>
</li>

<li><a id="orgfc2a797"></a>Associations<br />
<div class="outline-text-6" id="text-2-1-3-1-7">
<p>
An association looks just a list of pairs, like this:
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>name <span class="org-string">"Alice"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>age 24<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>favorite-color <span class="org-string">"brown"</span><span class="org-kcats-brackets">]]</span>
</pre>
</div>

<p>
However there are some words you can use that make a list behave a bit
differently. For example:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>name <span class="org-string">"Alice"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>age 24<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>favorite-color <span class="org-string">"brown"</span><span class="org-kcats-brackets">]]</span>

<span class="org-kcats-brackets">[</span>age<span class="org-kcats-brackets">]</span> 25 assign
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>name <span class="org-string">"Alice"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>age 25<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>favorite-color <span class="org-string">"brown"</span><span class="org-kcats-brackets">]]</span>
</pre>
</div>

<p>
Here we use <code>assign</code> to reset Alice's age - it does not simply add a new
item to the list.  It will find the existing key and replace it. It
will create a new item only if the key didn't already exist:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>name <span class="org-string">"Alice"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>age 24<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>favorite-color <span class="org-string">"brown"</span><span class="org-kcats-brackets">]]</span>

<span class="org-kcats-brackets">[</span>department<span class="org-kcats-brackets">]</span> <span class="org-string">"Sales"</span> assign
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>favorite-color <span class="org-string">"brown"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>name <span class="org-string">"Alice"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>department <span class="org-string">"Sales"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>age 24<span class="org-kcats-brackets">]]</span>
</pre>
</div>

<p>
Notice that the order of the items is not preserved. Once you treat a
list as an association, it "sticks" - it acts like an association from
then on, and order is no longer guaranteed to be maintained.
</p>

<p>
We can improve upon our example that incremented Alice's age
(presumably after her birthday) with the word <code>update</code>. That will run a
program on the value of whatever key (or keys) you specify.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>name <span class="org-string">"Alice"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>age 24<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>favorite-color <span class="org-string">"brown"</span><span class="org-kcats-brackets">]]</span>

<span class="org-kcats-brackets">[</span>age<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> update
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>name <span class="org-string">"Alice"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>favorite-color <span class="org-string">"brown"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>age 25<span class="org-kcats-brackets">]]</span>
</pre>
</div>

<p>
Note that associations and lists look the same when printed but
testing them for equality can reveal they are not the same:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>name <span class="org-string">"Alice"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>age 24<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>favorite-color <span class="org-string">"brown"</span><span class="org-kcats-brackets">]]</span>

<span class="org-kcats-brackets">[</span>age<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> update

<span class="org-kcats-brackets">[[</span>name <span class="org-string">"Alice"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>age 25<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>favorite-color <span class="org-string">"brown"</span><span class="org-kcats-brackets">]]</span>

=
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span>
</pre>
</div>

<p>
Here we are comparing an association with a list. The <code>=</code> operator has
no way of knowing whether you want the list semantics (which does care
about order), or the association semantics (which doesn't care about
order). It defaults to the more strict rules, so they are not equal.
</p>

<p>
The act of using a list as an association (by applying words to it
like <code>assign</code> or <code>update</code>) will convert it to an association, but what if
you just want to convert a list to an association, without doing
anything else?
</p>

<p>
You can use the word <code>association</code> to convert the list to an association:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>name <span class="org-string">"Alice"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>age 24<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>favorite-color <span class="org-string">"brown"</span><span class="org-kcats-brackets">]]</span>

<span class="org-kcats-brackets">[</span>age<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> update

<span class="org-kcats-brackets">[[</span>name <span class="org-string">"Alice"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>age 25<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>favorite-color <span class="org-string">"brown"</span><span class="org-kcats-brackets">]]</span>

association =
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-keyword">true</span>
</pre>
</div>
</div>
</li>

<li><a id="org8f9f90a"></a>Sets<br />
<div class="outline-text-6" id="text-2-1-3-1-8">
<p>
Sets are made to test for membership, and do not care about order. 
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-string">"Larry"</span> <span class="org-string">"Curly"</span> <span class="org-string">"Moe"</span><span class="org-kcats-brackets">]</span> set <span class="org-string">"Moe"</span> contains?
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-keyword">true</span>
</pre>
</div>

<p>
If you add an item to a set, but it's already there, nothing changes.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-string">"Larry"</span> <span class="org-string">"Curly"</span> <span class="org-string">"Moe"</span><span class="org-kcats-brackets">]</span> set <span class="org-string">"Curly"</span> <span class="org-function-name">put</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-string">"Larry"</span> <span class="org-string">"Moe"</span> <span class="org-string">"Curly"</span><span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
You can <code>take</code> from a set but since order doesn't matter, you get an arbitrary item.
</p>

<div class="org-src-container">
<pre class="src src-kcats">1 20 1 range set <span class="org-function-name">take</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">7 <span class="org-kcats-brackets">[</span>15 3 11 16 1 14 8 6 4 9 18 19 12 5 17 10 13 2<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</li>

<li><a id="org1d7147f"></a>Errors<br />
<div class="outline-text-6" id="text-2-1-3-1-9">
<p>
See <a href="#orgfc226f6">2.1.4</a>
</p>
</div>
</li>
<li><a id="org2f34089"></a>Pipes<br />
<div class="outline-text-6" id="text-2-1-3-1-10">
<p>
See <a href="#orgc0a3720">2.1.6</a>
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgd632f75" class="outline-5">
<h5 id="orgd632f75"><span class="section-number-5">2.1.3.2.</span> Traits</h5>
<div class="outline-text-5" id="text-2-1-3-2">
<p>
The types just discussed is all there are, but there are words that
operate on multiple types, and it's helpful to talk about what those
types have in common.
</p>
</div>
<ol class="org-ol">
<li><a id="org741cdea"></a>Dispenser<br />
<div class="outline-text-6" id="text-2-1-3-2-1">
<p>
Containers from which you can take out items, one by
one. Includes:
</p>
<ul class="org-ul">
<li>Strings</li>
<li>Bytes</li>
<li>Lists</li>
<li>Associations</li>
<li>Sets</li>
<li>Out Pipes</li>
<li>Tunnels</li>
</ul>

<p>
Supported words:
</p>
<ul class="org-ul">
<li><code>take</code></li>
<li><code>step</code></li>
</ul>
</div>
</li>
<li><a id="orge640d49"></a>Receptacle<br />
<div class="outline-text-6" id="text-2-1-3-2-2">
<p>
Containers into which you can put items, one by one. Includes:
</p>
<ul class="org-ul">
<li>Strings</li>
<li>Bytes</li>
<li>Lists</li>
<li>Associations</li>
<li>Sets</li>
<li>In Pipes</li>
<li>Tunnels</li>
</ul>

<p>
Supported words:
</p>
<ul class="org-ul">
<li><code>put</code></li>
</ul>
</div>
</li>
<li><a id="org457d825"></a>Sized<br />
<div class="outline-text-6" id="text-2-1-3-2-3">
<p>
Containers whose items can be counted. Includes:
</p>
<ul class="org-ul">
<li>Strings</li>
<li>Bytes</li>
<li>Lists</li>
<li>Associations</li>
<li>Sets</li>
</ul>

<p>
Supported words:
</p>
<ul class="org-ul">
<li><code>count</code></li>
<li><code>join</code></li>
<li><code>every?</code></li>
<li><code>any?</code></li>
</ul>
</div>
</li>
<li><a id="orgd045a58"></a>Ordered<br />
<div class="outline-text-6" id="text-2-1-3-2-4">
<p>
Containers whose items are kept in a specific order. Includes
</p>
<ul class="org-ul">
<li>Strings</li>
<li>Bytes</li>
<li>Lists</li>
</ul>

<p>
Supported words:
</p>
<ul class="org-ul">
<li><code>pop</code></li>
<li><code>first</code></li>
<li><code>second</code></li>
<li><code>last</code></li>
<li><code>reverse</code></li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-org3e8c316" class="outline-5">
<h5 id="org3e8c316"><span class="section-number-5">2.1.3.3.</span> Promotion</h5>
<div class="outline-text-5" id="text-2-1-3-3">
<p>
Data types are automatically converted when you try to use them in a
way that requires it.
</p>

<p>
For example, if you have a list of pairs and you use the word <code>lookup</code>,
it assumes your intention is to use the list as an associative data
type, so it will be automatically converted, and remain converted
after <code>lookup</code> completes.
</p>

<p>
You can tell by the spec when the return type is a promoted type:
</p>
<div class="org-src-container">
<pre class="src src-kcats">dictionary <span class="org-kcats-brackets">[</span>assign spec<span class="org-kcats-brackets">]</span> lookup
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>item value<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>list keys<span class="org-kcats-brackets">]</span> sized<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>association<span class="org-kcats-brackets">]]</span>
</pre>
</div>

<p>
Here you can see that the spec for <code>assign</code> takes a <code>sized</code> and returns an
<code>association</code>. This allows you to do things like this:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>name <span class="org-string">"Susie"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>age 25<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>sport<span class="org-kcats-brackets">]</span> <span class="org-string">"bowling"</span> assign
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>name <span class="org-string">"Susie"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>age 25<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>sport <span class="org-string">"bowling"</span><span class="org-kcats-brackets">]]</span>
</pre>
</div>

<p>
The initial value of <code>[[name "Susie"] [age 25]]</code> is not an <code>associative</code>,
it's just a <code>list</code>. You could explicitly convert it using the word
<code>association</code> but <code>assign</code> will do it for you, because it needs an
associative type.
</p>

<p>
Note that the conversion can fail, because converting to <code>associative</code>
requires that you have a list of pairs. If you don't, that's an error:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span><span class="org-string">"foo"</span> <span class="org-string">"bar"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>age<span class="org-kcats-brackets">]</span> 25 assign
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>actual <span class="org-string">"foo"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[]]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>pair<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>handled <span class="org-keyword">true</span><span class="org-kcats-brackets">]]</span>
</pre>
</div>

<p>
The most common promotion is from <code>list</code> to <code>associative</code> but there are
others.
</p>
</div>
</div>
</div>
<div id="outline-container-orgfc226f6" class="outline-4">
<h4 id="orgfc226f6"><span class="section-number-4">2.1.4.</span> Error handling</h4>
<div class="outline-text-4" id="text-2-1-4">
<p>
In kcats, when a program encounters an error, an error object is
placed on the stack instead of the usual result.
</p>

<div class="org-src-container">
<pre class="src src-kcats">2 3 <span class="org-string">"four"</span> * + 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>type error<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>number<span class="org-kcats-brackets">]]</span>
 <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>* +<span class="org-kcats-brackets">]]]</span>
<span class="org-string">"four"</span> 3 2
</pre>
</div>

<p>
Notice the <code>unwound</code> field contains the rest of the program that
remained when the error occurred.
</p>

<p>
We can fix the problem and continue, but only if we can stop the
unwinding before our entire program is unwound. We can do that using
the word <code>recover</code>, which takes two programs: <code>p</code> and <code>r</code>, <code>p</code> is run and if
it results in an error, the unwinding is limited to <code>p</code> and then <code>r</code> is
run. When <code>r</code> runs, the error object is on the top of stack. If there is no
error, <code>r</code> does not run.
</p>

<p>
In the program below, we recover by discarding the error and the
string "four", and replacing it with the number <code>4</code>. Then trying the
operations <code>* +</code> again.
</p>
<div class="org-src-container">
<pre class="src src-kcats">2 3 <span class="org-string">"four"</span> <span class="org-kcats-brackets">[</span>* +<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-builtin">drop</span> 4 * +<span class="org-kcats-brackets">]</span> recover
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">14
</pre>
</div>

<p>
The problem with the usage of <code>recover</code> above is that we had to specify
the arithmetic words <code>* +</code> twice - once in <code>p</code> and again in <code>r</code> in case they
failed the first time. Remember those operations are saved in the
<code>unwound</code> field of the error, and we can access them and even <code>execute</code>
them. There is a word that does this for you: <code>retry</code>: it takes an error
on the top of stack, and executes its <code>unwound</code> program.
</p>

<div class="org-src-container">
<pre class="src src-kcats">2 3 <span class="org-string">"four"</span> <span class="org-kcats-brackets">[</span>* +<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span><span class="org-builtin">drop</span> 4<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> retry<span class="org-kcats-brackets">]</span> recover
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">14
</pre>
</div>

<p>
In the above program, after the error occurs, we discard the string
underneath the error and replace it with the integer <code>4</code>.
</p>

<p>
Sometimes you need to raise your own errors, you can do that with the
word <code>fail</code>.
</p>

<div class="org-src-container">
<pre class="src src-kcats">2
<span class="org-kcats-brackets">[</span>odd?<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span><span class="org-string">"ok"</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[[</span>type error<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>asked odd?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>reason <span class="org-string">"expected odd number"</span><span class="org-kcats-brackets">]]</span>
 association fail<span class="org-kcats-brackets">]</span>
<span class="org-preprocessor">if</span>
3 4 +
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>asked odd?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>3 4 +<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>reason <span class="org-string">"expected odd number"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>handled <span class="org-keyword">true</span><span class="org-kcats-brackets">]]</span> 2
</pre>
</div>

<p>
Sometimes you want to handle some errors but not others. There's no
error type matching like you'd find with java's <code>catch</code>. You have to
recover, examine the error, and if it's one you don't want to handle,
re-activate it with <code>fail</code>.
</p>
</div>
</div>
<div id="outline-container-org396cc5c" class="outline-4">
<h4 id="org396cc5c"><span class="section-number-4">2.1.5.</span> Generators</h4>
<div class="outline-text-4" id="text-2-1-5">
<p>
Sometimes in programming, having the concept of an indefinite sequence
is handy. You have part of your program producing data, and another
consuming it, but the producer doesn't know how much the consumer will
actually need. A producer might calculate a huge number of values at
great expense, only for the consumer to only need a tiny fraction of
them. Generators allow the consumer to tell the producer when to
produce, but the producer still retains all the logic of how that's done.
</p>

<p>
Here's an example: Let's say you want to create the fibonacci
sequence. Let's see how we can code that without worrying about how
many items in the sequence we'll eventually need.
</p>

<p>
A generator consists of two things: state, and a program. Each time
we want to generate a value, we run the program. The program should
produce a new value and update the state. We just put however many
state items we need on the stack, and then a program that can work
with those items.
</p>

<div class="org-src-container">
<pre class="src src-kcats">1 0 <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-builtin">swap</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
So here we start with <code>1 0</code>. That's the starting state. Normally we'd
start fibonacci with <code>1 1</code> but we're deviating a bit from that, and we'll
see why soon. Then we have a program that takes two numbers as input
and leaves one new number. Let's just <code>execute</code> that program and see
the result:
</p>

<div class="org-src-container">
<pre class="src src-kcats">1 0 <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-builtin">swap</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">execute</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">1 1 1
</pre>
</div>

<p>
So why did it produce <code>1</code>? Remember the generator must do two things,
produce a new value and update the state. We need to return <code>1</code> as the
first fibonacci number, and also keep <code>1 1</code> as the state, because for
the following item we need to add <code>1</code> and <code>1</code>. We <code>clone</code> it so it can serve
both purposes.
</p>

<p>
This gets us somewhere, but not the actual fibonacci sequence. Let's
look at the word <code>generate</code>. All it does is run the program, pulls the
generated item to the top of the stack, and puts a new copy of the
program in place so that when we want the next item, we can call
<code>generate</code> again:
</p>

<div class="org-src-container">
<pre class="src src-kcats">1 0 <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-builtin">swap</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> generate
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">1 <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-builtin">swap</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> 1 1
</pre>
</div>

<p>
Notice here that the only difference from before is that the program
is sandwiched between the fibonacci number we produced, and the state.
</p>

<p>
Let's keep going and call generate again! But wait, before we do that
we need to do something with value we just produced, to get it out of
the way. For now we'll just <code>drop</code> it. We've seen it and we want to
see what's next.
</p>

<div class="org-src-container">
<pre class="src src-kcats">1 0 <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-builtin">swap</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> generate <span class="org-comment-delimiter">;; </span><span class="org-comment">what we had before</span>
<span class="org-builtin">drop</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">throw away the first value</span>
generate <span class="org-comment-delimiter">;; </span><span class="org-comment">the 2nd value</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">1 <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-builtin">swap</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> 1 2
</pre>
</div>

<p>
Ok, so the 2nd value is <code>1</code> and we can see the state is updated -
instead of <code>1 1</code> we have <code>1 2</code>.
</p>

<p>
One more time:
</p>
<div class="org-src-container">
<pre class="src src-kcats">1 0 <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-builtin">swap</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span>generate <span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> 2 <span class="org-preprocessor">times</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">generate and drop the first two values</span>
generate <span class="org-comment-delimiter">;; </span><span class="org-comment">the 3rd value</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">2 <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-builtin">swap</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> 2 3
</pre>
</div>

<p>
Ok we can see that we can get values one at a time by calling
<code>generate</code>, but this is not very useful. What we really want is to get
the first <code>20</code> numbers in the fibonacci sequence, and collect them into a
list. We can do exactly that:
</p>

<div class="org-src-container">
<pre class="src src-kcats">1 0 <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-builtin">swap</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">our original generator</span>
20 taker <span class="org-comment-delimiter">;; </span><span class="org-comment">another generator that stops generating after 20 items</span>
collect <span class="org-comment-delimiter">;; </span><span class="org-comment">collects all the generated items into a list</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 1 2 3 5 8 13 21 34 55 89 144 233 377 610 987 1597 2584 4181 6765<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>positive?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>dec <span class="org-kcats-brackets">[</span>generate<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dive</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> 0 <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-builtin">swap</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> 6765 10946
</pre>
</div>

<p>
There's the fibonacci sequence! Hey wait, what's all that stuff after
it?  We just want fibonacci! That's there in case you wanted to keep
generating more values. If you want to just get the result and throw
away the generators, you can do that with <code>shield</code>, which erases all
stack effects except whatever was on top. So we'll just <code>shield</code> the
entire thing:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 0 <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-builtin">swap</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span>
 20 taker
 collect<span class="org-kcats-brackets">]</span>
<span class="org-preprocessor">shield</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 1 2 3 5 8 13 21 34 55 89 144 233 377 610 987 1597 2584 4181 6765<span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
So what is happening here? We're stacking up generators. Starting at
the top, we have <code>collect</code> which will repeatedly call <code>generate</code> on the
generator below it. It keeps going and collecting the generated items
in a list, until the generator below returns <code>nothing</code>. Then it stops.
</p>

<p>
Then below <code>collect</code> we have a generator <code>20 taker</code> - what that does is
keeps its own state of how many items we want it to take. It counts
down as it generates items below it, passing them up to <code>collect</code> and
when it hits zero, it returns <code>nothing</code> (even if the generator below it
would have produced something, <code>taker</code> won't even ask). That will signal
<code>collect</code> to stop.
</p>

<p>
We have other handy generators we can stack up. Let's say for whatever
reason we want to know what are the first 20 <b>odd</b> fibonacci numbers?
Well, we have <code>keep</code>:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 0 <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-builtin">swap</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">our original generator</span>
<span class="org-kcats-brackets">[</span>odd?<span class="org-kcats-brackets">]</span> keep <span class="org-comment-delimiter">;; </span><span class="org-comment">a generator that keeps calling the one</span>
            <span class="org-comment-delimiter">;; </span><span class="org-comment">below it until it gets something that</span>
            <span class="org-comment-delimiter">;; </span><span class="org-comment">passes the predicate we specified</span>
20 taker <span class="org-comment-delimiter">;; </span><span class="org-comment">another generator that calls generate 20 times</span>
collect<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">collects all the generated items into a list</span>
<span class="org-preprocessor">shield</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 1 3 5 13 21 55 89 233 377 987 1597 4181 6765 17711 28657 75025 121393 317811 514229<span class="org-kcats-brackets">]</span>
</pre>
</div>

<p>
There it is, the first 20 <b>odd</b> fibonacci numbers!
</p>

<p>
Let's say instead we wanted to know the prime factors that make up
each of the first 20 fibonacci numbers. We can do that with <code>each</code>:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 0 <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-builtin">swap</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">our original generator</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">a program to give the prime factors of a given number</span>
 <span class="org-kcats-brackets">[[]</span> <span class="org-builtin">swap</span> 2
  <span class="org-kcats-brackets">[</span>/ 2 &gt;=<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[[</span>mod zero?<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-builtin">sink</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dipdown</span> / 2<span class="org-kcats-brackets">]</span>
   <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span>
   <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span>
  <span class="org-preprocessor">while</span>
  <span class="org-builtin">drop</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]</span>
 each

 20 taker <span class="org-comment-delimiter">;; </span><span class="org-comment">another generator that calls generate 20 times</span>
 collect<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">collects all the generated items into a list</span>
<span class="org-preprocessor">shield</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>1<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>2<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>2 2 2<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>13<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>3 7<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>2 17<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>5 11<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>89<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>2 2 2 2 3 3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>233<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>13 29<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>2 5 61<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>3 7 47<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>1597<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>2 2 2 17 19<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>37 113<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>3 5 11 41<span class="org-kcats-brackets">]]</span>
</pre>
</div>

<p>
There we have it. We can see that <code>[2 2 2]</code> is what makes up <code>8</code>, etc.
</p>

<p>
Other included generators are:
</p>

<dl class="org-dl">
<dt>dropper</dt><dd>Inverse of <code>taker</code> - drops the first n items of the
sequence and returns the rest.</dd>
<dt>joiner</dt><dd>Joins items together</dd>
<dt>integers</dt><dd>all the numbers starting with 0</dd>
</dl>

<p>
<code>reduce</code> will consume what a generator produces. You provide a program
that takes 2 arguments, and <code>reduce</code> will generate all the items, and
pass to your program: the result so far and the next item generated,
and repeat that until there are no items left:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>integers
 1 dropper <span class="org-comment-delimiter">;; </span><span class="org-comment">drop 0 so we start with 1</span>
 10 taker
 <span class="org-kcats-brackets">[</span>3 *<span class="org-kcats-brackets">]</span> each
 <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> reduce<span class="org-kcats-brackets">]</span>
<span class="org-preprocessor">shield</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">135
</pre>
</div>

<p>
Let's say you go to the trouble of making a beautiful stack of
transformations and you want to re-use it, but you don't have a
generator, you have a list! Our transformation stack needs a
<b>generator</b>! How are we supposed to use it?  Never fear, there is a
simple way to adapt transformations to work on anything that works
with the word <code>take</code>. You can use the word <code>liberate</code> to convert a list to
a generator. (It's just an alias for <code>[take]</code> which is even shorter than
<code>liberate</code> so feel free to just use <code>[take]</code>).
</p>

<p>
Do you see why <code>[take]</code> converts a list to a generator? Remember,
generators are a state and a program. If we already have a list or
pipe, we can just treat that as the state. And <code>[take]</code> as the program
does exactly what we want, removes an item from the list and returns
it, leaving the state with one fewer item.
</p>
</div>
</div>
<div id="outline-container-orgc0a3720" class="outline-4">
<h4 id="orgc0a3720"><span class="section-number-4">2.1.6.</span> Coordination and Input/Output</h4>
<div class="outline-text-4" id="text-2-1-6">
</div>
<div id="outline-container-orge9eeff4" class="outline-5">
<h5 id="orge9eeff4"><span class="section-number-5">2.1.6.1.</span> Basics</h5>
<div class="outline-text-5" id="text-2-1-6-1">
<p>
In kcats, both coordination and input/output are done with <code>pipes</code>. See
the <a href="#org2251359">definition</a> for pipe.
</p>

<p>
Let's take a common example of coordination. Your program has to do
several very long and intensive calculations but doesn't want to make
the user wait to do other things. The way that's done in kcats is by
creating multiple environments, and have them communicate with each
other using pipes. You can send any value through a pipe that you
could put onto the stack, including other pipes. You can <code>clone</code> a pipe
to give access to it to more than one environment.
</p>

<p>
There are two main operations a pipe supports: <code>put</code> and <code>take</code>. You
either put an item in, or take an item out. Either one of those
operations may <b>block</b>, if the pipe is either full (when putting) or
empty (when taking). Your environment would have to wait for some
other environment to take something out so there's space to put, or
put something in so that there's something to take out.
</p>

<p>
All pipes share the <code>put</code> and <code>take</code> operations but they can differ in
other ways. For example, the pipe you get when writing to a file will
only accept bytes. Trying to put any other type will cause an
error. Pipes also have varying capacity to hold items. Imagine a pipe
that has no length at all, it's just a hole in a thin wall. It doesn't
hold anything - you can only pass an item through if there's someone
on the other side of the wall already waiting to accept it. That's
called a <code>handoff</code>, and is the most common coordination pipe. Other
pipes have a capacity. Imagine a pipe where even if no one is taking
anything out of it, you can still put 10 items into it before it will
stop accepting more. That is a pipe with a capacity of 10 items.
</p>

<p>
Note that <code>put</code> and <code>take</code> can also be used on plain lists. <code>put</code> adds to
the end, and <code>take</code> removes the first item. Neither will ever block when
used on a list. Another slight difference is what happens when you've
reached the end of the content (either the list is empty or the pipe
has, for example, hit the end of file condition): a <code>take</code> from an empty
list will just return <code>nothing</code>, but a <code>take</code> from a pipe that is at EOF
will result in an error.
</p>
</div>
</div>

<div id="outline-container-orgd36f722" class="outline-5">
<h5 id="orgd36f722"><span class="section-number-5">2.1.6.2.</span> Input/output</h5>
<div class="outline-text-5" id="text-2-1-6-2">
<p>
Let's look at how we do I/O using files as an example - let's say we
want to write the word <code>foo</code> to a file called <code>bar</code>:
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>file <span class="org-string">"bar"</span><span class="org-kcats-brackets">]]</span> pipe-in <span class="org-comment-delimiter">;; </span><span class="org-comment">create the pipe to the given file "foo"</span>
<span class="org-string">"foo"</span> bytes <span class="org-comment-delimiter">;; </span><span class="org-comment">we have to convert string to bytes first, using the word</span>
            <span class="org-comment-delimiter">;; </span><span class="org-comment">=bytes=.</span>
<span class="org-function-name">put</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">finally, put the bytes into the pipe, and they are written to</span>
    <span class="org-comment-delimiter">;; </span><span class="org-comment">the file</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>values <span class="org-kcats-brackets">[[</span>type bytes<span class="org-kcats-brackets">]]]</span> <span class="org-kcats-brackets">[</span>type tunnel<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>to <span class="org-kcats-brackets">[[</span>file <span class="org-string">"bar"</span><span class="org-kcats-brackets">]]]]</span>
</pre>
</div>

<p>
Note the representation of the pipe shows where it leads (the <code>to</code>
field), and what types of items it can carry (the <code>values</code> field).
</p>

<p>
Neither <code>put</code> nor <code>take</code> consume the pipe from the stack,
for convenience, as most of the time you'll want to use it again.
</p>

<p>
Let's look at reading from a file:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>file <span class="org-string">"bar"</span><span class="org-kcats-brackets">]]</span> pipe-out
<span class="org-function-name">take</span> string
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-string">"hello world!"</span> <span class="org-kcats-brackets">[[</span>to <span class="org-kcats-brackets">[[</span>file <span class="org-string">"bar"</span><span class="org-kcats-brackets">]]]</span> <span class="org-kcats-brackets">[</span>type tunnel<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>values <span class="org-kcats-brackets">[[</span>type bytes<span class="org-kcats-brackets">]]]]</span>
</pre>
</div>

<p>
Note that the amount of bytes you'll get from a file on each take, is
limited. You will only get the entire contents if the file is
small. We'll want to repeatedly <code>take</code> until there's nothing left, and
put all the taken parts together.
</p>

<p>
Here's how we do it:
</p>
<ul class="org-ul">
<li>turn the pipe that provides chunks of a file into a <a href="#org396cc5c">generator</a>, with <code>[take]</code>.</li>
<li>Assemble the chunks with <code>reduce</code>. It requires a program to say how to
combine the chunks. We want to <code>join</code> them, so the program is <code>[join]</code>.</li>
</ul>

<p>
We can also use the word <code>file-out</code> as a shortcut to get a pipe given a
file's name.
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"bar"</span> file-out <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> reduce string
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-string">"Hello World!"</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">take</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>type tunnel<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>values <span class="org-kcats-brackets">[[</span>type bytes<span class="org-kcats-brackets">]]]</span> <span class="org-kcats-brackets">[</span>to <span class="org-kcats-brackets">[[</span>file <span class="org-string">"bar"</span><span class="org-kcats-brackets">]]]]</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org14758ca" class="outline-2">
<h2 id="org14758ca"><span class="section-number-2">3.</span> Implementations</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li></li>

<li><a href="prototype.html#MissingReference">Prototype implementation (for historical purposes only)</a></li>
</ul>
</div>
</div>
<div id="outline-container-org9a4cf30" class="outline-2">
<h2 id="org9a4cf30"><span class="section-number-2">4.</span> Using</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org9c619e7" class="outline-3">
<h3 id="org9c619e7"><span class="section-number-3">4.1.</span> Building</h3>
<div class="outline-text-3" id="text-4-1">
</div>
<div id="outline-container-org6d2e2a8" class="outline-4">
<h4 id="org6d2e2a8"><span class="section-number-4">4.1.1.</span> Dependencies</h4>
<div class="outline-text-4" id="text-4-1-1">
<ul class="org-ul">
<li>emacs</li>
<li>Runtime/compiler for the implemenation you're trying to run</li>
</ul>
</div>
</div>
<div id="outline-container-orgcee8e86" class="outline-4">
<h4 id="orgcee8e86"><span class="section-number-4">4.1.2.</span> Creating the source</h4>
<div class="outline-text-4" id="text-4-1-2">
<p>
The source is contained within these org files, along with annotations
and other non-code information. To generate the source code (that the
runtime or compiler needs as separate files) before running or
building, run the following command:
</p>

<p>
<code>emacs --batch --load org --load tangle.el</code>
</p>
</div>
</div>

<div id="outline-container-org930e7d9" class="outline-4">
<h4 id="org930e7d9"><span class="section-number-4">4.1.3.</span> Building and Running</h4>
<div class="outline-text-4" id="text-4-1-3">
<p>
See the Using heading in the file for the implementation you want to
use.
</p>
</div>
</div>
</div>
<div id="outline-container-orgf3ec124" class="outline-3">
<h3 id="orgf3ec124"><span class="section-number-3">4.2.</span> Debugging</h3>
<div class="outline-text-3" id="text-4-2">
</div>
<div id="outline-container-org98aec0a" class="outline-4">
<h4 id="org98aec0a"><span class="section-number-4">4.2.1.</span> Overview</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
In kcats, we don't need an external debugger. We can debug our
programs right in the kcats interpeter. We can specify the program to
run and step through it.
</p>

<p>
Let's say this is the program we want to step through. This is how we'd normally run it:
</p>
<div class="org-src-container">
<pre class="src src-kcats">0 1 5 inc range <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">15
</pre>
</div>

<p>
To debug, we put it into an environment object which we can then use
debugging words like <code>advance</code>:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>expression <span class="org-kcats-brackets">[</span>0 1 5 inc 1 range <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span> environment
<span class="org-kcats-brackets">[</span>advance<span class="org-kcats-brackets">]</span> 7 <span class="org-preprocessor">times</span>
eval-<span class="org-function-name">step</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> 1 0<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span> <span class="org-kcats-brackets">[</span>2 3 4 5<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
</pre>
</div>

<p>
Note that <code>advance</code> is like <code>step-over</code> in a traditional debugger, and
<code>eval-step</code> is like <code>step-into</code>.  So above we advance until we reach the
word <code>step</code> in the program, and then we step into it. We end up showing
the environment in the middle of execution. The stack has a program
<code>[+]</code> on top, and the next word is <code>execute</code> which will run that program.
</p>
</div>
</div>
</div>

<div id="outline-container-org52cd5d9" class="outline-3">
<h3 id="org52cd5d9"><span class="section-number-3">4.3.</span> Developing</h3>
<div class="outline-text-3" id="text-4-3">
</div>
<div id="outline-container-orgd4bff57" class="outline-4">
<h4 id="orgd4bff57"><span class="section-number-4">4.3.1.</span> Browsing the source</h4>
<div class="outline-text-4" id="text-4-3-1">
<p>
It can be checked out from git or viewed here: <a href="production.html#MissingReference">Production
implementation source</a>
</p>
</div>
</div>
<div id="outline-container-orga568095" class="outline-4">
<h4 id="orga568095"><span class="section-number-4">4.3.2.</span> Emacs</h4>
<div class="outline-text-4" id="text-4-3-2">
<p>
Execute these code snippets within emacs to enable kcats IDE
functionality. Soon these will be made into installable elpa packages.
</p>
</div>
<div id="outline-container-orga79a0bb" class="outline-5">
<h5 id="orga79a0bb"><span class="section-number-5">4.3.2.1.</span> major mode</h5>
<div class="outline-text-5" id="text-4-3-2-1">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defface</span> <span class="org-variable-name">kcats-brackets</span> 
  '((((class color)) (<span class="org-builtin">:foreground</span> <span class="org-string">"DimGrey"</span> <span class="org-builtin">:weight</span> bold)))
  <span class="org-doc">"kcats brackets"</span> <span class="org-builtin">:group</span> 'faces)
(<span class="org-keyword">defface</span> <span class="org-variable-name">kcats-stackop</span> 
  '((((class color)) (<span class="org-builtin">:foreground</span> <span class="org-string">"LightGreen"</span> <span class="org-builtin">:inherit</span> 'font-lock-keyword-face)))
  <span class="org-doc">"kcats stack manipulation operation"</span> <span class="org-builtin">:group</span> 'faces)

(<span class="org-keyword">defconst</span> <span class="org-variable-name">kcats-font-lock-keywords</span>
      `((<span class="org-string">"\\[</span><span class="org-string"><span class="org-constant"><span class="org-regexp-grouping-backslash">\\</span></span></span><span class="org-string"><span class="org-constant"><span class="org-regexp-grouping-construct">|</span></span></span><span class="org-string"><span class="org-constant">\\</span></span><span class="org-string">]"</span> 0 'kcats-brackets)
        (<span class="org-string">";;.*"</span> 0 'font-lock-comment-face)
        (,(regexp-opt '(<span class="org-string">"swap"</span> <span class="org-string">"swapdown"</span> <span class="org-string">"drop"</span> <span class="org-string">"dropdown"</span> <span class="org-string">"sink"</span> <span class="org-string">"float"</span> <span class="org-string">"clone"</span> <span class="org-string">"snapshot"</span> <span class="org-string">"evert"</span>) 'words) . (0 font-lock-builtin-face))
        (,(regexp-opt '(<span class="org-string">"true"</span> <span class="org-string">"false"</span> <span class="org-string">"nothing"</span> <span class="org-string">"[]"</span>) 'words) . (0 font-lock-keyword-face))
        (,(regexp-opt '(<span class="org-string">"first"</span> <span class="org-string">"second"</span> <span class="org-string">"last"</span> <span class="org-string">"put"</span> <span class="org-string">"take"</span> <span class="org-string">"pop"</span> <span class="org-string">"step"</span> <span class="org-string">"filter"</span>
                        <span class="org-string">"map"</span> <span class="org-string">"count"</span> <span class="org-string">"join"</span> <span class="org-string">"rest"</span> <span class="org-string">"wrap"</span> <span class="org-string">"unwrap"</span> <span class="org-string">"reverse"</span>) <span class="org-warning">'words) . (0 font-lock-function-name-face))</span>
        (,(regexp-opt '(<span class="org-string">"execute"</span> <span class="org-string">"dip"</span> <span class="org-string">"dive"</span> <span class="org-string">"divedown"</span> <span class="org-string">"dipdown"</span> <span class="org-string">"shield"</span> <span class="org-string">"shielddown"</span> <span class="org-string">"shielddeep"</span> <span class="org-string">"inject"</span>
                        <span class="org-string">"loop"</span> <span class="org-string">"while"</span> <span class="org-string">"until"</span> <span class="org-string">"if"</span> <span class="org-string">"branch"</span> <span class="org-string">"recur"</span> <span class="org-string">"times"</span>) <span class="org-warning">'words) . '(0 font-lock-preprocessor-face))</span>
        (<span class="org-string">"#?\""</span> 0 'double-quote prepend)))

(add-hook 'kcats-mode-hook (<span class="org-keyword">lambda</span> () (font-lock-add-keywords nil kcats-font-lock-keywords)))

(<span class="org-keyword">require</span> '<span class="org-constant">smie</span>) <span class="org-comment-delimiter">;; </span><span class="org-comment">indentation engine</span>

(<span class="org-keyword">setq</span> kcats-mode-syntax-table (<span class="org-keyword">let</span> ((table (make-syntax-table)))
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Initialize ASCII charset as symbol syntax</span>
    (modify-syntax-entry '(0 . 127) <span class="org-string">"_"</span> table)

    <span class="org-comment-delimiter">;; </span><span class="org-comment">Word syntax</span>
    (modify-syntax-entry '(?0 . ?9) <span class="org-string">"w"</span> table)
    (modify-syntax-entry '(?a . ?z) <span class="org-string">"w"</span> table)
    (modify-syntax-entry '(?A . ?Z) <span class="org-string">"w"</span> table)

    <span class="org-comment-delimiter">;; </span><span class="org-comment">Whitespace</span>
    (modify-syntax-entry ?\s <span class="org-string">" "</span> table)
    (modify-syntax-entry ?\xa0 <span class="org-string">" "</span> table) <span class="org-comment-delimiter">; </span><span class="org-comment">non-breaking space</span>
    (modify-syntax-entry ?\t <span class="org-string">" "</span> table)
    (modify-syntax-entry ?\f <span class="org-string">" "</span> table)
    <span class="org-comment-delimiter">;; </span><span class="org-comment">Setting commas as whitespace makes functions like `</span><span class="org-comment"><span class="org-constant">delete-trailing-whitespace</span></span><span class="org-comment">' behave unexpectedly (#561)</span>
    (modify-syntax-entry ?, <span class="org-string">"."</span> table)

    <span class="org-comment-delimiter">;; </span><span class="org-comment">Delimiters</span>
    (modify-syntax-entry ?\[ <span class="org-string">"(]"</span> table)
    (modify-syntax-entry ?\] <span class="org-string">")["</span> table)

    <span class="org-comment-delimiter">;; </span><span class="org-comment">Others</span>
    (modify-syntax-entry ?\; <span class="org-string">"&lt;"</span> table) <span class="org-comment-delimiter">; </span><span class="org-comment">comment start</span>
    (modify-syntax-entry ?\n <span class="org-string">"&gt;"</span> table) <span class="org-comment-delimiter">; </span><span class="org-comment">comment end</span>
    (modify-syntax-entry ?\" <span class="org-string">"\""</span> table) <span class="org-comment-delimiter">; </span><span class="org-comment">string</span>
    (modify-syntax-entry ?\\ <span class="org-string">"\\"</span> table) <span class="org-comment-delimiter">; </span><span class="org-comment">escape</span>

    table))

(<span class="org-keyword">define-derived-mode</span> <span class="org-function-name">kcats-mode</span> fundamental-mode <span class="org-string">"kcats"</span>
  <span class="org-doc">"major mode for editing kcats."</span>
  (set-syntax-table kcats-mode-syntax-table)
  (<span class="org-keyword">setq-local</span> comment-start <span class="org-string">";"</span>) <span class="org-comment-delimiter">;; </span><span class="org-comment">try ";;"</span>
  (<span class="org-keyword">setq-local</span> comment-end <span class="org-string">""</span>)

  (smie-setup nil (<span class="org-keyword">lambda</span> (method arg)
                    (<span class="org-keyword">when</span> (eq method <span class="org-builtin">:list-intro</span>)
                      t)))
  (<span class="org-keyword">setq</span> font-lock-defaults '(kcats-font-lock-keywords)))

(add-to-list 'auto-mode-alist '(<span class="org-string">"\\.kcats\\'"</span> . kcats-mode))
(<span class="org-keyword">defun</span> <span class="org-function-name">my-restart-kcats-mode</span> ()
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((kcats-mode-hook nil))
    (normal-mode)))

(<span class="org-keyword">defun</span> <span class="org-function-name">kcats-format-buffer</span> ()
  <span class="org-doc">"Format the current buffer according to the kcats language style."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">save-excursion</span>
    (goto-char (point-min))
    (<span class="org-keyword">while</span> (not (eobp))
      (<span class="org-keyword">pcase</span> (char-after)
        (?\[ (kcats-indent))
        (?\] (kcats-dedent))
        (_ (forward-char)))))
  (goto-char (point-min))
  (<span class="org-keyword">while</span> (search-forward <span class="org-string">"[["</span> nil t)
    (replace-match <span class="org-string">"[  ["</span>))
  (goto-char (point-min))
  (<span class="org-keyword">while</span> (search-forward-regexp <span class="org-string">"</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\[</span><span class="org-string"><span class="org-constant"><span class="org-regexp-grouping-backslash">\\</span></span></span><span class="org-string"><span class="org-constant"><span class="org-regexp-grouping-construct">|</span></span></span><span class="org-string"><span class="org-constant">\\</span></span><span class="org-string">]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">[[:space:]]+</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">(</span></span><span class="org-string">\\[</span><span class="org-string"><span class="org-constant"><span class="org-regexp-grouping-backslash">\\</span></span></span><span class="org-string"><span class="org-constant"><span class="org-regexp-grouping-construct">|</span></span></span><span class="org-string"><span class="org-constant">\\</span></span><span class="org-string">]</span><span class="org-string"><span class="org-regexp-grouping-backslash">\\</span></span><span class="org-string"><span class="org-regexp-grouping-construct">)</span></span><span class="org-string">"</span> nil t)
    (replace-match <span class="org-string">"\\1\\2"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">kcats-indent</span> ()
  <span class="org-doc">"Increase the indentation level by 2 spaces."</span>
  (beginning-of-line)
  (indent-line-to (+ (current-indentation) 2)))

(<span class="org-keyword">defun</span> <span class="org-function-name">kcats-dedent</span> ()
  <span class="org-doc">"Decrease the indentation level by 2 spaces."</span>
  (beginning-of-line)
  (indent-line-to (max (- (current-indentation) 2) 0)))
</pre>
</div>

<pre class="example">
kcats-dedent
</pre>
</div>
</div>

<div id="outline-container-orgab78f26" class="outline-5">
<h5 id="orgab78f26"><span class="section-number-5">4.3.2.2.</span> org-babel mode</h5>
<div class="outline-text-5" id="text-4-3-2-2">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">org-babel-execute:kcats</span> (body params)
  <span class="org-doc">"Execute a block of kcats code with org-babel."</span>
  (org-babel-eval
   kcats-babel-executable
   body))

(<span class="org-keyword">defcustom</span> <span class="org-variable-name">kcats-babel-executable</span> <span class="org-string">"kcats"</span>
  <span class="org-doc">"Location of the kcats binary"</span>
  <span class="org-builtin">:type</span> 'string
  <span class="org-builtin">:group</span> 'kcats-babel)
</pre>
</div>

<pre class="example">
kcats-babel-executable
</pre>
</div>
</div>

<div id="outline-container-orgb0be41e" class="outline-5">
<h5 id="orgb0be41e"><span class="section-number-5">4.3.2.3.</span> Repl mode</h5>
<div class="outline-text-5" id="text-4-3-2-3">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">require</span> '<span class="org-constant">comint</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">kcats-send</span> (proc code)
  <span class="org-doc">"Send the CODE to the kcats interpreter and return the result."</span>
  (message <span class="org-string">"Sending: %s"</span> code)
  (<span class="org-keyword">let*</span> ((code-len (+ (length code) 1))
         (code-str (format <span class="org-string">"%d\n%s"</span> code-len code)))
    (<span class="org-keyword">with-temp-buffer</span>
      (insert code-str)
      (process-send-region proc (point-min) (point-max)))
    (process-send-string proc <span class="org-string">"\n"</span>)
    <span class="org-comment-delimiter">;;</span><span class="org-comment">(accept-process-output proc)</span>
    ))

(<span class="org-keyword">defun</span> <span class="org-function-name">kcats-repl</span> ()
  <span class="org-doc">"Start a REPL for process kcats."</span>
  (<span class="org-keyword">interactive</span>)
  (<span class="org-keyword">let</span> ((buffer (get-buffer-create <span class="org-string">"*kcats* REPL"</span>)))
    (switch-to-buffer buffer)
    (<span class="org-keyword">unless</span> (comint-check-proc buffer)
      (<span class="org-keyword">let</span> ((buffer (comint-exec buffer <span class="org-string">"kcats"</span> kcats-babel-executable nil '(<span class="org-string">"-i"</span>)))
            (process (get-buffer-process buffer)))
        (set-process-buffer process buffer)
        (set-process-query-on-exit-flag process nil)
        (set-process-sentinel
         process
         (<span class="org-keyword">lambda</span> (process event)
           (<span class="org-keyword">when</span> (string= event <span class="org-string">"finished\n"</span>)
             (message <span class="org-string">"kcats process terminated."</span>)))))
      (kcats-repl-mode))))

(<span class="org-keyword">defun</span> <span class="org-function-name">string-drop-first-line</span> (s)
  (<span class="org-keyword">let</span> ((lines (split-string s <span class="org-string">"\n"</span> t)))
    (mapconcat 'identity (cdr lines) <span class="org-string">"\n"</span>)))

(<span class="org-keyword">defun</span> <span class="org-function-name">kcats-repl-insert-prompt</span> (s)
  (concat s <span class="org-string">"kcats&gt; "</span>))

(<span class="org-keyword">define-derived-mode</span> <span class="org-function-name">kcats-repl-mode</span> comint-mode <span class="org-string">"kcats REPL"</span>
  <span class="org-doc">"Major mode for interacting with the foo process."</span>
  (smartparens-strict-mode t)
  (add-hook 'comint-preoutput-filter-functions 'string-drop-first-line)
  (add-hook 'comint-preoutput-filter-functions 'kcats-repl-insert-prompt)
  (<span class="org-keyword">setq</span> comint-prompt-regexp <span class="org-string">"^kcats&gt;"</span>)
  (<span class="org-keyword">setq</span> comint-highlight-input nil)
  (<span class="org-keyword">setq</span> comint-use-prompt-regexp t)
  (<span class="org-keyword">setq</span> comint-input-sender 'kcats-send)
  (set-syntax-table kcats-mode-syntax-table)
  (<span class="org-keyword">setq</span> font-lock-defaults '(kcats-font-lock-keywords)))

(<span class="org-keyword">defun</span> <span class="org-function-name">my-restart-kcats-repl-mode</span> ()
    (<span class="org-keyword">interactive</span>)
    (<span class="org-keyword">let</span> ((kcats-repl-mode-hook nil))
      (normal-mode)))


</pre>
</div>

<pre class="example">
my-restart-kcats-repl-mode
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgef70a61" class="outline-3">
<h3 id="orgef70a61"><span class="section-number-3">4.4.</span> Get started using introspection</h3>
<div class="outline-text-3" id="text-4-4">
</div>
<div id="outline-container-org7897a5a" class="outline-4">
<h4 id="org7897a5a"><span class="section-number-4">4.4.1.</span> Overview</h4>
<div class="outline-text-4" id="text-4-4-1">
<p>
The standard library is part of the source, it lives in <a href="lexicon.html">the lexicon</a> file.
</p>

<p>
Kcats lets you treat the standard library as data, and you can process
it with&#x2026; itself. All the documentation is in there. You just need to
know how to ask.
</p>
</div>
</div>
<div id="outline-container-org03eed43" class="outline-4">
<h4 id="org03eed43"><span class="section-number-4">4.4.2.</span> What words or functions are available?</h4>
<div class="outline-text-4" id="text-4-4-2">
<p>
This snippet retrieves the dictionary of the starting environment, and
prints just the name of each, sorted in alphabetical order.
</p>
<div class="org-src-container">
<pre class="src src-kcats">dictionary <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-kcats-brackets">[]</span> sort
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>* + ++lookup ++sort - / &lt; &lt;= = &gt; &gt;= abs addmethod advance and animate
 any? assert assign association association? atom bail both? <span class="org-preprocessor">branch</span>
 break buffer bytes bytes? ceil <span class="org-builtin">clone</span> close collect compare contains?
 <span class="org-function-name">count</span> dec decide decorate decorated delegated dictionary <span class="org-preprocessor">dip</span> <span class="org-preprocessor">dipdown</span>
 <span class="org-preprocessor">dive</span> <span class="org-preprocessor">divedown</span> <span class="org-builtin">drop</span> <span class="org-builtin">dropdown</span> dropper each emit environment error?
 eval-<span class="org-function-name">step</span> evaluate even? <span class="org-builtin">evert</span> every? <span class="org-preprocessor">execute</span> fail <span class="org-keyword">false</span> file-in
 file-out <span class="org-function-name">filter</span> <span class="org-function-name">first</span> flip <span class="org-builtin">float</span> functional future generate handle
 handoff hash <span class="org-preprocessor">if</span> inc <span class="org-preprocessor">inject</span> inspect integers <span class="org-function-name">join</span> joiner keep key <span class="org-function-name">last</span>
 let liberate lingo list? lookup <span class="org-preprocessor">loop</span> <span class="org-function-name">map</span> max min mod negative? not
 <span class="org-keyword">nothing</span> <span class="org-keyword">nothing</span>? number? odd? or pair pipe-in pipe-out pipe? <span class="org-function-name">pop</span>
 positive? prepend primrec <span class="org-function-name">put</span> quot range read recover <span class="org-preprocessor">recur</span> redefine
 reduce rem <span class="org-function-name">rest</span> retry <span class="org-function-name">reverse</span> <span class="org-function-name">second</span> select serversocket set set?
 <span class="org-preprocessor">shield</span> <span class="org-preprocessor">shielddeep</span> <span class="org-preprocessor">shielddown</span> sign <span class="org-builtin">sink</span> <span class="org-builtin">snapshot</span> something? sort spit
 sqrt standard <span class="org-function-name">step</span> string string? <span class="org-builtin">swap</span> <span class="org-builtin">swapdown</span> <span class="org-function-name">take</span> taker timeout
 <span class="org-preprocessor">times</span> timestamps toe tos <span class="org-keyword">true</span> tunnel type unassign <span class="org-preprocessor">until</span> <span class="org-function-name">unwrap</span>
 update value verify <span class="org-preprocessor">while</span> within? word? <span class="org-function-name">wrap</span> xor zero? zip<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org58e946a" class="outline-4">
<h4 id="org58e946a"><span class="section-number-4">4.4.3.</span> What inputs/outputs does a particular function have?</h4>
<div class="outline-text-4" id="text-4-4-3">
<p>
The specification of a function's input and output types is stored in
the dictionary too. It's in the field called <code>spec</code>. Let's say you're
interested in the word <code>swap</code>.
</p>

<div class="org-src-container">
<pre class="src src-kcats">dictionary <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> spec<span class="org-kcats-brackets">]</span> lookup
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>item a<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>item b<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[[</span>item b<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>item a<span class="org-kcats-brackets">]]]</span>
</pre>
</div>

<p>
What we have here is two lists - the spec of the input, and the spec of the output.
</p>

<p>
The input spec is <code>[[item a] [item b]]</code>. The output spec is <code>[[item b]
[item a]]</code>. What it's telling you is that it requires two items on the
stack, any two, we'll call them <code>a</code> (on top) and <code>b</code> beneath. There may be
more items below that but they won't be touched. When swap is
finished, <code>a</code> and <code>b</code> will have their places swapped so that <code>b</code> is on
top. And in fact that's what we get:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"b"</span> <span class="org-string">"a"</span> <span class="org-builtin">swap</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-string">"b"</span> <span class="org-string">"a"</span>
</pre>
</div>

<p>
Remember the top of the stack is printed first, and so <code>b</code> is now on top. 
</p>
</div>
</div>
<div id="outline-container-org58d35de" class="outline-4">
<h4 id="org58d35de"><span class="section-number-4">4.4.4.</span> What are some example usages of a function?</h4>
<div class="outline-text-4" id="text-4-4-4">
<div class="org-src-container">
<pre class="src src-kcats">dictionary <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> examples<span class="org-kcats-brackets">]</span> lookup
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>1 2 3 <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>1 3 2<span class="org-kcats-brackets">]]]</span>
</pre>
</div>

<p>
This is a list of examples, and each example is a pair:
</p>

<ul class="org-ul">
<li>A program that calls the given function</li>
<li>A program that doesn't call the function that gives the same result</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc95027e" class="outline-2">
<h2 id="orgc95027e"><span class="section-number-2">5.</span> Example programs</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org1cc9734" class="outline-3">
<h3 id="org1cc9734"><span class="section-number-3">5.1.</span> Factorial</h3>
<div class="outline-text-3" id="text-5-1">
</div>
<div id="outline-container-org42a791b" class="outline-4">
<h4 id="org42a791b"><span class="section-number-4">5.1.1.</span> Recursive with recur</h4>
<div class="outline-text-4" id="text-5-1-1">
<div class="org-src-container">
<pre class="src src-kcats">10
<span class="org-kcats-brackets">[</span>1 &lt;=<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[]</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> dec<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span> *<span class="org-kcats-brackets">]</span>
<span class="org-preprocessor">recur</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">3628800
</pre>
</div>
</div>
</div>

<div id="outline-container-org53ea43f" class="outline-4">
<h4 id="org53ea43f"><span class="section-number-4">5.1.2.</span> Using range</h4>
<div class="outline-text-4" id="text-5-1-2">
<div class="org-src-container">
<pre class="src src-kcats">10
inc <span class="org-kcats-brackets">[</span>1 1<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> 1 range 
<span class="org-kcats-brackets">[</span>*<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">3628800
</pre>
</div>
</div>
</div>

<div id="outline-container-org5b0aa2b" class="outline-4">
<h4 id="org5b0aa2b"><span class="section-number-4">5.1.3.</span> Plain loop</h4>
<div class="outline-text-4" id="text-5-1-3">
<div class="org-src-container">
<pre class="src src-kcats">10 <span class="org-builtin">clone</span> 
<span class="org-keyword">true</span> <span class="org-kcats-brackets">[</span>dec <span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span>*<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">clone</span> 1 &gt;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">loop</span>
<span class="org-builtin">drop</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">3628800
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org98862a6" class="outline-3">
<h3 id="org98862a6"><span class="section-number-3">5.2.</span> Jensen's Device</h3>
<div class="outline-text-3" id="text-5-2">
<p>
<a href="https://rosettacode.org/wiki/Jensen%27s_Device">https://rosettacode.org/wiki/Jensen%27s_Device</a>
</p>
<div class="org-src-container">
<pre class="src src-kcats">100 <span class="org-kcats-brackets">[</span>0<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>1.0 <span class="org-builtin">swap</span> /<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> +<span class="org-kcats-brackets">]</span> primrec
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">5.187377517639621
</pre>
</div>
</div>
</div>

<div id="outline-container-org27710a7" class="outline-3">
<h3 id="org27710a7"><span class="section-number-3">5.3.</span> Fibonacci</h3>
<div class="outline-text-3" id="text-5-3">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 0 <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-builtin">swap</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">fibonacci generator</span>
 20 taker <span class="org-comment-delimiter">;; </span><span class="org-comment">another generator that calls generate 20 times</span>
 collect<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">collects all the generated items into a list</span>
 <span class="org-preprocessor">shield</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>1 1 2 3 5 8 13 21 34 55 89 144 233 377 610 987 1597 2584 4181 6765<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org80a3d44" class="outline-3">
<h3 id="org80a3d44"><span class="section-number-3">5.4.</span> Prime factors</h3>
<div class="outline-text-3" id="text-5-4">
<div class="org-src-container">
<pre class="src src-kcats">360

<span class="org-kcats-brackets">[]</span> <span class="org-builtin">swap</span> 2

<span class="org-kcats-brackets">[</span>/ 2 &gt;=<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>mod zero?<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-builtin">sink</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dipdown</span> / 2<span class="org-kcats-brackets">]</span>
  <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span>
  <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span>
<span class="org-preprocessor">while</span>

<span class="org-builtin">drop</span> <span class="org-function-name">put</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>2 2 2 3 3 5<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org88434b1" class="outline-3">
<h3 id="org88434b1"><span class="section-number-3">5.5.</span> bidirectional comms from a socket</h3>
<div class="outline-text-3" id="text-5-5">
<pre class="example" id="org46ccead">
["" [string join] ;; each group of bytes that come out of the tunnel,
                  ;; convert to string and join to whatever we already
                  ;; collectd
 [[type ip-port]
  [address "localhost"]
  [port 9988]] association ;; description of where to connect to (an ip port)
 tunnel ;; make a bidirectional tunnel
 "foo! bar!" put ;; send this string
 collect] ;; receive
</pre>
</div>
</div>
<div id="outline-container-orgcfd1830" class="outline-3">
<h3 id="orgcfd1830"><span class="section-number-3">5.6.</span> Write string to a file</h3>
<div class="outline-text-3" id="text-5-6">
<pre class="example" id="orga66f407">
[[[file "/tmp/foo"]] pipe-in
 "blah" put
 close]
</pre>
</div>
</div>
<div id="outline-container-orgfb9be63" class="outline-3">
<h3 id="orgfb9be63"><span class="section-number-3">5.7.</span> Search the dictionary</h3>
<div class="outline-text-3" id="text-5-7">
<div class="org-src-container">
<pre class="src src-kcats">dictionary <span class="org-comment-delimiter">;; </span><span class="org-comment">put the dictionary of all words onto the stack as key value pairs</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">second</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">the value of one of those pairs</span>
 <span class="org-kcats-brackets">[</span>spec<span class="org-kcats-brackets">]</span> lookup <span class="org-comment-delimiter">;; </span><span class="org-comment">look up the spec field</span>
 <span class="org-function-name">first</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">the input part of the spec</span>
 <span class="org-kcats-brackets">[</span>number number<span class="org-kcats-brackets">]</span> =<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">is it taking two number inputs?</span>
<span class="org-function-name">filter</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">filter the dictionary using the above criteria</span>
<span class="org-kcats-brackets">[</span><span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">of what remains, just keep the key (which is the word itself)</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>&gt; rem &gt;= * mod min - + &lt;= within? &lt; max quot /<span class="org-kcats-brackets">]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org5e7c406" class="outline-3">
<h3 id="org5e7c406"><span class="section-number-3">5.8.</span> Copy data from one file to another</h3>
<div class="outline-text-3" id="text-5-8">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>file <span class="org-string">"/tmp/bar"</span><span class="org-kcats-brackets">]]</span> pipe-in
<span class="org-kcats-brackets">[[</span>file <span class="org-string">"/tmp/foo"</span><span class="org-kcats-brackets">]]</span> pipe-out 
<span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"/tmp/foo"</span> <span class="org-string">"/tmp/bar"</span>
pair <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[</span>file<span class="org-kcats-brackets">]</span> <span class="org-builtin">float</span> assign<span class="org-kcats-brackets">]</span> <span class="org-function-name">map</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">make file descriptors for both</span>
<span class="org-function-name">take</span> pipe-out
<span class="org-builtin">swap</span> <span class="org-function-name">unwrap</span> pipe-in
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>unwound <span class="org-kcats-brackets">[[</span>type<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> = <span class="org-kcats-brackets">[[[[</span>file <span class="org-string">"/tmp/foo"</span><span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[[[</span>file <span class="org-string">"/tmp/bar"</span><span class="org-kcats-brackets">]]]]]</span> <span class="org-function-name">unwrap</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span> <span class="org-function-name">second</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> <span class="org-preprocessor">branch</span> <span class="org-kcats-brackets">[[[[</span><span class="org-function-name">count</span> 1 =<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">first</span> <span class="org-kcats-brackets">[</span>type<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> =<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> <span class="org-function-name">second</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">first</span> <span class="org-function-name">first</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>file <span class="org-string">"/tmp/foo"</span><span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[[[</span>file <span class="org-string">"/tmp/bar"</span><span class="org-kcats-brackets">]]]]]</span> <span class="org-function-name">unwrap</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-builtin">swap</span> <span class="org-builtin">drop</span> <span class="org-kcats-brackets">[[[[</span>association<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span><span class="org-kcats-brackets">]]]</span> <span class="org-function-name">unwrap</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-function-name">unwrap</span> or <span class="org-kcats-brackets">[[[[</span><span class="org-keyword">nothing</span>?<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>or<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">take</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> or<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">recur</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">execute</span> <span class="org-builtin">swap</span> <span class="org-builtin">drop</span> <span class="org-builtin">swap</span> <span class="org-builtin">drop</span> <span class="org-kcats-brackets">[</span>file<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> = <span class="org-kcats-brackets">[[[[</span>file <span class="org-string">"/tmp/foo"</span><span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[[[</span>file <span class="org-string">"/tmp/bar"</span><span class="org-kcats-brackets">]]]]]</span> <span class="org-function-name">unwrap</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-kcats-brackets">[[[[</span>file <span class="org-string">"/tmp/foo"</span><span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[[[</span>file <span class="org-string">"/tmp/bar"</span><span class="org-kcats-brackets">]]]]]</span> <span class="org-function-name">unwrap</span> <span class="org-builtin">evert</span> <span class="org-function-name">first</span> <span class="org-kcats-brackets">[[</span>value file-out<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[[[</span>type <span class="org-kcats-brackets">[</span>ip-port<span class="org-kcats-brackets">]</span> <span class="org-function-name">unwrap</span> =<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-kcats-brackets">[</span>port<span class="org-kcats-brackets">]</span> lookup <span class="org-kcats-brackets">[[</span>address<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> serversocket<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[[</span>list?<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+kcats.pipe/-&gt;filled<span class="org-kcats-brackets">]]]</span> decide<span class="org-kcats-brackets">]]</span> <span class="org-function-name">unwrap</span> <span class="org-preprocessor">branch</span> <span class="org-builtin">swap</span> <span class="org-function-name">unwrap</span> pipe-in<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>actual <span class="org-kcats-brackets">[[</span>file <span class="org-string">"/tmp/foo"</span><span class="org-kcats-brackets">]]]</span> <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>list<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>handled <span class="org-keyword">true</span><span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[[[</span>file <span class="org-string">"/tmp/bar"</span><span class="org-kcats-brackets">]]]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf66155f" class="outline-3">
<h3 id="orgf66155f"><span class="section-number-3">5.9.</span> List the steps of program execution</h3>
<div class="outline-text-3" id="text-5-9">
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>0 <span class="org-kcats-brackets">[</span>1 2 3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">the program to trace</span>

<span class="org-kcats-brackets">[</span>expression<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span> <span class="org-function-name">wrap</span> environment <span class="org-comment-delimiter">;; </span><span class="org-comment">create a starting env</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">now create a generator of environment states for each step of execution</span>
<span class="org-kcats-brackets">[[[</span>expression<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">if the expression is not empty</span>
 <span class="org-kcats-brackets">[</span>eval-<span class="org-function-name">step</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">step </span>
 <span class="org-kcats-brackets">[[]]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">otherwise emit nothing to stop the consumption</span>
 <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">consume the generator</span>
collect
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>stack <span class="org-kcats-brackets">[</span>0<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[[</span>1 2 3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[</span>1 2 3<span class="org-kcats-brackets">]</span> 0<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>1 2 3<span class="org-kcats-brackets">]</span> 0<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[</span><span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> 1 0<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span> <span class="org-kcats-brackets">[</span>2 3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[</span>1 0<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[</span>+ <span class="org-kcats-brackets">[</span>2 3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[</span>1<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[[</span>2 3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[</span>2 3<span class="org-kcats-brackets">]</span> 1<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>2 3<span class="org-kcats-brackets">]</span> 1<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[</span><span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> 2 1<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span> <span class="org-kcats-brackets">[</span>3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[</span>2 1<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[</span>+ <span class="org-kcats-brackets">[</span>3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[</span>3<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[[</span>3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[</span>3<span class="org-kcats-brackets">]</span> 3<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>3<span class="org-kcats-brackets">]</span> 3<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[</span><span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> 3 3<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[</span>3 3<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[</span>+ <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[</span>6<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[]</span> 6<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> 6<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[</span><span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[</span>6<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[]]]]</span>
<span class="org-kcats-brackets">[[[</span>expression<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>eval-<span class="org-function-name">step</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>expression <span class="org-kcats-brackets">[]]</span> <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>6<span class="org-kcats-brackets">]]]</span>
</pre>
</div>

<p>
We could ensure the stack/expression are printed in the same order each time
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>0 <span class="org-kcats-brackets">[</span>1 2 3<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">the program to debug</span>

<span class="org-kcats-brackets">[</span>expression<span class="org-kcats-brackets">]</span> <span class="org-builtin">swap</span> <span class="org-function-name">put</span> <span class="org-function-name">wrap</span> environment <span class="org-comment-delimiter">;; </span><span class="org-comment">create a starting env</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">now create a generator of environment states for each step of execution</span>
<span class="org-kcats-brackets">[[[</span>expression<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>eval-<span class="org-function-name">step</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span>

<span class="org-comment-delimiter">;; </span><span class="org-comment">print with the fields sorted the same way for each step</span>
<span class="org-kcats-brackets">[</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> 3 3<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span> <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[</span>3 3<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[</span>+ <span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[</span>6<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[[]</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[]</span> 6<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> 6<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[</span><span class="org-function-name">step</span><span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[[</span>stack <span class="org-kcats-brackets">[</span>6<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>expression <span class="org-kcats-brackets">[]]]]</span>
<span class="org-kcats-brackets">[[[</span>expression<span class="org-kcats-brackets">]</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>eval-<span class="org-function-name">step</span> <span class="org-builtin">clone</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-preprocessor">if</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>expression <span class="org-kcats-brackets">[]]</span> <span class="org-kcats-brackets">[</span>stack <span class="org-kcats-brackets">[</span>6<span class="org-kcats-brackets">]]]</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org492eb7a" class="outline-2">
<h2 id="org492eb7a"><span class="section-number-2">6.</span> Contributing</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org87c236e" class="outline-3">
<h3 id="org87c236e"><span class="section-number-3">6.1.</span> Bug reports</h3>
<div class="outline-text-3" id="text-6-1">
<p>
Instead of opening a github issue, add a <code>TODO</code> subheading to the
<a href="#org1ab1c0f">Issues</a> heading. Commit the change and submit it as a pull request. In
the branch where that issue is being fixed, it will be changed to
<code>INPROGRESS</code>. When the issue is fixed, the heading will be
removed. (If you disagree that it's been fixed, submit a PR that
reverts the commit to remove it).
</p>

<p>
You can edit this file right on github, in your own fork of the
project, if you prefer.
</p>

<p>
Why do things this weird way? I don't want to rely on github, nice as
it is.
</p>
</div>
</div>
</div>
<div id="outline-container-org1ab1c0f" class="outline-2">
<h2 id="org1ab1c0f"><span class="section-number-2">7.</span> Issues</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org25ed2b9" class="outline-3">
<h3 id="org25ed2b9"><span class="section-number-3">7.1.</span> <span class="done DONE">DONE</span> Build without using emacs interactively</h3>
<div class="outline-text-3" id="text-7-1">
<p>
Users should not be required to know emacs to build the project, only
have it installed. The build should be accessible from bash without
having to use emacs interactively. 
</p>
</div>
</div>
<div id="outline-container-org4fe25a7" class="outline-3">
<h3 id="org4fe25a7"><span class="section-number-3">7.2.</span> <span class="done DONE">DONE</span> Remove platform interop from lexicon</h3>
<div class="outline-text-3" id="text-7-2">
<p>
That was only there as a cheat when there was only the prototype
implementation. The platforms are different and their function names
don't belong in the lexicon.
</p>

<p>
I'm not even sure there should be platform interop at all - it doesn't
appear to be possible in the rust impl anyway.
</p>

<p>
So far what I've done is have some lower level words actually in the
dictionary but marked them like `++lookup`. I haven't decided what to
do about this yet. Lower level words probably should just be first
class citizens and I just need to think of better names. Right now the
low level (single-depth) lookup is `++lookup` and the user-facing
`lookup` does the arbitrary depth. In this case, the user-facing name
probably needs to change to reflect what it does (something like
`drill` or `extract`), and then the low level can just be `lookup`.
</p>

<p>
That means for all the i/o and crypto interactions, there needs to be
low-level words. I'm not sure yet how to prevent namespace pollution,
as one of the design choices is
</p>
</div>
</div>
<div id="outline-container-org6bde354" class="outline-3">
<h3 id="org6bde354"><span class="section-number-3">7.3.</span> <span class="done DONE">DONE</span> 'unassign' doesn't take a keylist, only a single key</h3>
<div class="outline-text-3" id="text-7-3">
<p>
Should change to match <code>assign</code> and <code>lookup</code>, accept a list instead of
a single bare word.
</p>
</div>
</div>
<div id="outline-container-orged84c58" class="outline-3">
<h3 id="orged84c58"><span class="section-number-3">7.4.</span> <span class="done DONE">DONE</span> More support for nested/related envs</h3>
<div class="outline-text-3" id="text-7-4">
<p>
Debuggers, spawning, ingesting etc
</p>
</div>
</div>
<div id="outline-container-org76b0d38" class="outline-3">
<h3 id="org76b0d38"><span class="section-number-3">7.5.</span> <span class="todo TODO">TODO</span> Graphical environment browser/editor</h3>
<div class="outline-text-3" id="text-7-5">
<p>
It would be nice to have a graphical display of all the environments
in an application, and be able to 
</p>
<ul class="org-ul">
<li>Drill into the environment and read the stack/expression/dictionary</li>
<li>Pause/resume execution</li>
<li>Apply debugging (breakpoint, step etc)</li>
<li>View pipes and what/where they connect to (draw lines if they
connect somewhere else in the app)</li>
<li>Manually put things into pipes or take them out</li>
<li>Create new envs</li>
<li>Persist changes</li>
<li>Revert changes</li>
</ul>
</div>
</div>
<div id="outline-container-org9453617" class="outline-3">
<h3 id="org9453617"><span class="section-number-3">7.6.</span> <span class="todo TODO">TODO</span> Code distribution method</h3>
<div class="outline-text-3" id="text-7-6">
<p>
Let's say we write an app or library, how do we distribute it?
</p>

<p>
This ties in with durability - where do we store things in general,
and not just libraries? kcats does support the filesystem but I would
like that to be for compatibility only. The "native" kcats way of
storing and retrieving things should be via hash keys. There may also
be a fact database, probably with sparse tables (aka eavt format).
</p>

<p>
It brings up the question of what should "come with" the language. I
am thinking maybe there's a "barebones" version of the language with
no library management or anything. Then on top of that, build some
durability and networking to distribute code and other data. Then the
question is, what do we need to support in the base language? Seems
like there needs to be database/network functionality there, but
unused? Maybe make it a feature flag?
</p>

<p>
Let's explore the various options
</p>
</div>
<div id="outline-container-org721fcf7" class="outline-4">
<h4 id="org721fcf7"><span class="section-number-4">7.6.1.</span> Durability</h4>
<div class="outline-text-4" id="text-7-6-1">
<p>
It's tempting to want the flexibility of EAV (where there's basically
just one big db table with 3 columns and every attribute is a row).
</p>

<p>
However this may be a little hasty. Perhaps what we're really after
here is custom tables - the idea being that each user's db schema
might be different depending on what data is important to them.
</p>

<p>
We've basically got a database schema consensus problem. Maybe Alice
has a table CATS with columns SIZE COLOR AGE and Bob has a table CATS
with columns HEIGHT COAT-COLOR AGE. How do they share data? The two
tables are not really compatible without a specialized conversion tool
and even then some data would be missing. So Alice and Bob ideally
should agree on what a CATS schema is, otherwise they can't really
share CAT facts. The advantage of EAV might be that even if they had
different schemas they could stlil perhaps meaningfully talk about AGE
and possibly even COLOR (with a bit of intervention, or even another
fact that equates COLOR and COAT-COLOR in CATS).
</p>

<p>
The drawback of EAV is of course that it would perform rather terribly
as the database grows. I can't say for sure how many facts could
potentially be stored here, but here are some constraints:
</p>

<ul class="org-ul">
<li>Assume individual data only (no facebooks that store millions of
people's data)</li>
<li>Assume popularity of the app (users may try to cram every fact they
"know" into this db)</li>
<li><p>
Assume there's some kind of garbage collection - Alice may collect
weather observations or predictions constantly but doesn't need to
keep old data. Maybe facts have a TTL? Not sure how that could be
determined automatically.
</p>

<p>
It's hard to estimate how large the db might get, but I suspect a
 lower bound of supporting 1M entries is safe. As for upper bound,
 it's more difficult to say, but I would think the hardware limits of
 mobile devices would come into play. As of 2023 I think a db size on
 the order of 10gb would be approaching the device's capability
 limits, so maybe 100M entries or so. I think it would be difficult
 to get an EAV database to perform well at that size, especially on
 mobile. Note datomic can handle that size so it's theoretically
 within reach.
</p>

<p>
It may be possible to pick a standard db now (sqlite maybe) and not
worry too much about performance. As long as the facts are portable
to another db (which shouldn't be that hard), the issue can be
revisited when it becomes an issue.
</p>

<p>
Even using sqlite though, just building proper queries may be
difficult. It may be possible to skirt that problem too and just do
a minimal query to get a dataset that fits easily in memory and then
post-process the rest. Let's say the query is "List all predictors
(people who made predictions) and their accuracy", you could get all
the unique predictor ids in a query, then one by one get all their
predictions, then get all the relevant observations and compare
them. Slow but not the type of query that will be done often, and
possibly indexable.
</p></li>
</ul>
</div>
<div id="outline-container-orgf6acc97" class="outline-5">
<h5 id="orgf6acc97"><span class="section-number-5">7.6.1.1.</span> Possible dynamic sql db</h5>
<div class="outline-text-5" id="text-7-6-1-1">
<p>
One possible design is to just use plain old sql (sqlite?) and create
normal tables. However the table names would be namespaced, possibly
with some sort of hash. That way, one person's "Customer" schema could
be in the same database as another person's without interfering.
</p>

<p>
So for example, the kcats language might need to keep track of library
dependencies. There could be a table <code>dependencies-01234abcd</code> with
columns <code>name</code>, <code>version</code>, <code>hash</code>, <code>blob</code> etc. Anything else wanting to use the
same schema could refer to it by hash. It would be possible to have
foriegn keys too.
</p>

<p>
One thing we want to avoid is having kcats users writing sql query
strings, that is not the idiomatic way of dealing with i/o. What
should happen is there's a <code>query</code> word that takes a program and db
descriptor of where the db is, and returns a pipe (where results come
out). The program is a "query equivalent" and would need to be
translated to sql and post-processed. This is very much nontrivial and
a naive implementation probably wouldn't perform well but we will try
it anyway. For example instead of writing
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> Customers (<span class="org-keyword">name</span>, age) <span class="org-keyword">values</span> ("Bob", 25); 
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> Customers <span class="org-keyword">where</span> <span class="org-keyword">name</span>="Bob";
</pre>
</div>

<p>
you'd write something like
</p>
<div class="org-src-container">
<pre class="src src-kcats">customers <span class="org-kcats-brackets">[[</span>name <span class="org-string">"Bob"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>age 25<span class="org-kcats-brackets">]]</span> <span class="org-function-name">put</span>

customers <span class="org-kcats-brackets">[[</span>name<span class="org-kcats-brackets">]</span> lookup <span class="org-string">"Bob"</span> =<span class="org-kcats-brackets">]</span> <span class="org-function-name">filter</span>
</pre>
</div>

<p>
and 
And then the translation would see we're selecting from customers,
then there's a filter. The filter might not translate to sql so it
will either just select all, or if it sees a certain format for the
predicate it can translate to a <code>where</code> clause. This is going to be
complex and bug prone but hopefully can be done in a way that the
worst case is poor performance and then iterate to get better
speed.
</p>


<p>
I suppose content distribution might need to be done
alongside this.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org04558e2" class="outline-3">
<h3 id="org04558e2"><span class="section-number-3">7.7.</span> <span class="done DONE">DONE</span> Clean up all the vector conversion</h3>
<div class="outline-text-3" id="text-7-7">
<p>
I've been calling <code>vec</code> a lot, sometimes just so the list will print
out with square braces. I now have a <code>repr</code> function that could do
this, so using <code>vec</code> for that purpose is no longer needed.
</p>

<p>
However, I can't get rid of all of them- for example, calling <code>conj</code>
on a vector vs list adds at different ends of the list so they are not
interchangeable in that respect. It may be dangerous to leave any
lists lying around if they might get conjed onto expecting it to go on
the end.
</p>
</div>
</div>
<div id="outline-container-org15c119f" class="outline-3">
<h3 id="org15c119f"><span class="section-number-3">7.8.</span> <span class="done DONE">DONE</span> org-babel-execute for kcats</h3>
</div>
<div id="outline-container-orgbae1623" class="outline-3">
<h3 id="orgbae1623"><span class="section-number-3">7.9.</span> <span class="todo INPROGRESS">INPROGRESS</span> At least one example for each word in lexicon</h3>
<div class="outline-text-3" id="text-7-9">
<div class="org-src-container">
<pre class="src src-kcats">10 0.5 *
</pre>
</div>

<pre class="example">
5
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-string">"foo"</span> bytes
</pre>
</div>

<pre class="example">
#b64 "Zm9v"
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>a b<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>c <span class="org-kcats-brackets">[[</span>d e<span class="org-kcats-brackets">]]]]</span> <span class="org-kcats-brackets">[</span>c d<span class="org-kcats-brackets">]</span> 5 assign
</pre>
</div>

<pre class="example">
[[c [[d 5]]] [a b]]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>a b<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>c <span class="org-kcats-brackets">[]]]</span> <span class="org-kcats-brackets">[</span>c<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[[</span>d 5<span class="org-kcats-brackets">]]</span> association assign
</pre>
</div>

<pre class="example">
[[c [[d 5]]] [a b]]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>a b<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>c <span class="org-kcats-brackets">[[</span>d e<span class="org-kcats-brackets">]]]]</span> <span class="org-kcats-brackets">[</span>1 1 0 1<span class="org-kcats-brackets">]</span> 5 assign
</pre>
</div>

<pre class="example">
[[a b] [c [[d 5]]]]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>a b<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>c <span class="org-kcats-brackets">[[</span>d e<span class="org-kcats-brackets">]]]]</span> <span class="org-kcats-brackets">[</span>1 0<span class="org-kcats-brackets">]</span> 5 assign
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">4 3 <span class="org-kcats-brackets">[</span>&gt;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">sink</span> <span class="org-preprocessor">branch</span> 
</pre>
</div>

<pre class="example">
4
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-keyword">true</span> 4 2  <span class="org-preprocessor">branch</span>
</pre>
</div>

<pre class="example">
[[asked [program]] [reason "type mismatch"] [type error] [unwound [branch]]] 2 4 true
</pre>


<div class="org-src-container">
<pre class="src src-kcats">5
<span class="org-kcats-brackets">[</span>1 2 <span class="org-string">"oh fudge"</span><span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[</span>+<span class="org-kcats-brackets">]</span>
 <span class="org-kcats-brackets">[]</span>
 recover<span class="org-kcats-brackets">]</span>
<span class="org-function-name">map</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>type error<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>reason <span class="org-string">"word is not defined"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>handle<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[]]]</span> <span class="org-kcats-brackets">[[</span>unwound <span class="org-kcats-brackets">[]]</span> <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>handle<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>reason <span class="org-string">"word is not defined"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[[</span>asked <span class="org-kcats-brackets">[</span>number<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>type error<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]]]]</span> 5
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">5 1 <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> recover
</pre>
</div>

<pre class="example">
[[unwound []] [asked [handle]] [reason "word is not defined"] [type error]] 1 5
</pre>


<div class="org-src-container">
<pre class="src src-kcats">1 type
</pre>
</div>

<pre class="example">
number
</pre>


<div class="org-src-container">
<pre class="src src-kcats">5.01 5 0.1 <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>- abs<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> &lt;
</pre>
</div>

<pre class="example">
true
</pre>
</div>
</div>

<div id="outline-container-orgd3ca719" class="outline-3">
<h3 id="orgd3ca719"><span class="section-number-3">7.10.</span> <span class="todo TODO">TODO</span> Prime number sieve example</h3>
<div class="outline-text-3" id="text-7-10">
<div class="org-src-container">
<pre class="src src-kcats">2000 <span class="org-builtin">clone</span> 2 <span class="org-builtin">swap</span> range <span class="org-comment-delimiter">;; </span><span class="org-comment">all the numbers up to n</span>

<span class="org-kcats-brackets">[</span>sqrt 2<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span>  <span class="org-comment-delimiter">;; </span><span class="org-comment">start counter at 2, stop at sqrt of n</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">sink</span> =<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">stop loop when the counter hits sqrt n</span>
<span class="org-kcats-brackets">[[</span><span class="org-builtin">drop</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span>  <span class="org-comment-delimiter">;; </span><span class="org-comment">drop the original args, just leaving the primes</span>
<span class="org-kcats-brackets">[[[[</span>=<span class="org-kcats-brackets">]</span> 
   <span class="org-kcats-brackets">[</span><span class="org-builtin">swap</span> mod positive?<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span> any?<span class="org-kcats-brackets">]</span> 
 <span class="org-function-name">filter</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">keep the counter but no multiples of it </span>
 <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">increment counter</span>
<span class="org-kcats-brackets">[</span><span class="org-preprocessor">execute</span><span class="org-kcats-brackets">]</span>
<span class="org-preprocessor">recur</span>
</pre>
</div>

<pre class="example">
[[asked [consume]] [reason "not enough items on stack"] [type error] [unwound [sqrt 2 [[]] unwrap [sink =] [[drop drop] dip] [[[[=] [swap mod positive?]] [execute] any?] filter [inc] dip] [execute] recur]] [handled true]]
</pre>


<p>
Here's a mimic of the python version, WIP:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-comment-delimiter">;; </span><span class="org-comment">num</span>
10
<span class="org-kcats-brackets">[[[]</span> <span class="org-kcats-brackets">[</span><span class="org-keyword">true</span> <span class="org-function-name">put</span><span class="org-kcats-brackets">]]</span> <span class="org-preprocessor">dip</span> <span class="org-preprocessor">times</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-comment-delimiter">; </span><span class="org-comment">a n</span>
2 <span class="org-comment-delimiter">;; </span><span class="org-comment">p a n</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">swapdown</span> <span class="org-builtin">clone</span> * &gt; <span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">while test</span>
<span class="org-kcats-brackets">[[</span><span class="org-function-name">wrap</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">; </span><span class="org-comment">if test - fetch by index</span>
 <span class="org-kcats-brackets">[</span>
 <span class="org-builtin">swapdown</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">p n a</span>
 <span class="org-builtin">clone</span> <span class="org-comment-delimiter">; </span><span class="org-comment">p</span>
 <span class="org-builtin">clone</span> * <span class="org-comment-delimiter">; </span><span class="org-comment">p^2 p n a</span>
 <span class="org-comment-delimiter">;; </span><span class="org-comment">range wants p, n+1, p^2 </span>
 <span class="org-builtin">sink</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">p n p^2</span>
 <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">p n+1 p^2</span>
 <span class="org-kcats-brackets">[</span>range<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">r p n+1 p^2 a</span>
 <span class="org-kcats-brackets">[</span>dec <span class="org-builtin">sink</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dipdown</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">r p a n</span>
 <span class="org-builtin">swapdown</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">r a p</span>
 <span class="org-kcats-brackets">[</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">i r a p</span>
  <span class="org-function-name">wrap</span> <span class="org-comment-delimiter">;;</span><span class="org-comment">swapdown ;; [i] a r p</span>
  <span class="org-kcats-brackets">[[]]</span> update <span class="org-comment-delimiter">;; </span><span class="org-comment">set to false: a r p</span>
  <span class="org-builtin">swap</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">r a p</span>
 <span class="org-kcats-brackets">]</span>
 <span class="org-function-name">step</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">a p</span>
 <span class="org-builtin">swap</span> 
 <span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">; </span><span class="org-comment">do the for loop</span>
 <span class="org-kcats-brackets">[]</span> <span class="org-comment-delimiter">; </span><span class="org-comment">else do nothing</span>
 <span class="org-preprocessor">if</span>
 inc <span class="org-comment-delimiter">;; </span><span class="org-comment">p++</span>
<span class="org-kcats-brackets">]</span>
<span class="org-preprocessor">while</span> 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[</span>type error<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>asked <span class="org-kcats-brackets">[</span>association<span class="org-kcats-brackets">]]</span> <span class="org-kcats-brackets">[</span>reason <span class="org-string">"type mismatch"</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>unwound <span class="org-kcats-brackets">[</span>update <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>8 10<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[[]]</span> update <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span> <span class="org-builtin">swap</span> inc <span class="org-kcats-brackets">[</span><span class="org-builtin">swapdown</span> <span class="org-builtin">clone</span> * &gt;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[[</span><span class="org-function-name">wrap</span> lookup<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">swapdown</span> <span class="org-builtin">clone</span> <span class="org-builtin">clone</span> * <span class="org-builtin">sink</span> <span class="org-kcats-brackets">[</span>inc<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-kcats-brackets">[</span>range<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-kcats-brackets">[</span>dec <span class="org-builtin">sink</span> <span class="org-builtin">drop</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dipdown</span> <span class="org-builtin">swapdown</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[[]]</span> update <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">step</span> <span class="org-builtin">swap</span><span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[]</span> <span class="org-preprocessor">if</span> inc <span class="org-kcats-brackets">[</span><span class="org-builtin">swapdown</span> <span class="org-builtin">clone</span> * &gt;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">loop</span><span class="org-kcats-brackets">]]]</span> <span class="org-kcats-brackets">[[]]</span> <span class="org-kcats-brackets">[</span>6<span class="org-kcats-brackets">]</span> 2 <span class="org-kcats-brackets">[</span><span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-kcats-brackets">[]</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span><span class="org-kcats-brackets">]</span> 10
</pre>
</div>

<p>
impl of 'repeat'
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-keyword">true</span> 10 <span class="org-kcats-brackets">[]</span> <span class="org-builtin">sink</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-preprocessor">times</span>
</pre>
</div>

<pre class="example">
[true true true true true true true true true true]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-keyword">true</span> 10 <span class="org-kcats-brackets">[]</span> <span class="org-builtin">sink</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-function-name">put</span><span class="org-kcats-brackets">]</span> <span class="org-function-name">join</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-preprocessor">times</span>
</pre>
</div>

<pre class="example">
[true true true true true true true true true true]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[]</span> <span class="org-kcats-brackets">[[</span><span class="org-keyword">true</span><span class="org-kcats-brackets">]</span> 15 <span class="org-preprocessor">times</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">inject</span>
2 <span class="org-builtin">swap</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">p a</span>
<span class="org-kcats-brackets">[</span><span class="org-builtin">clone</span> <span class="org-builtin">clone</span> *<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">p^2 a p</span>
<span class="org-kcats-brackets">[[[</span><span class="org-function-name">count</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span><span class="org-kcats-brackets">]</span> <span class="org-preprocessor">dip</span> <span class="org-builtin">swap</span> <span class="org-kcats-brackets">[</span>&lt;<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">b p^2 a p  </span>
<span class="org-kcats-brackets">[[</span><span class="org-function-name">wrap</span> <span class="org-kcats-brackets">[</span><span class="org-builtin">drop</span> <span class="org-kcats-brackets">[]]</span> update<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shield</span> <span class="org-comment-delimiter">;; </span><span class="org-comment">do the update </span>
 <span class="org-builtin">float</span> <span class="org-builtin">drop</span> <span class="org-builtin">sink</span> <span class="org-kcats-brackets">[</span>+<span class="org-kcats-brackets">]</span> <span class="org-preprocessor">shielddown</span> <span class="org-builtin">swapdown</span><span class="org-kcats-brackets">]</span> <span class="org-comment-delimiter">;; </span>
<span class="org-comment-delimiter">;</span><span class="org-comment">while</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span class="org-keyword">true</span> 4 <span class="org-kcats-brackets">[</span><span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span> <span class="org-keyword">true</span><span class="org-kcats-brackets">]</span> 2
</pre>
</div>

<p>
How do we write this code? Generally, how do we decide what order things go on the stack?
</p>

<p>
It looks like the array of bools is the main piece of data here, that
is used throughout the algorithm. The other commonly used variable is
p, the one that's incremented. I think probably p should remain on
top. The outermost loop needs to know when to stop, and that needs to
compare to num. That can go on the bottom.
</p>

<p>
The inner loop uses i. That should probably replace p on top when in use.
So it should be <code>[p a]</code> and later <code>[i a p]</code>.
</p>

<p>
Now that <code>lingo</code> exists, maybe should also write <code>let</code> for variables
(where the values are evaluated before updating the dictionary)?  Also
these aren't actually "variables" because you can't change the value,
without an inner <code>let</code>.
</p>

<p>
Actually this is probably best implemented in two parts:
</p>
<ul class="org-ul">
<li>a word that takes a set of bindings and evaluates the values,
leaving a map of word to value</li>
<li>a word that takes the map above and inserts it into the
dictionary. I think <code>lingo</code> does this already.</li>
</ul>

<p>
let's try to write the former here. I think we need <code>map-values</code> type of
thing here, which requires treating a map as a list.
</p>

<div class="org-src-container">
<pre class="src src-kcats">
</pre>
</div>
<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[[[</span>a <span class="org-kcats-brackets">[</span>+ 5 6<span class="org-kcats-brackets">]]</span>
  <span class="org-kcats-brackets">[</span>b <span class="org-kcats-brackets">[</span>- 100 8<span class="org-kcats-brackets">]]]</span>
 <span class="org-kcats-brackets">[</span>a b +<span class="org-kcats-brackets">]</span>
 let<span class="org-kcats-brackets">]</span> 

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org36b5266" class="outline-2">
<h2 id="org36b5266"><span class="section-number-2">8.</span> Roadmap Notes</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-org0fde90c" class="outline-3">
<h3 id="org0fde90c"><span class="section-number-3">8.1.</span> Higher level persistence abstraction</h3>
<div class="outline-text-3" id="text-8-1">
<p>
I wonder whether kcats should have any notion of files and sockets at
all. Sort of like java doesn't have any notion of memory addresses or
malloc/free - it operates at a higher level and handles mem management
for you. Maybe kcats handles persistence for you. This may be a sort
of chicken/egg problem where I need a network protocol to help w
persistence and I want that protocol to include kcats as a
language. Can they be bootstrapped as a single unit? Seems possible
but not easy. Persistence might involve having another party store
data for you, which might involve identity (to limit access) and money
(to incentivize someone to keep your data for later). That might be a
bit of a reach for a programming standard lib to handle.
</p>

<p>
And then there's the question of interop with other programs, how
would they communicate if kcats doesn't know what a file or socket is?
Maybe it can know what a file/socket is but you don't need to use it
except as interop (like clojure's java interop or java's jni).
</p>

<p>
So what would this look like?
</p>

<p>
Instead of telling the program <b>where</b> to persist, you just want it
persisted and you get a sort of claim check (maybe the hash of the
data?). Then to get it back later, you present the claim
check. Persistence is a best-effort deal (you can't be 100% sure no
disaster could wipe it out). So maybe also include some optional
params to indicate:
</p>

<ul class="org-ul">
<li>how long until you might need this again</li>
<li>how long you can wait between requesting it and getting it</li>
<li>how disaster-proof it needs to be</li>
<li>how much you're willing to pay to store it</li>
</ul>

<p>
Maybe we can even put messaging under this model - after all, sending
someone a message is in fact making a copy of data you have. You don't
necessarily want to retrieve it later though.
</p>

<p>
Computing might be better thought of as a worldwide resource - you
might not be able to trust someone else to do a computation for you
(yet, unless it's a specific type where you can verify without doing
the full computation yourself) but you can trust them with storage
(given enough redundancy - they can't steal your data because it's
encrypted).
</p>
</div>
</div>
<div id="outline-container-org0cfd9f8" class="outline-3">
<h3 id="org0cfd9f8"><span class="section-number-3">8.2.</span> DHT of hash:content</h3>
<div class="outline-text-3" id="text-8-2">
<p>
This can be distributed storage of names and what they point to.
</p>

<p>
Let's say you have a file, "my-book-report", and later you want to be
able to retrieve it using that name. You hash the file, and
separately, the name (possibly after encrypting them to yourself), and
call the DHT store function on H(name), H(file). Later when you need
to get the file, you hash the name again and call DHT get on
H(name). You get the hash back which you can use to get the content
(from a separate system - either a local hash-based filesystem or
bittorrent-like sharing system, or ipfs)
</p>

<p>
This could also be used to map names to anything else - people,
machines, code libraries etc.
</p>
</div>
</div>
<div id="outline-container-orgd0f2f31" class="outline-3">
<h3 id="orgd0f2f31"><span class="section-number-3">8.3.</span> File distribution</h3>
</div>

<div id="outline-container-orge16b163" class="outline-3">
<h3 id="orge16b163"><span class="section-number-3">8.4.</span> Object construction, caching</h3>
<div class="outline-text-3" id="text-8-4">
<p>
Often we create objects similar to java construction, where the input
and output are informationally equivalent (you can reconstruct the
output from the input anytime you want, and sometimes vice versa).
</p>

<p>
It might be nice if kcats didn't force you as a user to do this type
of operation and just let you use the original data.
</p>

<p>
For example, lets say you have <code>[[file "/tmp/foo"]]</code>. That's an
association of <code>file</code> (a type) to a string. Really what that means is
we're referring to a file on disk. In java we'd construct a <code>File</code>
object with <code>new File("/tmp/foo")</code>. It'd be nice if everywhere in
kcats you never needed a <code>File</code> object and could use the original
descriptor instead (or a pipe you've already created, if state
matters). On the jvm platform obviously somewhere a <code>File</code> object
would get created but that should be hidden from view. How would that
work?
</p>

<p>
I thought of a word like <code>derive</code> that caches these things? Maybe it
would keep a cache of previously derived things and just return the
answer if asked again (like memoized function in clojure and could
even be implemented that way). It would also have a mapping of <b>how</b>
to derive one thing from another. eg <code>[[file "foo"]]</code> and create a
pipe-in to write to it. You'd first need an inputstream to the file
(as inputstream is what the pipe protocol is actually using).
</p>

<p>
The thing is, inputstreams are not values. They're stateful, pointers
to places on disk. So we probably can't cache them nor need to.
</p>

<p>
<code>derive</code> would be more for things like crypto keys created from a
seed.
</p>

<p>
For pipes, we need to go from a descriptor, to some platform specific
object, to a pipe. How do we keep platform specific code isolated? I'm
hesitant to make public abstractions for anything but pipes. I don't
want a <code>file</code> word that creates file objects from descriptors, kcats
users should never see that. The only solution I can think of is to
just leave the platform-specific code where it is, and have some kind
of switching mechanism like clj/cljs has.
</p>
</div>


<div id="outline-container-org6c4abd6" class="outline-4">
<h4 id="org6c4abd6"><span class="section-number-4">8.4.1.</span> Platform specific definitions</h4>
<div class="outline-text-4" id="text-8-4-1">
<p>
It's not good to have platform-specific code in the lexicon. That's
supposed to be a standard library, pure kcats and loaded without issue
no matter which platform.
</p>

<p>
However, it's also nice to have platform interop so we can leverage
the platform. The question is, how do we isolate the interop stuff?
</p>

<p>
It seems clear that it would be useful to have kcats words to deal
with platform-specific objects. For example, jvm's streams, files,
sockets etc. Bytes often come from these sources but kcats doesn't
deal with them officially, it only uses pipes. But we have to create a
pipe from these things.
</p>
</div>
</div>
</div>
<div id="outline-container-org0fbebc1" class="outline-3">
<h3 id="org0fbebc1"><span class="section-number-3">8.5.</span> Adjectives and other parts of speech</h3>
<div class="outline-text-3" id="text-8-5">
<p>
It might be nice to make kcats read more like english. 
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span class="org-kcats-brackets">[</span>room little green paint<span class="org-kcats-brackets">]</span>
<span class="org-kcats-brackets">[[[</span>type room<span class="org-kcats-brackets">]]]</span> | little green paint
<span class="org-kcats-brackets">[[[</span>type room<span class="org-kcats-brackets">]</span> <span class="org-kcats-brackets">[</span>size little<span class="org-kcats-brackets">]]]</span> | green paint

</pre>
</div>
</div>
</div>
<div id="outline-container-orgc904dcc" class="outline-3">
<h3 id="orgc904dcc"><span class="section-number-3">8.6.</span> Contextual words</h3>
<div class="outline-text-3" id="text-8-6">
<p>
It might be nice to have certain words defined only in
context. However it could be argued that the stack <b>is</b> the
context. Can we put more words on the stack? Seems plausible - put a
dictionary on the stack and step thru execution of a program just as
if it was a nested env, merging the new dictionary into the original.
</p>

<p>
But i'm not sure this is a good idea. We already have
multimethod-based words. What added value would contextual words give?
</p>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Inspired by Alan Kay's quote "Lisp isn't a language, it's a
building material".
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
Everything that makes sense to be a value. References to
real-world resources (like files on a particular disk or network
connections to a particular destination, etc) are not portable. 
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: Skyrod Vactai</p>
<p class="date">Created: 2023-08-07 Mon 18:57</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>