<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-08-06 Sun 19:39 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The kcats Programming Language (Production Implementation)</title>
<meta name="author" content="Skyrod Vactai" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>
<style> pre.src { background: black; color: white; } #content { max-width: 1000px } </style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>
<link rel="stylesheet" type="text/css" href="styles.css"/>
<style type="text/css">
.org-src-container.results > pre {
margin: 1px 0 0 2em;
}
.org-src-container > pre {
margin: 1px 0 0 2em;
}
.org-src-container.results::before {
content: "Result:";
display: inline-block;
font-size: 0.55em;
margin: 0 0 0 3em;
padding: 0;
}
p {
margin: 12px 0 12px 0;
}
</style>
</head>
<body>
<div id="content" class="content">
<h1 class="title">The kcats Programming Language (Production Implementation)</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgf15ea77">1. Production implementation</a>
<ul>
<li><a href="#org5036cc7">1.1. Base Language</a></li>
<li><a href="#org2574de3">1.2. Status</a></li>
<li><a href="#org2ccda97">1.3. Using</a>
<ul>
<li><a href="#org56da7dc">1.3.1. Dependencies</a></li>
<li><a href="#org41de62f">1.3.2. Build</a></li>
<li><a href="#org594203e">1.3.3. Run</a></li>
<li><a href="#orgb29c1af">1.3.4. Emacs REPL</a></li>
</ul>
</li>
<li><a href="#orga89a834">1.4. Source</a>
<ul>
<li><a href="#org963286a">1.4.1. Project File</a></li>
<li><a href="#org055c270">1.4.2. Internal data types</a>
<ul>
<li><a href="#orged5d22f">1.4.2.1. Basic internal types</a></li>
<li><a href="#org0854958">1.4.2.2. Collection types</a></li>
<li><a href="#orge071d3f">1.4.2.3. Associative types</a></li>
<li><a href="#org21527e6">1.4.2.4. Error types</a></li>
<li><a href="#orgc614200">1.4.2.5. Dictionary types</a></li>
<li><a href="#org0398d97">1.4.2.6. Environment types</a></li>
<li><a href="#orgcc05310">1.4.2.7. Cryptographic primitives</a></li>
</ul>
</li>
<li><a href="#org1b0e4df">1.4.3. Serialization</a></li>
<li><a href="#org8acf252">1.4.4. Builtin words</a></li>
<li><a href="#orgecaf640">1.4.5. Top level execution</a></li>
<li><a href="#org5e8b907">1.4.6. Pipes (input/output)</a></li>
</ul>
</li>
<li><a href="#org8c0a655">1.5. Issues</a>
<ul>
<li><a href="#orgc1ce6e0">1.5.1. <span class="todo INPROGRESS">INPROGRESS</span> Interactive mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="tools">tools</span></span></a>
<ul>
<li><a href="#org37aaf84">1.5.1.1. <span class="todo TODO">TODO</span> Only print the changed part of the stack</a></li>
<li><a href="#orga8d20b2">1.5.1.2. <span class="todo TODO">TODO</span> Emacs keybindings to send common stack ops</a></li>
</ul>
</li>
<li><a href="#org6f6e1a3">1.5.2. <span class="done DONE">DONE</span> Install the lexicon in the proper place</a></li>
<li><a href="#orgf84da9a">1.5.3. <span class="done CANCELED">CANCELED</span> Add option to read an alternative lexicon file</a></li>
<li><a href="#orgf40d4c5">1.5.4. <span class="todo TODO">TODO</span> Package the binary for various platforms</a></li>
<li><a href="#org6a5d56d">1.5.5. <span class="done DONE">DONE</span> Optimize memory allocation</a>
<ul>
<li><a href="#orgda255b5">1.5.5.1. <span class="done DONE">DONE</span> Lists</a></li>
</ul>
</li>
<li><a href="#org21de4b8">1.5.6. <span class="done DONE">DONE</span> pack and unpack are not inverse</a></li>
<li><a href="#org7af50ee">1.5.7. <span class="done DONE">DONE</span> true and false are not words?</a></li>
<li><a href="#orgeeb7475">1.5.8. <span class="done DONE">DONE</span> Division by zero panics</a></li>
<li><a href="#orgb4b5614">1.5.9. <span class="todo INPROGRESS">INPROGRESS</span> Implement pipes&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></a>
<ul>
<li><a href="#orgd157840">1.5.9.1. <span class="done DONE">DONE</span> Write to a file</a></li>
<li><a href="#org25c80e7">1.5.9.2. <span class="done DONE">DONE</span> Read from a file</a></li>
<li><a href="#orga070eff">1.5.9.3. <span class="done DONE">DONE</span> Close a pipe</a></li>
<li><a href="#org32ed505">1.5.9.4. <span class="done DONE">DONE</span> Serialize pipes with something sane</a></li>
<li><a href="#orga082c59">1.5.9.5. <span class="done DONE">DONE</span> Sockets</a></li>
<li><a href="#orgb3934c9">1.5.9.6. <span class="done DONE">DONE</span> Convert In/Out traits to enums in pipes modules</a></li>
<li><a href="#orgdb5a1cd">1.5.9.7. <span class="todo TODO">TODO</span> Composable transforms</a></li>
<li><a href="#org40c9f9c">1.5.9.8. <span class="done CANCELED">CANCELED</span> Filled pipes</a></li>
<li><a href="#orgea088ae">1.5.9.9. <span class="todo TODO">TODO</span> Object pipes</a></li>
<li><a href="#org9f54c39">1.5.9.10. <span class="done DONE">DONE</span> Time pipe</a></li>
<li><a href="#org4aee8ec">1.5.9.11. <span class="done DONE">DONE</span> stdin/stdout pipes</a></li>
<li><a href="#org1e9225e">1.5.9.12. <span class="todo TODO">TODO</span> Pipe take outcome</a></li>
</ul>
</li>
<li><a href="#org0f61e94">1.5.10. <span class="done DONE">DONE</span> 'Fail' is not defined</a></li>
<li><a href="#org9a91eab">1.5.11. <span class="done DONE">DONE</span> 'dictionary' doesn't allow access to the data inside definitions</a></li>
<li><a href="#org6d308df">1.5.12. <span class="todo INPROGRESS">INPROGRESS</span> Use a single word for all derivation/conversion&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></a></li>
<li><a href="#org2ac7ee7">1.5.13. <span class="done DONE">DONE</span> Change boolean operators to retain values</a></li>
<li><a href="#org54c46b5">1.5.14. <span class="done DONE">DONE</span> 'recover' is broken</a></li>
<li><a href="#org4c3a32b">1.5.15. <span class="done DONE">DONE</span> Fix handle in nested env</a></li>
<li><a href="#org1b5eca4">1.5.16. <span class="done DONE">DONE</span> Lots of association-like objects that aren't</a></li>
<li><a href="#orgc33ce18">1.5.17. <span class="done DONE">DONE</span> scoping of dictionary entries</a>
<ul>
<li><a href="#org5e6e369">1.5.17.1. What to call this word</a></li>
<li><a href="#org31cc55d">1.5.17.2. Implementation</a></li>
</ul>
</li>
<li><a href="#orgb51c839">1.5.18. <span class="done DONE">DONE</span> Move environment stuff into own module</a></li>
<li><a href="#org537110f">1.5.19. <span class="done DONE">DONE</span> When printing results, don't wrap the stack</a></li>
<li><a href="#org438184f">1.5.20. <span class="done DONE">DONE</span> Update pipes to use enums instead of traits</a></li>
<li><a href="#org0fa0a69">1.5.21. <span class="done CANCELED">CANCELED</span> Recover clears the stack built up in the try program</a></li>
<li><a href="#org55af8fb">1.5.22. <span class="done DONE">DONE</span> List access and update by index</a></li>
<li><a href="#org18bdc0a">1.5.23. <span class="done DONE">DONE</span> write 'let'</a></li>
<li><a href="#org6098803">1.5.24. <span class="todo TODO">TODO</span> Error should have actual struct fields&#xa0;&#xa0;&#xa0;<span class="tag"><span class="optimization">optimization</span></span></a></li>
<li><a href="#org2871994">1.5.25. <span class="todo TODO">TODO</span> Script</a>
<ul>
<li><a href="#orgcb1574e">1.5.25.1. <span class="done DONE">DONE</span> Cryptographic primitives</a></li>
<li><a href="#org7511af6">1.5.25.2. <span class="done DONE">DONE</span> Pure functional env</a></li>
<li><a href="#org27a53f1">1.5.25.3. <span class="todo TODO">TODO</span> Infinite loop protection</a></li>
</ul>
</li>
<li><a href="#org151259c">1.5.26. <span class="done DONE">DONE</span> Multithreading</a>
<ul>
<li><a href="#org968a19a">1.5.26.1. Overview</a></li>
<li><a href="#orgccb98d6">1.5.26.2. Pipes</a></li>
<li><a href="#orgd06ad28">1.5.26.3. <span class="done DONE">DONE</span> Add tokio as dep</a></li>
<li><a href="#orgb07853d">1.5.26.4. <span class="done DONE">DONE</span> Prepare for multithreading</a></li>
<li><a href="#org4c15c21">1.5.26.5. <span class="done DONE">DONE</span> Update pipe types for fs and net to use tokio calls</a></li>
<li><a href="#orgd47caf4">1.5.26.6. <span class="done DONE">DONE</span> Use channel type to implement handoff pipe</a></li>
<li><a href="#org6d65253">1.5.26.7. <span class="done DONE">DONE</span> Implement 'spawn' or equavalent</a></li>
<li><a href="#orged1c5b4">1.5.26.8. <span class="done DONE">DONE</span> Implement 'future' or equivalent</a></li>
</ul>
</li>
<li><a href="#org8069032">1.5.27. <span class="todo TODO">TODO</span> retry should have opposite argument order&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span>&#xa0;<span class="consistency">consistency</span></span></a></li>
<li><a href="#orgc4603a5">1.5.28. <span class="todo INPROGRESS">INPROGRESS</span> Support Kademlia DHT</a>
<ul>
<li><a href="#orgeb3a22e">1.5.28.1. <span class="done DONE">DONE</span> XOR</a></li>
<li><a href="#org38a8780">1.5.28.2. <span class="todo INPROGRESS">INPROGRESS</span> Simple API server</a></li>
<li><a href="#org8a94ca8">1.5.28.3. <span class="todo TODO">TODO</span> Kademlia functions</a></li>
</ul>
</li>
<li><a href="#orgeef602f">1.5.29. <span class="done DONE">DONE</span> Implement print (opposite of read)</a></li>
<li><a href="#org8037a62">1.5.30. <span class="todo TODO">TODO</span> read and emit don't have quite the same semantics&#xa0;&#xa0;&#xa0;<span class="tag"><span class="consistency">consistency</span></span></a></li>
<li><a href="#orgef0e5ac">1.5.31. <span class="todo TODO">TODO</span> Inconsistent stack handling when encountering error&#xa0;&#xa0;&#xa0;<span class="tag"><span class="consistency">consistency</span></span></a>
<ul>
<li><a href="#orgd3c045c">1.5.31.1. <span class="todo TODO">TODO</span> 'read' on invalid edn consumes the string argument</a></li>
<li><a href="#org5653171">1.5.31.2. <span class="todo TODO">TODO</span> Division by zero consumes stack items</a></li>
</ul>
</li>
<li><a href="#org08c98a9">1.5.32. <span class="done DONE">DONE</span> logical enum hierarchy</a>
<ul>
<li><a href="#orga303b9f">1.5.32.1. <span class="done DONE">DONE</span> Collection hierarchy</a></li>
<li><a href="#org035e294">1.5.32.2. <span class="done DONE">DONE</span> pipe as list-like thing</a></li>
<li><a href="#org0e5730a">1.5.32.3. <span class="done DONE">DONE</span> Step accepts pipes</a></li>
<li><a href="#orgce8bdc6">1.5.32.4. <span class="done DONE">DONE</span> Set close = discard</a></li>
<li><a href="#orgaa52342">1.5.32.5. <span class="done DONE">DONE</span> Remove closed?</a></li>
<li><a href="#orged81bc0">1.5.32.6. <span class="done DONE">DONE</span> make a polymorphic 'join'</a></li>
<li><a href="#orgd97015f">1.5.32.7. <span class="done DONE">DONE</span> Update spec types to be more abstract</a></li>
</ul>
</li>
<li><a href="#orgd3366e5">1.5.33. <span class="done DONE">DONE</span> Support char type</a></li>
<li><a href="#org3d6f772">1.5.34. <span class="todo TODO">TODO</span> implement sleep&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></a></li>
<li><a href="#org2064453">1.5.35. <span class="done DONE">DONE</span> handoff tests</a></li>
<li><a href="#orge12b87f">1.5.36. <span class="todo TODO">TODO</span> Performance optimizations&#xa0;&#xa0;&#xa0;<span class="tag"><span class="optimization">optimization</span></span></a>
<ul>
<li><a href="#orge511386">1.5.36.1. <span class="todo TODO">TODO</span> Compile programs</a></li>
<li><a href="#orgff58107">1.5.36.2. <span class="todo TODO">TODO</span> Programs as their own immutable type</a></li>
</ul>
</li>
<li><a href="#org68edd2f">1.5.37. <span class="todo TODO">TODO</span> Debugging method for animated envs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="tools">tools</span></span></a></li>
<li><a href="#orgbc93d78">1.5.38. <span class="todo INPROGRESS">INPROGRESS</span> Generators&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></a>
<ul>
<li><a href="#org5ed4b5c">1.5.38.1. <span class="done DONE">DONE</span> Basic functionality and generators</a></li>
<li><a href="#orgf6366f5">1.5.38.2. <span class="done DONE">DONE</span> map</a></li>
<li><a href="#org9bf7203">1.5.38.3. <span class="done DONE">DONE</span> filter</a></li>
<li><a href="#org60bbefe">1.5.38.4. <span class="done DONE">DONE</span> take</a></li>
<li><a href="#orgd75df45">1.5.38.5. <span class="done DONE">DONE</span> drop</a></li>
<li><a href="#org4126d9f">1.5.38.6. <span class="done CANCELED">CANCELED</span> last</a></li>
<li><a href="#orgc9a41e9">1.5.38.7. <span class="todo TODO">TODO</span> distinct</a></li>
<li><a href="#org5edabcd">1.5.38.8. <span class="todo TODO">TODO</span> partition</a></li>
<li><a href="#orge9ae093">1.5.38.9. <span class="done DONE">DONE</span> joiner (aka catenate)</a></li>
<li><a href="#orge8628a4">1.5.38.10. <span class="todo TODO">TODO</span> groupby</a></li>
<li><a href="#org021a8f8">1.5.38.11. <span class="done CANCELED">CANCELED</span> Map/filter can't access lower stack items</a></li>
<li><a href="#orgb117ec7">1.5.38.12. <span class="done DONE">DONE</span> Reduce</a></li>
</ul>
</li>
<li><a href="#org22b6954">1.5.39. <span class="done DONE">DONE</span> Investigate simpler map/filter impls</a></li>
<li><a href="#org0a14aca">1.5.40. <span class="done DONE">DONE</span> Allow generator transforms to work on pipes</a></li>
<li><a href="#orgb134821">1.5.41. <span class="todo INPROGRESS">INPROGRESS</span> Implement hashset&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></a>
<ul>
<li><a href="#org750789c">1.5.41.1. <span class="todo INPROGRESS">INPROGRESS</span> Implement set membership check</a></li>
</ul>
</li>
<li><a href="#orgf21ecae">1.5.42. <span class="done DONE">DONE</span> Implement until</a></li>
<li><a href="#org632ba92">1.5.43. <span class="todo TODO">TODO</span> Implement sorting&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></a>
<ul>
<li><a href="#orgc0a545a">1.5.43.1. <span class="todo TODO">TODO</span> Implement partialord</a></li>
<li><a href="#org4bc3ce9">1.5.43.2. <span class="todo TODO">TODO</span> Make floats hashable</a></li>
<li><a href="#org6e14e70">1.5.43.3. <span class="todo TODO">TODO</span> Implement compare</a></li>
</ul>
</li>
<li><a href="#org5dc79a5">1.5.44. <span class="todo INPROGRESS">INPROGRESS</span> CI on github&#xa0;&#xa0;&#xa0;<span class="tag"><span class="alpha">alpha</span></span></a></li>
<li><a href="#org3db1505">1.5.45. <span class="done DONE">DONE</span> Add a kcats logo to github project page&#xa0;&#xa0;&#xa0;<span class="tag"><span class="alpha">alpha</span></span></a></li>
<li><a href="#org9c54e58">1.5.46. <span class="done DONE">DONE</span> Add a video snippet of repl interaction to github project page&#xa0;&#xa0;&#xa0;<span class="tag"><span class="alpha">alpha</span></span></a></li>
<li><a href="#org815fafc">1.5.47. <span class="todo INPROGRESS">INPROGRESS</span> Write an alpha release announcement&#xa0;&#xa0;&#xa0;<span class="tag"><span class="alpha">alpha</span></span></a></li>
<li><a href="#org29e8cbf">1.5.48. <span class="todo TODO">TODO</span> Post announcement on various forums&#xa0;&#xa0;&#xa0;<span class="tag"><span class="alpha">alpha</span></span></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgf15ea77" class="outline-2">
<h2 id="orgf15ea77"><span class="section-number-2">1.</span> Production implementation</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org5036cc7" class="outline-3">
<h3 id="org5036cc7"><span class="section-number-3">1.1.</span> Base Language</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Built in Rust - it's fast and modern, its memory allocation model
seems well suited to kcats.
</p>
</div>
</div>
<div id="outline-container-org2574de3" class="outline-3">
<h3 id="org2574de3"><span class="section-number-3">1.2.</span> Status</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Unstable
</p>
</div>
</div>
<div id="outline-container-org2ccda97" class="outline-3">
<h3 id="org2ccda97"><span class="section-number-3">1.3.</span> Using</h3>
<div class="outline-text-3" id="text-1-3">
</div>
<div id="outline-container-org56da7dc" class="outline-4">
<h4 id="org56da7dc"><span class="section-number-4">1.3.1.</span> Dependencies</h4>
<div class="outline-text-4" id="text-1-3-1">
<ul class="org-ul">
<li>rustc</li>
<li>cargo</li>
</ul>
</div>
</div>
<div id="outline-container-org41de62f" class="outline-4">
<h4 id="org41de62f"><span class="section-number-4">1.3.2.</span> Build</h4>
<div class="outline-text-4" id="text-1-3-2">
<p>
Run <code>cargo build --release</code>, the binary will be placed in <code>./target/release</code> by
default.
</p>
</div>
</div>
<div id="outline-container-org594203e" class="outline-4">
<h4 id="org594203e"><span class="section-number-4">1.3.3.</span> Run</h4>
<div class="outline-text-4" id="text-1-3-3">
<p>
Execute the binary: <code>./target/release/kcats</code>. It will read a program
from stdin and execute it, then print the resulting stack. (To signal
you're done with input, on most platforms Ctrl-D will do it).
</p>
</div>
</div>
<div id="outline-container-orgb29c1af" class="outline-4">
<h4 id="orgb29c1af"><span class="section-number-4">1.3.4.</span> Emacs REPL</h4>
<div class="outline-text-4" id="text-1-3-4">
<p>
See <a href="book-of-kcats.html#MissingReference">Emacs</a>. The elisp files you need to evaluate are there. Evaluate
them, then run <code>M-x kcats-repl</code>. You may need to run <code>M-x
customize-variable</code>, <code>kcats-babel-executable</code>, and enter the location of
the kcats binary.
</p>
</div>
</div>
</div>
<div id="outline-container-orga89a834" class="outline-3">
<h3 id="orga89a834"><span class="section-number-3">1.4.</span> Source</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-org963286a" class="outline-4">
<h4 id="org963286a"><span class="section-number-4">1.4.1.</span> Project File</h4>
<div class="outline-text-4" id="text-1-4-1">
<div class="org-src-container">
<pre class="src src-toml">[<span style="color: #C2E5C2;">package</span>]
<span style="color: #E5E5A0; font-weight: bold;">name</span> = <span style="color: #DDC29A; font-weight: bold;">"kcats"</span>
<span style="color: #E5E5A0; font-weight: bold;">version</span> = <span style="color: #DDC29A; font-weight: bold;">"0.3.0"</span>
<span style="color: #E5E5A0; font-weight: bold;">edition</span> = <span style="color: #DDC29A; font-weight: bold;">"2021"</span>

<span style="color: #AD9292;"># </span><span style="color: #AD9292;">See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html</span>

[<span style="color: #C2E5C2;">dependencies</span>]
<span style="color: #AD9292;"># </span><span style="color: #AD9292;">serialization</span>
<span style="color: #E5E5A0; font-weight: bold;">edn-format</span> = <span style="color: #DDC29A; font-weight: bold;">"3.2.3"</span>
<span style="color: #E5E5A0; font-weight: bold;">base64</span> = <span style="color: #DDC29A; font-weight: bold;">"0.13.0"</span>

<span style="color: #AD9292;"># </span><span style="color: #AD9292;">String literals</span>
<span style="color: #E5E5A0; font-weight: bold;">internment</span> = <span style="color: #DDC29A; font-weight: bold;">"0.6.0"</span> 
<span style="color: #E5E5A0; font-weight: bold;">lazy_static</span> = <span style="color: #DDC29A; font-weight: bold;">"1.4.0"</span>

<span style="color: #E5E5A0; font-weight: bold;">num-integer</span> = <span style="color: #DDC29A; font-weight: bold;">"0.1.44"</span>

<span style="color: #AD9292;"># </span><span style="color: #AD9292;">crypto stuff</span>
<span style="color: #E5E5A0; font-weight: bold;">ed25519-dalek</span> = {version=<span style="color: #DDC29A; font-weight: bold;">"1"</span>, features=[<span style="color: #DDC29A; font-weight: bold;">"batch_deterministic"</span>, <span style="color: #DDC29A; font-weight: bold;">"std"</span>, <span style="color: #DDC29A; font-weight: bold;">"rand"</span>]}
<span style="color: #E5E5A0; font-weight: bold;">sha2</span> = <span style="color: #DDC29A; font-weight: bold;">"0.10.6"</span>
<span style="color: #E5E5A0; font-weight: bold;">rand_core</span> = <span style="color: #DDC29A; font-weight: bold;">"0.5.1"</span> <span style="color: #AD9292;"># </span><span style="color: #AD9292;">careful here, having 2 versions present will make weird compile errors</span>

<span style="color: #AD9292;"># </span><span style="color: #AD9292;">multithreading</span>
<span style="color: #E5E5A0; font-weight: bold;">futures</span> = <span style="color: #DDC29A; font-weight: bold;">"0.3"</span>
<span style="color: #E5E5A0; font-weight: bold;">tokio</span> = { version = <span style="color: #DDC29A; font-weight: bold;">"1"</span>, features = [<span style="color: #DDC29A; font-weight: bold;">"full"</span>] }
<span style="color: #AD9292;"># </span><span style="color: #AD9292;">multiple-consumer channels</span>
<span style="color: #AD9292;">#</span><span style="color: #AD9292;">crossbeam-channel = "0.5" # doesn't support async send/recv</span>
<span style="color: #AD9292;">#</span><span style="color: #AD9292;">async-channel = "1.8.0"</span>
<span style="color: #E5E5A0; font-weight: bold;">flume</span> = <span style="color: #DDC29A; font-weight: bold;">"0.10.14"</span>

<span style="color: #AD9292;"># </span><span style="color: #AD9292;">debugging</span>
<span style="color: #E5E5A0; font-weight: bold;">backtrace</span> = <span style="color: #DDC29A; font-weight: bold;">"0.3.61"</span>
[<span style="color: #C2E5C2;">dev-dependencies</span>]
<span style="color: #E5E5A0; font-weight: bold;">test-case</span> = <span style="color: #DDC29A; font-weight: bold;">"2.0.0"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org055c270" class="outline-4">
<h4 id="org055c270"><span class="section-number-4">1.4.2.</span> Internal data types</h4>
<div class="outline-text-4" id="text-1-4-2">
</div>
<div id="outline-container-orged5d22f" class="outline-5">
<h5 id="orged5d22f"><span class="section-number-5">1.4.2.1.</span> Basic internal types</h5>
<div class="outline-text-5" id="text-1-4-2-1">
<p>
We'll start by defining the basic data structures that kcats will use
internally, to keep track of things like the stack, expression, lists etc.
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">pipes</span>::{<span style="color: #C2E5C2;">In</span>, <span style="color: #C2E5C2;">Out</span>};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::collection <span style="color: #E5C2E5; font-weight: bold;">as</span> coll;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::dictionary <span style="color: #E5C2E5; font-weight: bold;">as</span> dict;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::environment <span style="color: #E5C2E5; font-weight: bold;">as</span> env;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #A0E5E5; font-weight: bold;">error</span>::<span style="color: #C2E5C2;">Error</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">internment</span>::<span style="color: #C2E5C2;">Intern</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">lazy_static</span>::lazy_static;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">collections</span>::{<span style="color: #C2E5C2;">HashMap</span>, <span style="color: #C2E5C2;">VecDeque</span>};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::fmt;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">hash</span>::<span style="color: #C2E5C2;">Hash</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">marker</span>::<span style="color: #C2E5C2;">Sync</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">ops</span>::{<span style="color: #C2E5C2;">Deref</span>, <span style="color: #C2E5C2;">DerefMut</span>};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">pin</span>::<span style="color: #C2E5C2;">Pin</span>;

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">mod</span> <span style="color: #A0E5E5; font-weight: bold;">associative</span>;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">mod</span> <span style="color: #A0E5E5; font-weight: bold;">collection</span>;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">mod</span> <span style="color: #A0E5E5; font-weight: bold;">dictionary</span>;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">mod</span> <span style="color: #A0E5E5; font-weight: bold;">environment</span>;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">mod</span> <span style="color: #A0E5E5; font-weight: bold;">error</span>;

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">A generic newtype to contain various kinds</span>
<span style="color: #00fa9a; font-weight: bold;">#[derive(PartialEq, Eq, PartialOrd, Ord, Hash, Debug)]</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">struct</span> <span style="color: #C2E5C2;">Newtype</span>&lt;<span style="color: #C2E5C2;">T</span>&gt;(<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #C2E5C2;">T</span>);

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">Access the inner value easily</span>
<span style="color: #E5C2E5; font-weight: bold;">impl</span>&lt;<span style="color: #C2E5C2;">T</span>&gt; <span style="color: #C2E5C2;">Deref</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Newtype</span>&lt;<span style="color: #C2E5C2;">T</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Target</span> = <span style="color: #C2E5C2;">T</span>;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">deref</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Target</span> {
        <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>.0
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span>&lt;<span style="color: #C2E5C2;">T</span>&gt; <span style="color: #C2E5C2;">DerefMut</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Newtype</span>&lt;<span style="color: #C2E5C2;">T</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">deref_mut</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Target</span> {
        <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>.0
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span>&lt;<span style="color: #E5E5A0; font-weight: bold;">T</span>: <span style="color: #C2E5C2;">IntoIterator</span>&gt; <span style="color: #C2E5C2;">IntoIterator</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Newtype</span>&lt;<span style="color: #C2E5C2;">T</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">T</span>::<span style="color: #C2E5C2;">Item</span>;
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">IntoIter</span> = <span style="color: #C2E5C2;">T</span>::<span style="color: #C2E5C2;">IntoIter</span>;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">into_iter</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">IntoIter</span> {
        <span style="color: #E5C2E5; font-weight: bold;">self</span>.0.into_iter()
    }
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">but still clone the whole thing, not the inner part</span>
<span style="color: #E5C2E5; font-weight: bold;">impl</span>&lt;<span style="color: #E5E5A0; font-weight: bold;">T</span>: <span style="color: #C2E5C2;">Clone</span>&gt; <span style="color: #C2E5C2;">Clone</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Newtype</span>&lt;<span style="color: #C2E5C2;">T</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">clone</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Newtype</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>.0.clone())
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Word</span> = <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt;;

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Stack</span> = <span style="color: #A0E5E5; font-weight: bold;">collection</span>::<span style="color: #C2E5C2;">List</span>;

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Bytes</span> = <span style="color: #C2E5C2;">Vec</span>&lt;<span style="color: #C2E5C2;">u8</span>&gt;;

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Int</span> = <span style="color: #C2E5C2;">i64</span>;

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Float</span> = <span style="color: #C2E5C2;">f64</span>;

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Char</span> = <span style="color: #C2E5C2;">char</span>;

<span style="color: #00fa9a; font-weight: bold;">lazy_static!</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_ASSOC</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"association"</span>.to_string());
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_BOOLEAN</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"boolean"</span>.to_string());
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_BYTES</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"bytes"</span>.to_string());
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_CHAR</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"character"</span>.to_string());
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_ENVIRONMENT</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"environment"</span>.to_string());
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_ERROR</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"error"</span>.to_string());
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_FLOAT</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"float"</span>.to_string());
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_INTEGER</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"integer"</span>.to_string());
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_ITEM</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"item"</span>.to_string());
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_LIST</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"list"</span>.to_string());
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_NUMBER</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"number"</span>.to_string());
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_PIPE</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"pipe"</span>.to_string());
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_PROGRAM</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"program"</span>.to_string());
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_STRING</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"string"</span>.to_string());
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_WORD</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"word"</span>.to_string());
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_DISPENSER</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"dispenser"</span>.to_string());
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_SIZED</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"sized"</span>.to_string());
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5E5A0; font-weight: bold;">S_ORDERED</span>: <span style="color: #C2E5C2;">Intern</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #C2E5C2;">Intern</span>::new(<span style="color: #DDC29A; font-weight: bold;">"ordered"</span>.to_string());
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">#[derive(Debug, Clone)]</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">pub enum Sequence {</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">Assoc(Associative),</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">List(ListContent),</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">Nothing,</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">}</span>

<span style="color: #00fa9a; font-weight: bold;">#[derive(Debug, Clone)]</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">enum</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #C2E5C2;">Int</span>(<span style="color: #C2E5C2;">Int</span>),
    <span style="color: #C2E5C2;">Float</span>(<span style="color: #C2E5C2;">Float</span>),
    <span style="color: #C2E5C2;">Word</span>(<span style="color: #C2E5C2;">Word</span>),
    <span style="color: #C2E5C2;">Char</span>(<span style="color: #C2E5C2;">Char</span>),
    <span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>),
    <span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>),
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">T</span>&gt; = <span style="color: #C2E5C2;">Pin</span>&lt;<span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">future</span>::<span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Output</span> = <span style="color: #C2E5C2;">T</span>&gt; + <span style="color: #C2E5C2;">Send</span>&gt;&gt;;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">StepFn</span> = <span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Fn</span>(<span style="color: #A0E5E5; font-weight: bold;">env</span>::<span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">env</span>::<span style="color: #C2E5C2;">Environment</span>&gt; + <span style="color: #C2E5C2;">Sync</span> + <span style="color: #C2E5C2;">Send</span>;

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">PartialEq</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">eq</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">other</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Self</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> (<span style="color: #E5C2E5; font-weight: bold;">self</span>, other) {
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">same types, just use their own eq</span>
            (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(a), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(b)) =&gt; a == b,
            (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(a), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(b)) =&gt; a == b,
            (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Word</span>(a), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Word</span>(b)) =&gt; a == b,
            (
                <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(a)),
                <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(b)),
            ) =&gt; a == b,
            (
                <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(a)),
                <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(b)),
            ) =&gt; a == b,
            (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(a), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(b)) =&gt; a == b,
            (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Char</span>(a), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Char</span>(b)) =&gt; a == b,
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">(Item::Assoc(a), Item::Assoc(b)) =&gt; a == b,</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">(Item::List(a), Item::List(b)) =&gt; a == b,</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">//TODO: (Item::Collection(a), Item::Collection(b)) =&gt; a == b,</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">(Item::Env(a), Item::Env(b)) =&gt; a == b,</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">(Item::Entry(a), Item::Entry(b)) =&gt; a == b,</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">(Item::Dictionary(a), Item::Dictionary(b)) =&gt; a == b,</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">(Item::Error(a), Item::Error(b)) =&gt; a == b,</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">//TODO:</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">//(Item::In(a), Item::In(b)) =&gt; a == b,</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">//(Item::Out(a), Item::Out(b)) =&gt; a == b,</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">//(Item::Tunnel(a), Item::Tunnel(b)) =&gt; a == b,</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">(Item::Nothing, Item::Nothing) =&gt; true,</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">// different types, but can be converted to the same type</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">(Item::Nothing, Item::List(l)) =&gt; l.is_empty(),</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">(Item::List(l), Item::Nothing) =&gt; l.is_empty(),</span>

            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">(Item::Nothing, Item::Assoc(l)) =&gt; l.is_empty(),</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">(Item::Assoc(l), Item::Nothing) =&gt; l.is_empty(),</span>

            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">(Item::Nothing, Item::Collection(l)) =&gt; l.is_empty(),</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">(Item::Collection(l), Item::Nothing) =&gt; l.is_empty(),</span>

            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">(Item::List(l), Item::Assoc(a)) =&gt; l.is_empty() &amp;&amp; a.is_empty(),</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">(Item::Assoc(a), Item::List(l)) =&gt; l.is_empty() &amp;&amp; a.is_empty(),</span>
            <span style="color: #AD9292;">//</span><span style="color: #AD9292;">(Item::Error(i), Item::Assoc(j)) =&gt; (*i).data == *j,</span>
            <span style="color: #AD9292;">//</span><span style="color: #AD9292;">(Item::Assoc(i), Item::Error(j)) =&gt; (*j).data == *i,</span>

            <span style="color: #AD9292;">//</span><span style="color: #AD9292;">TODO Definition, Associative etc</span>
            _ =&gt; <span style="color: #E5C2E5; font-weight: bold;">false</span>,
        }
    }
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">The default Item is NOTHING.</span>
<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Default</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">default</span>() -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">NOTHING</span>
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">wrap</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span> {
    <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter([i])
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Int</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i) =&gt; <span style="color: #C2E5C2;">Ok</span>(i),
            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"integer"</span>, i)),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Float</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i) =&gt; <span style="color: #C2E5C2;">Ok</span>(i),
            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"float"</span>, i)),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">String</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">s</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
        <span style="color: #E5C2E5; font-weight: bold;">match</span> s {
            <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(i) =&gt; <span style="color: #C2E5C2;">Ok</span>(i),
            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"string"</span>, i.into())),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Word</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Word</span>(i) =&gt; <span style="color: #C2E5C2;">Ok</span>(i),
            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"word"</span>, i)),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Bytes</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">s</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
        <span style="color: #E5C2E5; font-weight: bold;">match</span> s {
            <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(b) =&gt; <span style="color: #C2E5C2;">Ok</span>(b),
            b =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"bytes"</span>, b.into())),
        }
    }
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">impl TryFrom&lt;Item&gt; for Association {</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">type Error = Error;</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">fn try_from(i: Item) -&gt; Result&lt;Self, Self::Error&gt; {</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">match i {</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">Item::Assoc(a) =&gt; Ok(a),</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">Item::List(l) =&gt; Ok(to_hash(l)?),</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">Item::Nothing =&gt; Ok(Arc::new(AssociationContent::new())),</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">Item::DerivedDef(d) =&gt; Ok(Association::from(d)),</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">Item::AxiomDef(a) =&gt; Ok(Association::from(a)),</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">Item::Env(e) =&gt; Ok(Association::from(e)),</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">Item::Error(e) =&gt; Ok(Association::from(e)),</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">_ =&gt; Err(Error::expected("association")),</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">}</span>

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">In</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">In</span>(i)) =&gt; <span style="color: #C2E5C2;">Ok</span>(i),
            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"pipe"</span>, i)),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Out</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Out</span>(o)) =&gt; <span style="color: #C2E5C2;">Ok</span>(o),
            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"pipe"</span>, i)),
        }
    }
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">As there are no real booleans, we use the word 'true' but literally</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">any value except the empty list is truthy. If we read a value</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">'false' in edn, that's not actually a boolean, it's just the</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">symbol/word false.</span>
<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">bool</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">b</span>: <span style="color: #C2E5C2;">bool</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #E5C2E5; font-weight: bold;">if</span> b {
            <span style="color: #DDC29A; font-weight: bold;">"true"</span>.into()
        } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
            <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">NOTHING</span>
        }
    }
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">impl From&lt;Environment&gt; for Association {</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">fn from(env: Environment) -&gt; Association {</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">let mut a = AssociationContent::new();</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">a.insert(word_key("stack"), Item::List(env.stack.clone()));</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">a.insert(word_key("expression"), Item::List(env.expression.clone()));</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">a.insert(word_key("dictionary"), Item::Assoc(env.dictionary.clone()));</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">Arc::new(a)</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">}</span>

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">io</span>::<span style="color: #C2E5C2;">Error</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Error</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">err</span>: <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">io</span>::<span style="color: #C2E5C2;">Error</span>) -&gt; <span style="color: #C2E5C2;">Error</span> {
        <span style="color: #C2E5C2;">Error</span>::create(wrap(<span style="color: #DDC29A; font-weight: bold;">"io"</span>.into()), <span style="color: #ffffff; background-color: #000000;">&amp;</span>err.to_string(), <span style="color: #C2E5C2;">None</span>)
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">str</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">str</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Word</span>(<span style="color: #C2E5C2;">Word</span>::from(i))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">String</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(i)))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Bytes</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">b</span>: <span style="color: #C2E5C2;">Bytes</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(b)))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Char</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">c</span>: <span style="color: #C2E5C2;">Char</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Char</span>(c)
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Int</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">c</span>: <span style="color: #C2E5C2;">Int</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(c)
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org0854958" class="outline-5">
<h5 id="org0854958"><span class="section-number-5">1.4.2.2.</span> Collection types</h5>
<div class="outline-text-5" id="text-1-4-2-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">futures</span>::<span style="color: #C2E5C2;">FutureExt</span>;

<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::pipes <span style="color: #E5C2E5; font-weight: bold;">as</span> pipe;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::associative <span style="color: #E5C2E5; font-weight: bold;">as</span> assoc;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::*;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::{<span style="color: #A0E5E5; font-weight: bold;">collections</span>::<span style="color: #C2E5C2;">HashSet</span>, future, sync};

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Arc</span>&lt;<span style="color: #C2E5C2;">T</span>&gt; = <span style="color: #C2E5C2;">Newtype</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">sync</span>::<span style="color: #C2E5C2;">Arc</span>&lt;<span style="color: #C2E5C2;">T</span>&gt;&gt;;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Listy</span>&lt;<span style="color: #C2E5C2;">I</span>&gt; = <span style="color: #C2E5C2;">Newtype</span>&lt;<span style="color: #C2E5C2;">VecDeque</span>&lt;<span style="color: #C2E5C2;">I</span>&gt;&gt;;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Setty</span>&lt;<span style="color: #C2E5C2;">I</span>&gt; = <span style="color: #C2E5C2;">Newtype</span>&lt;<span style="color: #C2E5C2;">HashSet</span>&lt;<span style="color: #C2E5C2;">I</span>&gt;&gt;;
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">impl&lt;T: PartialEq&gt; PartialEq for Newtype&lt;Arc&lt;T&gt;&gt; {</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">fn eq(&amp;self, other: &amp;Self) -&gt; bool {</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">**self.0 == **other.0</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">}</span>

<span style="color: #E5C2E5; font-weight: bold;">impl</span>&lt;<span style="color: #E5E5A0; font-weight: bold;">T</span>: <span style="color: #C2E5C2;">Clone</span>&gt; <span style="color: #C2E5C2;">Arc</span>&lt;<span style="color: #C2E5C2;">T</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">make_mut</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #C2E5C2;">T</span> {
        <span style="color: #A0E5E5; font-weight: bold;">sync</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>.0)
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">inner</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">T</span> {
        <span style="color: #A0E5E5; font-weight: bold;">sync</span>::<span style="color: #C2E5C2;">Arc</span>::try_unwrap(<span style="color: #E5C2E5; font-weight: bold;">self</span>.0.clone()).unwrap_or_else(|rc| (*rc).clone())
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">wrap</span>(<span style="color: #E5E5A0; font-weight: bold;">inner</span>: <span style="color: #C2E5C2;">T</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Self</span>(<span style="color: #A0E5E5; font-weight: bold;">sync</span>::<span style="color: #C2E5C2;">Arc</span>::new(inner))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">ListContent</span> = <span style="color: #C2E5C2;">Listy</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">List</span> = <span style="color: #C2E5C2;">Arc</span>&lt;<span style="color: #C2E5C2;">ListContent</span>&gt;;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Set</span> = <span style="color: #C2E5C2;">Arc</span>&lt;<span style="color: #C2E5C2;">Setty</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>&gt;&gt;;

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">List</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">new</span>() -&gt; <span style="color: #C2E5C2;">List</span> {
        <span style="color: #C2E5C2;">Newtype</span>(<span style="color: #A0E5E5; font-weight: bold;">sync</span>::<span style="color: #C2E5C2;">Arc</span>::new(<span style="color: #C2E5C2;">Newtype</span>(<span style="color: #C2E5C2;">VecDeque</span>::new())))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Set</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">h</span>: <span style="color: #C2E5C2;">HashSet</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>&gt;) -&gt; <span style="color: #C2E5C2;">Set</span> {
        <span style="color: #C2E5C2;">Newtype</span>(<span style="color: #A0E5E5; font-weight: bold;">sync</span>::<span style="color: #C2E5C2;">Arc</span>::new(<span style="color: #C2E5C2;">Newtype</span>(h)))
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">new</span>() -&gt; <span style="color: #C2E5C2;">Set</span> {
        <span style="color: #C2E5C2;">Set</span>::from(<span style="color: #C2E5C2;">HashSet</span>::new())
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">FromIterator</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">List</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from_iter</span>&lt;<span style="color: #C2E5C2;">I</span>&gt;(<span style="color: #E5E5A0; font-weight: bold;">iter</span>: <span style="color: #C2E5C2;">I</span>) -&gt; <span style="color: #C2E5C2;">Self</span>
    <span style="color: #E5C2E5; font-weight: bold;">where</span>
        <span style="color: #E5E5A0; font-weight: bold;">I</span>: <span style="color: #C2E5C2;">IntoIterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Item</span>&gt;,
    {
        <span style="color: #C2E5C2;">Newtype</span>(<span style="color: #A0E5E5; font-weight: bold;">sync</span>::<span style="color: #C2E5C2;">Arc</span>::new(<span style="color: #C2E5C2;">Newtype</span>(
            iter.into_iter().collect::&lt;<span style="color: #C2E5C2;">VecDeque</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;&gt;(),
        )))
    }
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">Most generic collection type, all we know is it can contain</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">multiple items.</span>
<span style="color: #00fa9a; font-weight: bold;">#[derive(Debug, Clone, PartialEq)]</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">enum</span> <span style="color: #C2E5C2;">Dispenser</span> {
    <span style="color: #C2E5C2;">Sized</span>(<span style="color: #C2E5C2;">Sized</span>),
    <span style="color: #C2E5C2;">Out</span>(<span style="color: #A0E5E5; font-weight: bold;">pipe</span>::<span style="color: #C2E5C2;">Out</span>),
    <span style="color: #C2E5C2;">Tunnel</span>(<span style="color: #A0E5E5; font-weight: bold;">pipe</span>::<span style="color: #C2E5C2;">Tunnel</span>),
}

<span style="color: #00fa9a; font-weight: bold;">#[derive(Debug, Clone, PartialEq)]</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">enum</span> <span style="color: #C2E5C2;">Receptacle</span> {
    <span style="color: #C2E5C2;">Sized</span>(<span style="color: #C2E5C2;">Sized</span>),
    <span style="color: #C2E5C2;">In</span>(<span style="color: #A0E5E5; font-weight: bold;">pipe</span>::<span style="color: #C2E5C2;">In</span>),
    <span style="color: #C2E5C2;">Tunnel</span>(<span style="color: #A0E5E5; font-weight: bold;">pipe</span>::<span style="color: #C2E5C2;">Tunnel</span>),
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">Collection that has a definite size that we can access. Implies</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">that it can also be appended to.</span>
<span style="color: #00fa9a; font-weight: bold;">#[derive(Debug, Clone)]</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">enum</span> <span style="color: #C2E5C2;">Sized</span> {
    <span style="color: #C2E5C2;">Associative</span>(<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>),
    <span style="color: #C2E5C2;">List</span>(<span style="color: #C2E5C2;">List</span>),
    <span style="color: #C2E5C2;">Set</span>(<span style="color: #C2E5C2;">Set</span>),
    <span style="color: #C2E5C2;">String</span>(<span style="color: #C2E5C2;">String</span>),
    <span style="color: #C2E5C2;">Bytes</span>(<span style="color: #C2E5C2;">Bytes</span>),
    <span style="color: #C2E5C2;">Nothing</span>,
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">PartialEq</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Sized</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">eq</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">other</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Self</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>.is_empty() &amp;&amp; other.is_empty() {
            <span style="color: #E5C2E5; font-weight: bold;">return</span> <span style="color: #E5C2E5; font-weight: bold;">true</span>;
        }
        <span style="color: #E5C2E5; font-weight: bold;">match</span> (<span style="color: #E5C2E5; font-weight: bold;">self</span>, other) {
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(a), <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(b)) =&gt; a == b,
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(a), <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(b)) =&gt; a == b,
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(a), <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(b)) =&gt; a == b,
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(a), <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(b)) =&gt; a == b,
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(a), <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(b)) =&gt; a == b,
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span>, <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span>) =&gt; <span style="color: #E5C2E5; font-weight: bold;">true</span>,
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span>, l) =&gt; l.is_empty(),
            (l, <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span>) =&gt; l.is_empty(),
            _ =&gt; <span style="color: #E5C2E5; font-weight: bold;">false</span>,
        }
    }
}
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">a const Item value for Nothing</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">const</span> <span style="color: #E5E5A0; font-weight: bold;">NOTHING</span>: <span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span>));

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Dispenser</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">take</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;(<span style="color: #C2E5C2;">Dispenser</span>, <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;)&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(s) =&gt; <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #A0E5E5; font-weight: bold;">future</span>::ready(s.take())),
            <span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Out</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> o) =&gt; <span style="color: #C2E5C2;">Box</span>::pin({
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> = o.take();
                i.map(|r| {
                    (
                        <span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Out</span>(o),
                        <span style="color: #E5C2E5; font-weight: bold;">match</span> r {
                            <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Some</span>(i)) =&gt; <span style="color: #C2E5C2;">Some</span>(i),
                            <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">None</span>) =&gt; <span style="color: #C2E5C2;">None</span>,
                            <span style="color: #C2E5C2;">Err</span>(e) =&gt; <span style="color: #C2E5C2;">Some</span>(<span style="color: #C2E5C2;">Item</span>::from(e)),
                        },
                    )
                })
            }),
            <span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Tunnel</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> t) =&gt; <span style="color: #C2E5C2;">Box</span>::pin({
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> = t.take();
                i.map(|r| {
                    (
                        <span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Tunnel</span>(t),
                        <span style="color: #E5C2E5; font-weight: bold;">match</span> r {
                            <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Some</span>(i)) =&gt; <span style="color: #C2E5C2;">Some</span>(i),
                            <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">None</span>) =&gt; <span style="color: #C2E5C2;">None</span>,
                            <span style="color: #C2E5C2;">Err</span>(e) =&gt; <span style="color: #C2E5C2;">Some</span>(<span style="color: #C2E5C2;">Item</span>::from(e)),
                        },
                    )
                })
            }),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Sized</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">is_empty</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #E5C2E5; font-weight: bold;">self</span>.len() == 0
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">len</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">usize</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(a) =&gt; a.len(),
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(l) =&gt; l.len(),
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(s) =&gt; s.len(),
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(b) =&gt; b.len(),
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(s) =&gt; s.len(),
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span> =&gt; 0,
        }
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">take</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; (<span style="color: #C2E5C2;">Dispenser</span>, <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;) {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(a) =&gt; a.take(),
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> l) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">lm</span> = l.make_mut();
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> = lm.pop_front();
                (<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(l)), i)
            }
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span> =&gt; (<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span>), <span style="color: #C2E5C2;">None</span>),
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> s) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> = s.pop().map(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Char</span>);
                (<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(s)), i)
            }
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> b) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> = b.pop().map(|b| <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(b <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">i64</span>));
                (<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(b)), i)
            }
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> s) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> = s.iter().next().cloned();
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">sm</span> = s.make_mut();
                <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Some</span>(i) = i.clone() {
                    sm.take(<span style="color: #ffffff; background-color: #000000;">&amp;</span>i);
                }
                (<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(s)), i.map(<span style="color: #C2E5C2;">Item</span>::from))
            }
        }
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">put</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">other</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Sized</span>, <span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> (<span style="color: #E5C2E5; font-weight: bold;">self</span>, other) {
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> c), i) =&gt; {
                c.make_mut().push_back(i);
                <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(c))
            }
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(a), l) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(a.put(l)<span style="color: #C2C2E5; font-weight: bold;">?</span>)),
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> s), i) =&gt; {
                s.make_mut().insert(<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>);
                <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(s))
            }
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> b), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i)) =&gt; {
                b.push(i <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">u8</span>);
                <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(b))
            }
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span>, i) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(<span style="color: #C2E5C2;">List</span>::from_iter([i]))),
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(_), _) =&gt; <span style="color: #00fa9a; font-weight: bold;">unimplemented!</span>(),
            (i, _) =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"packable"</span>, i.into())),
        }
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">join</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">other</span>: <span style="color: #C2E5C2;">Sized</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Sized</span>, <span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #C2E5C2;">Ok</span>(<span style="color: #E5C2E5; font-weight: bold;">match</span> (<span style="color: #E5C2E5; font-weight: bold;">self</span>, other) {
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(a), <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(l)) =&gt; <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>({
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">a</span>: <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span> = a.into();
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">more</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::try_from_iter(l.clone().inner().into_iter())<span style="color: #C2C2E5; font-weight: bold;">?</span>;
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">am</span> = a.make_mut();
                am.extend(more.inner().into_iter());
                <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(a)
            }),
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(l), <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(a)) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">a</span>: <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span> = a.into();
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">la</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::try_from_iter(l.clone().inner().into_iter())<span style="color: #C2C2E5; font-weight: bold;">?</span>;
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">lam</span> = la.make_mut();
                lam.extend(a.inner().into_iter());
                <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(la))
            }
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(a), <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(b)) =&gt; <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(a.join(b)),
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> a), <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> b)) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">am</span> = a.make_mut();
                am.extend(b.inner());
                <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(a)
            }
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> a), <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> b)) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">am</span> = a.make_mut();
                am.extend(b.inner());
                <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(a)
            }
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> a), <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> b)) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">bm</span> = b.make_mut();

                bm.extend(
                    a.inner()
                        .into_iter()
                        .map(<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>::try_from)
                        .collect::&lt;<span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Vec</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>&gt;, <span style="color: #C2E5C2;">Error</span>&gt;&gt;()<span style="color: #C2C2E5; font-weight: bold;">?</span>
                        .into_iter(),
                );
                <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(b)
            }
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> a), <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> b)) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">am</span> = a.make_mut();

                am.extend(
                    b.inner()
                        .into_iter()
                        .map(<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>::try_from)
                        .collect::&lt;<span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Vec</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>&gt;, <span style="color: #C2E5C2;">Error</span>&gt;&gt;()<span style="color: #C2C2E5; font-weight: bold;">?</span>
                        .into_iter(),
                );
                <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(a)
            }
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> a), <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(b)) =&gt; {
                a.push_str(<span style="color: #ffffff; background-color: #000000;">&amp;</span>b);
                <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(a)
            }
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> a), <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(b)) =&gt; {
                a.extend(b);
                <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(a)
            }
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span>, x) =&gt; x,
            (x, <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span>) =&gt; x,
            <span style="color: #AD9292;">//</span><span style="color: #AD9292;">TODO: not every combination makes sense, return error here, don't panic</span>
            (s, other) =&gt; <span style="color: #00fa9a; font-weight: bold;">todo!</span>(<span style="color: #DDC29A; font-weight: bold;">"Cannot join {:?} and {:?}"</span>, s, other),
        })
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">contains</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">other</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> (<span style="color: #E5C2E5; font-weight: bold;">self</span>, other) {
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(a), other) =&gt; {
                <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>::try_from(other.clone()).map_or(<span style="color: #E5C2E5; font-weight: bold;">false</span>, |k| a.contains_key(<span style="color: #ffffff; background-color: #000000;">&amp;</span>k))
            }
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(l), other) =&gt; l.contains(other),
            (<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(s), other) =&gt; {
                <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>::try_from(other.clone()).map_or(<span style="color: #E5C2E5; font-weight: bold;">false</span>, |k| s.contains(<span style="color: #ffffff; background-color: #000000;">&amp;</span>k))
            }
            _ =&gt; <span style="color: #00fa9a; font-weight: bold;">todo!</span>(<span style="color: #DDC29A; font-weight: bold;">"contains not implemented for {:?}"</span>, <span style="color: #E5C2E5; font-weight: bold;">self</span>),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Receptacle</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">put</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Receptacle</span>, <span style="color: #C2E5C2;">Error</span>&gt;&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(s) =&gt; <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #A0E5E5; font-weight: bold;">future</span>::ready(s.put(i).map(<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>))),
            <span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">In</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> p) =&gt; <span style="color: #C2E5C2;">Box</span>::pin(p.put(i).map(|r| r.map(|_| <span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">In</span>(p)))),
            <span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Tunnel</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> t) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">p</span> = t.put(i);
                <span style="color: #C2E5C2;">Box</span>::pin(p.map(|r| r.map(|_| <span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Tunnel</span>(t))))
            }
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">IntoIterator</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Sized</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Item</span>;
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">IntoIter</span> = <span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Iterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Item</span>&gt;&gt;;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">into_iter</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">IntoIter</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(map) =&gt; <span style="color: #C2E5C2;">Box</span>::new(map.into_iter().map(|kv| kv.into())),
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> list) =&gt; <span style="color: #C2E5C2;">Box</span>::new(list.inner().into_iter()),
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span> =&gt; <span style="color: #C2E5C2;">Box</span>::new(<span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">iter</span>::empty()),
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(s) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">chars</span>: <span style="color: #C2E5C2;">Vec</span>&lt;<span style="color: #C2E5C2;">char</span>&gt; = s.chars().collect();
                <span style="color: #C2E5C2;">Box</span>::new(chars.into_iter().map(|c| c.into()))
            }
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(b) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">vec</span>: <span style="color: #C2E5C2;">Vec</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; = b.into_iter().map(|byte| <span style="color: #C2E5C2;">Item</span>::from(byte <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Int</span>)).collect();
                <span style="color: #C2E5C2;">Box</span>::new(vec.into_iter())
            }
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> s) =&gt; <span style="color: #C2E5C2;">Box</span>::new(s.inner().into_iter().map(|i| i.into())),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Dispenser</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Sized</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">c</span>: <span style="color: #C2E5C2;">Dispenser</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #AD9292;">//</span><span style="color: #AD9292;">println!("from iterable {:?}", c);</span>
        <span style="color: #E5C2E5; font-weight: bold;">match</span> c {
            <span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(s) =&gt; <span style="color: #C2E5C2;">Ok</span>(s),
            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"sized"</span>, i.into())),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Receptacle</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Sized</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">c</span>: <span style="color: #C2E5C2;">Receptacle</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> c {
            <span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(s) =&gt; <span style="color: #C2E5C2;">Ok</span>(s),
            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"sized"</span>, <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(i))),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Sized</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">List</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">s</span>: <span style="color: #C2E5C2;">Sized</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> s {
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(l) =&gt; <span style="color: #C2E5C2;">Ok</span>(l),
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span> =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">List</span>::new()),
            <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(a) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">List</span>::from_iter(a.into_iter().map(<span style="color: #C2E5C2;">Item</span>::from))),
            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"list"</span>, i.into())),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">List</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(l) =&gt; <span style="color: #C2E5C2;">Sized</span>::try_from(l).and_then(<span style="color: #C2E5C2;">List</span>::try_from),
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(l) =&gt; <span style="color: #C2E5C2;">Sized</span>::try_from(l).and_then(<span style="color: #C2E5C2;">List</span>::try_from),
            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"list"</span>, i.into())),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Sized</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">item</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> item {
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(c) =&gt; c.try_into(),
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(p) =&gt; <span style="color: #C2E5C2;">Dispenser</span>::try_from(p)<span style="color: #C2C2E5; font-weight: bold;">?</span>.try_into(),
            i =&gt; {
                <span style="color: #AD9292;">// </span><span style="color: #AD9292;">let bt = backtrace::Backtrace::new();</span>
                <span style="color: #AD9292;">// </span><span style="color: #AD9292;">println!("try from item {:?},\n {:?}", i, bt);</span>
                <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"sized"</span>, i))
            }
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Receptacle</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">item</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> item {
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(p) =&gt; <span style="color: #C2E5C2;">Ok</span>(p),
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(c) =&gt; c.try_into(),
            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"packable"</span>, i)),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Dispenser</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Receptacle</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">c</span>: <span style="color: #C2E5C2;">Dispenser</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> c {
            <span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(s) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(s)),
            <span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Tunnel</span>(t) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Tunnel</span>(t)),
            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"packable"</span>, i.into())),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Receptacle</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Dispenser</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">c</span>: <span style="color: #C2E5C2;">Receptacle</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> c {
            <span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(s) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(s)),
            <span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Tunnel</span>(t) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Tunnel</span>(t)),
            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"iterable"</span>, <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(i))),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Iterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Item</span>&gt;&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">item</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Sized</span>::try_from(item)<span style="color: #C2C2E5; font-weight: bold;">?</span>.into_iter())
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Sized</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Iterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Item</span>&gt;&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">sized</span>: <span style="color: #C2E5C2;">Sized</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Box</span>::new(sized.into_iter())
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">List</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Sized</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">l</span>: <span style="color: #C2E5C2;">List</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(l)
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Sized</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Dispenser</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">s</span>: <span style="color: #C2E5C2;">Sized</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(s)
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">List</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">l</span>: <span style="color: #C2E5C2;">List</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(l)))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Dispenser</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">c</span>: <span style="color: #C2E5C2;">Dispenser</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(c)
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Sized</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">s</span>: <span style="color: #C2E5C2;">Sized</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(s).into()
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Dispenser</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">item</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> item {
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(c) =&gt; <span style="color: #C2E5C2;">Ok</span>(c),
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(p) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Dispenser</span>::try_from(p)<span style="color: #C2C2E5; font-weight: bold;">?</span>),
            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"iterable"</span>, i)),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Set</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">item</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">s</span> = <span style="color: #C2E5C2;">Sized</span>::try_from(item)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">hs</span>: <span style="color: #C2E5C2;">HashSet</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>&gt; = s
            .into_iter()
            .map(|i| i.try_into())
            .collect::&lt;<span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">HashSet</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>&gt;, <span style="color: #C2E5C2;">Error</span>&gt;&gt;()<span style="color: #C2C2E5; font-weight: bold;">?</span>;
        <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Set</span>::from(hs))
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orge071d3f" class="outline-5">
<h5 id="orge071d3f"><span class="section-number-5">1.4.2.3.</span> Associative types</h5>
<div class="outline-text-5" id="text-1-4-2-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::collection <span style="color: #E5C2E5; font-weight: bold;">as</span> coll;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::dictionary <span style="color: #E5C2E5; font-weight: bold;">as</span> dict;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::environment <span style="color: #E5C2E5; font-weight: bold;">as</span> env;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::*;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">iter</span>::<span style="color: #C2E5C2;">FromIterator</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::sync;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Associationy</span>&lt;<span style="color: #C2E5C2;">K</span>, <span style="color: #C2E5C2;">V</span>&gt; = <span style="color: #C2E5C2;">Newtype</span>&lt;<span style="color: #C2E5C2;">HashMap</span>&lt;<span style="color: #C2E5C2;">K</span>, <span style="color: #C2E5C2;">V</span>&gt;&gt;;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">AssociationContent</span> = <span style="color: #C2E5C2;">Associationy</span>&lt;<span style="color: #C2E5C2;">KeyItem</span>, <span style="color: #C2E5C2;">Item</span>&gt;;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Association</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>&lt;<span style="color: #C2E5C2;">AssociationContent</span>&gt;;

<span style="color: #00fa9a; font-weight: bold;">#[derive(Debug, Clone, Eq, PartialEq, Hash, PartialOrd, Ord)]</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">enum</span> <span style="color: #C2E5C2;">KeyItem</span> {
    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">Order matters here, for comparison purposes - changing the</span>
    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">order will change the result of how eg int compares to word.</span>
    <span style="color: #C2E5C2;">Nothing</span>,
    <span style="color: #C2E5C2;">Int</span>(<span style="color: #C2E5C2;">Int</span>),
    <span style="color: #C2E5C2;">Word</span>(<span style="color: #C2E5C2;">Word</span>),
    <span style="color: #C2E5C2;">Bytes</span>(<span style="color: #C2E5C2;">Bytes</span>),
    <span style="color: #C2E5C2;">String</span>(<span style="color: #C2E5C2;">String</span>),
    <span style="color: #C2E5C2;">List</span>(<span style="color: #C2E5C2;">KeyList</span>),
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">KeyList</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from_iter</span>&lt;<span style="color: #C2E5C2;">I</span>&gt;(<span style="color: #E5E5A0; font-weight: bold;">l</span>: <span style="color: #C2E5C2;">I</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Error</span>&gt;
    <span style="color: #E5C2E5; font-weight: bold;">where</span>
        <span style="color: #E5E5A0; font-weight: bold;">I</span>: <span style="color: #C2E5C2;">IntoIterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Item</span>&gt;,
    {
        <span style="color: #C2E5C2;">Ok</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::wrap(<span style="color: #C2E5C2;">Newtype</span>(
            l.into_iter()
                .map(<span style="color: #C2E5C2;">KeyItem</span>::try_from)
                .collect::&lt;<span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">VecDeque</span>&lt;<span style="color: #C2E5C2;">KeyItem</span>&gt;, <span style="color: #C2E5C2;">Error</span>&gt;&gt;()<span style="color: #C2C2E5; font-weight: bold;">?</span>,
        )))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">KeyItem</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">KeyItem</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
            <span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Int</span>(i) =&gt; <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i),
            <span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">String</span>(i) =&gt; i.into(),
            <span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">List</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> l) =&gt; {
                <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter(l.inner().into_iter().map(<span style="color: #C2E5C2;">Item</span>::from)).into()
            }
            <span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Word</span>(w) =&gt; <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Word</span>(w),
            <span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Bytes</span>(bs) =&gt; bs.into(),
            <span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Nothing</span> =&gt; <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">NOTHING</span>,
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">str</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">KeyItem</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">str</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Word</span>(<span style="color: #C2E5C2;">Word</span>::from(i))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Word</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">KeyItem</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Word</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Word</span>(i)
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">KeyItem</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Int</span>(i)),
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(i))) =&gt; {
                <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">String</span>(i))
            }
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(i))) =&gt; {
                <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">String</span>(i))
            }
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(i))) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Bytes</span>(i)),
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(i))) =&gt; {
                <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Bytes</span>(i))
            }
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> l))) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">List</span>(
                <span style="color: #C2E5C2;">KeyList</span>::try_from_iter(l.inner().into_iter())<span style="color: #C2C2E5; font-weight: bold;">?</span>,
            )),

            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span>)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Nothing</span>),
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span>)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Nothing</span>),

            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Word</span>(w) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Word</span>(w)),

            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"KeyItem"</span>, i.into())),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">KeyItem</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Word</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">k</span>: <span style="color: #C2E5C2;">KeyItem</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> k {
            <span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Word</span>(w) =&gt; <span style="color: #C2E5C2;">Ok</span>(w.clone()),
            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"word"</span>, i.into())),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Entry</span> = (<span style="color: #C2E5C2;">KeyItem</span>, <span style="color: #C2E5C2;">Item</span>);

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">KeyListContent</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Listy</span>&lt;<span style="color: #C2E5C2;">KeyItem</span>&gt;;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">KeyList</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>&lt;<span style="color: #C2E5C2;">KeyListContent</span>&gt;;

<span style="color: #00fa9a; font-weight: bold;">#[derive(Debug, Clone)]</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">enum</span> <span style="color: #C2E5C2;">Associative</span> {
    <span style="color: #C2E5C2;">Assoc</span>(<span style="color: #C2E5C2;">Association</span>),
    <span style="color: #C2E5C2;">DictEntry</span>(<span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Entry</span>),
    <span style="color: #C2E5C2;">Env</span>(<span style="color: #A0E5E5; font-weight: bold;">env</span>::<span style="color: #C2E5C2;">Environment</span>),
    <span style="color: #C2E5C2;">Error</span>(<span style="color: #C2E5C2;">Error</span>),
    <span style="color: #C2E5C2;">Dictionary</span>(<span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Dictionary</span>),
    <span style="color: #C2E5C2;">Nothing</span>,
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">PartialEq</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Associative</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">eq</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">other</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Self</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> (<span style="color: #E5C2E5; font-weight: bold;">self</span>, other) {
            (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(a), <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(b)) =&gt; a == b,
            (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">DictEntry</span>(a), <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">DictEntry</span>(b)) =&gt; a == b,
            (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(a), <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(b)) =&gt; a == b,
            (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(a), <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(b)) =&gt; a == b,
            (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(a), <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(b)) =&gt; a == b,
            (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Nothing</span>, <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Nothing</span>) =&gt; <span style="color: #E5C2E5; font-weight: bold;">true</span>,
            <span style="color: #AD9292;">//</span><span style="color: #AD9292;">(Associative::Assoc(a), b) =&gt; Association::from(a) == Association::from(b),</span>
            <span style="color: #AD9292;">//</span><span style="color: #AD9292;">(a, Associative::Assoc(b)) =&gt; Association::from(a) == Association::from(b),</span>
            _ =&gt; <span style="color: #E5C2E5; font-weight: bold;">false</span>,
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Associative</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">len</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">usize</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(a) =&gt; a.len(),
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">DictEntry</span>(a) =&gt; a.len(),
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(e) =&gt; e.len(),
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(e) =&gt; e.len(),
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(d) =&gt; d.len(),
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Nothing</span> =&gt; 0,
        }
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">is_empty</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #E5C2E5; font-weight: bold;">self</span>.len() == 0
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">insert</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">k</span>: <span style="color: #C2E5C2;">KeyItem</span>, <span style="color: #E5E5A0; font-weight: bold;">v</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; (<span style="color: #C2E5C2;">Associative</span>, <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;) {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> a) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">am</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> a);
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">e</span> = am.insert(k, v);
                (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(a), e)
            }
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> d) =&gt; <span style="color: #E5C2E5; font-weight: bold;">match</span> (k, v) {
                (<span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Word</span>(w), e) =&gt; {
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">e2</span> = e.clone();
                    <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Ok</span>(e) = <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Entry</span>::try_from(e) {
                        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">dm</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> d);
                        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">e</span> = dm.insert(w, e).and_then(|e| <span style="color: #C2E5C2;">Some</span>(<span style="color: #C2E5C2;">Item</span>::from(e)));
                        (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(d), e)
                    } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">TODO silently failing to insert here is bad</span>
                        <span style="color: #C2C2E5; font-weight: bold;">println!</span>(<span style="color: #DDC29A; font-weight: bold;">"Warning, failed to insert into dictionary: </span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{:?}</span><span style="color: #DDC29A; font-weight: bold;">"</span>, e2);
                        (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(d), <span style="color: #C2E5C2;">None</span>)
                    }
                }
                _ =&gt; (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(d), <span style="color: #C2E5C2;">None</span>),
            },
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(e) =&gt; e.insert(k, v),
            _ =&gt; <span style="color: #00fa9a; font-weight: bold;">todo!</span>(<span style="color: #DDC29A; font-weight: bold;">"insert Implementations for error, env etc"</span>),
        }
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">put</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">other</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Associative</span>, <span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">entry</span>: (<span style="color: #C2E5C2;">KeyItem</span>, <span style="color: #C2E5C2;">Item</span>) = other.try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>;
        <span style="color: #C2E5C2;">Ok</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>.insert(entry.0, entry.1).0)
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">join</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">other</span>: <span style="color: #C2E5C2;">Associative</span>) -&gt; <span style="color: #C2E5C2;">Associative</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> (<span style="color: #E5C2E5; font-weight: bold;">self</span>, other) {
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">same type means 2nd one wins.</span>
            <span style="color: #AD9292;">//</span><span style="color: #AD9292;">TODO: a little more complex for types that can be extended</span>
            (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">DictEntry</span>(_), <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">DictEntry</span>(other)) =&gt; {
                <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">DictEntry</span>(other)
            }
            (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> this), <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> other)) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">thism</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> this);
                thism.extend(other.inner().into_iter());
                <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(this)
            }
            (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(_), <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(other)) =&gt; <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(other),
            (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(_), <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(other)) =&gt; <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(other),
            (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Nothing</span>, <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Nothing</span>) =&gt; <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Nothing</span>,
            (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> this), other) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">thism</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> this);
                thism.extend(other.into_iter());
                <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(this)
            }
            (this, other) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">thisa</span>: <span style="color: #C2E5C2;">Association</span> = this.into();
                (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(thisa)).join(other)
            }
        }
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">get</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">k</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">KeyItem</span>) -&gt; <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(a) =&gt; a.get(k).and_then(|x| <span style="color: #C2E5C2;">Some</span>(x.clone())),
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(e) =&gt; e.data.get(k).and_then(|x| <span style="color: #C2E5C2;">Some</span>(x.clone())),
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(e) =&gt; <span style="color: #E5C2E5; font-weight: bold;">match</span> k {
                <span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Word</span>(s) =&gt; e.get(s.as_str()),
                _ =&gt; <span style="color: #C2E5C2;">None</span>,
            },
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">DictEntry</span>(d) =&gt; <span style="color: #E5C2E5; font-weight: bold;">match</span> k {
                <span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Word</span>(s) =&gt; d.get(s.as_str()),
                _ =&gt; <span style="color: #C2E5C2;">None</span>,
            },
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(d) =&gt; <span style="color: #E5C2E5; font-weight: bold;">match</span> k {
                <span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Word</span>(w) =&gt; d.get(w).and_then(|x| <span style="color: #C2E5C2;">Some</span>(x.clone().into())),
                _ =&gt; <span style="color: #C2E5C2;">None</span>,
            },
            <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Nothing</span> =&gt; <span style="color: #C2E5C2;">None</span>,
        }
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">contains_key</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">k</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">KeyItem</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(a) =&gt; a.contains_key(k),
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(e) =&gt; e.data.contains_key(k),
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(e) =&gt; e.contains_key(k),
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">DictEntry</span>(d) =&gt; d.contains_key(k),
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(d) =&gt; <span style="color: #E5C2E5; font-weight: bold;">match</span> k {
                <span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Word</span>(w) =&gt; d.contains_key(w),
                _ =&gt; <span style="color: #E5C2E5; font-weight: bold;">false</span>,
            },
            <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Nothing</span> =&gt; <span style="color: #E5C2E5; font-weight: bold;">false</span>,
        }
    }

    <span style="color: #AD9292;">//</span><span style="color: #AD9292;">TODO remove</span>
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">remove</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">k</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">KeyItem</span>) -&gt; (<span style="color: #C2E5C2;">Associative</span>, <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;) {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> a) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">am</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> a);
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">v</span> = am.remove(k);
                (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(a), v)
            }
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> d) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">dm</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> d);
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">v</span> = dm.remove(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Word</span>::try_from(k.clone()).unwrap_or_default());
                (<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(d), v.map(|v| v.into()))
            }
            _ =&gt; <span style="color: #00fa9a; font-weight: bold;">todo!</span>(<span style="color: #DDC29A; font-weight: bold;">"Removing from other associative types"</span>),
        }
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">take</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; (<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>, <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;) {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> a) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">maybe_key</span> = a.inner().keys().next().cloned();
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">am</span> = a.make_mut();
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">maybe_value</span> = maybe_key.as_ref().and_then(|key| am.remove(<span style="color: #ffffff; background-color: #000000;">&amp;</span>key));
                (
                    <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(a))),
                    maybe_key.map(|key| {
                        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter(
                            <span style="color: #00fa9a; font-weight: bold;">vec!</span>[<span style="color: #C2E5C2;">Item</span>::from(key), <span style="color: #C2E5C2;">Item</span>::from(maybe_value.unwrap_or_default())]
                                .into_iter(),
                        )
                        .into()
                    }),
                )
            }
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> d) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">maybe_key</span> = d.inner().keys().next().cloned();
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">dm</span> = d.make_mut();
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">maybe_value</span> = maybe_key.and_then(|key| dm.remove(<span style="color: #ffffff; background-color: #000000;">&amp;</span>key));
                (
                    <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(d))),
                    maybe_key.map(|key| {
                        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter(
                            <span style="color: #00fa9a; font-weight: bold;">vec!</span>[
                                <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Word</span>(key),
                                maybe_value.map(<span style="color: #C2E5C2;">Item</span>::from).unwrap_or(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">NOTHING</span>),
                            ]
                            .into_iter(),
                        )
                        .into()
                    }),
                )
            }
            _ =&gt; <span style="color: #00fa9a; font-weight: bold;">unimplemented!</span>(),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">IntoIterator</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Associative</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Entry</span>;
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">IntoIter</span> = <span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Iterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Entry</span>&gt;&gt;;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">into_iter</span>&lt;'<span style="color: #E5E5A0; font-weight: bold;">a</span>&gt;(<span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">IntoIter</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> a) =&gt; <span style="color: #C2E5C2;">Box</span>::new(a.inner().into_iter()),
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">DictEntry</span>(e) =&gt; <span style="color: #C2E5C2;">Box</span>::new(e.into_iter()),
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> d) =&gt; {
                <span style="color: #C2E5C2;">Box</span>::new(d.inner().into_iter().map(|(k, v)| (k.into(), v.into())))
            }
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(e) =&gt; e.into_iter(),
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(e) =&gt; e.into_iter(),
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Nothing</span> =&gt; <span style="color: #C2E5C2;">Box</span>::new(<span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">iter</span>::empty()),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Associative</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #E5E5A0; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">a</span>: <span style="color: #C2E5C2;">Associative</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter(a.into_iter())
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Associative</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">s</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
        <span style="color: #E5C2E5; font-weight: bold;">match</span> s {
            <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(a) =&gt; <span style="color: #C2E5C2;">Ok</span>(a),
            <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(i) =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"associative"</span>, i.into())),
            <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(i) =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"associative"</span>, i.into())),
            s =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(<span style="color: #C2E5C2;">Association</span>::try_from_iter(s)<span style="color: #C2C2E5; font-weight: bold;">?</span>)),
        }
    }
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">Convert anything that can be iterated over as Items, to an</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">Association. The items must be pairs that are</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">convertable to Entry, otherwise it will return an error.</span>
<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Association</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">new</span>() -&gt; <span style="color: #C2E5C2;">Association</span> {
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::wrap(<span style="color: #C2E5C2;">Newtype</span>(<span style="color: #C2E5C2;">HashMap</span>::new()))
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from_iter</span>&lt;<span style="color: #C2E5C2;">I</span>&gt;(<span style="color: #E5E5A0; font-weight: bold;">l</span>: <span style="color: #C2E5C2;">I</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Error</span>&gt;
    <span style="color: #E5C2E5; font-weight: bold;">where</span>
        <span style="color: #E5E5A0; font-weight: bold;">I</span>: <span style="color: #C2E5C2;">IntoIterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Item</span>&gt;,
    {
        <span style="color: #C2E5C2;">Ok</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::wrap(<span style="color: #C2E5C2;">Newtype</span>(
            l.into_iter()
                .map(|i| <span style="color: #C2E5C2;">Entry</span>::try_from(i.clone()))
                .collect::&lt;<span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">HashMap</span>&lt;<span style="color: #C2E5C2;">KeyItem</span>, <span style="color: #C2E5C2;">Item</span>&gt;, <span style="color: #C2E5C2;">Error</span>&gt;&gt;()<span style="color: #C2C2E5; font-weight: bold;">?</span>,
        )))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">FromIterator</span>&lt;<span style="color: #C2E5C2;">Entry</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Association</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from_iter</span>&lt;<span style="color: #C2E5C2;">I</span>&gt;(<span style="color: #E5E5A0; font-weight: bold;">iter</span>: <span style="color: #C2E5C2;">I</span>) -&gt; <span style="color: #C2E5C2;">Self</span>
    <span style="color: #E5C2E5; font-weight: bold;">where</span>
        <span style="color: #E5E5A0; font-weight: bold;">I</span>: <span style="color: #C2E5C2;">IntoIterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Entry</span>&gt;,
    {
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::wrap(<span style="color: #C2E5C2;">Newtype</span>(
            iter.into_iter().collect::&lt;<span style="color: #C2E5C2;">HashMap</span>&lt;<span style="color: #C2E5C2;">KeyItem</span>, <span style="color: #C2E5C2;">Item</span>&gt;&gt;(),
        ))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">FromIterator</span>&lt;<span style="color: #C2E5C2;">Entry</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #E5E5A0; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from_iter</span>&lt;<span style="color: #C2E5C2;">I</span>&gt;(<span style="color: #E5E5A0; font-weight: bold;">iter</span>: <span style="color: #C2E5C2;">I</span>) -&gt; <span style="color: #C2E5C2;">Self</span>
    <span style="color: #E5C2E5; font-weight: bold;">where</span>
        <span style="color: #E5E5A0; font-weight: bold;">I</span>: <span style="color: #C2E5C2;">IntoIterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Entry</span>&gt;,
    {
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::wrap(<span style="color: #C2E5C2;">Newtype</span>(
            iter.into_iter()
                .map(|e| e.into())
                .collect::&lt;<span style="color: #C2E5C2;">VecDeque</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;&gt;(),
        ))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">FromIterator</span>&lt;<span style="color: #C2E5C2;">KeyItem</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">KeyList</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from_iter</span>&lt;<span style="color: #C2E5C2;">I</span>&gt;(<span style="color: #E5E5A0; font-weight: bold;">iter</span>: <span style="color: #C2E5C2;">I</span>) -&gt; <span style="color: #C2E5C2;">Self</span>
    <span style="color: #E5C2E5; font-weight: bold;">where</span>
        <span style="color: #E5E5A0; font-weight: bold;">I</span>: <span style="color: #C2E5C2;">IntoIterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">KeyItem</span>&gt;,
    {
        <span style="color: #C2E5C2;">Newtype</span>(<span style="color: #A0E5E5; font-weight: bold;">sync</span>::<span style="color: #C2E5C2;">Arc</span>::new(<span style="color: #C2E5C2;">Newtype</span>(
            iter.into_iter().collect::&lt;<span style="color: #C2E5C2;">VecDeque</span>&lt;<span style="color: #C2E5C2;">KeyItem</span>&gt;&gt;(),
        )))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Entry</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">e</span>: <span style="color: #C2E5C2;">Entry</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter([<span style="color: #C2E5C2;">Item</span>::from(e.0), e.1]).into()
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Entry</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">s</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
        <span style="color: #E5C2E5; font-weight: bold;">if</span> s.len() != 2 {
            <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"pair"</span>, s.into()))
        } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">iter</span> = s.into_iter();
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">key</span>: <span style="color: #C2E5C2;">KeyItem</span> = iter.next().unwrap().try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>;
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">value</span> = iter.next().unwrap();
            <span style="color: #C2E5C2;">Ok</span>((key, value))
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Associative</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Association</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">a</span>: <span style="color: #C2E5C2;">Associative</span>) -&gt; <span style="color: #C2E5C2;">Association</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> a {
            <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(a) =&gt; a,
            a =&gt; a.into_iter().collect::&lt;<span style="color: #C2E5C2;">Association</span>&gt;(),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">AssociationContent</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">a</span>: <span style="color: #C2E5C2;">AssociationContent</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::wrap(a).into()
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Association</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">a</span>: <span style="color: #C2E5C2;">Association</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(a).into()
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Associative</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">a</span>: <span style="color: #C2E5C2;">Associative</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(a).into()
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org21527e6" class="outline-5">
<h5 id="org21527e6"><span class="section-number-5">1.4.2.4.</span> Error types</h5>
<div class="outline-text-5" id="text-1-4-2-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::types;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::associative <span style="color: #E5C2E5; font-weight: bold;">as</span> assoc;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::collection <span style="color: #E5C2E5; font-weight: bold;">as</span> coll;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::{<span style="color: #C2E5C2;">Int</span>, <span style="color: #C2E5C2;">Item</span>, <span style="color: #C2E5C2;">Word</span>};

<span style="color: #00fa9a; font-weight: bold;">#[derive(Clone, PartialEq)]</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">struct</span> <span style="color: #C2E5C2;">Error</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5E5A0; font-weight: bold;">data</span>: <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>,
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5E5A0; font-weight: bold;">is_handled</span>: <span style="color: #C2E5C2;">bool</span>,
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Error</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">create</span>(<span style="color: #E5E5A0; font-weight: bold;">asked</span>: <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>, <span style="color: #E5E5A0; font-weight: bold;">reason</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">str</span>, <span style="color: #E5E5A0; font-weight: bold;">actual</span>: <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;) -&gt; <span style="color: #C2E5C2;">Error</span> {
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">let bt = backtrace::Backtrace::new();</span>
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">data</span>: <span style="color: #C2E5C2;">Vec</span>&lt;(<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>, <span style="color: #C2E5C2;">Item</span>)&gt; = <span style="color: #00fa9a; font-weight: bold;">vec!</span>[
            (<span style="color: #DDC29A; font-weight: bold;">"type"</span>.into(), <span style="color: #DDC29A; font-weight: bold;">"error"</span>.into()),
            (<span style="color: #DDC29A; font-weight: bold;">"asked"</span>.into(), asked.into()),
            (<span style="color: #DDC29A; font-weight: bold;">"reason"</span>.into(), reason.to_string().into()),
            <span style="color: #AD9292;">//</span><span style="color: #AD9292;">("backtrace".into(), Item::String(format!("{:?}", bt))),</span>
        ];
        <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Some</span>(actual) = actual {
            data.push((<span style="color: #DDC29A; font-weight: bold;">"actual"</span>.into(), actual));
        }
        <span style="color: #C2E5C2;">Error</span> {
            <span style="color: #E5E5A0; font-weight: bold;">is_handled</span>: <span style="color: #E5C2E5; font-weight: bold;">false</span>,

            <span style="color: #E5E5A0; font-weight: bold;">data</span>: <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::from_iter(data),
        }
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">stack_underflow</span>() -&gt; <span style="color: #C2E5C2;">Error</span> {
        <span style="color: #C2E5C2;">Error</span>::create(
            <span style="color: #A0E5E5; font-weight: bold;">types</span>::wrap(<span style="color: #DDC29A; font-weight: bold;">"consume"</span>.into()),
            <span style="color: #DDC29A; font-weight: bold;">"not enough items on stack"</span>,
            <span style="color: #C2E5C2;">None</span>,
        )
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">undefined</span>(<span style="color: #E5E5A0; font-weight: bold;">w</span>: <span style="color: #C2E5C2;">Word</span>) -&gt; <span style="color: #C2E5C2;">Error</span> {
        <span style="color: #C2E5C2;">Error</span>::create(<span style="color: #A0E5E5; font-weight: bold;">types</span>::wrap(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Word</span>(w)), <span style="color: #DDC29A; font-weight: bold;">"word is not defined"</span>, <span style="color: #C2E5C2;">None</span>)
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">type_mismatch</span>(<span style="color: #E5E5A0; font-weight: bold;">asked</span>: <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>, <span style="color: #E5E5A0; font-weight: bold;">actual</span>: <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;) -&gt; <span style="color: #C2E5C2;">Error</span> {
        <span style="color: #C2E5C2;">Error</span>::create(asked, <span style="color: #DDC29A; font-weight: bold;">"type mismatch"</span>, actual)
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">division_by_zero</span>() -&gt; <span style="color: #C2E5C2;">Error</span> {
        <span style="color: #C2E5C2;">Error</span>::create(<span style="color: #A0E5E5; font-weight: bold;">types</span>::wrap(<span style="color: #DDC29A; font-weight: bold;">"/"</span>.into()), <span style="color: #DDC29A; font-weight: bold;">"division by zero"</span>, <span style="color: #C2E5C2;">None</span>)
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">expected</span>(<span style="color: #E5E5A0; font-weight: bold;">typestr</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">str</span>, <span style="color: #E5E5A0; font-weight: bold;">actual</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Error</span> {
        <span style="color: #C2E5C2;">Error</span>::type_mismatch(<span style="color: #A0E5E5; font-weight: bold;">types</span>::wrap(typestr.into()), <span style="color: #C2E5C2;">Some</span>(actual))
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">short_list</span>(<span style="color: #E5E5A0; font-weight: bold;">expected</span>: <span style="color: #C2E5C2;">Int</span>) -&gt; <span style="color: #C2E5C2;">Error</span> {
        <span style="color: #C2E5C2;">Error</span>::create(
            <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter([<span style="color: #DDC29A; font-weight: bold;">"count"</span>.into(), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(expected), <span style="color: #DDC29A; font-weight: bold;">"&gt;="</span>.into()]),
            <span style="color: #DDC29A; font-weight: bold;">"list had too few items"</span>,
            <span style="color: #C2E5C2;">None</span>,
        )
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">list_count</span>(<span style="color: #E5E5A0; font-weight: bold;">expected</span>: <span style="color: #C2E5C2;">Int</span>) -&gt; <span style="color: #C2E5C2;">Error</span> {
        <span style="color: #C2E5C2;">Error</span>::create(
            <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter([<span style="color: #DDC29A; font-weight: bold;">"count"</span>.into(), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(expected), <span style="color: #DDC29A; font-weight: bold;">"="</span>.into()]),
            <span style="color: #DDC29A; font-weight: bold;">"list had wrong number of items"</span>,
            <span style="color: #C2E5C2;">None</span>,
        )
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">parse</span>(<span style="color: #E5E5A0; font-weight: bold;">reason</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">str</span>) -&gt; <span style="color: #C2E5C2;">Error</span> {
        <span style="color: #C2E5C2;">Error</span>::create(<span style="color: #A0E5E5; font-weight: bold;">types</span>::wrap(<span style="color: #DDC29A; font-weight: bold;">"read"</span>.into()), reason, <span style="color: #C2E5C2;">None</span>)
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">test_assertion</span>(<span style="color: #E5E5A0; font-weight: bold;">program</span>: <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>, <span style="color: #E5E5A0; font-weight: bold;">expected</span>: <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>, <span style="color: #E5E5A0; font-weight: bold;">actual</span>: <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>) -&gt; <span style="color: #C2E5C2;">Error</span> {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">e</span> = <span style="color: #C2E5C2;">Error</span>::create(program, <span style="color: #DDC29A; font-weight: bold;">"assertion failed"</span>, <span style="color: #C2E5C2;">Some</span>(actual.into()));
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">d</span> = e.data.make_mut();
        d.insert(<span style="color: #DDC29A; font-weight: bold;">"expected"</span>.into(), expected.into());
        <span style="color: #E5C2E5; font-weight: bold;">return</span> e;
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">len</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">usize</span> {
        <span style="color: #E5C2E5; font-weight: bold;">self</span>.data.len()
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Error</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #E5E5A0; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">e</span>: <span style="color: #C2E5C2;">Error</span>) -&gt; <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span> {
        e.data
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Error</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(
                <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(e),
            ))) =&gt; <span style="color: #C2E5C2;">Ok</span>(e),
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(_)))
            | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(_)))
            | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(_)))
            | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(_))) =&gt; {
                <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"error"</span>, <span style="color: #C2E5C2;">Default</span>::default()))
            }
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(c)) =&gt; c.into_iter().try_into(),
            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"error"</span>, i)),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Iterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Item</span>&gt;&gt;&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Error</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Iterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Item</span>&gt;&gt;) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #AD9292;">//</span><span style="color: #AD9292;">TODO: this can't fail, can just be a From.</span>
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">Really though, Error should have predefined fields like Environment.</span>
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">data</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::try_from_iter(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
        <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Error</span> {
            data,
            <span style="color: #E5E5A0; font-weight: bold;">is_handled</span>: <span style="color: #E5C2E5; font-weight: bold;">false</span>,
        })
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Error</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">a</span>: <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> a {
            <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(e) =&gt; <span style="color: #C2E5C2;">Ok</span>(e),
            <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(a) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">if</span> a.get(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>::from(<span style="color: #DDC29A; font-weight: bold;">"type"</span>)) != <span style="color: #C2E5C2;">Some</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Item</span>::from(<span style="color: #DDC29A; font-weight: bold;">"error"</span>)) {
                    <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"error"</span>, a.into()))
                } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Error</span> {
                        <span style="color: #E5E5A0; font-weight: bold;">data</span>: a.clone(),
                        <span style="color: #E5E5A0; font-weight: bold;">is_handled</span>: <span style="color: #E5C2E5; font-weight: bold;">true</span>,
                    })
                }
            }
            i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"error"</span>, i.into())),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Error</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">e</span>: <span style="color: #C2E5C2;">Error</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(e).into()
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">IntoIterator</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Error</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Item</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Entry</span>;
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">IntoIter</span> = <span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Iterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Entry</span>&gt;&gt;;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">into_iter</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">IntoIter</span> {
        <span style="color: #C2E5C2;">Box</span>::new(
            <span style="color: #E5C2E5; font-weight: bold;">self</span>.data
                .inner()
                .into_iter()
                .chain(<span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">iter</span>::once((<span style="color: #DDC29A; font-weight: bold;">"handled"</span>.into(), <span style="color: #E5C2E5; font-weight: bold;">self</span>.is_handled.into()))),
        )
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc614200" class="outline-5">
<h5 id="orgc614200"><span class="section-number-5">1.4.2.5.</span> Dictionary types</h5>
<div class="outline-text-5" id="text-1-4-2-5">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::associative <span style="color: #E5C2E5; font-weight: bold;">as</span> assoc;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::collection <span style="color: #E5C2E5; font-weight: bold;">as</span> coll;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::*;

<span style="color: #00fa9a; font-weight: bold;">#[derive(Debug, Clone)]</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">struct</span> <span style="color: #C2E5C2;">Entry</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5E5A0; font-weight: bold;">examples</span>: <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>&gt;,
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5E5A0; font-weight: bold;">spec</span>: <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>&gt;,
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5E5A0; font-weight: bold;">definition</span>: <span style="color: #C2E5C2;">Definition</span>,
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Entry</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">len</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">usize</span> {
        3 <span style="color: #AD9292;">// </span><span style="color: #AD9292;">3 fields</span>
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">get</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">key</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">str</span>) -&gt; <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> key {
            <span style="color: #DDC29A; font-weight: bold;">"spec"</span> =&gt; <span style="color: #E5C2E5; font-weight: bold;">self</span>.spec.clone().and_then(|x| <span style="color: #C2E5C2;">Some</span>(x.into())),
            <span style="color: #DDC29A; font-weight: bold;">"examples"</span> =&gt; <span style="color: #E5C2E5; font-weight: bold;">self</span>.examples.clone().and_then(|x| <span style="color: #C2E5C2;">Some</span>(x.into())),
            <span style="color: #DDC29A; font-weight: bold;">"definition"</span> =&gt; <span style="color: #C2E5C2;">Some</span>(<span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>.definition.clone() {
                <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Definition</span>::<span style="color: #C2E5C2;">Axiom</span>(_) =&gt; <span style="color: #DDC29A; font-weight: bold;">"builtin"</span>.into(),
                <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Definition</span>::<span style="color: #C2E5C2;">Derived</span>(d) =&gt; d.into(),
            }),
            _ =&gt; <span style="color: #C2E5C2;">None</span>,
        }
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">contains_key</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">key</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #C2E5C2;">Word</span>::try_from(key.clone()).map_or(<span style="color: #E5C2E5; font-weight: bold;">false</span>, |w| <span style="color: #E5C2E5; font-weight: bold;">match</span> w.as_str() {
            <span style="color: #DDC29A; font-weight: bold;">"examples"</span> =&gt; <span style="color: #E5C2E5; font-weight: bold;">true</span>,
            <span style="color: #DDC29A; font-weight: bold;">"spec"</span> =&gt; <span style="color: #E5C2E5; font-weight: bold;">true</span>,
            <span style="color: #DDC29A; font-weight: bold;">"definition"</span> =&gt; <span style="color: #E5C2E5; font-weight: bold;">true</span>,
            _ =&gt; <span style="color: #E5C2E5; font-weight: bold;">false</span>,
        })
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Dictionary</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>&lt;<span style="color: #C2E5C2;">HashMap</span>&lt;<span style="color: #C2E5C2;">Word</span>, <span style="color: #C2E5C2;">Entry</span>&gt;&gt;;

<span style="color: #00fa9a; font-weight: bold;">#[derive(Clone)]</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">enum</span> <span style="color: #C2E5C2;">Definition</span> {
    <span style="color: #C2E5C2;">Axiom</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span>'<span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #C2E5C2;">StepFn</span>),
    <span style="color: #C2E5C2;">Derived</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>),
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">PartialEq</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Definition</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">eq</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">_</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Self</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">TODO actually implement this</span>
        <span style="color: #E5C2E5; font-weight: bold;">true</span>
    }
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">dictionary entries are equal if they have the same function reference,</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">no need to compare the function values</span>
<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">PartialEq</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Entry</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">eq</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">other</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Self</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #E5C2E5; font-weight: bold;">self</span>.definition == other.definition
            &amp;&amp; <span style="color: #E5C2E5; font-weight: bold;">self</span>.examples == other.examples
            &amp;&amp; <span style="color: #E5C2E5; font-weight: bold;">self</span>.spec == other.spec
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #A0E5E5; font-weight: bold;">fmt</span>::<span style="color: #C2E5C2;">Debug</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Definition</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">fmt</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">f</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #A0E5E5; font-weight: bold;">fmt</span>::<span style="color: #C2E5C2;">Formatter</span>) -&gt; <span style="color: #A0E5E5; font-weight: bold;">fmt</span>::<span style="color: #C2E5C2;">Result</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Definition</span>::<span style="color: #C2E5C2;">Axiom</span>(_) =&gt; f.write_str(<span style="color: #DDC29A; font-weight: bold;">"Builtin"</span>),
            <span style="color: #C2E5C2;">Definition</span>::<span style="color: #C2E5C2;">Derived</span>(d) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">ds</span> = f.debug_list();
                ds.entries(d.iter());
                ds.finish()
            }
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">IntoIterator</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Entry</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Item</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Entry</span>;
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">IntoIter</span> = <span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Iterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Entry</span>&gt;&gt;;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">into_iter</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">IntoIter</span> {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">v</span>: <span style="color: #C2E5C2;">Vec</span>&lt;(<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>, <span style="color: #C2E5C2;">Item</span>)&gt; = <span style="color: #00fa9a; font-weight: bold;">vec!</span>[(<span style="color: #DDC29A; font-weight: bold;">"definition"</span>.into(), {
            <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>.definition {
                <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Definition</span>::<span style="color: #C2E5C2;">Derived</span>(l) =&gt; l.into(),
                <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Definition</span>::<span style="color: #C2E5C2;">Axiom</span>(_) =&gt; <span style="color: #DDC29A; font-weight: bold;">"builtin-function"</span>.into(),
            }
        })];
        <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Some</span>(e) = <span style="color: #E5C2E5; font-weight: bold;">self</span>.examples {
            v.push((<span style="color: #DDC29A; font-weight: bold;">"examples"</span>.into(), e.into()));
        }
        <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Some</span>(s) = <span style="color: #E5C2E5; font-weight: bold;">self</span>.spec {
            v.push((<span style="color: #DDC29A; font-weight: bold;">"spec"</span>.into(), s.into()))
        }
        <span style="color: #C2E5C2;">Box</span>::new(v.into_iter().map(|kv| kv.into()))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Iterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Item</span>&gt;&gt;&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Entry</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">iter</span>: <span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Iterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Item</span>&gt;&gt;) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">examples</span>: <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>&gt; = <span style="color: #C2E5C2;">None</span>;
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">definition</span>: <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Definition</span>&gt; = <span style="color: #C2E5C2;">None</span>;
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">spec</span>: <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>&gt; = <span style="color: #C2E5C2;">None</span>;
        <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> <span style="color: #E5C2E5; font-weight: bold;">in</span> iter {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> (k, v): (<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>, <span style="color: #C2E5C2;">Item</span>) = i.try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>;
            <span style="color: #AD9292;">//</span><span style="color: #AD9292;">println!("k: {:?}, v: {:?}", k, v);</span>
            <span style="color: #E5C2E5; font-weight: bold;">if</span> k == <span style="color: #DDC29A; font-weight: bold;">"examples"</span>.into() {
                examples = <span style="color: #C2E5C2;">Some</span>(v.try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>);
            } <span style="color: #E5C2E5; font-weight: bold;">else</span> <span style="color: #E5C2E5; font-weight: bold;">if</span> k == <span style="color: #DDC29A; font-weight: bold;">"definition"</span>.into() {
                definition = <span style="color: #C2E5C2;">Some</span>(v.try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>);
            } <span style="color: #E5C2E5; font-weight: bold;">else</span> <span style="color: #E5C2E5; font-weight: bold;">if</span> k == <span style="color: #DDC29A; font-weight: bold;">"spec"</span>.into() {
                spec = <span style="color: #C2E5C2;">Some</span>(v.try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>);
            } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                <span style="color: #E5C2E5; font-weight: bold;">continue</span>;
            }
        }
        <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Entry</span> {
            examples,
            <span style="color: #E5E5A0; font-weight: bold;">definition</span>: definition.unwrap_or(<span style="color: #C2E5C2;">Definition</span>::<span style="color: #C2E5C2;">Derived</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::new())),
            spec,
        })
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Iterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Item</span>&gt;&gt;&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Dictionary</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">iter</span>: <span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Iterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Item</span>&gt;&gt;) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Error</span>&gt; {
        iter.map(|kv| &lt;(<span style="color: #C2E5C2;">Word</span>, <span style="color: #C2E5C2;">Entry</span>)&gt;::try_from(kv))
            .collect::&lt;<span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">HashMap</span>&lt;<span style="color: #C2E5C2;">Word</span>, <span style="color: #C2E5C2;">Entry</span>&gt;, <span style="color: #C2E5C2;">Error</span>&gt;&gt;()
            .map(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::wrap)
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Definition</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(i).and_then(|l| <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Definition</span>::<span style="color: #C2E5C2;">Derived</span>(l)))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Entry</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">s</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
        <span style="color: #E5C2E5; font-weight: bold;">match</span> s {
            <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">DictEntry</span>(d)) =&gt; <span style="color: #C2E5C2;">Ok</span>(d),
            c =&gt; c.into_iter().try_into(),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Entry</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #E5E5A0; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">d</span>: <span style="color: #C2E5C2;">Entry</span>) -&gt; <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span> {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">assoc</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::new();
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">a</span> = assoc.make_mut();
        d.examples
            .and_then(|l| a.insert(<span style="color: #DDC29A; font-weight: bold;">"examples"</span>.into(), l.into()));
        d.spec.and_then(|l| a.insert(<span style="color: #DDC29A; font-weight: bold;">"spec"</span>.into(), l.into()));
        <span style="color: #E5C2E5; font-weight: bold;">match</span> d.definition {
            <span style="color: #C2E5C2;">Definition</span>::<span style="color: #C2E5C2;">Derived</span>(d) =&gt; {
                a.insert(<span style="color: #DDC29A; font-weight: bold;">"definition"</span>.into(), d.into());
            }
            _ =&gt; {}
        }
        <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(assoc)
    }
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">impl TryFrom&lt;Associative&gt; for Entry {</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">type Error = Error;</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">fn try_from(d: Associative) -&gt; Result&lt;Self, Error&gt; {</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">// TODO: This should handle cases where there's no def present</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">// and return error</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">let (d, def) = d.remove(&amp;"definition".into());</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">let (d, examples) = d.remove(&amp;"examples".into());</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">let (_, spec) = d.remove(&amp;"spec".into());</span>

<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">Ok(Entry {</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">definition: if let Some(d) = def {</span>
<span style="color: #AD9292;">//                 </span><span style="color: #AD9292;">Definition::Derived(List::try_from(d).unwrap())</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">} else {</span>
<span style="color: #AD9292;">//                 </span><span style="color: #AD9292;">//Err(Error::expected("definition field"))?  use a</span>
<span style="color: #AD9292;">//                 </span><span style="color: #AD9292;">// dummy value, presumably if this is during</span>
<span style="color: #AD9292;">//                 </span><span style="color: #AD9292;">// bootstrap,the definition will be replaced later.</span>
<span style="color: #AD9292;">//                 </span><span style="color: #AD9292;">Definition::Derived(Arc::new(ListContent::new()))</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">},</span>

<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">// {Box::leak(Box::new(move |env: Environment| {</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">//    env.push(Item::Error(Error::undefined(w)))</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">//}))}</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">examples: examples.and_then(|i| List::try_from(i).ok()),</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">spec: spec.and_then(|i| List::try_from(i).ok()),</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">})</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">}</span>

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">impl TryFrom&lt;List&gt; for Entry {</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">type Error = Error;</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">fn try_from(l: List) -&gt; Result&lt;Self, Error&gt; {</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">let a: Associative = l.try_into()?;</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">a.try_into()</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">}</span>

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">impl TryFrom&lt;assoc::Associative&gt; for Dictionary {</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">type Error = Error;</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">fn try_from(a: assoc::Associative) -&gt; Result&lt;Self, Self::Error&gt; {</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">match a {</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">assoc::Associative::Dictionary(e) =&gt; Ok(e),</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">assoc::Associative::Assoc(a) =&gt; {</span>
<span style="color: #AD9292;">//                 </span><span style="color: #AD9292;">let h = rc_inner(&amp;a)</span>
<span style="color: #AD9292;">//                     </span><span style="color: #AD9292;">.into_iter()</span>
<span style="color: #AD9292;">//                     </span><span style="color: #AD9292;">.map(|(k, v)| {</span>
<span style="color: #AD9292;">//                         </span><span style="color: #AD9292;">let e: (Word, Entry) = (k.try_into()?, v.try_into()?);</span>
<span style="color: #AD9292;">//                         </span><span style="color: #AD9292;">Ok(e)</span>
<span style="color: #AD9292;">//                     </span><span style="color: #AD9292;">})</span>
<span style="color: #AD9292;">//                     </span><span style="color: #AD9292;">.collect::&lt;Result&lt;HashMap&lt;Word, Entry&gt;, Error&gt;&gt;()?;</span>
<span style="color: #AD9292;">//                 </span><span style="color: #AD9292;">Ok(Arc::new(h))</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">_ =&gt; Err(Error::expected("dictionary")),</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">}</span>

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">impl From&lt;Dictionary&gt; for assoc::Associative {</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">fn from(d: Dictionary) -&gt; Self {</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">Associative::Assoc(Arc::new(</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">rc_inner(&amp;d)</span>
<span style="color: #AD9292;">//                 </span><span style="color: #AD9292;">.into_iter()</span>
<span style="color: #AD9292;">//                 </span><span style="color: #AD9292;">.map(|(k, v)| (assoc::KeyItem::Word(k), Item::Entry(v)))</span>
<span style="color: #AD9292;">//                 </span><span style="color: #AD9292;">.collect(),</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">))</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">}</span>

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Dictionary</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">s</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
        <span style="color: #E5C2E5; font-weight: bold;">match</span> s {
            <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(d)) =&gt; <span style="color: #C2E5C2;">Ok</span>(d),
            c =&gt; c.into_iter().try_into(),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Entry</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">e</span>: <span style="color: #C2E5C2;">Entry</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(
            <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">DictEntry</span>(e),
        )))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Dictionary</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">d</span>: <span style="color: #C2E5C2;">Dictionary</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(
            <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Dictionary</span>(d),
        )))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;(<span style="color: #C2E5C2;">Word</span>, <span style="color: #C2E5C2;">Entry</span>)&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>((k, v): (<span style="color: #C2E5C2;">Word</span>, <span style="color: #C2E5C2;">Entry</span>)) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter([<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Word</span>(k.clone()), <span style="color: #C2E5C2;">Item</span>::from(v.clone())]).into()
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> (<span style="color: #C2E5C2;">Word</span>, <span style="color: #C2E5C2;">Entry</span>) {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">s</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
        <span style="color: #E5C2E5; font-weight: bold;">if</span> s.len() != 2 {
            <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"pair"</span>, s.into()))
        } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">iter</span> = s.into_iter();
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">key</span>: <span style="color: #C2E5C2;">Word</span> = iter.next().unwrap().try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>;
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">value</span>: <span style="color: #C2E5C2;">Entry</span> = iter.next().unwrap().try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>;
            <span style="color: #C2E5C2;">Ok</span>((key, value))
        }
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org0398d97" class="outline-5">
<h5 id="org0398d97"><span class="section-number-5">1.4.2.6.</span> Environment types</h5>
<div class="outline-text-5" id="text-1-4-2-6">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::axiom;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::serialize;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::*;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::{associative <span style="color: #E5C2E5; font-weight: bold;">as</span> assoc, collection <span style="color: #E5C2E5; font-weight: bold;">as</span> coll, dictionary <span style="color: #E5C2E5; font-weight: bold;">as</span> dict};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::future;

<span style="color: #00fa9a; font-weight: bold;">#[derive(Clone, PartialEq)]</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">struct</span> <span style="color: #C2E5C2;">Environment</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5E5A0; font-weight: bold;">stack</span>: <span style="color: #C2E5C2;">Stack</span>,
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5E5A0; font-weight: bold;">expression</span>: <span style="color: #C2E5C2;">Stack</span>,
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5E5A0; font-weight: bold;">dictionary</span>: <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Dictionary</span>,
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Environment</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">push</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Environment</span> {
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>.stack).push_front(i);
        <span style="color: #E5C2E5; font-weight: bold;">self</span>
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">pop</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>.stack).pop_front().unwrap()
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">push_expr</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Environment</span> {
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>.expression).push_front(i);
        <span style="color: #E5C2E5; font-weight: bold;">self</span>
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">pop_expr</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>.expression)
            .pop_front()
            .unwrap()
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">append_expression</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">items</span>: <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>) -&gt; <span style="color: #C2E5C2;">Environment</span> {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">expr</span> = <span style="color: #E5C2E5; font-weight: bold;">self</span>.expression.make_mut();
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">ct</span> = expr.len();
        expr.append(items.make_mut());
        expr.rotate_left(ct);
        <span style="color: #E5C2E5; font-weight: bold;">self</span>
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">tos</span>&lt;'<span style="color: #E5E5A0; font-weight: bold;">a</span>&gt;(<span style="color: #ffffff; background-color: #000000;">&amp;</span>'<span style="color: #E5E5A0; font-weight: bold;">a</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #ffffff; background-color: #000000;">&amp;</span>'<span style="color: #E5E5A0; font-weight: bold;">a</span> <span style="color: #C2E5C2;">Item</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">self</span>.stack.front()
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">len</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">usize</span> {
        3 <span style="color: #AD9292;">// </span><span style="color: #AD9292;">3 fields</span>
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">get</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">key</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">str</span>) -&gt; <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> key {
            <span style="color: #DDC29A; font-weight: bold;">"stack"</span> =&gt; <span style="color: #C2E5C2;">Some</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>.stack.clone().into()),
            <span style="color: #DDC29A; font-weight: bold;">"expression"</span> =&gt; <span style="color: #C2E5C2;">Some</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>.expression.clone().into()),
            <span style="color: #DDC29A; font-weight: bold;">"dictionary"</span> =&gt; <span style="color: #C2E5C2;">Some</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>.dictionary.clone().into()),
            _ =&gt; <span style="color: #C2E5C2;">None</span>,
        }
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">contains_key</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">key</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #C2E5C2;">Word</span>::try_from(key.clone()).map_or(<span style="color: #E5C2E5; font-weight: bold;">false</span>, |w| <span style="color: #E5C2E5; font-weight: bold;">match</span> w.as_str() {
            <span style="color: #DDC29A; font-weight: bold;">"stack"</span> =&gt; <span style="color: #E5C2E5; font-weight: bold;">true</span>,
            <span style="color: #DDC29A; font-weight: bold;">"expression"</span> =&gt; <span style="color: #E5C2E5; font-weight: bold;">true</span>,
            <span style="color: #DDC29A; font-weight: bold;">"dictionary"</span> =&gt; <span style="color: #E5C2E5; font-weight: bold;">true</span>,
            _ =&gt; <span style="color: #E5C2E5; font-weight: bold;">false</span>,
        })
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">insert</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">k</span>: <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>, <span style="color: #E5E5A0; font-weight: bold;">v</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; (<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>, <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;) {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> k {
            <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Word</span>(w) =&gt; <span style="color: #E5C2E5; font-weight: bold;">match</span> w.as_str() {
                <span style="color: #DDC29A; font-weight: bold;">"stack"</span> =&gt; {
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">l</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(v.clone());
                    <span style="color: #E5C2E5; font-weight: bold;">match</span> l {
                        <span style="color: #C2E5C2;">Ok</span>(l) =&gt; {
                            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">old</span> = <span style="color: #E5C2E5; font-weight: bold;">self</span>.stack.clone();
                            <span style="color: #E5C2E5; font-weight: bold;">self</span>.stack = l;
                            (<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>), <span style="color: #C2E5C2;">Some</span>(old.into()))
                        }
                        <span style="color: #C2E5C2;">Err</span>(_) =&gt; {
                            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">a</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::from_iter(<span style="color: #E5C2E5; font-weight: bold;">self</span>);
                            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">old</span> = a.inner().insert(k, v);
                            (<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(a), old)
                        }
                    }
                }
                <span style="color: #DDC29A; font-weight: bold;">"expression"</span> =&gt; {
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">l</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(v.clone());
                    <span style="color: #E5C2E5; font-weight: bold;">match</span> l {
                        <span style="color: #C2E5C2;">Ok</span>(l) =&gt; {
                            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">old</span> = <span style="color: #E5C2E5; font-weight: bold;">self</span>.expression.clone();
                            <span style="color: #E5C2E5; font-weight: bold;">self</span>.expression = l;
                            (<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>), <span style="color: #C2E5C2;">Some</span>(old.into()))
                        }
                        <span style="color: #C2E5C2;">Err</span>(_) =&gt; {
                            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">a</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::from_iter(<span style="color: #E5C2E5; font-weight: bold;">self</span>);
                            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">old</span> = a.inner().insert(k, v);
                            (<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(a), old)
                        }
                    }
                }
                <span style="color: #DDC29A; font-weight: bold;">"dictionary"</span> =&gt; {
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">d</span> = <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Dictionary</span>::try_from(v.clone());
                    <span style="color: #E5C2E5; font-weight: bold;">match</span> d {
                        <span style="color: #C2E5C2;">Ok</span>(d) =&gt; {
                            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">old</span> = <span style="color: #E5C2E5; font-weight: bold;">self</span>.dictionary.clone();
                            <span style="color: #E5C2E5; font-weight: bold;">self</span>.dictionary = d;
                            (<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>), <span style="color: #C2E5C2;">Some</span>(old.into()))
                        }
                        <span style="color: #C2E5C2;">Err</span>(_) =&gt; {
                            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">a</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::from_iter(<span style="color: #E5C2E5; font-weight: bold;">self</span>);
                            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">old</span> = a.inner().insert(k, v);
                            (<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(a), old)
                        }
                    }
                }
                k =&gt; {
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">a</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::from_iter(<span style="color: #E5C2E5; font-weight: bold;">self</span>);
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">old</span> = a.inner().insert(k.into(), v);
                    (<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(a), old)
                }
            },
            _ =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">a</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::from_iter(<span style="color: #E5C2E5; font-weight: bold;">self</span>);
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">old</span> = a.inner().insert(k, v);
                (<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Assoc</span>(a), old)
            }
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Iterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Item</span>&gt;&gt;&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Environment</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">iter</span>: <span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Iterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Item</span>&gt;&gt;) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">stack</span>: <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>&gt; = <span style="color: #C2E5C2;">None</span>;
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">expression</span>: <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>&gt; = <span style="color: #C2E5C2;">None</span>;
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">dictionary</span>: <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Dictionary</span>&gt; = <span style="color: #C2E5C2;">None</span>;
        <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> <span style="color: #E5C2E5; font-weight: bold;">in</span> iter {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> (k, v): (<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>, <span style="color: #C2E5C2;">Item</span>) = i.try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>;
            <span style="color: #E5C2E5; font-weight: bold;">if</span> k == <span style="color: #DDC29A; font-weight: bold;">"stack"</span>.into() {
                stack = <span style="color: #C2E5C2;">Some</span>(v.try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>)
            } <span style="color: #E5C2E5; font-weight: bold;">else</span> <span style="color: #E5C2E5; font-weight: bold;">if</span> k == <span style="color: #DDC29A; font-weight: bold;">"expression"</span>.into() {
                expression = <span style="color: #C2E5C2;">Some</span>(v.try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>)
            } <span style="color: #E5C2E5; font-weight: bold;">else</span> <span style="color: #E5C2E5; font-weight: bold;">if</span> k == <span style="color: #DDC29A; font-weight: bold;">"dictionary"</span>.into() {
                dictionary = <span style="color: #C2E5C2;">Some</span>(v.try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>)
            } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                <span style="color: #E5C2E5; font-weight: bold;">continue</span>;
            }
        }
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span> = <span style="color: #A0E5E5; font-weight: bold;">axiom</span>::standard_env(expression, stack);
        <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Some</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> d) = dictionary {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">edmut</span> = env.dictionary.make_mut();
            edmut.extend(d.inner().into_iter());
        }
        <span style="color: #C2E5C2;">Ok</span>(env)
    }
}
<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Environment</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">s</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;

        <span style="color: #E5C2E5; font-weight: bold;">match</span> s {
            <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(e)) =&gt; <span style="color: #C2E5C2;">Ok</span>(e),
            l =&gt; l.into_iter().try_into(),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(env).into()
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
        <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #A0E5E5; font-weight: bold;">future</span>::ready(env))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">IntoIterator</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Environment</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Item</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Entry</span>;
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">IntoIter</span> = <span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Iterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Entry</span>&gt;&gt;;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">into_iter</span>(<span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">IntoIter</span> {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">v</span>: <span style="color: #C2E5C2;">Vec</span>&lt;(<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>, <span style="color: #C2E5C2;">Item</span>)&gt; = <span style="color: #00fa9a; font-weight: bold;">vec!</span>[
            (<span style="color: #DDC29A; font-weight: bold;">"stack"</span>.into(), <span style="color: #E5C2E5; font-weight: bold;">self</span>.stack.into()),
            (<span style="color: #DDC29A; font-weight: bold;">"expression"</span>.into(), <span style="color: #E5C2E5; font-weight: bold;">self</span>.expression.into()),
            (<span style="color: #DDC29A; font-weight: bold;">"dictionary"</span>.into(), <span style="color: #E5C2E5; font-weight: bold;">self</span>.dictionary.into()),
        ];
        <span style="color: #C2E5C2;">Box</span>::new(v.into_iter().map(|kv| kv.into()))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #A0E5E5; font-weight: bold;">serialize</span>::<span style="color: #C2E5C2;">Display</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Environment</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">representation</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">assoc</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::from_iter(<span style="color: #E5C2E5; font-weight: bold;">self</span>.clone());
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">am</span> = assoc.make_mut();
        am.remove(<span style="color: #ffffff; background-color: #000000;">&amp;</span>(<span style="color: #DDC29A; font-weight: bold;">"dictionary"</span>.into()));
        assoc.into()
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgcc05310" class="outline-5">
<h5 id="orgcc05310"><span class="section-number-5">1.4.2.7.</span> Cryptographic primitives</h5>
<div class="outline-text-5" id="text-1-4-2-7">
<p>
We'll implement certain cryptography functions in rust and make kcats
words for them (hashing, encryption, signing)
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">axiom</span>::<span style="color: #C2E5C2;">ItemResult</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::{associative <span style="color: #E5C2E5; font-weight: bold;">as</span> assoc, <span style="color: #A0E5E5; font-weight: bold;">error</span>::<span style="color: #C2E5C2;">Error</span>, <span style="color: #C2E5C2;">Bytes</span>, <span style="color: #C2E5C2;">Item</span>};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">core</span>::<span style="color: #A0E5E5; font-weight: bold;">ops</span>::<span style="color: #C2E5C2;">Deref</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">ed25519_dalek</span> <span style="color: #E5C2E5; font-weight: bold;">as</span> signing;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">ed25519_dalek</span>::{<span style="color: #C2E5C2;">Signer</span>, <span style="color: #C2E5C2;">Verifier</span>};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">rand_core</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">rand_core</span>::{<span style="color: #C2E5C2;">CryptoRng</span>, <span style="color: #C2E5C2;">RngCore</span>};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">sha2</span>::{<span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #C2E5C2;">Digest</span>};

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">hash</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">b</span> = <span style="color: #C2E5C2;">Bytes</span>::try_from(i).unwrap();
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #A0E5E5; font-weight: bold;">sha2</span>::<span style="color: #C2E5C2;">Sha256</span>::digest(b).deref().to_vec().into())
}

<span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Value</span> = <span style="color: #C2E5C2;">Vec</span>&lt;<span style="color: #C2E5C2;">u8</span>&gt;;

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">struct</span> <span style="color: #C2E5C2;">SeededRNG</span> {
    <span style="color: #E5E5A0; font-weight: bold;">seed</span>: <span style="color: #C2E5C2;">Value</span>,
    <span style="color: #E5E5A0; font-weight: bold;">salt</span>: <span style="color: #C2E5C2;">Value</span>,
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">SeededRNG</span> {
    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">Hash of seed|value</span>
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">hash</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Vec</span>&lt;<span style="color: #C2E5C2;">u8</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">v</span> = <span style="color: #E5C2E5; font-weight: bold;">self</span>.seed.clone();
        v.extend(<span style="color: #E5C2E5; font-weight: bold;">self</span>.salt.clone());
        <span style="color: #A0E5E5; font-weight: bold;">sha2</span>::<span style="color: #C2E5C2;">Sha256</span>::digest(v.as_slice()).deref().to_vec()
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">RngCore</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">SeededRNG</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">next_u32</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">u32</span> {
        <span style="color: #A0E5E5; font-weight: bold;">rand_core</span>::<span style="color: #A0E5E5; font-weight: bold;">impls</span>::next_u32_via_fill(<span style="color: #E5C2E5; font-weight: bold;">self</span>)
    }

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">next_u64</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">u64</span> {
        <span style="color: #A0E5E5; font-weight: bold;">rand_core</span>::<span style="color: #A0E5E5; font-weight: bold;">impls</span>::next_u64_via_fill(<span style="color: #E5C2E5; font-weight: bold;">self</span>)
    }

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">fill_bytes</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">dest</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> [<span style="color: #C2E5C2;">u8</span>]) {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">l</span> = dest.len();
        dest.copy_from_slice(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>.hash()[..l]);
    }

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_fill_bytes</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">dest</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> [<span style="color: #C2E5C2;">u8</span>]) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;(), <span style="color: #A0E5E5; font-weight: bold;">rand_core</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">self</span>.fill_bytes(dest);
        <span style="color: #C2E5C2;">Ok</span>(())
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">CryptoRng</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">SeededRNG</span> {}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">key</span>(<span style="color: #E5E5A0; font-weight: bold;">seed</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">sbs</span>: <span style="color: #C2E5C2;">Bytes</span> = seed.try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">kp</span> = <span style="color: #A0E5E5; font-weight: bold;">signing</span>::<span style="color: #C2E5C2;">Keypair</span>::generate(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #C2E5C2;">SeededRNG</span> {
        <span style="color: #E5E5A0; font-weight: bold;">seed</span>: <span style="color: #00fa9a; font-weight: bold;">vec!</span>[],
        <span style="color: #E5E5A0; font-weight: bold;">salt</span>: sbs,
    });
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::from_iter([
        (<span style="color: #DDC29A; font-weight: bold;">"type"</span>.into(), <span style="color: #DDC29A; font-weight: bold;">"elliptic-curve-key"</span>.into()),
        (<span style="color: #DDC29A; font-weight: bold;">"secret"</span>.into(), kp.secret.as_ref().to_vec().into()),
        (<span style="color: #DDC29A; font-weight: bold;">"public"</span>.into(), kp.public.as_ref().to_vec().into()),
    ])
    .into())
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #E5E5A0; font-weight: bold;">signing</span>::<span style="color: #C2E5C2;">Keypair</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">sk</span>: <span style="color: #A0E5E5; font-weight: bold;">signing</span>::<span style="color: #C2E5C2;">SecretKey</span> = i.try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>;
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">pk</span>: <span style="color: #A0E5E5; font-weight: bold;">signing</span>::<span style="color: #C2E5C2;">PublicKey</span> = (<span style="color: #ffffff; background-color: #000000;">&amp;</span>sk).into();
        <span style="color: #C2E5C2;">Ok</span>(<span style="color: #A0E5E5; font-weight: bold;">signing</span>::<span style="color: #C2E5C2;">Keypair</span> {
            <span style="color: #E5E5A0; font-weight: bold;">secret</span>: sk,
            <span style="color: #E5E5A0; font-weight: bold;">public</span>: pk,
        })
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #E5E5A0; font-weight: bold;">signing</span>::<span style="color: #C2E5C2;">SecretKey</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">a</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
        <span style="color: #E5C2E5; font-weight: bold;">if</span> a.get(&amp;<span style="color: #DDC29A; font-weight: bold;">"type"</span>.into()) == <span style="color: #C2E5C2;">Some</span>(<span style="color: #DDC29A; font-weight: bold;">"elliptic-curve-key"</span>.into()) {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">sk</span> = <span style="color: #A0E5E5; font-weight: bold;">signing</span>::<span style="color: #C2E5C2;">SecretKey</span>::from_bytes(
                <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Bytes</span>::try_from(
                    a.get(&amp;<span style="color: #DDC29A; font-weight: bold;">"secret"</span>.into())
                        .ok_or_else(|| <span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"secret"</span>, <span style="color: #C2E5C2;">Default</span>::default()))<span style="color: #C2C2E5; font-weight: bold;">?</span>,
                )<span style="color: #C2C2E5; font-weight: bold;">?</span>[..],
            )
            .map_err(|_e| <span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"valid-secret-key"</span>, <span style="color: #C2E5C2;">Default</span>::default()))<span style="color: #C2C2E5; font-weight: bold;">?</span>;
            <span style="color: #C2E5C2;">Ok</span>(sk)
        } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
            <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"keypair"</span>, a.clone().into()))
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">TryFrom</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #E5E5A0; font-weight: bold;">signing</span>::<span style="color: #C2E5C2;">PublicKey</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Error</span> = <span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">try_from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Self</span>, <span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">a</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
        <span style="color: #E5C2E5; font-weight: bold;">if</span> a.get(&amp;<span style="color: #DDC29A; font-weight: bold;">"type"</span>.into()) == <span style="color: #C2E5C2;">Some</span>(<span style="color: #DDC29A; font-weight: bold;">"elliptic-curve-key"</span>.into()) {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">pk</span> = <span style="color: #A0E5E5; font-weight: bold;">signing</span>::<span style="color: #C2E5C2;">PublicKey</span>::from_bytes(
                <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Bytes</span>::try_from(
                    a.get(&amp;<span style="color: #DDC29A; font-weight: bold;">"public"</span>.into())
                        .ok_or_else(|| <span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"public"</span>, <span style="color: #C2E5C2;">Default</span>::default()))<span style="color: #C2C2E5; font-weight: bold;">?</span>,
                )<span style="color: #C2C2E5; font-weight: bold;">?</span>[..],
            )
            .map_err(|_e| <span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"valid-public-key"</span>, <span style="color: #C2E5C2;">Default</span>::default()))<span style="color: #C2C2E5; font-weight: bold;">?</span>;
            <span style="color: #C2E5C2;">Ok</span>(pk)
        } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
            <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"public-key"</span>, a.clone().into()))
        }
    }
}
<span style="color: #AD9292;">//</span><span style="color: #AD9292;">TODO: we can only call sign from a keypair, so we may want to assume</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">that we have either the kp, or just the secret key.</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">sign</span>(<span style="color: #E5E5A0; font-weight: bold;">k</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">m</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">kp</span>: <span style="color: #A0E5E5; font-weight: bold;">signing</span>::<span style="color: #C2E5C2;">Keypair</span> = k.try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">message</span>: <span style="color: #C2E5C2;">Bytes</span> = m.try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">signature</span>: <span style="color: #A0E5E5; font-weight: bold;">signing</span>::<span style="color: #C2E5C2;">Signature</span> = kp.sign(<span style="color: #ffffff; background-color: #000000;">&amp;</span>message);
    <span style="color: #C2E5C2;">Ok</span>(signature.as_ref().to_vec().into())
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">verify</span>(<span style="color: #E5E5A0; font-weight: bold;">k</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">m</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">s</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">pk</span>: <span style="color: #A0E5E5; font-weight: bold;">signing</span>::<span style="color: #C2E5C2;">PublicKey</span> = k.try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">mbs</span>: <span style="color: #C2E5C2;">Bytes</span> = m.try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">sbs</span>: <span style="color: #C2E5C2;">Bytes</span> = s.try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">sig</span> = <span style="color: #A0E5E5; font-weight: bold;">signing</span>::<span style="color: #C2E5C2;">Signature</span>::from_bytes(<span style="color: #ffffff; background-color: #000000;">&amp;</span>sbs)
        .map_err(|_e| <span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"signature"</span>, <span style="color: #C2E5C2;">Default</span>::default()))<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #C2E5C2;">Ok</span>(pk
        .verify(<span style="color: #ffffff; background-color: #000000;">&amp;</span>mbs, <span style="color: #ffffff; background-color: #000000;">&amp;</span>sig)
        .map(|_| <span style="color: #C2E5C2;">Item</span>::from(<span style="color: #E5C2E5; font-weight: bold;">true</span>))
        .unwrap_or_default())
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org1b0e4df" class="outline-4">
<h4 id="org1b0e4df"><span class="section-number-4">1.4.3.</span> Serialization</h4>
<div class="outline-text-4" id="text-1-4-3">
<p>
We'll define how kcats data structure are parsed and written (for
example, in order to read/write to/from disk).
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">extern</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span> edn_format;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #A0E5E5; font-weight: bold;">environment</span>::<span style="color: #C2E5C2;">Environment</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::{associative <span style="color: #E5C2E5; font-weight: bold;">as</span> assoc, collection <span style="color: #E5C2E5; font-weight: bold;">as</span> coll, <span style="color: #A0E5E5; font-weight: bold;">error</span>::<span style="color: #C2E5C2;">Error</span>, *};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">base64</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">collections</span>::<span style="color: #C2E5C2;">VecDeque</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::fmt;

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">trait</span> <span style="color: #C2E5C2;">Display</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">representation</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Item</span>;
}

<span style="color: #E5C2E5; font-weight: bold;">const</span> <span style="color: #E5E5A0; font-weight: bold;">BYTE_TAG</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">str</span> = <span style="color: #DDC29A; font-weight: bold;">"b64"</span>;

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">to_item</span>(<span style="color: #E5E5A0; font-weight: bold;">item</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Item</span>, <span style="color: #C2E5C2;">Error</span>&gt; {
    <span style="color: #AD9292;">//</span><span style="color: #AD9292;">println!("to item {:?}", item);</span>
    <span style="color: #E5C2E5; font-weight: bold;">match</span> item {
        <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">Integer</span>(i) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(*i)),
        <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">Vector</span>(v) =&gt; <span style="color: #C2E5C2;">Ok</span>({
            <span style="color: #E5C2E5; font-weight: bold;">if</span> v.is_empty() {
                <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">NOTHING</span>
            } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter(
                    v.iter()
                        .map(|i| to_item(i))
                        .collect::&lt;<span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Vec</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;, <span style="color: #C2E5C2;">Error</span>&gt;&gt;()<span style="color: #C2C2E5; font-weight: bold;">?</span>,
                )
                .into()
            }
        }),
        <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">Symbol</span>(s) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Word</span>(s.to_string().into())),
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">we don't have booleans in kcats, so if we see 'false' that</span>
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">is the word false which is not defined in the base</span>
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">language, but might be user-defined later.</span>
        <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">Boolean</span>(b) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #E5C2E5; font-weight: bold;">if</span> *b { <span style="color: #DDC29A; font-weight: bold;">"true"</span>.into() } <span style="color: #E5C2E5; font-weight: bold;">else</span> { <span style="color: #DDC29A; font-weight: bold;">"false"</span>.into() }),
        <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">String</span>(s) =&gt; <span style="color: #C2E5C2;">Ok</span>(s.to_string().into()),
        <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">Float</span>(f) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(f.into_inner())),
        <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">TaggedElement</span>(tag, e) =&gt; {
            <span style="color: #E5C2E5; font-weight: bold;">if</span> *tag == <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Symbol</span>::from_name(<span style="color: #C2E5C2;">BYTE_TAG</span>) {
                <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">String</span>(s) = <span style="color: #ffffff; background-color: #000000;">&amp;</span>**e {
                    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #A0E5E5; font-weight: bold;">base64</span>::decode(s).unwrap().into())
                } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                    <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::parse(<span style="color: #DDC29A; font-weight: bold;">"Invalid tag datatype for byte literal"</span>))
                }
            } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::parse(<span style="color: #DDC29A; font-weight: bold;">"Unsupported tag"</span>))
            }
        }
        <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">Character</span>(c) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Char</span>(*c)),
        _ =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::parse(<span style="color: #DDC29A; font-weight: bold;">"Unsupported data literal"</span>)),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from_item</span>(<span style="color: #E5E5A0; font-weight: bold;">item</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> item {
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">dictionaries are big and it's ugly to print them for</span>
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">environments.</span>
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(
            <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(e),
        ))) =&gt; from_item(<span style="color: #ffffff; background-color: #000000;">&amp;</span>e.representation()),
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i) =&gt; <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">Integer</span>(*i),
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(f) =&gt; <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::from(*f),
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Char</span>(c) =&gt; <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">Character</span>(*c),
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(s))) =&gt; {
            <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">String</span>(s.to_string())
        }
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(bs))) =&gt; {
            <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">TaggedElement</span>(
                <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Symbol</span>::from_name(<span style="color: #DDC29A; font-weight: bold;">"b64"</span>),
                <span style="color: #C2E5C2;">Box</span>::new(<span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">String</span>(<span style="color: #A0E5E5; font-weight: bold;">base64</span>::encode(bs))),
            )
        }
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(s))) =&gt; {
            <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">String</span>(s.to_string())
        }
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(bs))) =&gt; {
            <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">TaggedElement</span>(
                <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Symbol</span>::from_name(<span style="color: #DDC29A; font-weight: bold;">"b64"</span>),
                <span style="color: #C2E5C2;">Box</span>::new(<span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">String</span>(<span style="color: #A0E5E5; font-weight: bold;">base64</span>::encode(bs))),
            )
        }
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(v)) =&gt; <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">Vector</span>(
            v.clone()
                .into_iter()
                .map(|i| from_item(<span style="color: #ffffff; background-color: #000000;">&amp;</span>i))
                .collect::&lt;<span style="color: #C2E5C2;">Vec</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>&gt;&gt;(),
        ),
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(v)) =&gt; {
            from_item(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(v.clone())))
        }
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Word</span>(w) =&gt; <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Value</span>::<span style="color: #C2E5C2;">Symbol</span>(<span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Symbol</span>::from_name(w)),
        <span style="color: #AD9292;">//</span><span style="color: #AD9292;">Item::Entry(w) =&gt; edn_format::Value::Symbol(edn_format::Symbol::from_name(&amp;w.word)),</span>
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Out</span>(o)) =&gt; from_item(<span style="color: #ffffff; background-color: #000000;">&amp;</span>o.representation()),
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Tunnel</span>(t)) =&gt; from_item(<span style="color: #ffffff; background-color: #000000;">&amp;</span>t.representation()),
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">In</span>(i)) =&gt; from_item(<span style="color: #ffffff; background-color: #000000;">&amp;</span>i.representation()),
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Tunnel</span>(t)) =&gt; from_item(<span style="color: #ffffff; background-color: #000000;">&amp;</span>t.representation()),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">parse</span>(<span style="color: #E5E5A0; font-weight: bold;">s</span>: <span style="color: #C2E5C2;">String</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>, <span style="color: #C2E5C2;">Error</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">parser</span> = <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">Parser</span>::from_iter(s.chars(), <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::<span style="color: #C2E5C2;">ParserOptions</span>::default());
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter(
        parser
            .map(<span style="color: #E5C2E5; font-weight: bold;">move</span> |r| <span style="color: #E5C2E5; font-weight: bold;">match</span> r {
                <span style="color: #C2E5C2;">Ok</span>(expr) =&gt; <span style="color: #C2E5C2;">Ok</span>(to_item(<span style="color: #ffffff; background-color: #000000;">&amp;</span>expr)<span style="color: #C2C2E5; font-weight: bold;">?</span>),
                <span style="color: #C2E5C2;">Err</span>(_) =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::parse(<span style="color: #DDC29A; font-weight: bold;">"Invalid edn"</span>)),
            })
            .collect::&lt;<span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Vec</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;, <span style="color: #C2E5C2;">Error</span>&gt;&gt;()<span style="color: #C2C2E5; font-weight: bold;">?</span>,
    ))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">emit</span>(<span style="color: #E5E5A0; font-weight: bold;">item</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">String</span> {
    <span style="color: #A0E5E5; font-weight: bold;">edn_format</span>::emit_str(<span style="color: #ffffff; background-color: #000000;">&amp;</span>from_item(item))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">emit_all</span>(<span style="color: #E5E5A0; font-weight: bold;">items</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">VecDeque</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;) -&gt; <span style="color: #C2E5C2;">String</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">s</span>: <span style="color: #C2E5C2;">String</span> = <span style="color: #C2E5C2;">String</span>::new();
    <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> <span style="color: #E5C2E5; font-weight: bold;">in</span> items {
        s.push_str(<span style="color: #ffffff; background-color: #000000;">&amp;</span>emit(<span style="color: #ffffff; background-color: #000000;">&amp;</span>i));
        s.push_str(<span style="color: #DDC29A; font-weight: bold;">" "</span>.into());
    }
    s.pop();
    <span style="color: #E5C2E5; font-weight: bold;">return</span> s;
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">print out envs in error messages</span>
<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #A0E5E5; font-weight: bold;">fmt</span>::<span style="color: #C2E5C2;">Debug</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Environment</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">fmt</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">f</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #A0E5E5; font-weight: bold;">fmt</span>::<span style="color: #C2E5C2;">Formatter</span>) -&gt; <span style="color: #A0E5E5; font-weight: bold;">fmt</span>::<span style="color: #C2E5C2;">Result</span> {
        <span style="color: #00fa9a; font-weight: bold;">write!</span>(
            f,
            <span style="color: #DDC29A; font-weight: bold;">"{{ stack: {}, expression: {} }}"</span>,
            emit(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Item</span>::from(<span style="color: #E5C2E5; font-weight: bold;">self</span>.stack.clone())),
            emit(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Item</span>::from(<span style="color: #E5C2E5; font-weight: bold;">self</span>.expression.clone())),
        )
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #A0E5E5; font-weight: bold;">fmt</span>::<span style="color: #C2E5C2;">Debug</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Error</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">fmt</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">f</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #A0E5E5; font-weight: bold;">fmt</span>::<span style="color: #C2E5C2;">Formatter</span>) -&gt; <span style="color: #A0E5E5; font-weight: bold;">fmt</span>::<span style="color: #C2E5C2;">Result</span> {
        <span style="color: #C2C2E5; font-weight: bold;">write!</span>(f, <span style="color: #DDC29A; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{}</span><span style="color: #DDC29A; font-weight: bold;">"</span>, emit(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Item</span>::from(<span style="color: #E5C2E5; font-weight: bold;">self</span>.data.clone())))
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org8acf252" class="outline-4">
<h4 id="org8acf252"><span class="section-number-4">1.4.4.</span> Builtin words</h4>
<div class="outline-text-4" id="text-1-4-4">
<p>
We'll define some words as axioms (not in terms of other words, only defined in Rust). 
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">super</span>::serialize;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::pipes;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::associative <span style="color: #E5C2E5; font-weight: bold;">as</span> assoc;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::collection <span style="color: #E5C2E5; font-weight: bold;">as</span> coll;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::dictionary <span style="color: #E5C2E5; font-weight: bold;">as</span> dict;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #A0E5E5; font-weight: bold;">environment</span>::<span style="color: #C2E5C2;">Environment</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #A0E5E5; font-weight: bold;">error</span>::<span style="color: #C2E5C2;">Error</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::*;

<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">futures</span>::<span style="color: #A0E5E5; font-weight: bold;">future</span>::<span style="color: #C2E5C2;">FutureExt</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">num_integer</span>::<span style="color: #C2E5C2;">Roots</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">collections</span>::<span style="color: #C2E5C2;">HashMap</span>;
<span style="color: #AD9292;">//</span><span style="color: #AD9292;">use std::future::Future;</span>
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::mem;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">ops</span>::<span style="color: #C2E5C2;">Range</span>;

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">ItemResult</span> = <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Item</span>, <span style="color: #C2E5C2;">Error</span>&gt;;

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">ItemResult</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">ItemResult</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
            <span style="color: #C2E5C2;">Ok</span>(i) =&gt; i,
            <span style="color: #C2E5C2;">Err</span>(e) =&gt; e.into(),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">f_stack1</span>(<span style="color: #E5E5A0; font-weight: bold;">f</span>: <span style="color: #E5C2E5; font-weight: bold;">fn</span>(<span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span>) -&gt; <span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Fn</span>(<span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">move</span> |<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>| {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">x</span> = env.pop();
        env.push(<span style="color: #C2E5C2;">Item</span>::from(f(x))).into()
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">f_stack2</span>(<span style="color: #E5E5A0; font-weight: bold;">f</span>: <span style="color: #E5C2E5; font-weight: bold;">fn</span>(<span style="color: #C2E5C2;">Item</span>, <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span>) -&gt; <span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Fn</span>(<span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">move</span> |<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>| {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">x</span> = env.pop();
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">y</span> = env.pop();
        env.push(<span style="color: #C2E5C2;">Item</span>::from(f(y, x))).into()
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">f_stack3</span>(<span style="color: #E5E5A0; font-weight: bold;">f</span>: <span style="color: #E5C2E5; font-weight: bold;">fn</span>(<span style="color: #C2E5C2;">Item</span>, <span style="color: #C2E5C2;">Item</span>, <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span>) -&gt; <span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Fn</span>(<span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">move</span> |<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>| {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">x</span> = env.pop();
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">y</span> = env.pop();
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">z</span> = env.pop();
        env.push(<span style="color: #C2E5C2;">Item</span>::from(f(z, y, x))).into()
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">f_stack2_async</span>(
    <span style="color: #E5E5A0; font-weight: bold;">f</span>: <span style="color: #E5C2E5; font-weight: bold;">fn</span>(<span style="color: #C2E5C2;">Item</span>, <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">ItemResult</span>&gt;,
) -&gt; <span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Fn</span>(<span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">move</span> |<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>| {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">x</span> = env.pop();
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">y</span> = env.pop();
        <span style="color: #C2E5C2;">Box</span>::pin(f(x, y).map(|r| env.push(<span style="color: #C2E5C2;">Item</span>::from(r))))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">update_axiom_entries</span>(
    <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">d</span>: <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Dictionary</span>,
    <span style="color: #E5E5A0; font-weight: bold;">updates</span>: <span style="color: #C2E5C2;">Vec</span>&lt;(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">str</span>, <span style="color: #ffffff; background-color: #000000;">&amp;</span>'<span style="color: #E5C2E5; font-weight: bold;">static</span> <span style="color: #C2E5C2;">StepFn</span>)&gt;,
) -&gt; <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Dictionary</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">dm</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> d);
    <span style="color: #E5C2E5; font-weight: bold;">for</span> (w, f) <span style="color: #E5C2E5; font-weight: bold;">in</span> updates {
        dm.entry(<span style="color: #C2E5C2;">Word</span>::from(w)).and_modify(|e| {
            e.definition = <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Definition</span>::<span style="color: #C2E5C2;">Axiom</span>(f);
        });
    }
    d
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">add_builtins</span>(<span style="color: #E5E5A0; font-weight: bold;">d</span>: <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Dictionary</span>) -&gt; <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Dictionary</span> {
    update_axiom_entries(
        d,
        <span style="color: #00fa9a; font-weight: bold;">vec!</span>[
            (<span style="color: #DDC29A; font-weight: bold;">"*"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(mult)))),
            (<span style="color: #DDC29A; font-weight: bold;">"+"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(plus)))),
            (<span style="color: #DDC29A; font-weight: bold;">"++lookup"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(lookup)))),
            (<span style="color: #DDC29A; font-weight: bold;">"++sort"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(sort_by_key)))),
            (<span style="color: #DDC29A; font-weight: bold;">"-"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(minus)))),
            (<span style="color: #DDC29A; font-weight: bold;">"/"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(div)))),
            (<span style="color: #DDC29A; font-weight: bold;">"&lt;"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(lt)))),
            (<span style="color: #DDC29A; font-weight: bold;">"&lt;="</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(lte)))),
            (<span style="color: #DDC29A; font-weight: bold;">"="</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(eq)))),
            (<span style="color: #DDC29A; font-weight: bold;">"&gt;"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(gt)))),
            (<span style="color: #DDC29A; font-weight: bold;">"&gt;="</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(gte)))),
            (<span style="color: #DDC29A; font-weight: bold;">"abs"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(abs)))),
            (<span style="color: #DDC29A; font-weight: bold;">"and"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(and)))),
            (<span style="color: #DDC29A; font-weight: bold;">"animate"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(animate))),
            (<span style="color: #DDC29A; font-weight: bold;">"assign"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack3(assign)))),
            (<span style="color: #DDC29A; font-weight: bold;">"association"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(association)))),
            (
                <span style="color: #DDC29A; font-weight: bold;">"association?"</span>,
                <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(is_association))),
            ),
            (<span style="color: #DDC29A; font-weight: bold;">"branch"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(branch))),
            (<span style="color: #DDC29A; font-weight: bold;">"bytes"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(bytes)))),
            (<span style="color: #DDC29A; font-weight: bold;">"bytes?"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(is_bytes)))),
            (<span style="color: #DDC29A; font-weight: bold;">"clone"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(clone))),
            (<span style="color: #DDC29A; font-weight: bold;">"contains?"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(contains)))),
            (<span style="color: #DDC29A; font-weight: bold;">"ceil"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(ceil)))),
            (<span style="color: #DDC29A; font-weight: bold;">"compare"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(compare)))),
            (<span style="color: #DDC29A; font-weight: bold;">"count"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(count)))),
            (<span style="color: #DDC29A; font-weight: bold;">"dec"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(dec)))),
            (<span style="color: #DDC29A; font-weight: bold;">"decide"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(decide))),
            (<span style="color: #DDC29A; font-weight: bold;">"dip"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(dip))),
            (<span style="color: #DDC29A; font-weight: bold;">"dictionary"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(dictionary))),
            (<span style="color: #DDC29A; font-weight: bold;">"dipdown"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(dipdown))),
            (<span style="color: #DDC29A; font-weight: bold;">"drop"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(drop))),
            (<span style="color: #DDC29A; font-weight: bold;">"emit"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(emit)))),
            (<span style="color: #DDC29A; font-weight: bold;">"environment"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(environment)))),
            (<span style="color: #DDC29A; font-weight: bold;">"error?"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(is_error)))),
            (<span style="color: #DDC29A; font-weight: bold;">"eval-step"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(eval_step_outer))),
            (<span style="color: #DDC29A; font-weight: bold;">"evaluate"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(evaluate))),
            (<span style="color: #DDC29A; font-weight: bold;">"even?"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(is_even)))),
            (<span style="color: #DDC29A; font-weight: bold;">"evert"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(evert))),
            (<span style="color: #DDC29A; font-weight: bold;">"execute"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(execute))),
            (<span style="color: #DDC29A; font-weight: bold;">"fail"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(fail)))),
            (
                <span style="color: #DDC29A; font-weight: bold;">"file-in"</span>,
                <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(<span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">pipes</span>::<span style="color: #A0E5E5; font-weight: bold;">fs</span>::file_in))),
            ),
            (
                <span style="color: #DDC29A; font-weight: bold;">"file-out"</span>,
                <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(<span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">pipes</span>::<span style="color: #A0E5E5; font-weight: bold;">fs</span>::file_out))),
            ),
            (<span style="color: #DDC29A; font-weight: bold;">"first"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(first)))),
            (<span style="color: #DDC29A; font-weight: bold;">"float"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(float))),
            (<span style="color: #DDC29A; font-weight: bold;">"handle"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(handle)))),
            (
                <span style="color: #DDC29A; font-weight: bold;">"handoff"</span>,
                <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(<span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">pipes</span>::<span style="color: #A0E5E5; font-weight: bold;">channel</span>::handoff)),
            ),
            (<span style="color: #DDC29A; font-weight: bold;">"hash"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(<span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">crypto</span>::hash)))),
            (<span style="color: #DDC29A; font-weight: bold;">"inc"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(inc)))),
            (<span style="color: #DDC29A; font-weight: bold;">"inspect"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(inspect)))),
            (<span style="color: #DDC29A; font-weight: bold;">"join"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(join)))),
            (<span style="color: #DDC29A; font-weight: bold;">"key"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(<span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">crypto</span>::key)))),
            (<span style="color: #DDC29A; font-weight: bold;">"last"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(last)))),
            (<span style="color: #DDC29A; font-weight: bold;">"list?"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(is_list)))),
            (<span style="color: #DDC29A; font-weight: bold;">"loop"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(loop_))),
            (<span style="color: #DDC29A; font-weight: bold;">"mod"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(mod_)))),
            (<span style="color: #DDC29A; font-weight: bold;">"not"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(not)))),
            (<span style="color: #DDC29A; font-weight: bold;">"number?"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(is_number)))),
            (<span style="color: #DDC29A; font-weight: bold;">"odd?"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(is_odd)))),
            (<span style="color: #DDC29A; font-weight: bold;">"or"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(or)))),
            (<span style="color: #DDC29A; font-weight: bold;">"pop"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(pop))),
            (<span style="color: #DDC29A; font-weight: bold;">"put"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(put))),
            (<span style="color: #DDC29A; font-weight: bold;">"pipe?"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(is_pipe)))),
            (<span style="color: #DDC29A; font-weight: bold;">"range"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(range))),
            (<span style="color: #DDC29A; font-weight: bold;">"read"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(read))),
            (<span style="color: #DDC29A; font-weight: bold;">"recur"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(recur))),
            (<span style="color: #DDC29A; font-weight: bold;">"redefine"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(redefine))),
            (<span style="color: #DDC29A; font-weight: bold;">"resume"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(identity))),
            (<span style="color: #DDC29A; font-weight: bold;">"reverse"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(reverse)))),
            (<span style="color: #DDC29A; font-weight: bold;">"second"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(second)))),
            (
                <span style="color: #DDC29A; font-weight: bold;">"serversocket"</span>,
                <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2_async(<span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">pipes</span>::<span style="color: #A0E5E5; font-weight: bold;">net</span>::server_socket))),
            ),
            (<span style="color: #DDC29A; font-weight: bold;">"set"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(set)))),
            (<span style="color: #DDC29A; font-weight: bold;">"set?"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(is_set)))),
            (<span style="color: #DDC29A; font-weight: bold;">"sign"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(<span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">crypto</span>::sign)))),
            (<span style="color: #DDC29A; font-weight: bold;">"sink"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(sink))),
            (<span style="color: #DDC29A; font-weight: bold;">"sqrt"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(sqrt)))),
            (<span style="color: #DDC29A; font-weight: bold;">"standard"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(standard))),
            (<span style="color: #DDC29A; font-weight: bold;">"step"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(step))),
            (<span style="color: #DDC29A; font-weight: bold;">"string"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(string)))),
            (<span style="color: #DDC29A; font-weight: bold;">"string?"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(is_string)))),
            (<span style="color: #DDC29A; font-weight: bold;">"swap"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(swap))),
            (<span style="color: #DDC29A; font-weight: bold;">"swapdown"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(swapdown))),
            (<span style="color: #DDC29A; font-weight: bold;">"timestamps"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(timestamps))),
            (<span style="color: #DDC29A; font-weight: bold;">"true"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(true_))),
            (<span style="color: #DDC29A; font-weight: bold;">"unassign"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(unassign)))),
            (<span style="color: #DDC29A; font-weight: bold;">"take"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(take))),
            (<span style="color: #DDC29A; font-weight: bold;">"unwrap"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(unwrap))),
            (
                <span style="color: #DDC29A; font-weight: bold;">"verify"</span>,
                <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack3(<span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">crypto</span>::verify))),
            ),
            (<span style="color: #DDC29A; font-weight: bold;">"word?"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(is_word)))),
            (<span style="color: #DDC29A; font-weight: bold;">"wrap"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(wrap))),
            (<span style="color: #DDC29A; font-weight: bold;">"xor"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack2(xor)))),
            (<span style="color: #DDC29A; font-weight: bold;">"zero?"</span>, <span style="color: #C2E5C2;">Box</span>::leak(<span style="color: #C2E5C2;">Box</span>::new(f_stack1(is_zero)))),
        ],
    )
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">read_lexicon</span>(<span style="color: #E5E5A0; font-weight: bold;">lexicon</span>: <span style="color: #C2E5C2;">String</span>, <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Environment</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">items</span> = <span style="color: #A0E5E5; font-weight: bold;">serialize</span>::parse(lexicon).unwrap();
    <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #E5E5A0; font-weight: bold;">r</span> <span style="color: #E5C2E5; font-weight: bold;">in</span> <span style="color: #C2E5C2;">Box</span>::new(items.inner().into_iter()) {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> (k, def): (<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>, <span style="color: #C2E5C2;">Item</span>) = r.try_into().unwrap();
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">word</span>: <span style="color: #C2E5C2;">Word</span> = k.try_into().unwrap();
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">iter</span>: <span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Iterator</span>&lt;<span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Item</span>&gt;&gt; = def.try_into().unwrap();

        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">new_entry</span>: <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Entry</span> = iter.try_into().unwrap();
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">new_entry2</span> = new_entry.clone();
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">dict</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> env.dictionary);
        dict.entry(word)
            .and_modify(|e| {
                e.examples = new_entry.examples;
                e.spec = new_entry.spec;
                e.definition = new_entry.definition;
            })
            .or_insert(new_entry2);
    }
    env
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">add_standard_dictionary</span>(<span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Environment</span> {
    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">read builtins</span>
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">builtins</span> = <span style="color: #C2E5C2;">String</span>::from_utf8(<span style="color: #00fa9a; font-weight: bold;">include_bytes!</span>(<span style="color: #DDC29A; font-weight: bold;">"kcats/builtins.kcats"</span>).to_vec()).unwrap();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span> = read_lexicon(builtins, env);
    <span style="color: #AD9292;">//</span><span style="color: #AD9292;">println!("with builtins {:?}", env.dictionary);</span>
    env.dictionary = add_builtins(env.dictionary);
    <span style="color: #AD9292;">//</span><span style="color: #AD9292;">env = add_derivations(env);</span>
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">lexicon</span> = <span style="color: #C2E5C2;">String</span>::from_utf8(<span style="color: #00fa9a; font-weight: bold;">include_bytes!</span>(<span style="color: #DDC29A; font-weight: bold;">"kcats/lexicon.kcats"</span>).to_vec()).unwrap();
    read_lexicon(lexicon, env)
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">invalid_type_error</span>(<span style="color: #E5E5A0; font-weight: bold;">asked</span>: <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>, <span style="color: #E5E5A0; font-weight: bold;">actual</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::type_mismatch(asked, <span style="color: #C2E5C2;">Some</span>(actual)))
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">number_type_error</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    invalid_type_error(<span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::wrap(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Word</span>(*<span style="color: #C2E5C2;">S_NUMBER</span>)), i)
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">pair</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter([i, j]).into()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">plus</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> (i, j) {
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i + j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i + j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Float</span> + j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i + j <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Float</span>)),
        (i, j) =&gt; number_type_error(pair(i, j)),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">minus</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> (i, j) {
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i - j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i - j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Float</span> - j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i - j <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Float</span>)),
        (i, j) =&gt; number_type_error(pair(i, j)),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">mult</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> (i, j) {
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i * j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i * j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Float</span> * j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i * j <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Float</span>)),
        (i, j) =&gt; number_type_error(pair(i, j)),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">divide</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Float</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Float</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">q</span> = i / j;
    <span style="color: #E5C2E5; font-weight: bold;">if</span> q.is_nan() {
        <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::division_by_zero())
    } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
        <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(q))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">div</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> (i, j) {
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(j)) =&gt; i
            .checked_div(j)
            .ok_or_else(|| <span style="color: #C2E5C2;">Error</span>::division_by_zero())
            .and_then(|i| <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i))),

        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(j)) =&gt; divide(i, j),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(j)) =&gt; divide(i <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Float</span>, j),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(j)) =&gt; divide(i, j <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Float</span>),
        (i, j) =&gt; number_type_error(pair(i, j)),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">mod_</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> = <span style="color: #C2E5C2;">Int</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">j</span> = <span style="color: #C2E5C2;">Int</span>::try_from(j)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i % j))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">inc</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(<span style="color: #C2E5C2;">Int</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span> + 1))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">dec</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(<span style="color: #C2E5C2;">Int</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span> - 1))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">is_zero</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i == 0)),
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i == 0.0)),
        i =&gt; number_type_error(i),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">gt</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> (i, j) {
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i &gt; j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i &gt; j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Float</span> &gt; j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i &gt; j <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Float</span>)),

        (i, j) =&gt; number_type_error(pair(i, j)),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">lt</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> (i, j) {
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i &lt; j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i &lt; j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from((i <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Float</span>) &lt; j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i &lt; j <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Float</span>)),

        (i, j) =&gt; number_type_error(pair(i, j)),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">gte</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> (i, j) {
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i &gt;= j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i &gt;= j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Float</span> &gt;= j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i &gt;= j <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Float</span>)),

        (i, j) =&gt; number_type_error(pair(i, j)),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">lte</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> (i, j) {
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i &lt;= j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i &lt;= j)),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from((i <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Float</span>).le(<span style="color: #ffffff; background-color: #000000;">&amp;</span>j))),
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i &lt;= j <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Float</span>)),

        (i, j) =&gt; number_type_error(pair(i, j)),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">join</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">j</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::try_from(j)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #C2E5C2;">Ok</span>(i.join(j)<span style="color: #C2C2E5; font-weight: bold;">?</span>.into())
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">put</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">j</span> = env.pop();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> = env.pop();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i2</span> = i.clone();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">pr</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::try_from(i);
    <span style="color: #E5C2E5; font-weight: bold;">match</span> pr {
        <span style="color: #C2E5C2;">Ok</span>(p) =&gt; <span style="color: #C2E5C2;">Box</span>::pin(p.put(j).map(|f| <span style="color: #E5C2E5; font-weight: bold;">match</span> f {
            <span style="color: #C2E5C2;">Ok</span>(p) =&gt; env.push(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(p)).into(),
            <span style="color: #C2E5C2;">Err</span>(e) =&gt; env.push(i2).push(e.into()).into(),
        })),
        <span style="color: #C2E5C2;">Err</span>(e) =&gt; env.push(i2).push(e.into()).into(),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">clone</span>(<span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">clone</span> = env.stack.front().unwrap().clone();
    env.push(clone).into()
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">swap2</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>, <span style="color: #E5E5A0; font-weight: bold;">offset</span>: <span style="color: #C2E5C2;">usize</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> env.stack).swap(offset, offset + 1);
    env.into()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">swap</span>(<span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    swap2(env, 0)
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">swapdown</span>(<span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    swap2(env, 1)
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">sink</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">s</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> env.stack);
    s.swap(0, 2);
    s.swap(0, 1);
    env.into()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">float</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">s</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> env.stack);
    s.swap(0, 2);
    s.swap(1, 2);
    env.into()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">drop</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    env.pop();
    env.into()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">eq</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i == j))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">count</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(i)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i.len() <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Int</span>)),
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(i)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i.len() <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Int</span>)),
        i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"sized"</span>, i)),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">is_string</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(<span style="color: #00fa9a; font-weight: bold;">matches!</span>(
        i,
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(_)))
            | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(_)))
    )))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">is_bytes</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(<span style="color: #00fa9a; font-weight: bold;">matches!</span>(
        i,
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(_)))
            | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(_)))
    )))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">is_error</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(<span style="color: #00fa9a; font-weight: bold;">matches!</span>(
        i,
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(
            <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(_),
        )))
    )))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">is_word</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(<span style="color: #E5C2E5; font-weight: bold;">match</span> i {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Word</span>(_) =&gt; <span style="color: #E5C2E5; font-weight: bold;">true</span>,
        <span style="color: #AD9292;">//</span><span style="color: #AD9292;">Item::Iterable(Item(_)) =&gt; true,</span>
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">TODO maybe also check if it's an associative that looks like a Def?</span>
        _ =&gt; <span style="color: #E5C2E5; font-weight: bold;">false</span>,
    }))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">is_pipe</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(<span style="color: #E5C2E5; font-weight: bold;">match</span> i {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Out</span>(_)) =&gt; <span style="color: #E5C2E5; font-weight: bold;">true</span>,
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Tunnel</span>(_)) =&gt; <span style="color: #E5C2E5; font-weight: bold;">true</span>,
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">In</span>(_)) =&gt; <span style="color: #E5C2E5; font-weight: bold;">true</span>,
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Tunnel</span>(_)) =&gt; <span style="color: #E5C2E5; font-weight: bold;">true</span>,
        _ =&gt; <span style="color: #E5C2E5; font-weight: bold;">false</span>,
    }))
}
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">is_number</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(<span style="color: #00fa9a; font-weight: bold;">matches!</span>(i, <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(_) | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(_))))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">is_list</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(<span style="color: #00fa9a; font-weight: bold;">matches!</span>(
        i,
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(_))
    )))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">first</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">l</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #C2E5C2;">Ok</span>(l.front().map(|i| i.clone()).unwrap_or_default())
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">second</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">l</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #C2E5C2;">Ok</span>(l.get(1).map(|i| i.clone()).unwrap_or_default())
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">last</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">l</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #C2E5C2;">Ok</span>(l.back().map(|i| i.clone()).unwrap_or_default())
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">loop_</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">p</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(env.pop());
    <span style="color: #E5C2E5; font-weight: bold;">match</span> p {
        <span style="color: #C2E5C2;">Ok</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> p) =&gt; {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">f</span> = env.pop();
            <span style="color: #E5C2E5; font-weight: bold;">if</span> is_truthy(f) {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">p2</span> = p.clone();
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">pm</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> p);
                pm.push_back(<span style="color: #C2E5C2;">Item</span>::from(p2));
                pm.push_back(<span style="color: #DDC29A; font-weight: bold;">"loop"</span>.into());
                env.append_expression(p)
            } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                env
            }
        }
        <span style="color: #C2E5C2;">Err</span>(e) =&gt; env.push(<span style="color: #C2E5C2;">Item</span>::from(e)),
    }
    .into()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">execute</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> = env.pop();
    <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(i) {
        <span style="color: #C2E5C2;">Ok</span>(program) =&gt; env.append_expression(program),
        <span style="color: #C2E5C2;">Err</span>(e) =&gt; env.push(e.into()),
    }
    .into()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">wrap</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">item</span> = env.pop();
    env.push(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter([item]).into()).into()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #AD9292;">//</span><span style="color: #AD9292;">println!("unwrapping");</span>
    <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(env.pop()) {
        <span style="color: #C2E5C2;">Ok</span>(l) =&gt; {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">len</span> = l.len();
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">l2</span> = (0..len).map(<span style="color: #E5C2E5; font-weight: bold;">move</span> |i| l[i].clone());
            <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> <span style="color: #E5C2E5; font-weight: bold;">in</span> l2 {
                env = env.push(i);
            }
            env
        }
        <span style="color: #C2E5C2;">Err</span>(e) =&gt; env.push(e.into()),
    }
    .into()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">dip</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(env.pop()) {
        <span style="color: #C2E5C2;">Ok</span>(program) =&gt; {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">item</span> = env.pop();
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">expr</span> = env.expression.make_mut();
            expr.push_front(<span style="color: #DDC29A; font-weight: bold;">"unwrap"</span>.into());
            expr.push_front(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter([item]).into());
            env.append_expression(program)
        }
        <span style="color: #C2E5C2;">Err</span>(e) =&gt; env.push(e.into()),
    }
    .into()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">dipdown</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(env.pop()) {
        <span style="color: #C2E5C2;">Ok</span>(program) =&gt; {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">item1</span> = env.pop();
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">item2</span> = env.pop();
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">expr</span> = env.expression.make_mut();
            expr.push_front(<span style="color: #DDC29A; font-weight: bold;">"unwrap"</span>.into());
            expr.push_front(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter([item2, item1]).into());
            env.append_expression(program)
        }
        <span style="color: #C2E5C2;">Err</span>(e) =&gt; env.push(e.into()),
    }
    .into()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">take</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">TODO: handle Nothing case</span>
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">coll</span> = {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">stack</span> = env.stack.make_mut();
        stack.pop_front()
    };
    <span style="color: #E5C2E5; font-weight: bold;">match</span> coll {
        <span style="color: #C2E5C2;">Some</span>(i) =&gt; {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i2</span> = i.clone();
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">r</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::try_from(i);
            <span style="color: #E5C2E5; font-weight: bold;">match</span> r {
                <span style="color: #C2E5C2;">Ok</span>(it) =&gt; {
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">f</span> = it.take();
                    <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> {
                        <span style="color: #E5C2E5; font-weight: bold;">let</span> (c, i) = f.<span style="color: #E5C2E5; font-weight: bold;">await</span>;
                        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">stack</span> = env.stack.make_mut();
                        stack.push_front(c.into());
                        stack.push_front(i.unwrap_or_default());
                        env
                    })
                }
                <span style="color: #C2E5C2;">Err</span>(e) =&gt; {
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">stack</span> = env.stack.make_mut();
                    stack.push_front(i2);
                    stack.push_front(e.into());
                    env.into()
                }
            }
        }
        <span style="color: #C2E5C2;">None</span> =&gt; {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">stack</span> = env.stack.make_mut();
            stack.push_front(<span style="color: #C2E5C2;">Error</span>::stack_underflow().into());
            env.into()
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">pop</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">coll</span> = {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">stack</span> = env.stack.make_mut();
        stack.pop_front()
    };
    <span style="color: #E5C2E5; font-weight: bold;">match</span> coll {
        <span style="color: #C2E5C2;">Some</span>(i) =&gt; {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i2</span> = i.clone();
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">r</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(i);
            <span style="color: #E5C2E5; font-weight: bold;">match</span> r {
                <span style="color: #C2E5C2;">Ok</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> it) =&gt; {
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">itm</span> = it.make_mut();
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> = itm.pop_back();
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">stack</span> = env.stack.make_mut();
                    stack.push_front(it.into());
                    stack.push_front(i.unwrap_or_default());
                    env.into()
                }
                <span style="color: #C2E5C2;">Err</span>(e) =&gt; {
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">stack</span> = env.stack.make_mut();
                    stack.push_front(i2);
                    stack.push_front(e.into());
                    env.into()
                }
            }
        }
        <span style="color: #C2E5C2;">None</span> =&gt; {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">stack</span> = env.stack.make_mut();
            stack.push_front(<span style="color: #C2E5C2;">Error</span>::stack_underflow().into());
            env.into()
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">is_truthy</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
    <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::try_from(i).map_or(<span style="color: #E5C2E5; font-weight: bold;">true</span>, |s| !s.is_empty())
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">fn boolean_value(b: bool) -&gt; Item {</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">if b {</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">"true".into()</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">} else {</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">coll::NOTHING</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">}</span>

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">branch</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> (
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(env.pop()),
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(env.pop()),
    ) {
        (<span style="color: #C2E5C2;">Ok</span>(false_branch), <span style="color: #C2E5C2;">Ok</span>(true_branch)) =&gt; {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">b</span> = env.pop();

            env.append_expression(<span style="color: #E5C2E5; font-weight: bold;">if</span> is_truthy(b) {
                true_branch
            } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                false_branch
            })
        }
        (<span style="color: #C2E5C2;">Err</span>(e), _) =&gt; env.push(e.into()),
        (_, <span style="color: #C2E5C2;">Err</span>(e)) =&gt; env.push(e.into()),
    }
    .into()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">step</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">p</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(env.pop()).unwrap();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">it</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::try_from(env.pop()).unwrap();
    <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> {
        <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> (it, <span style="color: #C2E5C2;">Some</span>(litem)) = it.take().<span style="color: #E5C2E5; font-weight: bold;">await</span> {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">expr</span> = env.expression.make_mut();
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">prepare the next iteration, even if the iterator is now</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">empty</span>
            expr.push_front(<span style="color: #DDC29A; font-weight: bold;">"step"</span>.into());
            expr.push_front(p.clone().into());
            expr.push_front(it.into());
            expr.push_front(<span style="color: #DDC29A; font-weight: bold;">"execute"</span>.into());

            env.push(litem).push(p.into()).into()
        } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
            env.into()
        }
    })
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">range</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">stepby</span> = <span style="color: #C2E5C2;">Int</span>::try_from(env.pop()).unwrap();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">to</span> = <span style="color: #C2E5C2;">Int</span>::try_from(env.pop()).unwrap();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">from</span> = <span style="color: #C2E5C2;">Int</span>::try_from(env.pop()).unwrap();
    env.push(
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter((from..to).step_by(stepby <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">usize</span>).map(|i| <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i))).into(),
    )
    .into()
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">(effect [rec2 rec1 then pred]</span>
<span style="color: #AD9292;">//                   </span><span style="color: #AD9292;">['[if]</span>
<span style="color: #AD9292;">//</span><span style="color: #AD9292;">[(concat rec1</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">[[pred then rec1 rec2 'recur]] rec2)</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">then pred]])</span>

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">recur</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">rec2</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(env.pop()).unwrap();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">rec1</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(env.pop()).unwrap();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">then</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(env.pop()).unwrap();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">pred</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(env.pop()).unwrap();
    env = env.push_expr(<span style="color: #DDC29A; font-weight: bold;">"if"</span>.into());
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">r</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter([
        <span style="color: #C2E5C2;">Item</span>::from(pred.clone()),
        then.clone().into(),
        rec1.clone().into(),
        rec2.clone().into(),
        <span style="color: #DDC29A; font-weight: bold;">"recur"</span>.into(),
    ])
    .into();
    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">I think i did this right - used to create a new list and extend</span>
    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">it with rec1, then push r, then extend again with rec2. now</span>
    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">start with rec1 (copied on write), then push r, then extend</span>
    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">with rec2.  That should be equivalent.</span>
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">rm</span> = rec1.make_mut();
    rm.push_back(r);
    rm.extend(rec2.make_mut().drain(..));

    env.push(pred.into())
        .push(then.into())
        .push(rec1.into())
        .into()
}

<span style="color: #AD9292;">//</span><span style="color: #AD9292;">(fn [{[l &amp; others] 'stack :as env}]</span>
<span style="color: #AD9292;">//            </span><span style="color: #AD9292;">(assoc env 'stack (apply list (vec others) l)))</span>

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">evert</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">l</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(env.pop()).unwrap();
    <span style="color: #A0E5E5; font-weight: bold;">mem</span>::swap(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> env.stack, <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> l);
    env.push(l.into()).into()
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">assoc_in</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">ks</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span>[<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>], <span style="color: #E5E5A0; font-weight: bold;">v</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Item</span>, <span style="color: #C2E5C2;">Error</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> [k, ks @ ..] = ks {
        <span style="color: #E5C2E5; font-weight: bold;">if</span> ks.is_empty() {
            <span style="color: #E5C2E5; font-weight: bold;">match</span> (i, k) {
                (
                    <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> l))),
                    <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Int</span>(k),
                ) =&gt; {
                    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">vector set by index</span>
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">lm</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> l);
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">idx</span> = *k <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">usize</span>;
                    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">extend the size of the vector to be big enough to set</span>
                    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">the given index, pad with 'nothing' values.</span>
                    <span style="color: #E5C2E5; font-weight: bold;">if</span> lm.len() &lt;= idx {
                        lm.resize(idx + 1, <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">NOTHING</span>);
                    }
                    lm[*k <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">usize</span>] = v;
                    <span style="color: #C2E5C2;">Ok</span>(l.into())
                }
                (i, k) =&gt; {
                    <span style="color: #AD9292;">//</span><span style="color: #AD9292;">println!("assoc_in: {:?} {:?}", i, k);</span>
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">a</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
                    <span style="color: #C2E5C2;">Ok</span>(a.insert(k.clone(), v).0.into())
                }
            }
            <span style="color: #AD9292;">//</span><span style="color: #AD9292;">hm.insert(k.clone(), v);</span>
        } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
            <span style="color: #E5C2E5; font-weight: bold;">match</span> (i, k) {
                (
                    <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> l))),
                    <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Int</span>(k),
                ) =&gt; {
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">lm</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> l);
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">idx</span> = *k <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">usize</span>;
                    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">extend the size of the vector to be big enough to set</span>
                    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">the given index, pad with 'nothing' values.</span>
                    <span style="color: #E5C2E5; font-weight: bold;">if</span> lm.len() &lt;= idx {
                        lm.resize(idx + 1, <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">NOTHING</span>);
                    }
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">inner</span> = <span style="color: #ffffff; background-color: #000000;">&amp;</span>lm[idx];

                    lm[*k <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">usize</span>] = <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> [nextk, ..] = ks {
                        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span> = <span style="color: #E5C2E5; font-weight: bold;">match</span> (inner, nextk) {
                            (
                                <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(l))),
                                <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Int</span>(_),
                            ) =&gt; l.clone().into(),
                            (_, <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Int</span>(_)) =&gt; <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::new().into(),
                            _ =&gt; <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::new().into(),
                        };
                        assoc_in(i, ks, v)<span style="color: #C2C2E5; font-weight: bold;">?</span>
                    } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                        v
                    };

                    <span style="color: #AD9292;">//</span><span style="color: #AD9292;">if the inner value isn't a list, overwrite it</span>
                    <span style="color: #C2E5C2;">Ok</span>(l.into())
                }
                (i, k) =&gt; {
                    <span style="color: #AD9292;">//</span><span style="color: #AD9292;">println!("assoc_in morekeys: {:?} {:?}", i, k);</span>
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">a</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">inner</span> = a.get(<span style="color: #ffffff; background-color: #000000;">&amp;</span>k).unwrap_or_default().clone();
                    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">if the inner value isn't a map, we're just overwriting whatever it</span>
                    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">is with a new map.</span>

                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> = <span style="color: #E5C2E5; font-weight: bold;">match</span> inner {
                        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(a))) =&gt; {
                            a.clone().into()
                        }
                        _ =&gt; <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::new().into(),
                    };
                    <span style="color: #C2E5C2;">Ok</span>(a.insert(k.clone(), assoc_in(i, ks, v)<span style="color: #C2C2E5; font-weight: bold;">?</span>).0.into())
                }
            }
        }
    } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
        <span style="color: #C2E5C2;">Ok</span>(i)
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">unassoc_in</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">ks</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span>[<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>]) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Item</span>, <span style="color: #C2E5C2;">Error</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> [k, ks @ ..] = ks {
        <span style="color: #E5C2E5; font-weight: bold;">if</span> ks.is_empty() {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">a</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
            <span style="color: #C2E5C2;">Ok</span>(a.remove(<span style="color: #ffffff; background-color: #000000;">&amp;</span>k).0.into())
        } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
            <span style="color: #E5C2E5; font-weight: bold;">match</span> (i, k) {
                (
                    <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> l))),
                    <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Int</span>(k),
                ) =&gt; {
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">lm</span> = l.make_mut();
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">old_value</span> = <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Some</span>(item) = lm.get_mut(*k <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">usize</span>) {
                        <span style="color: #A0E5E5; font-weight: bold;">mem</span>::replace(item, <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">NOTHING</span>)
                    } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                        <span style="color: #E5C2E5; font-weight: bold;">return</span> <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::short_list(k.clone())); <span style="color: #AD9292;">// </span><span style="color: #AD9292;">replace with your error</span>
                    };
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">new_value</span> = unassoc_in(old_value, ks)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
                    lm[*k <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">usize</span>] = new_value;
                    <span style="color: #C2E5C2;">Ok</span>(l.into())
                }
                (a, k) =&gt; {
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">a</span>: <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span> = a.try_into()<span style="color: #C2C2E5; font-weight: bold;">?</span>;
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">a</span>: <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span> = a.into_iter().collect();
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">am</span> = a.make_mut();
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">res</span>: <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Result</span>&lt;_, <span style="color: #C2E5C2;">Error</span>&gt;&gt; = <span style="color: #C2E5C2;">None</span>;
                    am.entry(k.clone()).and_modify(|v| {
                        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">new_value</span> = unassoc_in(v.clone(), ks);
                        res = <span style="color: #C2E5C2;">Some</span>(new_value.map(|nv| {
                            *v = nv;
                        }));
                    });
                    <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Some</span>(<span style="color: #C2E5C2;">Err</span>(e)) = res {
                        <span style="color: #E5C2E5; font-weight: bold;">return</span> <span style="color: #C2E5C2;">Err</span>(e);
                    }
                    <span style="color: #C2E5C2;">Ok</span>(a.into())
                }
            }
        }
    } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
        <span style="color: #C2E5C2;">Ok</span>(i)
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">assign</span>(<span style="color: #E5E5A0; font-weight: bold;">m</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">ks</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">v</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">kit</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(ks)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">ksvec</span>: <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyList</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyList</span>::try_from_iter(kit.inner().into_iter())<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    ksvec.make_mut().make_contiguous();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> (ks, _) = ksvec.as_slices();
    assoc_in(m, ks, v)
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">unassign</span>(<span style="color: #E5E5A0; font-weight: bold;">m</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">ks</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">kit</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(ks)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">ksvec</span>: <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyList</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyList</span>::try_from_iter(kit.inner().into_iter())<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    ksvec.make_mut().make_contiguous();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> (ks, _) = ksvec.as_slices();
    unassoc_in(m, ks)
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">association</span>(<span style="color: #E5E5A0; font-weight: bold;">m</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::try_from(m) {
        <span style="color: #C2E5C2;">Ok</span>(m) =&gt; <span style="color: #C2E5C2;">Ok</span>(m.into()),
        <span style="color: #C2E5C2;">Err</span>(e) =&gt; <span style="color: #C2E5C2;">Err</span>(e),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">lookup</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">k</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #AD9292;">//</span><span style="color: #AD9292;">println!("lookup {:?} \n {:?}", m, k);</span>
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">k</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>::try_from(k)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">match</span> (i, k) {
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(l))), <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>::<span style="color: #C2E5C2;">Int</span>(k)) =&gt; {
            <span style="color: #C2E5C2;">Ok</span>(l.get(k <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">usize</span>)
                .and_then(|x| <span style="color: #C2E5C2;">Some</span>(x.clone()))
                .unwrap_or_default())
        }
        (i, k) =&gt; {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">m</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
            <span style="color: #C2E5C2;">Ok</span>(m.get(<span style="color: #ffffff; background-color: #000000;">&amp;</span>k).unwrap_or_default())
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">contains</span>(<span style="color: #E5E5A0; font-weight: bold;">c</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">s</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::try_from(c)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #C2E5C2;">Ok</span>(s.contains(<span style="color: #ffffff; background-color: #000000;">&amp;</span>i).into())
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">or</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #E5C2E5; font-weight: bold;">if</span> is_truthy(i.clone()) {
        i
    } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
        <span style="color: #E5C2E5; font-weight: bold;">if</span> is_truthy(j.clone()) {
            j
        } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
            <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">NOTHING</span>
        }
    })
    <span style="color: #AD9292;">//</span><span style="color: #AD9292;">Ok(Item::from(is_truthy(i) || is_truthy(j)))</span>
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">and</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #E5C2E5; font-weight: bold;">if</span> is_truthy(i) &amp;&amp; is_truthy(j.clone()) {
        j
    } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">NOTHING</span>
    })
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">not</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(!is_truthy(i)))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">is_association</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::try_from(i)
        .map(|s| <span style="color: #00fa9a; font-weight: bold;">matches!</span>(s, <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(_) | <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span>))
        .unwrap_or(<span style="color: #E5C2E5; font-weight: bold;">false</span>)
        .into())
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">is_set</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::try_from(i)
        .map(|s| <span style="color: #00fa9a; font-weight: bold;">matches!</span>(s, <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(_) | <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span>))
        .unwrap_or(<span style="color: #E5C2E5; font-weight: bold;">false</span>)
        .into())
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">is_odd</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> = <span style="color: #C2E5C2;">Int</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i &amp; 1 == 1))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">is_even</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> = <span style="color: #C2E5C2;">Int</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::from(i &amp; 1 == 0))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">decide</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">clauses</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(env.pop()).unwrap();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">clauses_data</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> clauses);
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">clause</span> = clauses_data.pop_front();

    <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Some</span>(clause) = clause {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">clause</span>: <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>, <span style="color: #C2E5C2;">Error</span>&gt; = clause.try_into();
        <span style="color: #E5C2E5; font-weight: bold;">match</span> clause {
            <span style="color: #C2E5C2;">Ok</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> clause) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">if</span> clause.len() != 2 {
                    env.push(<span style="color: #C2E5C2;">Error</span>::list_count(2).into()).into()
                } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">clause_data</span> = clause.make_mut();
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">test</span>: <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>, <span style="color: #C2E5C2;">Error</span>&gt; = clause_data
                        .pop_front()
                        .ok_or(<span style="color: #C2E5C2;">Error</span>::list_count(2))
                        .and_then(|i| i.try_into());
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">expr</span>: <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>, <span style="color: #C2E5C2;">Error</span>&gt; = clause_data
                        .pop_front()
                        .ok_or(<span style="color: #C2E5C2;">Error</span>::list_count(2))
                        .and_then(|i| i.try_into());

                    <span style="color: #E5C2E5; font-weight: bold;">match</span> (test, expr) {
                        (<span style="color: #C2E5C2;">Ok</span>(test), <span style="color: #C2E5C2;">Ok</span>(expr)) =&gt; {
                            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">construct if</span>
                            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">testp</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter([<span style="color: #C2E5C2;">Item</span>::from(test), <span style="color: #DDC29A; font-weight: bold;">"shield"</span>.into()]);
                            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">elsep</span> =
                                <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter([<span style="color: #C2E5C2;">Item</span>::from(clauses), <span style="color: #DDC29A; font-weight: bold;">"decide"</span>.into()]);
                            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">newexpr</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter([
                                <span style="color: #C2E5C2;">Item</span>::from(testp),
                                expr.into(),
                                elsep.into(),
                                <span style="color: #DDC29A; font-weight: bold;">"if"</span>.into(),
                            ]);
                            env.append_expression(newexpr).into()
                        }
                        (<span style="color: #C2E5C2;">Err</span>(test), _) =&gt; env.push(test.into()).into(),
                        (_, <span style="color: #C2E5C2;">Err</span>(expr)) =&gt; env.push(expr.into()).into(),
                    }
                }
            }
            <span style="color: #C2E5C2;">Err</span>(e) =&gt; env.push(e.into()).into(),
        }
    } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">clauses empty, return nothing</span>
        env.push(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">NOTHING</span>).into()
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">read</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">s</span> = <span style="color: #C2E5C2;">String</span>::try_from(env.pop()).unwrap();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">parsed</span> = <span style="color: #A0E5E5; font-weight: bold;">serialize</span>::parse(s);
    env.push(<span style="color: #E5C2E5; font-weight: bold;">match</span> parsed {
        <span style="color: #C2E5C2;">Ok</span>(l) =&gt; l.into(),
        <span style="color: #C2E5C2;">Err</span>(e) =&gt; e.into(),
    })
    .into()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">emit</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(<span style="color: #A0E5E5; font-weight: bold;">serialize</span>::emit(<span style="color: #ffffff; background-color: #000000;">&amp;</span>i)),
    )))
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">check_type</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">w</span>: <span style="color: #C2E5C2;">Word</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;(), <span style="color: #C2E5C2;">Error</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> (w, i) {
        (w, _) <span style="color: #E5C2E5; font-weight: bold;">if</span> w == *<span style="color: #C2E5C2;">S_ITEM</span> =&gt; <span style="color: #C2E5C2;">Ok</span>(()),
        (w, <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(_) | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(_)) <span style="color: #E5C2E5; font-weight: bold;">if</span> w == *<span style="color: #C2E5C2;">S_DISPENSER</span> =&gt; <span style="color: #C2E5C2;">Ok</span>(()),
        (w, <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(_)) <span style="color: #E5C2E5; font-weight: bold;">if</span> w == *<span style="color: #C2E5C2;">S_INTEGER</span> || w == *<span style="color: #C2E5C2;">S_NUMBER</span> =&gt; <span style="color: #C2E5C2;">Ok</span>(()),
        (w, <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(_)) <span style="color: #E5C2E5; font-weight: bold;">if</span> w == *<span style="color: #C2E5C2;">S_FLOAT</span> || w == *<span style="color: #C2E5C2;">S_NUMBER</span> =&gt; <span style="color: #C2E5C2;">Ok</span>(()),
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">TODO: also handle cases where bytes/string is a list</span>
        (
            w,
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(_)))
            | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(_))),
        ) <span style="color: #E5C2E5; font-weight: bold;">if</span> w == *<span style="color: #C2E5C2;">S_BYTES</span> || w == *<span style="color: #C2E5C2;">S_ORDERED</span> =&gt; <span style="color: #C2E5C2;">Ok</span>(()),

        (
            w,
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(_)))
            | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(_))),
        ) <span style="color: #E5C2E5; font-weight: bold;">if</span> w == *<span style="color: #C2E5C2;">S_STRING</span> =&gt; <span style="color: #C2E5C2;">Ok</span>(()),
        (w, <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Word</span>(_)) <span style="color: #E5C2E5; font-weight: bold;">if</span> w == *<span style="color: #C2E5C2;">S_WORD</span> =&gt; <span style="color: #C2E5C2;">Ok</span>(()),

        (
            w,
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Out</span>(_))
            | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Tunnel</span>(_))
            | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Tunnel</span>(_))
            | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">In</span>(_)),
        ) <span style="color: #E5C2E5; font-weight: bold;">if</span> w == *<span style="color: #C2E5C2;">S_PIPE</span> =&gt; <span style="color: #C2E5C2;">Ok</span>(()),

        (
            w,
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(_)))
            | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(_)))
            | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span>))
            | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Nothing</span>)),
        ) <span style="color: #E5C2E5; font-weight: bold;">if</span> w == *<span style="color: #C2E5C2;">S_LIST</span> || w == *<span style="color: #C2E5C2;">S_PROGRAM</span> =&gt; <span style="color: #C2E5C2;">Ok</span>(()),

        (
            w,
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(_)))
            | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(_))),
        ) <span style="color: #E5C2E5; font-weight: bold;">if</span> w == *<span style="color: #C2E5C2;">S_ASSOC</span> =&gt; <span style="color: #C2E5C2;">Ok</span>(()),

        (
            w,
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(
                <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(_),
            )))
            | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(
                <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(_),
            ))),
        ) <span style="color: #E5C2E5; font-weight: bold;">if</span> w == *<span style="color: #C2E5C2;">S_ERROR</span> =&gt; <span style="color: #C2E5C2;">Ok</span>(()),

        (
            w,
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(_))
            | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(_)),
        ) <span style="color: #E5C2E5; font-weight: bold;">if</span> w == *<span style="color: #C2E5C2;">S_SIZED</span> || w == *<span style="color: #C2E5C2;">S_ORDERED</span> =&gt; <span style="color: #C2E5C2;">Ok</span>(()),

        (
            w,
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(
                <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(_),
            )))
            | <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(
                <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Env</span>(_),
            ))),
        ) <span style="color: #E5C2E5; font-weight: bold;">if</span> w == *<span style="color: #C2E5C2;">S_ENVIRONMENT</span> =&gt; <span style="color: #C2E5C2;">Ok</span>(()),
        (w, i) =&gt; {
            <span style="color: #AD9292;">//</span><span style="color: #AD9292;">println!("Type check failed! wanted {} got {:?}", w, i);</span>
            <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #ffffff; background-color: #000000;">&amp;</span>w, i.clone()))
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">check_stack_depth</span>(<span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Environment</span>, <span style="color: #E5E5A0; font-weight: bold;">min_depth</span>: <span style="color: #C2E5C2;">usize</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;(), <span style="color: #C2E5C2;">Error</span>&gt; {
    <span style="color: #AD9292;">//</span><span style="color: #AD9292;">println!("Checking stack has at least {} items", min_depth);</span>
    <span style="color: #E5C2E5; font-weight: bold;">if</span> env.stack.len() &lt; min_depth {
        <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::stack_underflow())
    } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
        <span style="color: #C2E5C2;">Ok</span>(())
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">check_input_spec</span>(<span style="color: #E5E5A0; font-weight: bold;">spec</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>, <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;(), <span style="color: #C2E5C2;">Error</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">specs</span>: <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span> = spec
        .front()
        .ok_or(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"specs"</span>, <span style="color: #C2E5C2;">Default</span>::default()))
        .and_then(|i| i.clone().try_into())<span style="color: #C2C2E5; font-weight: bold;">?</span>;

    check_stack_depth(env, specs.len())<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">indexes</span> = <span style="color: #C2E5C2;">Range</span> {
        <span style="color: #E5E5A0; font-weight: bold;">start</span>: 0,
        <span style="color: #E5E5A0; font-weight: bold;">end</span>: specs.len(),
    };

    indexes
        .into_iter()
        .map(|i| {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">item</span> = env.stack.get(i).unwrap();
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">spec</span> = specs.get(i).unwrap();

            <span style="color: #E5C2E5; font-weight: bold;">match</span> spec {
                <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(named))) =&gt; {
                    <span style="color: #E5C2E5; font-weight: bold;">match</span> named.get(0).unwrap() {
                        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Word</span>(w) =&gt; check_type(item, *w),
                        i =&gt; {
                            <span style="color: #C2C2E5; font-weight: bold;">println!</span>(<span style="color: #DDC29A; font-weight: bold;">"Expected word, got </span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{:?}</span><span style="color: #DDC29A; font-weight: bold;">"</span>, i);
                            <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"list"</span>, i.clone()))
                        }
                    }
                }
                <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Word</span>(w) =&gt; check_type(item, *w),
                <span style="color: #AD9292;">// </span><span style="color: #AD9292;">the type might happen to also be a defined</span>
                <span style="color: #AD9292;">// </span><span style="color: #AD9292;">word, like 'association'</span>
                i =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"list"</span>, i.clone())),
            }
        })
        .collect::&lt;<span style="color: #C2E5C2;">Result</span>&lt;(), <span style="color: #C2E5C2;">Error</span>&gt;&gt;()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">eval_step</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #AD9292;">//</span><span style="color: #AD9292;">println!("{:?}", env);</span>
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">next_item</span> = env.expression.front();

    <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Some</span>(val) = next_item {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> val {
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Word</span>(word) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Some</span>(dfn) = env.dictionary.get(word) {
                    {
                        <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Some</span>(spec) = <span style="color: #ffffff; background-color: #000000;">&amp;</span>dfn.spec {
                            <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Err</span>(e) = check_input_spec(<span style="color: #ffffff; background-color: #000000;">&amp;</span>spec, <span style="color: #ffffff; background-color: #000000;">&amp;</span>env) {
                                env = env.push(e.into());
                                <span style="color: #E5C2E5; font-weight: bold;">return</span> env.into();
                            }
                        } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                            <span style="color: #C2C2E5; font-weight: bold;">println!</span>(<span style="color: #DDC29A; font-weight: bold;">"No spec for </span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{}</span><span style="color: #DDC29A; font-weight: bold;">!"</span>, word);
                        }
                        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">expr</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> env.expression);
                        expr.pop_front();

                        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #ffffff; background-color: #000000;">&amp;</span>dfn.definition {
                            <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Definition</span>::<span style="color: #C2E5C2;">Axiom</span>(a) =&gt; {
                                <span style="color: #AD9292;">// </span><span style="color: #AD9292;">we can't keep borrowing the env, so we</span>
                                <span style="color: #AD9292;">// </span><span style="color: #AD9292;">clone the axiom def to release it and then</span>
                                <span style="color: #AD9292;">// </span><span style="color: #AD9292;">we can pass the env to the axiom def fn</span>
                                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">f</span> = a.clone();
                                (f)(env)
                            }
                            <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Definition</span>::<span style="color: #C2E5C2;">Derived</span>(d) =&gt; {
                                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">items</span> = d.clone();
                                env.append_expression(items).into()
                            }
                        }
                    }
                } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">w</span> = *word;
                    env.push(<span style="color: #C2E5C2;">Error</span>::undefined(w).into()).into()
                }
            }
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(
                <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">DictEntry</span>(entry),
            ))) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Some</span>(spec) = <span style="color: #ffffff; background-color: #000000;">&amp;</span>entry.spec {
                    <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Err</span>(e) = check_input_spec(<span style="color: #ffffff; background-color: #000000;">&amp;</span>spec, <span style="color: #ffffff; background-color: #000000;">&amp;</span>env) {
                        env = env.push(e.into());
                        <span style="color: #E5C2E5; font-weight: bold;">return</span> env.into();
                    }
                }
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">expr</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> env.expression);
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">e</span>: <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Entry</span> = expr.pop_front().unwrap().try_into().unwrap();

                <span style="color: #E5C2E5; font-weight: bold;">match</span> e.definition {
                    <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Definition</span>::<span style="color: #C2E5C2;">Axiom</span>(builtin) =&gt; {
                        <span style="color: #AD9292;">//</span><span style="color: #AD9292;">let b = dict::Axiom::try_from(env.pop_expr()).unwrap();</span>
                        (builtin)(env)
                    }
                    <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Definition</span>::<span style="color: #C2E5C2;">Derived</span>(d) =&gt; {
                        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">d</span> = d.clone();
                        env.append_expression(d).into()
                    }
                }
            }
            _ =&gt; {
                <span style="color: #AD9292;">// </span><span style="color: #AD9292;">not a word, just push onto stack</span>
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> = env.pop_expr();
                env.push(i).into()
            }
        }
    } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
        env.push(<span style="color: #C2E5C2;">Error</span>::short_list(1).into()).into()
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">reverse</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">l</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(i).unwrap();
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter(l.inner().into_iter().rev()).into())
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">bytes</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(s))) =&gt; {
            <span style="color: #C2E5C2;">Ok</span>(s.as_bytes().to_vec().into())
        }
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(s))) =&gt; {
            <span style="color: #C2E5C2;">Ok</span>(s.as_bytes().to_vec().into())
        }
        i =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Bytes</span>::from(<span style="color: #A0E5E5; font-weight: bold;">serialize</span>::emit(<span style="color: #ffffff; background-color: #000000;">&amp;</span>i)).into()),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">string</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(b))) =&gt; {
            <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(
                <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(<span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #C2E5C2;">str</span>::from_utf8(<span style="color: #ffffff; background-color: #000000;">&amp;</span>b).unwrap().to_string()),
            )))
        }
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(b))) =&gt; {
            <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(
                <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(<span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #C2E5C2;">str</span>::from_utf8(<span style="color: #ffffff; background-color: #000000;">&amp;</span>b).unwrap().to_string()),
            )))
        }
        i =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(
            <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(<span style="color: #A0E5E5; font-weight: bold;">serialize</span>::emit(<span style="color: #ffffff; background-color: #000000;">&amp;</span>i)),
        ))),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">get_error</span>(<span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Error</span>&gt; {
    env.stack.front().and_then(|i| <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(
            <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(e),
        ))) =&gt; <span style="color: #C2E5C2;">Some</span>(e.clone()),
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(
            <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(e),
        ))) =&gt; <span style="color: #C2E5C2;">Some</span>(e.clone()),
        _ =&gt; <span style="color: #C2E5C2;">None</span>,
    })
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">unwind</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Environment</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">err</span> = env.pop();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">w</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Item</span> = &amp;<span style="color: #DDC29A; font-weight: bold;">"handle"</span>.into();

    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">err</span> = <span style="color: #E5C2E5; font-weight: bold;">match</span> err {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(
            <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> e),
        ))) =&gt; {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">next</span> = env.expression.front();
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">unwound</span> = <span style="color: #C2E5C2;">Vec</span>::&lt;<span style="color: #C2E5C2;">Item</span>&gt;::new();
            <span style="color: #E5C2E5; font-weight: bold;">while</span> next.is_some() &amp;&amp; next.unwrap() != w {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> = env.pop_expr();
                unwound.push(i);
                next = env.expression.front();
            }
            <span style="color: #E5C2E5; font-weight: bold;">if</span> next.is_some() {
                env.pop_expr();
            }
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">set the is_handled bit</span>
            e.is_handled = <span style="color: #E5C2E5; font-weight: bold;">true</span>;
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">em</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> e.data);
            em.insert(<span style="color: #DDC29A; font-weight: bold;">"unwound"</span>.into(), <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter(unwound).into());
            e.into()
        }
        i =&gt; i,
    };
    env = env.push(err);
    <span style="color: #E5C2E5; font-weight: bold;">return</span> env;
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">eval</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Environment</span> {
    <span style="color: #E5C2E5; font-weight: bold;">loop</span> {
        <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Some</span>(err) = get_error(<span style="color: #ffffff; background-color: #000000;">&amp;</span>env) {
            <span style="color: #E5C2E5; font-weight: bold;">if</span> !err.is_handled {
                env = unwind(env); <span style="color: #AD9292;">// </span><span style="color: #AD9292;">TODO: this should be done in eval_step</span>
            };
        }
        <span style="color: #E5C2E5; font-weight: bold;">if</span> !env.expression.is_empty() {
            env = eval_step(env).<span style="color: #E5C2E5; font-weight: bold;">await</span>;
        } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
            <span style="color: #E5C2E5; font-weight: bold;">break</span>;
        }
    }
    env
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">standard_env</span>(<span style="color: #E5E5A0; font-weight: bold;">program</span>: <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>&gt;, <span style="color: #E5E5A0; font-weight: bold;">stack</span>: <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>&gt;) -&gt; <span style="color: #C2E5C2;">Environment</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">prog_expr</span> = <span style="color: #E5C2E5; font-weight: bold;">match</span> program {
        <span style="color: #C2E5C2;">Some</span>(p) =&gt; <span style="color: #C2E5C2;">Stack</span>::from(p),
        _ =&gt; <span style="color: #C2E5C2;">Stack</span>::new(),
    };

    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">env</span> = <span style="color: #C2E5C2;">Environment</span> {
        <span style="color: #E5E5A0; font-weight: bold;">stack</span>: stack.unwrap_or(<span style="color: #C2E5C2;">Stack</span>::new()),
        <span style="color: #E5E5A0; font-weight: bold;">expression</span>: prog_expr,
        <span style="color: #E5E5A0; font-weight: bold;">dictionary</span>: <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Arc</span>::wrap(<span style="color: #C2E5C2;">HashMap</span>::&lt;<span style="color: #C2E5C2;">Word</span>, <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Entry</span>&gt;::new()),
    };
    add_standard_dictionary(env)
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">environment</span>(<span style="color: #E5E5A0; font-weight: bold;">p</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #C2E5C2;">Environment</span>::try_from(p).map(|e| e.into())
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">eval_step_outer</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">tos</span> = env.pop();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">inner_env</span> = <span style="color: #C2E5C2;">Environment</span>::try_from(tos);
    <span style="color: #E5C2E5; font-weight: bold;">match</span> inner_env {
        <span style="color: #C2E5C2;">Ok</span>(inner) =&gt; <span style="color: #C2E5C2;">Box</span>::pin(eval_step(inner).map(|inner_next| env.push(inner_next.into()))),
        <span style="color: #C2E5C2;">Err</span>(e) =&gt; env.push(e.into()).into(),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">evaluate</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">tos</span> = env.pop();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">inner_env</span> = <span style="color: #C2E5C2;">Environment</span>::try_from(tos);
    <span style="color: #E5C2E5; font-weight: bold;">match</span> inner_env {
        <span style="color: #C2E5C2;">Ok</span>(inner) =&gt; <span style="color: #C2E5C2;">Box</span>::pin(eval(inner).map(|inner_done| env.push(inner_done.into()))),
        <span style="color: #C2E5C2;">Err</span>(e) =&gt; env.push(e.into()).into(),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">identity</span>(<span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    env.into()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">dictionary</span>(<span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">d</span> = env.dictionary.clone();
    env.push(d.into()).into()
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">ceil</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">f</span> = <span style="color: #C2E5C2;">Float</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(f.ceil()))
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">sqrt</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i.sqrt())),
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(f) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(f.sqrt())),
        i =&gt; number_type_error(i),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">abs</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i.abs())),
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(f) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Float</span>(f.abs())),
        i =&gt; number_type_error(i),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">handle</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> i {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Associative</span>(
            <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Associative</span>::<span style="color: #C2E5C2;">Error</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> e),
        ))) =&gt; <span style="color: #C2E5C2;">Ok</span>({
            e.is_handled = <span style="color: #E5C2E5; font-weight: bold;">true</span>;
            e.into()
        }),
        i =&gt; <span style="color: #C2E5C2;">Ok</span>(i),
    }
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">fn inscription(env: &amp;mut Environment) -&gt; Result&lt;(Word, dict::Entry), Error&gt; {</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">let d = env.pop();</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">let mut wl = coll::List::try_from(env.pop())?;</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">let w1 = coll::Arc::make_mut(&amp;mut wl).pop_front();</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">let x = w1.ok_or(Error::short_list(1))?;</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">let w = Word::try_from(x.clone())?;</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">Ok((w, dict::Entry::try_from(d)?))</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">}</span>

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">pub fn inscribe(mut env: Environment) -&gt; Environment {</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">let r = inscription(&amp;mut env);</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">match r {</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">Ok((w, def)) =&gt; {</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">let d = coll::Arc::make_mut(&amp;mut env.dictionary);</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">d.insert(assoc::KeyItem::Word(w), Item::Entry(def));</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">env</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">Err(e) =&gt; env.push(e.into()),</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">}</span>

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">make 'true' a word that doesn't have to be quoted, just pushes</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">itself onto the stack.</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">true_</span>(<span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    env.push(<span style="color: #DDC29A; font-weight: bold;">"true"</span>.into()).into()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">fail</span>(<span style="color: #E5E5A0; font-weight: bold;">e</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">e</span>: <span style="color: #C2E5C2;">Error</span> = e.try_into().unwrap();
    e.is_handled = <span style="color: #E5C2E5; font-weight: bold;">false</span>;
    <span style="color: #C2E5C2;">Err</span>(e)
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">fn normalize_dictionary(mut d: dict::Dictionary) -&gt; Result&lt;dict::Dictionary, Error&gt; {</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">let dm = coll::Arc::make_mut(&amp;mut d);</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">for (k, v) in dm.iter_mut() {</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">match v {</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">Item::Assoc(a) =&gt; {</span>
<span style="color: #AD9292;">//                 </span><span style="color: #AD9292;">let aa = a.clone();</span>
<span style="color: #AD9292;">//                 </span><span style="color: #AD9292;">let (aa, _) = aa.insert("word".into(), Item::try_from(k.clone()).unwrap());</span>
<span style="color: #AD9292;">//                 </span><span style="color: #AD9292;">*v = Item::Entry(aa.try_into()?)</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">Item::List(l) =&gt; {</span>
<span style="color: #AD9292;">//                 </span><span style="color: #AD9292;">let a: assoc::Associative = l.clone().try_into()?;</span>
<span style="color: #AD9292;">//                 </span><span style="color: #AD9292;">let (a, _) = a.insert("word".into(), Item::try_from(k.clone()).unwrap());</span>
<span style="color: #AD9292;">//                 </span><span style="color: #AD9292;">*v = Item::Entry(a.try_into()?)</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">Item::Entry(_) =&gt; {}</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">_ =&gt; {</span>
<span style="color: #AD9292;">//                 </span><span style="color: #AD9292;">return Err(Error::expected("dictionary"));</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">Ok(d)</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">}</span>

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">redefine</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">d</span> = <span style="color: #A0E5E5; font-weight: bold;">dict</span>::<span style="color: #C2E5C2;">Dictionary</span>::try_from(env.pop());
    <span style="color: #E5C2E5; font-weight: bold;">match</span> d {
        <span style="color: #C2E5C2;">Ok</span>(d) =&gt; {
            env.dictionary = d;
            env
        }
        <span style="color: #C2E5C2;">Err</span>(e) =&gt; {
            env = env.push(e.into());
            env
        }
    }
    .into()
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">Takes an inner environment from the top of the stack, and spawns a</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">tokio task to evaluate that environment.</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">animate</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">tos</span> = env.pop();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">inner_env</span> = <span style="color: #C2E5C2;">Environment</span>::try_from(tos);
    <span style="color: #C2C2E5; font-weight: bold;">println!</span>(<span style="color: #DDC29A; font-weight: bold;">"Animating: </span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{:?}</span><span style="color: #DDC29A; font-weight: bold;">"</span>, inner_env);
    <span style="color: #E5C2E5; font-weight: bold;">match</span> inner_env {
        <span style="color: #C2E5C2;">Ok</span>(inner) =&gt; {
            <span style="color: #A0E5E5; font-weight: bold;">tokio</span>::spawn(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { eval(inner).<span style="color: #E5C2E5; font-weight: bold;">await</span> });
            env.into()
        }
        <span style="color: #C2E5C2;">Err</span>(e) =&gt; env.push(e.into()).into(),
    }
}
<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">xor_</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Bytes</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Bytes</span>) -&gt; <span style="color: #C2E5C2;">Bytes</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">len</span> = <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">cmp</span>::max(i.len(), j.len());
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">result</span> = <span style="color: #C2E5C2;">Vec</span>::with_capacity(len);
    <span style="color: #E5C2E5; font-weight: bold;">for</span> (byte_i, byte_j) <span style="color: #E5C2E5; font-weight: bold;">in</span> i
        .iter()
        .chain(<span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">iter</span>::repeat(<span style="color: #ffffff; background-color: #000000;">&amp;</span>0).take(len - i.len()))
        .zip(j.iter().chain(<span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">iter</span>::repeat(<span style="color: #ffffff; background-color: #000000;">&amp;</span>0).take(len - j.len())))
    {
        result.push(byte_i ^ byte_j);
    }
    result
}
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">xor</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> (i, j) {
        (<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i), <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(j)) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(i ^ j)),
        (
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(i))),
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(j))),
        ) =&gt; <span style="color: #C2E5C2;">Ok</span>(xor_(i, j).into()),
        (
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(i))),
            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Bytes</span>(j))),
        ) =&gt; <span style="color: #C2E5C2;">Ok</span>(xor_(i, j).into()),
        (i, j) =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"integers"</span>, pair(i, j))),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">inspect</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">s</span> = <span style="color: #C2C2E5; font-weight: bold;">format!</span>(<span style="color: #DDC29A; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{:?}</span><span style="color: #DDC29A; font-weight: bold;">"</span>, i);
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">String</span>(s),
    )))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">timestamps</span>(<span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    env.push(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Out</span>(<span style="color: #A0E5E5; font-weight: bold;">pipes</span>::<span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Time</span>)))
        .into()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">standard</span>(<span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    env.push(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Tunnel</span>(
        <span style="color: #A0E5E5; font-weight: bold;">pipes</span>::<span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Standard</span>,
    )))
    .into()
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">set</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Set</span>::try_from(i).map(|s| <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">Set</span>(s))))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">compare</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">ki</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">kj</span> = <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>::try_from(j)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">match</span> ki.partial_cmp(<span style="color: #ffffff; background-color: #000000;">&amp;</span>kj) {
        <span style="color: #C2E5C2;">Some</span>(<span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">cmp</span>::<span style="color: #C2E5C2;">Ordering</span>::<span style="color: #C2E5C2;">Less</span>) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #DDC29A; font-weight: bold;">"less"</span>.into()),
        <span style="color: #C2E5C2;">Some</span>(<span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">cmp</span>::<span style="color: #C2E5C2;">Ordering</span>::<span style="color: #C2E5C2;">Equal</span>) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #DDC29A; font-weight: bold;">"equal"</span>.into()),
        <span style="color: #C2E5C2;">Some</span>(<span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">cmp</span>::<span style="color: #C2E5C2;">Ordering</span>::<span style="color: #C2E5C2;">Greater</span>) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #DDC29A; font-weight: bold;">"greater"</span>.into()),
        <span style="color: #C2E5C2;">None</span> =&gt; <span style="color: #C2E5C2;">Err</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"comparable"</span>, pair(ki.into(), kj.into()))),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">as_pair</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;(<span style="color: #C2E5C2;">Item</span>, <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>), <span style="color: #C2E5C2;">Error</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">i</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">im</span> = i.make_mut();
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">j</span> = im.pop_front().ok_or(<span style="color: #C2E5C2;">Error</span>::short_list(1))<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">k</span> = im
        .pop_front()
        .ok_or(<span style="color: #C2E5C2;">Error</span>::short_list(2))
        .and_then(<span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>::try_from)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #C2E5C2;">Ok</span>((j, k))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">sort_by_key</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">l</span> = <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">it</span> = l.inner().into_iter().map(as_pair);
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">it</span> = it.collect::&lt;<span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Vec</span>&lt;(<span style="color: #C2E5C2;">Item</span>, <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">KeyItem</span>)&gt;, <span style="color: #C2E5C2;">Error</span>&gt;&gt;()<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    it.sort_unstable_by(|(_, a), (_, b)| a.partial_cmp(b).unwrap_or(<span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">cmp</span>::<span style="color: #C2E5C2;">Ordering</span>::<span style="color: #C2E5C2;">Less</span>));
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter(it.into_iter().map(|(k, _)| k)).into())
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgecaf640" class="outline-4">
<h4 id="orgecaf640"><span class="section-number-4">1.4.5.</span> Top level execution</h4>
<div class="outline-text-4" id="text-1-4-5">
<p>
We'll define the main module which reads input for the kcats
interpreter process, and prints output.
</p>

<p>
We'll also define how to run unit tests.
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">mod</span> <span style="color: #A0E5E5; font-weight: bold;">axiom</span>;
<span style="color: #E5C2E5; font-weight: bold;">mod</span> <span style="color: #A0E5E5; font-weight: bold;">crypto</span>;
<span style="color: #E5C2E5; font-weight: bold;">mod</span> <span style="color: #A0E5E5; font-weight: bold;">pipes</span>;
<span style="color: #E5C2E5; font-weight: bold;">mod</span> <span style="color: #A0E5E5; font-weight: bold;">serialize</span>;
<span style="color: #E5C2E5; font-weight: bold;">mod</span> <span style="color: #A0E5E5; font-weight: bold;">types</span>;

<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::{<span style="color: #A0E5E5; font-weight: bold;">environment</span>::<span style="color: #C2E5C2;">Environment</span>, error, *};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::io;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">io</span>::{<span style="color: #C2E5C2;">BufRead</span>, <span style="color: #C2E5C2;">Read</span>};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">sync</span>::<span style="color: #C2E5C2;">Arc</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">tokio</span>;

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">print_result</span>(<span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) {
    <span style="color: #E5C2E5; font-weight: bold;">if</span> env.expression.is_empty() {
        <span style="color: #C2C2E5; font-weight: bold;">println!</span>(<span style="color: #DDC29A; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{}</span><span style="color: #DDC29A; font-weight: bold;">"</span>, <span style="color: #A0E5E5; font-weight: bold;">serialize</span>::emit_all(<span style="color: #ffffff; background-color: #000000;">&amp;</span>env.stack));
    } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
        <span style="color: #C2C2E5; font-weight: bold;">println!</span>(
            <span style="color: #DDC29A; font-weight: bold;">"stack: </span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{}</span><span style="color: #DDC29A; font-weight: bold;">\nexpression: </span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{}</span><span style="color: #DDC29A; font-weight: bold;">"</span>,
            <span style="color: #A0E5E5; font-weight: bold;">serialize</span>::emit(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Item</span>::from(env.stack)),
            <span style="color: #A0E5E5; font-weight: bold;">serialize</span>::emit(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Item</span>::from(env.expression))
        )
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">get_stdin</span>() -&gt; <span style="color: #C2E5C2;">String</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">buf</span> = <span style="color: #C2E5C2;">String</span>::new();
    <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #E5E5A0; font-weight: bold;">line</span> <span style="color: #E5C2E5; font-weight: bold;">in</span> <span style="color: #A0E5E5; font-weight: bold;">io</span>::stdin().lock().lines() {
        buf.push_str(<span style="color: #ffffff; background-color: #000000;">&amp;</span>line.unwrap());
        buf.push(<span style="color: #DDC29A; font-weight: bold;">'\n'</span>);
    }
    buf
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">A function that takes a handle to stdin. It reads a length from</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">stdin, then reads that many bytes and returns a string.</span>
<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">read_input</span>() -&gt; <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; {
    <span style="color: #AD9292;">//</span><span style="color: #AD9292;">spawn a thread to read from stdin</span>
    <span style="color: #AD9292;">//</span><span style="color: #AD9292;">println!("Reading input");</span>
    <span style="color: #A0E5E5; font-weight: bold;">tokio</span>::spawn(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">stdin</span> = <span style="color: #A0E5E5; font-weight: bold;">io</span>::stdin().lock();
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">buf</span> = <span style="color: #C2E5C2;">String</span>::new();
        <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Err</span>(e) = stdin.read_line(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> buf) {
            <span style="color: #C2C2E5; font-weight: bold;">println!</span>(<span style="color: #DDC29A; font-weight: bold;">"Error reading content length </span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{:?}</span><span style="color: #DDC29A; font-weight: bold;">"</span>, e);
            <span style="color: #E5C2E5; font-weight: bold;">return</span> <span style="color: #C2E5C2;">None</span>;
        }
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">parse an integer from buf</span>
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">read_len</span> = buf.trim();
        <span style="color: #AD9292;">//</span><span style="color: #AD9292;">println!("Read length {}", read_len);</span>
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">len</span> = read_len.parse::&lt;<span style="color: #C2E5C2;">usize</span>&gt;().unwrap_or(0 <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">usize</span>);
        <span style="color: #E5C2E5; font-weight: bold;">if</span> len == 0 {
            <span style="color: #E5C2E5; font-weight: bold;">return</span> <span style="color: #C2E5C2;">None</span>;
        }
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">read len bytes from stdin</span>
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">buf</span> = <span style="color: #00fa9a; font-weight: bold;">vec!</span>[0; len];
        stdin.read_exact(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> buf).unwrap();

        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">convert the bytes to a string</span>
        <span style="color: #C2E5C2;">Some</span>(<span style="color: #C2E5C2;">String</span>::from_utf8(buf).unwrap())
    })
    .<span style="color: #E5C2E5; font-weight: bold;">await</span>
    .unwrap()
}

<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">print</span>(<span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Environment</span>) {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">result</span> = <span style="color: #A0E5E5; font-weight: bold;">serialize</span>::emit_all(<span style="color: #ffffff; background-color: #000000;">&amp;</span>env.stack);
    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">first print the length of the result</span>
    <span style="color: #C2C2E5; font-weight: bold;">println!</span>(<span style="color: #DDC29A; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{}</span><span style="color: #DDC29A; font-weight: bold;">\n</span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{}</span><span style="color: #DDC29A; font-weight: bold;">"</span>, result.len(), result);
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">a function that takes an env, and an input string. Parses the</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">string, if it parses, returns the env with the input added to the</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">expression. Otherwise returns Error.</span>
<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">parse_input</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>, <span style="color: #E5E5A0; font-weight: bold;">input</span>: <span style="color: #C2E5C2;">String</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Environment</span>, <span style="color: #A0E5E5; font-weight: bold;">error</span>::<span style="color: #C2E5C2;">Error</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">parsed</span> = <span style="color: #A0E5E5; font-weight: bold;">serialize</span>::parse(input)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">expr</span> = <span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> env.expression);
    expr.extend(<span style="color: #C2E5C2;">Arc</span>::make_mut(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> parsed).drain(..));
    <span style="color: #C2E5C2;">Ok</span>(env)
}

<span style="color: #AD9292;">//</span><span style="color: #AD9292;">It converts the bytes to a</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">string, and then evaluates that string as a kcats program. It then</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">prints the length of the result, and then the result itself.</span>
<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">interactive_mode</span>() {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">env</span> = <span style="color: #A0E5E5; font-weight: bold;">axiom</span>::standard_env(<span style="color: #C2E5C2;">None</span>, <span style="color: #C2E5C2;">None</span>);

    <span style="color: #E5C2E5; font-weight: bold;">loop</span> {
        <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Some</span>(program) = read_input().<span style="color: #E5C2E5; font-weight: bold;">await</span> {
            <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Ok</span>(parsed_env) = parse_input(env, program) {
                <span style="color: #AD9292;">//</span><span style="color: #AD9292;">env = parsed_env;</span>
                env = <span style="color: #A0E5E5; font-weight: bold;">axiom</span>::eval(parsed_env).<span style="color: #E5C2E5; font-weight: bold;">await</span>;
                print(<span style="color: #ffffff; background-color: #000000;">&amp;</span>env).<span style="color: #E5C2E5; font-weight: bold;">await</span>;
            } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                <span style="color: #C2C2E5; font-weight: bold;">println!</span>(<span style="color: #DDC29A; font-weight: bold;">"Could not parse input"</span>);
                <span style="color: #E5C2E5; font-weight: bold;">break</span>;
            }
        } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
            <span style="color: #AD9292;">//</span><span style="color: #AD9292;">println!("Blank input received, exiting");</span>
            <span style="color: #E5C2E5; font-weight: bold;">continue</span>;
        }
    }
}

<span style="color: #00fa9a; font-weight: bold;">#[tokio::main]</span>
<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">main</span>() {
    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">read command line options, to look for -i switch</span>
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">args</span>: <span style="color: #C2E5C2;">Vec</span>&lt;<span style="color: #C2E5C2;">String</span>&gt; = <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">env</span>::args().collect();
    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">if args contains "-i", read via handle_stdin</span>
    <span style="color: #E5C2E5; font-weight: bold;">if</span> args.contains(&amp;<span style="color: #DDC29A; font-weight: bold;">"-i"</span>.to_string()) {
        interactive_mode().<span style="color: #E5C2E5; font-weight: bold;">await</span>;
    } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">otherwise, read from stdin</span>
        <span style="color: #E5C2E5; font-weight: bold;">match</span> parse_input(<span style="color: #A0E5E5; font-weight: bold;">axiom</span>::standard_env(<span style="color: #C2E5C2;">None</span>, <span style="color: #C2E5C2;">None</span>), get_stdin()) {
            <span style="color: #C2E5C2;">Ok</span>(env) =&gt; {
                print_result(<span style="color: #A0E5E5; font-weight: bold;">axiom</span>::eval(env).<span style="color: #E5C2E5; font-weight: bold;">await</span>);
            }
            <span style="color: #C2E5C2;">Err</span>(e) =&gt; {
                <span style="color: #C2C2E5; font-weight: bold;">println!</span>(<span style="color: #DDC29A; font-weight: bold;">"Error parsing input: </span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{:?}</span><span style="color: #DDC29A; font-weight: bold;">"</span>, e);
            }
        }
    }
}

<span style="color: #00fa9a; font-weight: bold;">#[cfg(test)]</span>
<span style="color: #E5C2E5; font-weight: bold;">mod</span> <span style="color: #A0E5E5; font-weight: bold;">tests</span> {
    <span style="color: #AD9292;">// </span><span style="color: #AD9292;">Note this useful idiom: importing names from outer (for mod tests) scope.</span>
    <span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">super</span>::<span style="color: #A0E5E5; font-weight: bold;">error</span>::<span style="color: #C2E5C2;">Error</span>;
    <span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">super</span>::*;
    <span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::collection <span style="color: #E5C2E5; font-weight: bold;">as</span> coll;
    <span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">internment</span>::<span style="color: #C2E5C2;">Intern</span>;
    <span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">borrow</span>::<span style="color: #C2E5C2;">Borrow</span>;
    <span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">test_case</span>::test_case;
    <span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">tokio</span>;

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">get_item</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">index</span>: <span style="color: #C2E5C2;">usize</span>) -&gt; <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; {
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::try_from(i)
            .ok()
            .and_then(|l| <span style="color: #E5C2E5; font-weight: bold;">match</span> l.get(index) {
                <span style="color: #C2E5C2;">Some</span>(x) =&gt; <span style="color: #C2E5C2;">Some</span>(x.clone()),
                <span style="color: #C2E5C2;">None</span> =&gt; <span style="color: #C2E5C2;">None</span>,
            })
    }

    <span style="color: #00fa9a; font-weight: bold;">#[tokio::main]</span>
    <span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">test_example</span>(
        <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">prog_env</span>: <span style="color: #C2E5C2;">Environment</span>,
        <span style="color: #E5E5A0; font-weight: bold;">program</span>: <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>,
        <span style="color: #E5E5A0; font-weight: bold;">expected</span>: <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>,
    ) -&gt; <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">exp_env</span> = prog_env.clone();
        prog_env = prog_env.append_expression(program.clone());
        exp_env = exp_env.append_expression(expected.clone());

        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">p_fut</span> = <span style="color: #A0E5E5; font-weight: bold;">tokio</span>::spawn(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { <span style="color: #A0E5E5; font-weight: bold;">axiom</span>::eval(prog_env).<span style="color: #E5C2E5; font-weight: bold;">await</span> });

        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">exp_fut</span> = <span style="color: #A0E5E5; font-weight: bold;">tokio</span>::spawn(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { <span style="color: #A0E5E5; font-weight: bold;">axiom</span>::eval(exp_env).<span style="color: #E5C2E5; font-weight: bold;">await</span> });
        <span style="color: #E5C2E5; font-weight: bold;">let</span> (prog_env, exp_env) = <span style="color: #A0E5E5; font-weight: bold;">tokio</span>::<span style="color: #00fa9a; font-weight: bold;">join!</span>(p_fut, exp_fut);
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">prog_env</span> = prog_env.unwrap();
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">exp_env</span> = exp_env.unwrap();

        <span style="color: #E5C2E5; font-weight: bold;">if</span> prog_env.stack == exp_env.stack {
            <span style="color: #C2C2E5; font-weight: bold;">println!</span>(
                <span style="color: #DDC29A; font-weight: bold;">"Nice expected </span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{}</span><span style="color: #DDC29A; font-weight: bold;"> got </span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{}</span><span style="color: #DDC29A; font-weight: bold;">"</span>,
                <span style="color: #A0E5E5; font-weight: bold;">serialize</span>::emit_all(exp_env.stack.borrow()),
                <span style="color: #A0E5E5; font-weight: bold;">serialize</span>::emit_all(prog_env.stack.borrow())
            );
            <span style="color: #C2E5C2;">None</span>
        } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
            <span style="color: #C2C2E5; font-weight: bold;">println!</span>(
                <span style="color: #DDC29A; font-weight: bold;">"uh oh expected </span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{}</span><span style="color: #DDC29A; font-weight: bold;"> got </span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{}</span><span style="color: #DDC29A; font-weight: bold;">"</span>,
                <span style="color: #A0E5E5; font-weight: bold;">serialize</span>::emit_all(exp_env.stack.borrow()),
                <span style="color: #A0E5E5; font-weight: bold;">serialize</span>::emit_all(prog_env.stack.borrow())
            );
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">println!(</span>
            <span style="color: #AD9292;">//     </span><span style="color: #AD9292;">"Debug: expected {:?} got {:?}",</span>
            <span style="color: #AD9292;">//     </span><span style="color: #AD9292;">exp_env.stack, prog_env.stack</span>
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">);</span>
            <span style="color: #C2E5C2;">Some</span>(<span style="color: #C2E5C2;">Error</span>::test_assertion(program, expected, prog_env.stack))
        }
    }

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">test_word</span>(<span style="color: #E5E5A0; font-weight: bold;">standard_env</span>: <span style="color: #C2E5C2;">Environment</span>, <span style="color: #E5E5A0; font-weight: bold;">w</span>: <span style="color: #C2E5C2;">Word</span>) -&gt; <span style="color: #C2E5C2;">Vec</span>&lt;<span style="color: #C2E5C2;">Error</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Some</span>(d) = standard_env.dictionary.get(<span style="color: #ffffff; background-color: #000000;">&amp;</span>w) {
            d.examples
                .clone()
                .unwrap()
                .iter()
                .filter_map(|ex| {
                    <span style="color: #E5C2E5; font-weight: bold;">match</span> (
                        get_item(ex.clone(), 0).unwrap(),
                        get_item(ex.clone(), 1).unwrap(),
                    ) {
                        (
                            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(p))),
                            <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Sized</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Sized</span>::<span style="color: #C2E5C2;">List</span>(exp))),
                        ) =&gt; test_example(standard_env.clone(), p.clone(), exp.clone()),
                        (i, _) =&gt; <span style="color: #C2E5C2;">Some</span>(<span style="color: #C2E5C2;">Error</span>::expected(<span style="color: #DDC29A; font-weight: bold;">"list"</span>, i.into())),
                    }
                })
                .collect::&lt;<span style="color: #C2E5C2;">Vec</span>&lt;<span style="color: #C2E5C2;">Error</span>&gt;&gt;()
        } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
            <span style="color: #C2C2E5; font-weight: bold;">println!</span>(<span style="color: #DDC29A; font-weight: bold;">"Empty!"</span>);
            <span style="color: #C2E5C2;">Vec</span>::new()
        }
    }

    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"+"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"plus"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"-"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"minus"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"="</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"eq"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"&gt;"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"gt"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"&gt;="</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"gte"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"&lt;"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"lt"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"&lt;="</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"lte"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"*"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"mult"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"/"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"divide"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"abs"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"and"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"any?"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"is_any"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"assign"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"association"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"association?"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"is_association"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"bail"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"both?"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"is_both"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"branch"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"breaker"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"bytes"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"bytes?"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"is_bytes"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"ceil"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"clone"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"collect"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"compare"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"contains?"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"contains"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"count"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"dec"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"decide"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"decorate"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"decorated"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"dip"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"dipdown"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"drop"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"dropper"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"each"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"emit"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"environment"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"evaluate"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"eval_step"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"even?"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"is_even"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"evert"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"every?"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"is_every"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"execute"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"filter"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"first"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"float"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"functional"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"future"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"generate"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"if"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"inc"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"inject"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"inscribe"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"join"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"joiner"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"keep"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"let"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"lingo"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"list?"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"is_list"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"lookup"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"loop"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"map"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"max"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"min"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"mod"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"not"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"nothing?"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"is_nothing"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"number?"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"is_number"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"odd?"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"is_odd"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"or"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"pop"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"put"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"prepend"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"primrec"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"range"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"reduce"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"recover"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"recur"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"rest"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"retry"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"reverse"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"set"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"set?"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"is_set"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"shield"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"shielddown"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"shielddowndown"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"sink"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"snapshot"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"something?"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"is_something"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"sqrt"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"step"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"string"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"string?"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"is_string"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"swap"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"swapdown"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"take"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"taker"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"times"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"type"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"unassign"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"until"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"unwrap"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"update"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"value"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"while"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"within?"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"is_within"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"word?"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"wrap"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"xor"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"zero?"</span><span style="color: #00fa9a; font-weight: bold;"> ; </span><span style="color: #DDC29A; font-weight: bold;">"is_zero"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #00fa9a; font-weight: bold;">#[test_case(</span><span style="color: #DDC29A; font-weight: bold;">"zip"</span><span style="color: #00fa9a; font-weight: bold;">)]</span>
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">test_lexicon</span>(<span style="color: #E5E5A0; font-weight: bold;">word</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">str</span>) {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">e</span> = <span style="color: #A0E5E5; font-weight: bold;">axiom</span>::standard_env(<span style="color: #C2E5C2;">None</span>, <span style="color: #C2E5C2;">None</span>);

        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">r</span> = test_word(e.clone(), <span style="color: #C2E5C2;">Intern</span>::new(word.to_string()));
        <span style="color: #00fa9a; font-weight: bold;">assert!</span>(r.is_empty(), <span style="color: #DDC29A; font-weight: bold;">"{:?}"</span>, r);
    }
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">if let (Item::List(program), Item::List(expected)) = (program, expected) {</span>

<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">} else {</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">Err(Error::from("Example should be a pair"))</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">}</span>

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">for ex in d.examples().iter() {</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">let e = List::try_from(*ex).ok().unwrap();</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">let p = List::try_from(*e.get(0).unwrap()).ok().unwrap();</span>
<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">let exp = List::try_from(*e.get(1).unwrap()).ok().unwrap();</span>

<span style="color: #AD9292;">//             </span><span style="color: #AD9292;">test_example(axiom::standard_env.clone(), w, p,exp)</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">}.retain(|i| i.is_some()).collect::&lt;Vec&lt;Error&gt;&gt;()</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org5e8b907" class="outline-4">
<h4 id="org5e8b907"><span class="section-number-4">1.4.6.</span> Pipes (input/output)</h4>
<div class="outline-text-4" id="text-1-4-6">
<p>
Kcats will confine all i/o to pipes. You can put values into pipes and
they emerge elsewhere. Words that act on pipes are the only ones that
can be impure. Everything else is a value.
</p>
</div>
<ol class="org-ol">
<li><a id="org60fceb9"></a>Basic Types<br />
<div class="outline-text-6" id="text-1-4-6-0-1">
<p>
The basic pipe contracts.
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::collection <span style="color: #E5C2E5; font-weight: bold;">as</span> coll;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #A0E5E5; font-weight: bold;">error</span>::<span style="color: #C2E5C2;">Error</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::{<span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #C2E5C2;">Item</span>};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">sync</span>::<span style="color: #C2E5C2;">Arc</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">tokio</span>::<span style="color: #A0E5E5; font-weight: bold;">sync</span>::<span style="color: #C2E5C2;">RwLock</span>;

<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">futures</span>::executor;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">mod</span> <span style="color: #A0E5E5; font-weight: bold;">channel</span>;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">mod</span> <span style="color: #A0E5E5; font-weight: bold;">fs</span>;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">mod</span> <span style="color: #A0E5E5; font-weight: bold;">net</span>;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">mod</span> <span style="color: #A0E5E5; font-weight: bold;">standard</span>;
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">mod</span> <span style="color: #A0E5E5; font-weight: bold;">time</span>;

<span style="color: #00fa9a; font-weight: bold;">#[derive(Debug, Clone)]</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">enum</span> <span style="color: #C2E5C2;">In</span> {
    <span style="color: #C2E5C2;">StaticFile</span>(<span style="color: #C2E5C2;">Arc</span>&lt;<span style="color: #C2E5C2;">RwLock</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">fs</span>::<span style="color: #C2E5C2;">StaticFile</span>&gt;&gt;),
    <span style="color: #C2E5C2;">Socket</span>(<span style="color: #C2E5C2;">Arc</span>&lt;<span style="color: #C2E5C2;">RwLock</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">net</span>::<span style="color: #C2E5C2;">Socket</span>&gt;&gt;),
    <span style="color: #C2E5C2;">Handoff</span>(<span style="color: #A0E5E5; font-weight: bold;">channel</span>::<span style="color: #C2E5C2;">Handoff</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;),
    <span style="color: #C2E5C2;">Standard</span>,
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">PartialEq</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">In</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">eq</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">other</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Self</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> (<span style="color: #E5C2E5; font-weight: bold;">self</span>, other) {
            (<span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">StaticFile</span>(s1), <span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">StaticFile</span>(s2)) =&gt; <span style="color: #C2E5C2;">Arc</span>::ptr_eq(s1, s2),
            (<span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">Socket</span>(s1), <span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">Socket</span>(s2)) =&gt; <span style="color: #C2E5C2;">Arc</span>::ptr_eq(s1, s2),
            (<span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">Handoff</span>(h1), <span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">Handoff</span>(h2)) =&gt; h1 == h2,
            _ =&gt; <span style="color: #E5C2E5; font-weight: bold;">false</span>,
        }
    }
}

<span style="color: #00fa9a; font-weight: bold;">#[derive(Debug, Clone)]</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">enum</span> <span style="color: #C2E5C2;">Out</span> {
    <span style="color: #C2E5C2;">StaticFile</span>(<span style="color: #C2E5C2;">Arc</span>&lt;<span style="color: #C2E5C2;">RwLock</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">fs</span>::<span style="color: #C2E5C2;">StaticFile</span>&gt;&gt;),
    <span style="color: #C2E5C2;">Socket</span>(<span style="color: #C2E5C2;">Arc</span>&lt;<span style="color: #C2E5C2;">RwLock</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">net</span>::<span style="color: #C2E5C2;">Socket</span>&gt;&gt;),
    <span style="color: #C2E5C2;">ServerSocket</span>(<span style="color: #C2E5C2;">Arc</span>&lt;<span style="color: #C2E5C2;">RwLock</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">net</span>::<span style="color: #C2E5C2;">ServerSocket</span>&gt;&gt;),
    <span style="color: #C2E5C2;">Handoff</span>(<span style="color: #A0E5E5; font-weight: bold;">channel</span>::<span style="color: #C2E5C2;">Handoff</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;),
    <span style="color: #C2E5C2;">Time</span>,
    <span style="color: #C2E5C2;">Standard</span>,
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">PartialEq</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Out</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">eq</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">other</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Self</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> (<span style="color: #E5C2E5; font-weight: bold;">self</span>, other) {
            (<span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">StaticFile</span>(s1), <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">StaticFile</span>(s2)) =&gt; <span style="color: #C2E5C2;">Arc</span>::ptr_eq(s1, s2),
            (<span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Socket</span>(s1), <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Socket</span>(s2)) =&gt; <span style="color: #C2E5C2;">Arc</span>::ptr_eq(s1, s2),
            (<span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">ServerSocket</span>(s1), <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">ServerSocket</span>(s2)) =&gt; <span style="color: #C2E5C2;">Arc</span>::ptr_eq(s1, s2),
            (<span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Handoff</span>(h1), <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Handoff</span>(h2)) =&gt; h1 == h2,
            (<span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Time</span>, <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Time</span>) =&gt; <span style="color: #E5C2E5; font-weight: bold;">true</span>,
            (<span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Standard</span>, <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Standard</span>) =&gt; <span style="color: #E5C2E5; font-weight: bold;">true</span>,
            _ =&gt; <span style="color: #E5C2E5; font-weight: bold;">false</span>,
        }
    }
}

<span style="color: #00fa9a; font-weight: bold;">#[derive(Debug, Clone)]</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">enum</span> <span style="color: #C2E5C2;">Tunnel</span> {
    <span style="color: #C2E5C2;">StaticFile</span>(<span style="color: #C2E5C2;">Arc</span>&lt;<span style="color: #C2E5C2;">RwLock</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">fs</span>::<span style="color: #C2E5C2;">StaticFile</span>&gt;&gt;),
    <span style="color: #C2E5C2;">Socket</span>(<span style="color: #C2E5C2;">Arc</span>&lt;<span style="color: #C2E5C2;">RwLock</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">net</span>::<span style="color: #C2E5C2;">Socket</span>&gt;&gt;),
    <span style="color: #C2E5C2;">Handoff</span>(<span style="color: #A0E5E5; font-weight: bold;">channel</span>::<span style="color: #C2E5C2;">Handoff</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;),
    <span style="color: #C2E5C2;">Standard</span>,
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">PartialEq</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Tunnel</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">eq</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">other</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Self</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> (<span style="color: #E5C2E5; font-weight: bold;">self</span>, other) {
            (<span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">StaticFile</span>(s1), <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">StaticFile</span>(s2)) =&gt; <span style="color: #C2E5C2;">Arc</span>::ptr_eq(s1, s2),
            (<span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Socket</span>(s1), <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Socket</span>(s2)) =&gt; <span style="color: #C2E5C2;">Arc</span>::ptr_eq(s1, s2),
            (<span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Handoff</span>(h1), <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Handoff</span>(h2)) =&gt; h1 == h2,
            (<span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Standard</span>, <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Standard</span>) =&gt; <span style="color: #E5C2E5; font-weight: bold;">true</span>,
            _ =&gt; <span style="color: #E5C2E5; font-weight: bold;">false</span>,
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Tunnel</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Out</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">t</span>: <span style="color: #C2E5C2;">Tunnel</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> t {
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">StaticFile</span>(f) =&gt; <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">StaticFile</span>(f),
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Socket</span>(s) =&gt; <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Socket</span>(s),
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Handoff</span>(h) =&gt; <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Handoff</span>(h),
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Standard</span> =&gt; <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Standard</span>,
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Tunnel</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">In</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">t</span>: <span style="color: #C2E5C2;">Tunnel</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> t {
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">StaticFile</span>(f) =&gt; <span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">StaticFile</span>(f),
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Socket</span>(s) =&gt; <span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">Socket</span>(s),
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Handoff</span>(h) =&gt; <span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">Handoff</span>(h),
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Standard</span> =&gt; <span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">Standard</span>,
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">In</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">put</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Result</span>&lt;(), <span style="color: #C2E5C2;">Error</span>&gt;&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">StaticFile</span>(f) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">f</span> = f.clone();
                <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { f.write().<span style="color: #E5C2E5; font-weight: bold;">await</span>.put(i).<span style="color: #E5C2E5; font-weight: bold;">await</span> })
            }
            <span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">Socket</span>(f) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">f</span> = f.clone();
                <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { f.write().<span style="color: #E5C2E5; font-weight: bold;">await</span>.put(i).<span style="color: #E5C2E5; font-weight: bold;">await</span> })
            }
            <span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">Handoff</span>(<span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">h</span>) =&gt; <span style="color: #C2E5C2;">Box</span>::pin(h.put(i)), <span style="color: #AD9292;">//</span><span style="color: #AD9292;">_ =&gt; Err(Error::expected("foo")),</span>
            <span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">Standard</span> =&gt; <span style="color: #A0E5E5; font-weight: bold;">standard</span>::put(i),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Tunnel</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">put</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Result</span>&lt;(), <span style="color: #C2E5C2;">Error</span>&gt;&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">StaticFile</span>(f) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">f</span> = f.clone();
                <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { f.write().<span style="color: #E5C2E5; font-weight: bold;">await</span>.put(i).<span style="color: #E5C2E5; font-weight: bold;">await</span> })
            }
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Socket</span>(f) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">f</span> = f.clone();
                <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { f.write().<span style="color: #E5C2E5; font-weight: bold;">await</span>.put(i).<span style="color: #E5C2E5; font-weight: bold;">await</span> })
            }
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Handoff</span>(<span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">h</span>) =&gt; <span style="color: #C2E5C2;">Box</span>::pin(h.put(i)),
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Standard</span> =&gt; <span style="color: #A0E5E5; font-weight: bold;">standard</span>::put(i),
        }
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">take</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;, <span style="color: #C2E5C2;">Error</span>&gt;&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">StaticFile</span>(f) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">f</span> = f.clone();
                <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { f.write().<span style="color: #E5C2E5; font-weight: bold;">await</span>.take().<span style="color: #E5C2E5; font-weight: bold;">await</span> })
            }
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Socket</span>(f) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">f</span> = f.clone();
                <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { f.write().<span style="color: #E5C2E5; font-weight: bold;">await</span>.take().<span style="color: #E5C2E5; font-weight: bold;">await</span> })
            }
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Handoff</span>(<span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">h</span>) =&gt; <span style="color: #C2E5C2;">Box</span>::pin(h.take()),
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Standard</span> =&gt; <span style="color: #A0E5E5; font-weight: bold;">standard</span>::take(),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Out</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">take</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;, <span style="color: #C2E5C2;">Error</span>&gt;&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">StaticFile</span>(f) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">f</span> = f.clone();
                <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { f.write().<span style="color: #E5C2E5; font-weight: bold;">await</span>.take().<span style="color: #E5C2E5; font-weight: bold;">await</span> })
            }
            <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Socket</span>(f) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">f</span> = f.clone();
                <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { f.write().<span style="color: #E5C2E5; font-weight: bold;">await</span>.take().<span style="color: #E5C2E5; font-weight: bold;">await</span> })
            }
            <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">ServerSocket</span>(f) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">f</span> = f.clone();
                <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { f.write().<span style="color: #E5C2E5; font-weight: bold;">await</span>.take().<span style="color: #E5C2E5; font-weight: bold;">await</span> })
            }
            <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Handoff</span>(<span style="color: #E5C2E5; font-weight: bold;">ref</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">h</span>) =&gt; <span style="color: #C2E5C2;">Box</span>::pin(h.take()),
            <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Time</span> =&gt; <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #A0E5E5; font-weight: bold;">time</span>::take()),
            <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Standard</span> =&gt; <span style="color: #A0E5E5; font-weight: bold;">standard</span>::take(),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">serialize</span>::<span style="color: #C2E5C2;">Display</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">In</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">representation</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">StaticFile</span>(f) =&gt; <span style="color: #A0E5E5; font-weight: bold;">executor</span>::block_on(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { f.read().<span style="color: #E5C2E5; font-weight: bold;">await</span>.representation() }),
            <span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">Socket</span>(f) =&gt; <span style="color: #A0E5E5; font-weight: bold;">executor</span>::block_on(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { f.read().<span style="color: #E5C2E5; font-weight: bold;">await</span>.representation() }),
            <span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">Handoff</span>(h) =&gt; h.representation(),
            <span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">Standard</span> =&gt; <span style="color: #A0E5E5; font-weight: bold;">standard</span>::representation(),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">serialize</span>::<span style="color: #C2E5C2;">Display</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Out</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">representation</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">StaticFile</span>(f) =&gt; {
                <span style="color: #A0E5E5; font-weight: bold;">executor</span>::block_on(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { f.read().<span style="color: #E5C2E5; font-weight: bold;">await</span>.representation() })
            }
            <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Socket</span>(f) =&gt; <span style="color: #A0E5E5; font-weight: bold;">executor</span>::block_on(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { f.read().<span style="color: #E5C2E5; font-weight: bold;">await</span>.representation() }),
            <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">ServerSocket</span>(f) =&gt; {
                <span style="color: #A0E5E5; font-weight: bold;">executor</span>::block_on(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { f.read().<span style="color: #E5C2E5; font-weight: bold;">await</span>.representation() })
            }
            <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Handoff</span>(h) =&gt; h.representation(),
            <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Time</span> =&gt; <span style="color: #A0E5E5; font-weight: bold;">time</span>::representation(),
            <span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">Standard</span> =&gt; <span style="color: #A0E5E5; font-weight: bold;">standard</span>::representation(),
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">serialize</span>::<span style="color: #C2E5C2;">Display</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Tunnel</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">representation</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #E5C2E5; font-weight: bold;">self</span> {
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">StaticFile</span>(f) =&gt; {
                <span style="color: #A0E5E5; font-weight: bold;">executor</span>::block_on(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { f.read().<span style="color: #E5C2E5; font-weight: bold;">await</span>.representation() })
            }
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Socket</span>(f) =&gt; <span style="color: #A0E5E5; font-weight: bold;">executor</span>::block_on(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { f.read().<span style="color: #E5C2E5; font-weight: bold;">await</span>.representation() }),
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Handoff</span>(h) =&gt; h.representation(),
            <span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Standard</span> =&gt; <span style="color: #A0E5E5; font-weight: bold;">standard</span>::representation(),
        }
    }
}
<span style="color: #AD9292;">/* </span><span style="color: #AD9292;">Pipes can be "closed", from either end to signal that either the</span>
<span style="color: #AD9292;"> * putter or taker has gone away. Sometimes the type of pipe</span>
<span style="color: #AD9292;"> * may not really support this concept but an implementation is</span>
<span style="color: #AD9292;"> * required.  For example, files. When you open a file for writing and</span>
<span style="color: #AD9292;"> * then "close" it, that doesn't really do anything. Rust doesn't have</span>
<span style="color: #AD9292;"> * an explicit file close. You have to drop the reference to it, which</span>
<span style="color: #AD9292;"> * in kcats you can do by popping the pipe off the stack. Rust will</span>
<span style="color: #AD9292;"> * clean up automatically, other impls might have to reference count.</span>
<span style="color: #AD9292;"> *</span>
<span style="color: #AD9292;"> * The contract here is as follows:</span>
<span style="color: #AD9292;"> * 1. After calling close, put on the pipe returns an error</span>
<span style="color: #AD9292;"> *</span>
<span style="color: #AD9292;"> * 2. After calling close, take on the pipe will return still-buffered</span>
<span style="color: #AD9292;"> * items (if the pipe has a buffer), but once buffer is exhausted it</span>
<span style="color: #AD9292;"> * will return error.</span>
<span style="color: #AD9292;"> *</span>
<span style="color: #AD9292;"> * 2. Errors cannot be put into a pipe (the taker can't distinguish</span>
<span style="color: #AD9292;"> * between io error and an error value). To work around this, wrap the</span>
<span style="color: #AD9292;"> * error value in a list to quote it. Putting error into a pipe will</span>
<span style="color: #AD9292;"> * return an io error.</span>
<span style="color: #AD9292;"> *</span>
<span style="color: #AD9292;"> * 3. Once closed pipes cannot be ever be put into again. closed? will always</span>
<span style="color: #AD9292;"> * return true thereafter.</span>
<span style="color: #AD9292;"> *</span>
<span style="color: #AD9292;"> * One use case that has to be handled specially is a file we've fully</span>
<span style="color: #AD9292;"> * read but later someone else might write more bytes to the end. Does</span>
<span style="color: #AD9292;"> * the pipe close when we reach EOF? I think we might need to support</span>
<span style="color: #AD9292;"> * both types (a type that closes when hitting eof and one that</span>
<span style="color: #AD9292;"> * doesn't). The former is the "normal" use case, which will be the</span>
<span style="color: #AD9292;"> * default.</span>
<span style="color: #AD9292;"> *</span>
<span style="color: #AD9292;"> * These two types are basically static vs dynamic content. Either all</span>
<span style="color: #AD9292;"> * the content is known now, or it isn't.</span>
<span style="color: #AD9292;"> *</span>
<span style="color: #AD9292;">*/</span>

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">closed_error</span>(<span style="color: #E5E5A0; font-weight: bold;">on_take</span>: <span style="color: #C2E5C2;">bool</span>) -&gt; <span style="color: #C2E5C2;">Error</span> {
    <span style="color: #C2E5C2;">Error</span>::create(
        <span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">List</span>::from_iter([
            <span style="color: #C2E5C2;">Item</span>::from(<span style="color: #DDC29A; font-weight: bold;">"close"</span>),
            <span style="color: #E5C2E5; font-weight: bold;">if</span> on_take { <span style="color: #DDC29A; font-weight: bold;">"take"</span> } <span style="color: #E5C2E5; font-weight: bold;">else</span> { <span style="color: #DDC29A; font-weight: bold;">"put"</span> }.into(),
        ]),
        <span style="color: #DDC29A; font-weight: bold;">"attempt to use closed pipe"</span>,
        <span style="color: #C2E5C2;">None</span>,
    )
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Tunnel</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">t</span>: <span style="color: #C2E5C2;">Tunnel</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Tunnel</span>(t))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">Out</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">t</span>: <span style="color: #C2E5C2;">Out</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Dispenser</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Dispenser</span>::<span style="color: #C2E5C2;">Out</span>(t))
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">In</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">t</span>: <span style="color: #C2E5C2;">In</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Receptacle</span>(<span style="color: #A0E5E5; font-weight: bold;">coll</span>::<span style="color: #C2E5C2;">Receptacle</span>::<span style="color: #C2E5C2;">In</span>(t))
    }
}
</pre>
</div>
</div>
</li>
<li><a id="org9461dfb"></a>Files<br />
<div class="outline-text-6" id="text-1-4-6-0-2">
<p>
How to interact with files on disk
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">axiom</span>::<span style="color: #C2E5C2;">ItemResult</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::associative <span style="color: #E5C2E5; font-weight: bold;">as</span> assoc;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #A0E5E5; font-weight: bold;">error</span>::<span style="color: #C2E5C2;">Error</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::*;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">futures</span>::<span style="color: #C2E5C2;">Stream</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::future;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">pin</span>::<span style="color: #C2E5C2;">Pin</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::ptr;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">sync</span>::<span style="color: #C2E5C2;">Arc</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">task</span>::{<span style="color: #C2E5C2;">Context</span>, <span style="color: #C2E5C2;">Poll</span>};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">tokio</span>::<span style="color: #A0E5E5; font-weight: bold;">fs</span>::<span style="color: #C2E5C2;">File</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">tokio</span>::<span style="color: #A0E5E5; font-weight: bold;">io</span>::{<span style="color: #C2E5C2;">AsyncRead</span>, <span style="color: #C2E5C2;">ReadBuf</span>};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">tokio</span>::<span style="color: #A0E5E5; font-weight: bold;">io</span>::{<span style="color: #C2E5C2;">AsyncReadExt</span>, <span style="color: #C2E5C2;">AsyncWriteExt</span>};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">tokio</span>::<span style="color: #A0E5E5; font-weight: bold;">sync</span>::<span style="color: #C2E5C2;">RwLock</span>;

<span style="color: #00fa9a; font-weight: bold;">#[derive(Debug)]</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">struct</span> <span style="color: #C2E5C2;">StaticFile</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5E5A0; font-weight: bold;">file</span>: <span style="color: #C2E5C2;">File</span>,
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5E5A0; font-weight: bold;">path</span>: <span style="color: #C2E5C2;">String</span>,
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">PartialEq</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">StaticFile</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">eq</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">other</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Self</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">Check if the 'file' fields of both structs are the same by reference</span>
        <span style="color: #A0E5E5; font-weight: bold;">ptr</span>::eq(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>.file, <span style="color: #ffffff; background-color: #000000;">&amp;</span>other.file)
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">StaticFile</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">put</span>&lt;'<span style="color: #E5E5A0; font-weight: bold;">a</span>&gt;(
        <span style="color: #ffffff; background-color: #000000;">&amp;</span>'<span style="color: #E5E5A0; font-weight: bold;">a</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>,
        <span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>,
    ) -&gt; <span style="color: #C2E5C2;">Pin</span>&lt;<span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">future</span>::<span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Output</span> = <span style="color: #C2E5C2;">Result</span>&lt;(), <span style="color: #C2E5C2;">Error</span>&gt;&gt; + <span style="color: #C2E5C2;">Send</span> + '<span style="color: #E5E5A0; font-weight: bold;">a</span>&gt;&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">b</span> = <span style="color: #C2E5C2;">Bytes</span>::try_from(i);

        <span style="color: #E5C2E5; font-weight: bold;">match</span> b {
            <span style="color: #C2E5C2;">Ok</span>(bs) =&gt; <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { <span style="color: #E5C2E5; font-weight: bold;">self</span>.file.write_all(<span style="color: #ffffff; background-color: #000000;">&amp;</span>bs).<span style="color: #E5C2E5; font-weight: bold;">await</span>.map_err(|e| e.into()) }),
            <span style="color: #C2E5C2;">Err</span>(e) =&gt; <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #A0E5E5; font-weight: bold;">future</span>::ready(<span style="color: #C2E5C2;">Err</span>(e))),
        }
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">take</span>&lt;'<span style="color: #E5E5A0; font-weight: bold;">a</span>&gt;(
        <span style="color: #ffffff; background-color: #000000;">&amp;</span>'<span style="color: #E5E5A0; font-weight: bold;">a</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>,
    ) -&gt; <span style="color: #C2E5C2;">Pin</span>&lt;<span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">future</span>::<span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Output</span> = <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;, <span style="color: #C2E5C2;">Error</span>&gt;&gt; + <span style="color: #C2E5C2;">Send</span> + '<span style="color: #E5E5A0; font-weight: bold;">a</span>&gt;&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">bs</span> = [0<span style="color: #C2E5C2;">u8</span>; 1024];
        <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">ct</span> = <span style="color: #E5C2E5; font-weight: bold;">self</span>.file.read(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> bs).<span style="color: #E5C2E5; font-weight: bold;">await</span><span style="color: #C2C2E5; font-weight: bold;">?</span>;
            <span style="color: #E5C2E5; font-weight: bold;">if</span> ct == 0 {
                <span style="color: #AD9292;">// </span><span style="color: #AD9292;">EOF, no more takes since it's static</span>
                <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">None</span>)
            } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Some</span>(bs[0..ct].to_vec().into()))
            }
        })
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Stream</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">StaticFile</span> {
    <span style="color: #E5C2E5; font-weight: bold;">type</span> <span style="color: #C2E5C2;">Item</span> = <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Item</span>, <span style="color: #C2E5C2;">Error</span>&gt;;

    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">poll_next</span>(<span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>: <span style="color: #C2E5C2;">Pin</span>&lt;<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #C2E5C2;">Self</span>&gt;, <span style="color: #E5E5A0; font-weight: bold;">cx</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #C2E5C2;">Context</span>&lt;'<span style="color: #E5E5A0; font-weight: bold;">_</span>&gt;) -&gt; <span style="color: #C2E5C2;">Poll</span>&lt;<span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Self</span>::<span style="color: #C2E5C2;">Item</span>&gt;&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">buf</span> = <span style="color: #00fa9a; font-weight: bold;">vec!</span>[0<span style="color: #C2E5C2;">u8</span>; 1024];
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">read_buf</span> = <span style="color: #C2E5C2;">ReadBuf</span>::new(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> buf);

        <span style="color: #E5C2E5; font-weight: bold;">match</span> <span style="color: #C2E5C2;">Pin</span>::new(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>.file).poll_read(cx, <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> read_buf) {
            <span style="color: #C2E5C2;">Poll</span>::<span style="color: #C2E5C2;">Ready</span>(<span style="color: #C2E5C2;">Ok</span>(())) =&gt; {
                <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">bytes_read</span> = read_buf.filled().len();
                <span style="color: #E5C2E5; font-weight: bold;">if</span> bytes_read == 0 {
                    <span style="color: #C2E5C2;">Poll</span>::<span style="color: #C2E5C2;">Ready</span>(<span style="color: #C2E5C2;">None</span>)
                } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                    <span style="color: #C2E5C2;">Poll</span>::<span style="color: #C2E5C2;">Ready</span>(<span style="color: #C2E5C2;">Some</span>(<span style="color: #C2E5C2;">Ok</span>(read_buf.filled().to_owned().into())))
                }
            }
            <span style="color: #C2E5C2;">Poll</span>::<span style="color: #C2E5C2;">Ready</span>(<span style="color: #C2E5C2;">Err</span>(e)) =&gt; <span style="color: #C2E5C2;">Poll</span>::<span style="color: #C2E5C2;">Ready</span>(<span style="color: #C2E5C2;">Some</span>(<span style="color: #C2E5C2;">Err</span>(e.into()))),
            <span style="color: #C2E5C2;">Poll</span>::<span style="color: #C2E5C2;">Pending</span> =&gt; <span style="color: #C2E5C2;">Poll</span>::<span style="color: #C2E5C2;">Pending</span>,
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">serialize</span>::<span style="color: #C2E5C2;">Display</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">StaticFile</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">representation</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::from_iter([
            (<span style="color: #DDC29A; font-weight: bold;">"type"</span>.into(), <span style="color: #DDC29A; font-weight: bold;">"tunnel"</span>.into()),
            (
                <span style="color: #DDC29A; font-weight: bold;">"values"</span>.into(),
                <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::from_iter([(<span style="color: #DDC29A; font-weight: bold;">"type"</span>.into(), <span style="color: #DDC29A; font-weight: bold;">"bytes"</span>.into())]).into(),
            ),
            (
                <span style="color: #DDC29A; font-weight: bold;">"to"</span>.into(),
                <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::from_iter([(<span style="color: #DDC29A; font-weight: bold;">"file"</span>.into(), <span style="color: #E5C2E5; font-weight: bold;">self</span>.path.clone().into())]).into(),
            ),
        ])
        .into()
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">file_in</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">path</span> = <span style="color: #C2E5C2;">String</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">file</span> = <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">fs</span>::<span style="color: #C2E5C2;">File</span>::options()
        .read(<span style="color: #E5C2E5; font-weight: bold;">true</span>)
        .write(<span style="color: #E5C2E5; font-weight: bold;">true</span>)
        .create_new(<span style="color: #E5C2E5; font-weight: bold;">true</span>)
        .open(path.clone())<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #E5C2E5; font-weight: bold;">super</span>::<span style="color: #C2E5C2;">In</span>::<span style="color: #C2E5C2;">StaticFile</span>(<span style="color: #C2E5C2;">Arc</span>::new(<span style="color: #C2E5C2;">RwLock</span>::new(<span style="color: #C2E5C2;">StaticFile</span> {
        <span style="color: #E5E5A0; font-weight: bold;">file</span>: <span style="color: #C2E5C2;">File</span>::from_std(file),
        path,
    })))
    .into())
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">file_out</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">ItemResult</span> {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">path</span> = <span style="color: #C2E5C2;">String</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">file</span> = <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">fs</span>::<span style="color: #C2E5C2;">File</span>::open(path.clone())<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #E5C2E5; font-weight: bold;">super</span>::<span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">StaticFile</span>(<span style="color: #C2E5C2;">Arc</span>::new(<span style="color: #C2E5C2;">RwLock</span>::new(<span style="color: #C2E5C2;">StaticFile</span> {
        <span style="color: #E5E5A0; font-weight: bold;">file</span>: <span style="color: #C2E5C2;">File</span>::from_std(file),
        path,
    })))
    .into())
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #C2E5C2;">StaticFile</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">f</span>: <span style="color: #C2E5C2;">StaticFile</span>) -&gt; <span style="color: #C2E5C2;">Self</span> {
        <span style="color: #E5C2E5; font-weight: bold;">super</span>::<span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">StaticFile</span>(<span style="color: #C2E5C2;">Arc</span>::new(<span style="color: #C2E5C2;">RwLock</span>::new(f))).into()
    }
}
</pre>
</div>
</div>
</li>
<li><a id="org7735f9d"></a>Network<br />
<div class="outline-text-6" id="text-1-4-6-0-3">
<p>
How to interact with the network (TCP/IP sockets)
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">axiom</span>::<span style="color: #C2E5C2;">ItemResult</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::associative <span style="color: #E5C2E5; font-weight: bold;">as</span> assoc;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #A0E5E5; font-weight: bold;">error</span>::<span style="color: #C2E5C2;">Error</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::{<span style="color: #E5C2E5; font-weight: bold;">self</span>, wrap, <span style="color: #C2E5C2;">Int</span>, <span style="color: #C2E5C2;">Item</span>};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">futures</span>::<span style="color: #A0E5E5; font-weight: bold;">future</span>::<span style="color: #C2E5C2;">FutureExt</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">future</span>::{<span style="color: #E5C2E5; font-weight: bold;">self</span>};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">net</span>::{<span style="color: #C2E5C2;">Ipv4Addr</span>, <span style="color: #C2E5C2;">SocketAddr</span>, <span style="color: #C2E5C2;">SocketAddrV4</span>};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">pin</span>::<span style="color: #C2E5C2;">Pin</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::ptr;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #C2E5C2;">str</span>::<span style="color: #C2E5C2;">FromStr</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">sync</span>::<span style="color: #C2E5C2;">Arc</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">tokio</span>::<span style="color: #A0E5E5; font-weight: bold;">io</span>::{<span style="color: #C2E5C2;">AsyncReadExt</span>, <span style="color: #C2E5C2;">AsyncWriteExt</span>};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">tokio</span>::<span style="color: #A0E5E5; font-weight: bold;">net</span>::{<span style="color: #C2E5C2;">TcpListener</span>, <span style="color: #C2E5C2;">TcpStream</span>};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">tokio</span>::<span style="color: #A0E5E5; font-weight: bold;">sync</span>::<span style="color: #C2E5C2;">RwLock</span>;

<span style="color: #00fa9a; font-weight: bold;">#[derive(Debug)]</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">struct</span> <span style="color: #C2E5C2;">Socket</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5E5A0; font-weight: bold;">socket</span>: <span style="color: #C2E5C2;">TcpStream</span>,
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5E5A0; font-weight: bold;">addr</span>: <span style="color: #C2E5C2;">SocketAddr</span>,
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">PartialEq</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Socket</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">eq</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">other</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Self</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">Check if the 'socket' fields of both structs are the same by reference</span>
        <span style="color: #A0E5E5; font-weight: bold;">ptr</span>::eq(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>.socket, <span style="color: #ffffff; background-color: #000000;">&amp;</span>other.socket)
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Socket</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">put</span>&lt;'<span style="color: #E5E5A0; font-weight: bold;">a</span>&gt;(
        <span style="color: #ffffff; background-color: #000000;">&amp;</span>'<span style="color: #E5E5A0; font-weight: bold;">a</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>,
        <span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>,
    ) -&gt; <span style="color: #C2E5C2;">Pin</span>&lt;<span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">future</span>::<span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Output</span> = <span style="color: #C2E5C2;">Result</span>&lt;(), <span style="color: #C2E5C2;">Error</span>&gt;&gt; + <span style="color: #C2E5C2;">Send</span> + '<span style="color: #E5E5A0; font-weight: bold;">a</span>&gt;&gt; {
        <span style="color: #C2C2E5; font-weight: bold;">println!</span>(<span style="color: #DDC29A; font-weight: bold;">"Putting </span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{:?}</span><span style="color: #DDC29A; font-weight: bold;">"</span>, i);
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">b</span> = <span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #C2E5C2;">Bytes</span>::try_from(i);
        <span style="color: #E5C2E5; font-weight: bold;">match</span> b {
            <span style="color: #C2E5C2;">Ok</span>(bs) =&gt; {
                <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> { <span style="color: #E5C2E5; font-weight: bold;">self</span>.socket.write_all(<span style="color: #ffffff; background-color: #000000;">&amp;</span>bs).<span style="color: #E5C2E5; font-weight: bold;">await</span>.map_err(|e| e.into()) })
            }
            <span style="color: #C2E5C2;">Err</span>(e) =&gt; <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #A0E5E5; font-weight: bold;">future</span>::ready(<span style="color: #C2E5C2;">Err</span>(e))),
        }
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">take</span>&lt;'<span style="color: #E5E5A0; font-weight: bold;">a</span>&gt;(
        <span style="color: #ffffff; background-color: #000000;">&amp;</span>'<span style="color: #E5E5A0; font-weight: bold;">a</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>,
    ) -&gt; <span style="color: #C2E5C2;">Pin</span>&lt;<span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">future</span>::<span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Output</span> = <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;, <span style="color: #C2E5C2;">Error</span>&gt;&gt; + <span style="color: #C2E5C2;">Send</span> + '<span style="color: #E5E5A0; font-weight: bold;">a</span>&gt;&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">bs</span> = [0<span style="color: #C2E5C2;">u8</span>; 1024];
        <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">n</span> = <span style="color: #E5C2E5; font-weight: bold;">self</span>.socket.read(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> bs).<span style="color: #E5C2E5; font-weight: bold;">await</span><span style="color: #C2C2E5; font-weight: bold;">?</span>;
            <span style="color: #E5C2E5; font-weight: bold;">if</span> n == 0 {
                <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">None</span>)
            } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
                <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Some</span>(bs[..n].to_vec().into()))
            }
        })
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">serialize</span>::<span style="color: #C2E5C2;">Display</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Socket</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">representation</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::from_iter([
            (<span style="color: #DDC29A; font-weight: bold;">"type"</span>.into(), <span style="color: #DDC29A; font-weight: bold;">"tunnel"</span>.into()),
            (<span style="color: #DDC29A; font-weight: bold;">"realm"</span>.into(), <span style="color: #DDC29A; font-weight: bold;">"tcp"</span>.into()),
            (<span style="color: #DDC29A; font-weight: bold;">"address"</span>.into(), <span style="color: #E5C2E5; font-weight: bold;">self</span>.addr.to_string().into()),
        ])
        .into()
    }
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">Server sockets</span>
<span style="color: #00fa9a; font-weight: bold;">#[derive(Debug)]</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">struct</span> <span style="color: #C2E5C2;">ServerSocket</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5E5A0; font-weight: bold;">socket</span>: <span style="color: #C2E5C2;">TcpListener</span>,
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">PartialEq</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">ServerSocket</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">eq</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">other</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Self</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">Check if the 'socket' fields of both structs are the same by reference</span>
        <span style="color: #A0E5E5; font-weight: bold;">ptr</span>::eq(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>.socket, <span style="color: #ffffff; background-color: #000000;">&amp;</span>other.socket)
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">ServerSocket</span> {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">take</span>&lt;'<span style="color: #E5E5A0; font-weight: bold;">a</span>&gt;(
        <span style="color: #ffffff; background-color: #000000;">&amp;</span>'<span style="color: #E5E5A0; font-weight: bold;">a</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>,
    ) -&gt; <span style="color: #C2E5C2;">Pin</span>&lt;<span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">future</span>::<span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Output</span> = <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;, <span style="color: #C2E5C2;">Error</span>&gt;&gt; + <span style="color: #C2E5C2;">Send</span> + '<span style="color: #E5E5A0; font-weight: bold;">a</span>&gt;&gt; {
        <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> (socket, addr) = <span style="color: #E5C2E5; font-weight: bold;">self</span>.socket.accept().<span style="color: #E5C2E5; font-weight: bold;">await</span><span style="color: #C2C2E5; font-weight: bold;">?</span>;

            <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Some</span>(
                <span style="color: #E5C2E5; font-weight: bold;">super</span>::<span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Socket</span>(<span style="color: #C2E5C2;">Arc</span>::new(<span style="color: #C2E5C2;">RwLock</span>::new(<span style="color: #C2E5C2;">Socket</span> { socket, addr }))).into(),
            ))
        })
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">serialize</span>::<span style="color: #C2E5C2;">Display</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">ServerSocket</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">representation</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::from_iter([
            (<span style="color: #DDC29A; font-weight: bold;">"type"</span>.into(), <span style="color: #DDC29A; font-weight: bold;">"pipe"</span>.into()),
            (
                <span style="color: #DDC29A; font-weight: bold;">"serversocket"</span>.into(),
                <span style="color: #DDC29A; font-weight: bold;">"todo: fix serversocket local addr async issue"</span>.into(), <span style="color: #AD9292;">//</span><span style="color: #AD9292;">Item::String(self.socket.lock().await.local_addr().unwrap().to_string()),</span>
            ),
        ])
        .into()
    }
}

<span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">socket_addr</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">SocketAddrV4</span>, <span style="color: #C2E5C2;">Error</span>&gt; {
    <span style="color: #C2C2E5; font-weight: bold;">println!</span>(<span style="color: #DDC29A; font-weight: bold;">"socket: </span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{:?}</span><span style="color: #DDC29A; font-weight: bold;"> </span><span style="color: #DDC29A; font-weight: bold; font-style: italic;">{:?}</span><span style="color: #DDC29A; font-weight: bold;">"</span>, i, j);
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">addr</span> = <span style="color: #C2E5C2;">Ipv4Addr</span>::from_str(<span style="color: #C2E5C2;">String</span>::try_from(j)<span style="color: #C2C2E5; font-weight: bold;">?</span>.as_str())<span style="color: #C2C2E5; font-weight: bold;">?</span>;
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">port</span> = <span style="color: #C2E5C2;">Int</span>::try_from(i)<span style="color: #C2C2E5; font-weight: bold;">?</span> <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">u16</span>;
    <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">SocketAddrV4</span>::new(addr, port))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">server_socket</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>, <span style="color: #E5E5A0; font-weight: bold;">j</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">ItemResult</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">match</span> socket_addr(i, j) {
        <span style="color: #C2E5C2;">Ok</span>(addr) =&gt; {
            <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #C2E5C2;">TcpListener</span>::bind(addr).map(|l| {
                <span style="color: #C2E5C2;">Ok</span>(<span style="color: #E5C2E5; font-weight: bold;">super</span>::<span style="color: #C2E5C2;">Out</span>::<span style="color: #C2E5C2;">ServerSocket</span>(<span style="color: #C2E5C2;">Arc</span>::new(<span style="color: #C2E5C2;">RwLock</span>::new(<span style="color: #C2E5C2;">ServerSocket</span> {
                    <span style="color: #E5E5A0; font-weight: bold;">socket</span>: l.unwrap(),
                })))
                .into())
            }))
        }
        <span style="color: #C2E5C2;">Err</span>(e) =&gt; <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #A0E5E5; font-weight: bold;">future</span>::ready(<span style="color: #C2E5C2;">Err</span>(e))),
    }
}

<span style="color: #AD9292;">// </span><span style="color: #AD9292;">pub fn server_socket(env: Environment) -&gt; environment::Future {</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">let addr = env.pop();</span>

<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">let inner_env = Environment::try_from(tos);</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">match inner_env {</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">Ok(inner) =&gt; Box::pin(eval_step(inner).map(|inner_next| env.push(Item::Env(inner_next)))),</span>
<span style="color: #AD9292;">//         </span><span style="color: #AD9292;">Err(e) =&gt; env.push(Item::Error(e)).into(),</span>
<span style="color: #AD9292;">//     </span><span style="color: #AD9292;">}</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">}</span>

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">From</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">net</span>::<span style="color: #C2E5C2;">AddrParseError</span>&gt; <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Error</span> {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">from</span>(<span style="color: #E5E5A0; font-weight: bold;">err</span>: <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">net</span>::<span style="color: #C2E5C2;">AddrParseError</span>) -&gt; <span style="color: #C2E5C2;">Error</span> {
        <span style="color: #C2E5C2;">Error</span>::create(wrap(<span style="color: #DDC29A; font-weight: bold;">"addrparse"</span>.into()), <span style="color: #ffffff; background-color: #000000;">&amp;</span>err.to_string(), <span style="color: #C2E5C2;">None</span>)
    }
}
</pre>
</div>
</div>
</li>
<li><a id="org79805a1"></a>Time<br />
<div class="outline-text-6" id="text-1-4-6-0-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::associative <span style="color: #E5C2E5; font-weight: bold;">as</span> assoc;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #A0E5E5; font-weight: bold;">error</span>::<span style="color: #C2E5C2;">Error</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::*;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::{
    future,
    <span style="color: #A0E5E5; font-weight: bold;">time</span>::{<span style="color: #C2E5C2;">SystemTime</span>, <span style="color: #C2E5C2;">UNIX_EPOCH</span>},
};

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">take</span>() -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;, <span style="color: #C2E5C2;">Error</span>&gt;&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">t</span> = <span style="color: #C2E5C2;">SystemTime</span>::now()
        .duration_since(<span style="color: #C2E5C2;">UNIX_EPOCH</span>)
        .unwrap()
        .as_millis() <span style="color: #E5C2E5; font-weight: bold;">as</span> <span style="color: #C2E5C2;">Int</span>;
    <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #A0E5E5; font-weight: bold;">future</span>::ready(<span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Some</span>(<span style="color: #C2E5C2;">Item</span>::<span style="color: #C2E5C2;">Int</span>(t)))))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">representation</span>() -&gt; <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::from_iter([
        (<span style="color: #DDC29A; font-weight: bold;">"type"</span>.into(), <span style="color: #DDC29A; font-weight: bold;">"out"</span>.into()),
        (<span style="color: #DDC29A; font-weight: bold;">"from"</span>.into(), <span style="color: #DDC29A; font-weight: bold;">"systemtime"</span>.into()),
        (
            <span style="color: #DDC29A; font-weight: bold;">"values"</span>.into(),
            <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::from_iter([
                (<span style="color: #DDC29A; font-weight: bold;">"type"</span>.into(), <span style="color: #DDC29A; font-weight: bold;">"integer"</span>.into()),
                (<span style="color: #DDC29A; font-weight: bold;">"units"</span>.into(), <span style="color: #DDC29A; font-weight: bold;">"milliseconds"</span>.into()),
            ])
            .into(),
        ),
    ])
    .into()
}
</pre>
</div>
</div>
</li>
<li><a id="org36bce51"></a>Standard in/out<br />
<div class="outline-text-6" id="text-1-4-6-0-5">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::associative <span style="color: #E5C2E5; font-weight: bold;">as</span> assoc;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #A0E5E5; font-weight: bold;">error</span>::<span style="color: #C2E5C2;">Error</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::{<span style="color: #E5C2E5; font-weight: bold;">self</span>, *};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::future;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::<span style="color: #A0E5E5; font-weight: bold;">io</span>::{<span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #C2E5C2;">Read</span>, <span style="color: #C2E5C2;">Write</span>};

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">take</span>() -&gt; <span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;, <span style="color: #C2E5C2;">Error</span>&gt;&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5E5A0; font-weight: bold;">buf</span> = [0<span style="color: #C2E5C2;">u8</span>];
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">n</span> = <span style="color: #A0E5E5; font-weight: bold;">io</span>::stdin().read(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> buf);
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">f</span> = <span style="color: #E5C2E5; font-weight: bold;">match</span> n {
        <span style="color: #C2E5C2;">Ok</span>(0) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">None</span>),
        <span style="color: #C2E5C2;">Ok</span>(n) =&gt; <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">Some</span>(buf[..n].to_vec().into())),
        <span style="color: #C2E5C2;">Err</span>(e) =&gt; <span style="color: #C2E5C2;">Err</span>(e.into()),
    };
    <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #A0E5E5; font-weight: bold;">future</span>::ready(f))
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">put</span>(<span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Result</span>&lt;(), <span style="color: #C2E5C2;">Error</span>&gt;&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">bs</span> = <span style="color: #C2E5C2;">Bytes</span>::try_from(i);
    <span style="color: #E5C2E5; font-weight: bold;">match</span> bs {
        <span style="color: #C2E5C2;">Ok</span>(bs) =&gt; {
            <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #E5E5A0; font-weight: bold;">f</span> = <span style="color: #A0E5E5; font-weight: bold;">io</span>::stdout().write(<span style="color: #ffffff; background-color: #000000;">&amp;</span>bs);
            <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #A0E5E5; font-weight: bold;">future</span>::ready(f.map_err(|e| e.into()).map(|_| ())))
        }
        <span style="color: #C2E5C2;">Err</span>(e) =&gt; <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #A0E5E5; font-weight: bold;">future</span>::ready(<span style="color: #C2E5C2;">Err</span>(e))),
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">representation</span>() -&gt; <span style="color: #C2E5C2;">Item</span> {
    <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::from_iter([
        (<span style="color: #DDC29A; font-weight: bold;">"type"</span>.into(), <span style="color: #DDC29A; font-weight: bold;">"tunnel"</span>.into()),
        (<span style="color: #DDC29A; font-weight: bold;">"peer"</span>.into(), <span style="color: #DDC29A; font-weight: bold;">"standard"</span>.into()),
    ])
    .into()
}
</pre>
</div>
</div>
</li>
<li><a id="org72a63a8"></a>Channels<br />
<div class="outline-text-6" id="text-1-4-6-0-6">
<p>
Implement the <code>handoff</code> type
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::pipes;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::associative <span style="color: #E5C2E5; font-weight: bold;">as</span> assoc;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #A0E5E5; font-weight: bold;">environment</span>::<span style="color: #C2E5C2;">Environment</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #A0E5E5; font-weight: bold;">error</span>::<span style="color: #C2E5C2;">Error</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">types</span>::{<span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #C2E5C2;">Item</span>};
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">flume</span>;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::future;
<span style="color: #E5C2E5; font-weight: bold;">use</span> <span style="color: #A0E5E5; font-weight: bold;">std</span>::ptr;

<span style="color: #00fa9a; font-weight: bold;">#[derive(Debug, Clone)]</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">Use Option because we want to be able to drop senders/receivers to</span>
<span style="color: #AD9292;">// </span><span style="color: #AD9292;">close the channel</span>
<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">struct</span> <span style="color: #C2E5C2;">Handoff</span>&lt;<span style="color: #C2E5C2;">T</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5E5A0; font-weight: bold;">receiver</span>: <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">flume</span>::<span style="color: #C2E5C2;">Receiver</span>&lt;<span style="color: #C2E5C2;">T</span>&gt;&gt;,
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5E5A0; font-weight: bold;">sender</span>: <span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #A0E5E5; font-weight: bold;">flume</span>::<span style="color: #C2E5C2;">Sender</span>&lt;<span style="color: #C2E5C2;">T</span>&gt;&gt;,
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span>&lt;<span style="color: #C2E5C2;">T</span>&gt; <span style="color: #C2E5C2;">PartialEq</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Handoff</span>&lt;<span style="color: #C2E5C2;">T</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">eq</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">other</span>: <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #C2E5C2;">Self</span>) -&gt; <span style="color: #C2E5C2;">bool</span> {
        <span style="color: #AD9292;">// </span><span style="color: #AD9292;">Check if the 'file' fields of both structs are the same by reference</span>
        <span style="color: #E5C2E5; font-weight: bold;">match</span> (<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>.receiver, <span style="color: #ffffff; background-color: #000000;">&amp;</span>other.receiver, <span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>.sender, <span style="color: #ffffff; background-color: #000000;">&amp;</span>other.sender) {
            (<span style="color: #C2E5C2;">Some</span>(sr), <span style="color: #C2E5C2;">Some</span>(or), <span style="color: #C2E5C2;">Some</span>(ss), <span style="color: #C2E5C2;">Some</span>(os)) =&gt; <span style="color: #A0E5E5; font-weight: bold;">ptr</span>::eq(<span style="color: #ffffff; background-color: #000000;">&amp;</span>sr, <span style="color: #ffffff; background-color: #000000;">&amp;</span>or) &amp;&amp; <span style="color: #A0E5E5; font-weight: bold;">ptr</span>::eq(<span style="color: #ffffff; background-color: #000000;">&amp;</span>ss, <span style="color: #ffffff; background-color: #000000;">&amp;</span>os),
            _ =&gt; <span style="color: #E5C2E5; font-weight: bold;">false</span>,
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Handoff</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">new</span>() -&gt; <span style="color: #C2E5C2;">Handoff</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">let</span> (sender, receiver) = <span style="color: #A0E5E5; font-weight: bold;">flume</span>::bounded::&lt;<span style="color: #C2E5C2;">Item</span>&gt;(0);
        <span style="color: #C2E5C2;">Handoff</span>::&lt;<span style="color: #C2E5C2;">Item</span>&gt; {
            <span style="color: #E5E5A0; font-weight: bold;">sender</span>: <span style="color: #C2E5C2;">Some</span>(sender),
            <span style="color: #E5E5A0; font-weight: bold;">receiver</span>: <span style="color: #C2E5C2;">Some</span>(receiver),
        }
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">put</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>, <span style="color: #E5E5A0; font-weight: bold;">i</span>: <span style="color: #C2E5C2;">Item</span>) -&gt; <span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Result</span>&lt;(), <span style="color: #C2E5C2;">Error</span>&gt;&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Some</span>(ch) = <span style="color: #E5C2E5; font-weight: bold;">self</span>.sender.clone() {
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">Can't send and receive in the same channel in same thread</span>
            <span style="color: #E5C2E5; font-weight: bold;">if</span> !<span style="color: #E5C2E5; font-weight: bold;">self</span>.receiver.is_none() {
                <span style="color: #AD9292;">//</span><span style="color: #AD9292;">println!("Dropping receiver");</span>
                <span style="color: #E5C2E5; font-weight: bold;">self</span>.receiver = <span style="color: #C2E5C2;">None</span>;
            }
            <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> {
                ch.send_async(i)
                    .<span style="color: #E5C2E5; font-weight: bold;">await</span>
                    .map_err(|_| <span style="color: #A0E5E5; font-weight: bold;">pipes</span>::closed_error(<span style="color: #E5C2E5; font-weight: bold;">false</span>))
            })
        } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
            <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #A0E5E5; font-weight: bold;">future</span>::ready(<span style="color: #C2E5C2;">Err</span>(<span style="color: #A0E5E5; font-weight: bold;">pipes</span>::closed_error(<span style="color: #E5C2E5; font-weight: bold;">false</span>))))
        }
    }

    <span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">take</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">mut</span> <span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Result</span>&lt;<span style="color: #C2E5C2;">Option</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt;, <span style="color: #C2E5C2;">Error</span>&gt;&gt; {
        <span style="color: #E5C2E5; font-weight: bold;">if</span> <span style="color: #E5C2E5; font-weight: bold;">let</span> <span style="color: #C2E5C2;">Some</span>(ch) = <span style="color: #E5C2E5; font-weight: bold;">self</span>.receiver.clone() {
            <span style="color: #AD9292;">// </span><span style="color: #AD9292;">Can't send and receive in the same channel in same thread</span>
            <span style="color: #E5C2E5; font-weight: bold;">if</span> !<span style="color: #E5C2E5; font-weight: bold;">self</span>.sender.is_none() {
                <span style="color: #AD9292;">//</span><span style="color: #AD9292;">println!("Dropping sender");</span>
                <span style="color: #E5C2E5; font-weight: bold;">self</span>.sender = <span style="color: #C2E5C2;">None</span>;
            }
            <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #E5C2E5; font-weight: bold;">async</span> <span style="color: #E5C2E5; font-weight: bold;">move</span> {
                <span style="color: #AD9292;">//</span><span style="color: #AD9292;">println!("Receiving");</span>
                ch.recv_async().<span style="color: #E5C2E5; font-weight: bold;">await</span>.map(<span style="color: #C2E5C2;">Some</span>).or_else(|_| <span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">None</span>))
            })
        } <span style="color: #E5C2E5; font-weight: bold;">else</span> {
            <span style="color: #C2E5C2;">Box</span>::pin(<span style="color: #A0E5E5; font-weight: bold;">future</span>::ready(<span style="color: #C2E5C2;">Ok</span>(<span style="color: #C2E5C2;">None</span>)))
        }
    }
}

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #E5C2E5; font-weight: bold;">crate</span>::<span style="color: #A0E5E5; font-weight: bold;">serialize</span>::<span style="color: #C2E5C2;">Display</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Handoff</span>&lt;<span style="color: #C2E5C2;">Item</span>&gt; {
    <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">representation</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span><span style="color: #E5C2E5; font-weight: bold;">self</span>) -&gt; <span style="color: #C2E5C2;">Item</span> {
        <span style="color: #A0E5E5; font-weight: bold;">assoc</span>::<span style="color: #C2E5C2;">Association</span>::from_iter([
            (<span style="color: #DDC29A; font-weight: bold;">"type"</span>.into(), <span style="color: #DDC29A; font-weight: bold;">"pipe"</span>.into()),
            (<span style="color: #DDC29A; font-weight: bold;">"handoff"</span>.into(), <span style="color: #DDC29A; font-weight: bold;">"todo: id-or-hash here"</span>.into()),
        ])
        .into()
    }
}

<span style="color: #E5C2E5; font-weight: bold;">pub</span> <span style="color: #E5C2E5; font-weight: bold;">fn</span> <span style="color: #E5E57E; font-weight: bold;">handoff</span>(<span style="color: #E5E5A0; font-weight: bold;">env</span>: <span style="color: #C2E5C2;">Environment</span>) -&gt; <span style="color: #A0E5E5; font-weight: bold;">types</span>::<span style="color: #C2E5C2;">Future</span>&lt;<span style="color: #C2E5C2;">Environment</span>&gt; {
    env.push(<span style="color: #A0E5E5; font-weight: bold;">pipes</span>::<span style="color: #C2E5C2;">Tunnel</span>::<span style="color: #C2E5C2;">Handoff</span>(<span style="color: #C2E5C2;">Handoff</span>::new()).into())
        .into()
}
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div id="outline-container-org8c0a655" class="outline-3">
<h3 id="org8c0a655"><span class="section-number-3">1.5.</span> Issues</h3>
<div class="outline-text-3" id="text-1-5">
</div>
<div id="outline-container-orgc1ce6e0" class="outline-4">
<h4 id="orgc1ce6e0"><span class="section-number-4">1.5.1.</span> <span class="todo INPROGRESS">INPROGRESS</span> Interactive mode&#xa0;&#xa0;&#xa0;<span class="tag"><span class="tools">tools</span></span></h4>
<div class="outline-text-4" id="text-1-5-1">
<p>
run with <code>kcats -i</code> for interactive, where you get a repl-like
prompt. Each prompt accepts kcats items as input, and updates the
state accordingly. There are special commands to print the current
state, clear it, write to file, etc.
</p>
</div>
<div id="outline-container-org37aaf84" class="outline-5">
<h5 id="org37aaf84"><span class="section-number-5">1.5.1.1.</span> <span class="todo TODO">TODO</span> Only print the changed part of the stack</h5>
</div>
<div id="outline-container-orga8d20b2" class="outline-5">
<h5 id="orga8d20b2"><span class="section-number-5">1.5.1.2.</span> <span class="todo TODO">TODO</span> Emacs keybindings to send common stack ops</h5>
<div class="outline-text-5" id="text-1-5-1-2">
<ul class="org-ul">
<li>swap / swapdown</li>
<li>clear ([] evert drop)</li>
<li>clone</li>
<li>snapshot?</li>
<li>discard</li>
<li>sink / float</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org6f6e1a3" class="outline-4">
<h4 id="org6f6e1a3"><span class="section-number-4">1.5.2.</span> <span class="done DONE">DONE</span> Install the lexicon in the proper place</h4>
<div class="outline-text-4" id="text-1-5-2">
<p>
Right now it's assumed to be in the src dir, but if we move the binary
it won't be able to find the lexicon file. The build process should be
able to place it in <code>/usr/share/kcats</code> or <code>~/.local/share/kcats</code> or
whatever the proper place is. Will have to look into how cargo
normally does this sort of thing.
</p>
</div>
</div>

<div id="outline-container-orgf84da9a" class="outline-4">
<h4 id="orgf84da9a"><span class="section-number-4">1.5.3.</span> <span class="done CANCELED">CANCELED</span> Add option to read an alternative lexicon file</h4>
<div class="outline-text-4" id="text-1-5-3">
<p>
The builtins can stay inside the binary, but we should have a cmdline
option to start without the usual lexicon. Should probably add a word
'lexicon' to add a parsed object as the lexicon.
</p>
</div>
</div>
<div id="outline-container-orgf40d4c5" class="outline-4">
<h4 id="orgf40d4c5"><span class="section-number-4">1.5.4.</span> <span class="todo TODO">TODO</span> Package the binary for various platforms</h4>
<div class="outline-text-4" id="text-1-5-4">
<p>
Would be nice to build rpms/debs etc so users can skip the nasty build
process.
</p>
</div>
</div>
<div id="outline-container-org6a5d56d" class="outline-4">
<h4 id="org6a5d56d"><span class="section-number-4">1.5.5.</span> <span class="done DONE">DONE</span> Optimize memory allocation</h4>
<div class="outline-text-4" id="text-1-5-5">
</div>
<div id="outline-container-orgda255b5" class="outline-5">
<h5 id="orgda255b5"><span class="section-number-5">1.5.5.1.</span> <span class="done DONE">DONE</span> Lists</h5>
<div class="outline-text-5" id="text-1-5-5-1">
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>a b<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>a<span style="color: #696969; font-weight: bold;">]</span> lookup
</pre>
</div>

<pre class="example">
b
</pre>
</div>
</div>
</div>
<div id="outline-container-org21de4b8" class="outline-4">
<h4 id="org21de4b8"><span class="section-number-4">1.5.6.</span> <span class="done DONE">DONE</span> pack and unpack are not inverse</h4>
<div class="outline-text-4" id="text-1-5-6">
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> unpack pack
</pre>
</div>

<pre class="example">

[[2 3 1]]
</pre>


<p>
It should result in [1 2 3], since people would assume unpack just
does the opposite of pack. But it doesn't, it takes items from the
front and pack puts them on the end.
</p>

<p>
Solution: rename to put take
</p>
</div>
</div>
<div id="outline-container-org7af50ee" class="outline-4">
<h4 id="org7af50ee"><span class="section-number-4">1.5.7.</span> <span class="done DONE">DONE</span> true and false are not words?</h4>
<div class="outline-text-4" id="text-1-5-7">
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> word?
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #E5C2E5; font-weight: bold;">true</span>
</pre>
</div>

<p>
If you didn't know <code>true</code> was a boolean you would think it was a
word. In the general sense it is a word. Should it be one technically
as well? I lean towards yes (return true if word or boolean).
</p>

<p>
It's messy because true/false are the only "words" you can put onto
the stack without wrapping.
</p>

<p>
There are several ways to deal with this:
</p>

<ul class="org-ul">
<li>just leave as is (these look like words but don't act like them)</li>

<li>Use something else for boolean values, like 0b 1b or something (ugly, no)</li>

<li>Revert to allowing bare words (that aren't actions) to go onto the
stack unwrapped, so that true/false aren't different</li>
</ul>

<p>
Right now I'm inclined to leave as-is, as it's the least bad
solution. Allowing undefined words to just go onto the stack is going
to mask all kinds of errors and will cause untold headaches.
</p>
</div>
</div>
<div id="outline-container-orgeeb7475" class="outline-4">
<h4 id="orgeeb7475"><span class="section-number-4">1.5.8.</span> <span class="done DONE">DONE</span> Division by zero panics</h4>
</div>
<div id="outline-container-orgb4b5614" class="outline-4">
<h4 id="orgb4b5614"><span class="section-number-4">1.5.9.</span> <span class="todo INPROGRESS">INPROGRESS</span> Implement pipes&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></h4>
<div class="outline-text-4" id="text-1-5-9">
</div>
<div id="outline-container-orgd157840" class="outline-5">
<h5 id="orgd157840"><span class="section-number-5">1.5.9.1.</span> <span class="done DONE">DONE</span> Write to a file</h5>
<div class="outline-text-5" id="text-1-5-9-1">
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>file <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">/tmp/bar4</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> pipe-in

<span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">hello world!</span><span style="color: #DDB579; font-weight: bold;">"</span>
 <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">Nice to meet you!</span><span style="color: #DDB579; font-weight: bold;">"</span>
 <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">My name is kcats</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span>

<span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">\n</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #E5E57E; font-weight: bold;">join</span> bytes <span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span>

<span style="color: #E5E57E; font-weight: bold;">step</span>
</pre>
</div>

<pre class="example">
[[asked [pipe]] [unwound [["Nice to meet you!" "My name is kcats"] ["\n" join bytes put] step]] [type error] [reason "type mismatch"]] [[type pipe] [file "/tmp/bar4"]]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>file <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">/tmp/bar101r7</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> pipe-in

<span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">hello world!</span><span style="color: #DDB579; font-weight: bold;">"</span>

bytes <span style="color: #E5E57E; font-weight: bold;">put</span>

</pre>
</div>

<pre class="example">
[[type pipe] [file "/tmp/bar101r7"]]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>file <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">/tmp/bar101r7</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> pipe-out

<span style="color: #E5E57E; font-weight: bold;">take</span>

string

</pre>
</div>

<pre class="example">
"hello world!" [[type pipe] [file "/tmp/bar101r7"]]
</pre>
</div>
</div>

<div id="outline-container-org25c80e7" class="outline-5">
<h5 id="org25c80e7"><span class="section-number-5">1.5.9.2.</span> <span class="done DONE">DONE</span> Read from a file</h5>
<div class="outline-text-5" id="text-1-5-9-2">
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #DDB579; font-weight: bold;">""</span> <span style="color: #696969; font-weight: bold;">[</span>string <span style="color: #E5E57E; font-weight: bold;">join</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>file <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">/tmp/bar2</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> pipe-out

collect 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">
stack: <span style="color: #696969; font-weight: bold;">[[[</span>reason <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">type mismatch</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>asked <span style="color: #696969; font-weight: bold;">[</span>pipe<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>type error<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>file <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">/tmp/bar2</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>type pipe<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #DDB579; font-weight: bold;">""</span><span style="color: #696969; font-weight: bold;">]</span>
expression: <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span>string <span style="color: #E5E57E; font-weight: bold;">join</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #696969; font-weight: bold;">[</span>closed? not<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span>string <span style="color: #E5E57E; font-weight: bold;">join</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #696969; font-weight: bold;">[</span>closed? not<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">loop</span> discard<span style="color: #696969; font-weight: bold;">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">dictionary <span style="color: #696969; font-weight: bold;">[</span>collect spec<span style="color: #696969; font-weight: bold;">]</span> lookup
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">
<span style="color: #696969; font-weight: bold;">[[[</span>type error<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>reason <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">word is not defined</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>asked <span style="color: #696969; font-weight: bold;">[</span>fail<span style="color: #696969; font-weight: bold;">]]]</span>
 <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">Lookup attempted on non association value</span><span style="color: #DDB579; font-weight: bold;">"</span>
 <span style="color: #696969; font-weight: bold;">[</span>spec<span style="color: #696969; font-weight: bold;">]</span>
 <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #696969; font-weight: bold;">[[</span>closed? not<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #00fa9a; font-weight: bold;">while</span> discard<span style="color: #696969; font-weight: bold;">]]</span>
  <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>pipe program<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]]]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orga070eff" class="outline-5">
<h5 id="orga070eff"><span class="section-number-5">1.5.9.3.</span> <span class="done DONE">DONE</span> Close a pipe</h5>
<div class="outline-text-5" id="text-1-5-9-3">
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>file <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">/tmp/foopytoop</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> pipe-in <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes <span style="color: #E5E57E; font-weight: bold;">put</span> close <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">bar</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes <span style="color: #E5E57E; font-weight: bold;">put</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>type pipe<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>file <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">/tmp/foopytoop</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org32ed505" class="outline-5">
<h5 id="org32ed505"><span class="section-number-5">1.5.9.4.</span> <span class="done DONE">DONE</span> Serialize pipes with something sane</h5>
<div class="outline-text-5" id="text-1-5-9-4">
<p>
Maybe they can't be easily round-tripped, but at least we can print
something reasonable that will tell human eyes what it is.
something like[[type pipe-in] [file "/tmp/foo"]]
</p>
</div>
</div>
<div id="outline-container-orga082c59" class="outline-5">
<h5 id="orga082c59"><span class="section-number-5">1.5.9.5.</span> <span class="done DONE">DONE</span> Sockets</h5>
<div class="outline-text-5" id="text-1-5-9-5">
</div>
<ol class="org-ol">
<li><a id="org9c31698"></a><span class="done DONE">DONE</span> Server Sockets<br />
<div class="outline-text-6" id="text-1-5-9-5-1">
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>type ip-port<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>address <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">127.0.0.1</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>port 11211<span style="color: #696969; font-weight: bold;">]]</span> pipe-out 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">socket: Int(11211) String(<span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">127.0.0.1</span><span style="color: #DDB579; font-weight: bold;">"</span>)
<span style="color: #696969; font-weight: bold;">[[</span>type pipe<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>serversocket todo: fix serversocket local addr async issue<span style="color: #696969; font-weight: bold;">]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">127.0.0.1</span><span style="color: #DDB579; font-weight: bold;">"</span> 12345 serversocket 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">socket: Int(12345) String(<span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">127.0.0.1</span><span style="color: #DDB579; font-weight: bold;">"</span>)
<span style="color: #696969; font-weight: bold;">[[</span>type pipe<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>serversocket todo: fix serversocket local addr async issue<span style="color: #696969; font-weight: bold;">]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>type ip-port<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>address <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">127.0.0.1</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>port 11211<span style="color: #696969; font-weight: bold;">]]</span> pipe-out <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">server socket</span>
<span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">accept connection by taking a socket out of the pipe</span>
<span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo\n</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">write a message to the socket</span>
<span style="color: #E5E57E; font-weight: bold;">take</span> string <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">get a message from the socket</span>
<span style="color: #696969; font-weight: bold;">[</span>discard <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">close the socket</span>
 discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">close the server socket</span>
<span style="color: #00fa9a; font-weight: bold;">dip</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>asked <span style="color: #696969; font-weight: bold;">[</span>string<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>unwound <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo\n</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #E5E57E; font-weight: bold;">take</span> string <span style="color: #696969; font-weight: bold;">[</span>discard discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>type error<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>reason <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">type mismatch</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span>
</pre>
</div>
</div>
</li>

<li><a id="org58d787e"></a><span class="done DONE">DONE</span> Sockets<br /></li>

<li><a id="org70320c2"></a><span class="todo INPROGRESS">INPROGRESS</span> Assemble is broken when reading files<br />
<div class="outline-text-6" id="text-1-5-9-5-3">
<p>
I think it's because <code>closed?</code> is broken.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #DDB579; font-weight: bold;">""</span> <span style="color: #696969; font-weight: bold;">[</span>string <span style="color: #E5E57E; font-weight: bold;">join</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>file <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">bar</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> pipe-out assemble
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #DDB579; font-weight: bold;">""</span> <span style="color: #696969; font-weight: bold;">[</span>string <span style="color: #E5E57E; font-weight: bold;">join</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>file <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">bar</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> pipe-out <span style="color: #E5E57E; font-weight: bold;">take</span> discard <span style="color: #E5E57E; font-weight: bold;">take</span> discard closed? 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">checking file closed <span style="color: #E5C2E5; font-weight: bold;">false</span>
Got 3 bytes
checking file closed <span style="color: #E5C2E5; font-weight: bold;">false</span>
Got 0 bytes
Closing!
checking file closed <span style="color: #E5C2E5; font-weight: bold;">false</span>
<span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #696969; font-weight: bold;">[</span>string <span style="color: #E5E57E; font-weight: bold;">join</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #DDB579; font-weight: bold;">""</span>
</pre>
</div>

<p>
I see the problem. When we clone the pipe, we also clone the <code>closed</code>
boolean and we shouldn't be doing that. There should only be one copy
of that. The entire struct should be in an Arc&lt;Mutex&gt; and not just the
file field. And when we modify the boolean, we shouldn't 
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgb3934c9" class="outline-5">
<h5 id="orgb3934c9"><span class="section-number-5">1.5.9.6.</span> <span class="done DONE">DONE</span> Convert In/Out traits to enums in pipes modules</h5>
<div class="outline-text-5" id="text-1-5-9-6">
<p>
Enums seem to work well elsewhere, and since pipes are also a closed
set, we can use them here too.
</p>

<p>
I don't think there will ever be user-created pipe types as it would
have to be done in rust and not in kcats.
</p>
</div>
</div>

<div id="outline-container-orgdb5a1cd" class="outline-5">
<h5 id="orgdb5a1cd"><span class="section-number-5">1.5.9.7.</span> <span class="todo TODO">TODO</span> Composable transforms</h5>
<div class="outline-text-5" id="text-1-5-9-7">
<p>
There should be some way to compose transforms in a pipe. For example,
we can have a pipe that when you put bytes in it, it gets written to a
certain file on disk. But what we really want is that we put bytes
into it, and they get compressed with lz4 before being written to
disk.
</p>

<p>
I suppose pump could take an optional transducer-like thing, and <b>those</b>
could be composable. The transformations I'm thinking of generally
aren't going to be i/o, it's pure computation. Actually I guess any
pipe could take an optional transform. Clojure.core.async channels do this.
</p>

<p>
Maybe the first thing to do is implement transducers?
</p>
</div>
</div>

<div id="outline-container-org40c9f9c" class="outline-5">
<h5 id="org40c9f9c"><span class="section-number-5">1.5.9.8.</span> <span class="done CANCELED">CANCELED</span> Filled pipes</h5>
<div class="outline-text-5" id="text-1-5-9-8">
<p>
Mostly for testing purposes, takes a list and creates a buffered pipe
that offers list items until the list is exhausted and then returns pipe closed errors.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> filled <span style="color: #E5E57E; font-weight: bold;">take</span>
</pre>
</div>

<pre class="example">
1 [[type pipe] [filled todo: id-or-hash here]]
</pre>
</div>
</div>

<div id="outline-container-orgea088ae" class="outline-5">
<h5 id="orgea088ae"><span class="section-number-5">1.5.9.9.</span> <span class="todo TODO">TODO</span> Object pipes</h5>
<div class="outline-text-5" id="text-1-5-9-9">
<p>
These pipes should send serialized kcats objects and each put/take
should transfer 1 object. Maybe use protocol buffers or similar
</p>

<p>
This could be done using a network pipe, and an assemble function that
pulls byte chunks and builds objects when there are enough bytes for
one object, and puts them into a handoff pipe.
</p>

<p>
This should be possible to do entirely in kcats.
</p>
</div>
</div>

<div id="outline-container-org9f54c39" class="outline-5">
<h5 id="org9f54c39"><span class="section-number-5">1.5.9.10.</span> <span class="done DONE">DONE</span> Time pipe</h5>
<div class="outline-text-5" id="text-1-5-9-10">
<p>
Each take from the pipe return the current unix time in ms.  Should be
a "singleton" - probably using Box::leak, so that we can insert a copy
of this pipe whenever we want and it's always a reference to the same
object. Might be an Arc for compatibility even though we don't need to
ref count. (But I suspect we don't need the Arc).
</p>

<div class="org-src-container">
<pre class="src src-kcats">timestamps <span style="color: #E5E57E; font-weight: bold;">take</span>
</pre>
</div>

<pre class="example">
1687273991929 [[from systemtime] [values [[type integer] [units milliseconds]]] [type out]]
</pre>
</div>
</div>

<div id="outline-container-org4aee8ec" class="outline-5">
<h5 id="org4aee8ec"><span class="section-number-5">1.5.9.11.</span> <span class="done DONE">DONE</span> stdin/stdout pipes</h5>
<div class="outline-text-5" id="text-1-5-9-11">
<p>
Should also be singleton. Should it always be a tunnel or should we
allow separate access to in or out?
</p>

<div class="org-src-container">
<pre class="src src-kcats">standard <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes <span style="color: #E5E57E; font-weight: bold;">put</span>
</pre>
</div>

<pre class="example">
foo[[type tunnel] [peer standard]]
</pre>


<p>
Stdin is not tested, since currently the interpreter reads the program
from stdin. May need to change that (read the program from filesystem
and let the program itself access stdin).
</p>
</div>
</div>
<div id="outline-container-org1e9225e" class="outline-5">
<h5 id="org1e9225e"><span class="section-number-5">1.5.9.12.</span> <span class="todo TODO">TODO</span> Pipe take outcome</h5>
<div class="outline-text-5" id="text-1-5-9-12">
<p>
There is some inconsistency with what happens when there's nothing
left - empty lists just return nothing on take, but closed pipes
return an error. May need to resolve this inconsistency.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">List</th>
<th scope="col" class="org-left">Handoff</th>
<th scope="col" class="org-left">Socket</th>
<th scope="col" class="org-left">StaticFile</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">take Items</td>
<td class="org-left">Item</td>
<td class="org-left">Item</td>
<td class="org-left">Bytes</td>
<td class="org-left">Bytes</td>
</tr>

<tr>
<td class="org-left">take Past EOF</td>
<td class="org-left">Nothing</td>
<td class="org-left">Nothing</td>
<td class="org-left">Nothing</td>
<td class="org-left">Nothing</td>
</tr>

<tr>
<td class="org-left">step Past EOF</td>
<td class="org-left">Exit</td>
<td class="org-left">Exit</td>
<td class="org-left">Exit</td>
<td class="org-left">Exit</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-org0f61e94" class="outline-4">
<h4 id="org0f61e94"><span class="section-number-4">1.5.10.</span> <span class="done DONE">DONE</span> 'Fail' is not defined</h4>
<div class="outline-text-4" id="text-1-5-10">
<p>
We need to be able to throw our own errors (eg lookup tries to do this)
</p>

<div class="org-src-container">
<pre class="src src-kcats">1 2 <span style="color: #696969; font-weight: bold;">[</span>1 <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">two</span><span style="color: #DDB579; font-weight: bold;">"</span> +<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>fail<span style="color: #696969; font-weight: bold;">]</span> recover 3 4 
</pre>
</div>

<pre class="example">
converting to error: Error([[type error] [asked [number]] [unwound [+]] [reason "type mismatch"]])
[[type error] [asked [number]] [unwound [3 4]] [reason "type mismatch"]] 2 1
</pre>
</div>
</div>

<div id="outline-container-org9a91eab" class="outline-4">
<h4 id="org9a91eab"><span class="section-number-4">1.5.11.</span> <span class="done DONE">DONE</span> 'dictionary' doesn't allow access to the data inside definitions</h4>
<div class="outline-text-4" id="text-1-5-11">
<p>
The definition is just shown as the word itself and we can't access
spec, definition etc.
</p>

<div class="org-src-container">
<pre class="src src-kcats">dictionary <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span> spec<span style="color: #696969; font-weight: bold;">]</span> lookup
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[[</span>item a<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item b<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>item b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item a<span style="color: #696969; font-weight: bold;">]]]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6d308df" class="outline-4">
<h4 id="org6d308df"><span class="section-number-4">1.5.12.</span> <span class="todo INPROGRESS">INPROGRESS</span> Use a single word for all derivation/conversion&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></h4>
<div class="outline-text-4" id="text-1-5-12">
<p>
Right now there's different words for converting bytes to string
(string) or string to bytes (bytes). Proposing a more composable
mechanism here, where there's a single action word that derives one
data structure from another.
</p>

<p>
Here we use the association shorthand for <code>[[type bytes]]</code>
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #696969; font-weight: bold;">[</span>bytes<span style="color: #696969; font-weight: bold;">]</span> derive
</pre>
</div>

<pre class="example">
No spec for derive!

[[] [bytes] "foo"]
</pre>


<p>
Here's a typical invocation
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #696969; font-weight: bold;">[[</span>type bytes<span style="color: #696969; font-weight: bold;">]]</span> derive
</pre>
</div>

<pre class="example">
No spec for derive!

[[] [[type bytes]] "foo"]
</pre>


<p>
Here's a derivation with two steps: convert string to bytes, then use
the bytes as entropy to generate an AES encryption key.
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span>
<span style="color: #696969; font-weight: bold;">[[</span>bytes<span style="color: #696969; font-weight: bold;">]</span>
 <span style="color: #696969; font-weight: bold;">[[</span>type aes-key<span style="color: #696969; font-weight: bold;">]</span>
  <span style="color: #696969; font-weight: bold;">[</span>length 128<span style="color: #696969; font-weight: bold;">]]]</span>
<span style="color: #696969; font-weight: bold;">[</span>derive<span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #E5E57E; font-weight: bold;">step</span>
</pre>
</div>

<pre class="example">
No spec for derive!
No spec for derive!

[[] [[type aes-key] [length 128]] [] [bytes] "foo"]
</pre>


<p>
This seems like a pretty straightforward syntax and should eliminate
an explosion of new words that just convert one type to another.
</p>

<p>
The difficulty is how to implement it. A naive way would just make
<code>derive</code> a multimethod and add lots of methods. The problem is the
<code>decide</code> based multimethods aren't really intended to have lots of
methods because it's inefficient - all the conditions are checked
until one is true. In this case, we can just do a straight lookup by
destination type (if we have different methods depending on input
type, THEN we can use <code>decide</code> internally).
</p>

<p>
But maybe even that isn't ideal - we could also lookup by <code>[sourcetype
destinationtype]</code> pairs. However we don't have explicit source
types. We just have a list that may or may not also act as a set or
association.
</p>

<p>
It should be possible to implement the <code>destinationtype</code> based lookup
pretty easily. Make <code>derive</code> a lexicon entry but insert it earlier so
that it will have an actual association object. It'll be refcounted or
possibly even static (if we don't care about leaking these - but that
would fail if we run through many envs in the same process).
</p>

<p>
Actually we can do this in kcats itself but it requires executing
arbitrary code. The lexicon doesn't really do that - it's just a data
file. 
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>derive<span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #696969; font-weight: bold;">[[[</span>bytes string<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>string<span style="color: #696969; font-weight: bold;">]]]</span> association <span style="color: #E5E57E; font-weight: bold;">wrap</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">float</span> type <span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">1 [string] =&gt; [number string]</span>
 lookup <span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span>
<span style="color: #696969; font-weight: bold;">[</span>definition<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span>
<span style="color: #E5E57E; font-weight: bold;">wrap</span>
inscribe

<span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes <span style="color: #696969; font-weight: bold;">[</span>string<span style="color: #696969; font-weight: bold;">]</span> 
derive 
</pre>
</div>

<pre class="example">
No spec for derive!

stack: [[[reason "type mismatch"] [asked [[[list?] [string?]] [execute] any?]] [type error]] [string]]
expression: [lookup execute]
</pre>



<p>
Ok here's the basic impl. Afterward, should change <code>string</code> to
<code>++string</code> to make them non-public, should use <code>[string] derive</code>
instead. The issue here is how do we add new conversions? We could
make the conversions a separate word, like <code>derivations</code>, but that
sticks out as different - it's a data structure and not an action
word.
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #AD9292;">;; </span><span style="color: #AD9292;">add some conversions</span>
derivations <span style="color: #696969; font-weight: bold;">[[</span>bytes string<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>string<span style="color: #696969; font-weight: bold;">]]</span> assign
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">the list of conversions</span>
<span style="color: #696969; font-weight: bold;">[[[</span>bytes string<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>string<span style="color: #696969; font-weight: bold;">]]]</span> association

<span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes <span style="color: #696969; font-weight: bold;">[</span>string<span style="color: #696969; font-weight: bold;">]</span>


<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">determine the current type and look up the conversion</span>
<span style="color: #696969; font-weight: bold;">[[</span>type<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span> <span style="color: #E5E57E; font-weight: bold;">wrap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dipdown</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #E5E57E; font-weight: bold;">wrap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> 
<span style="color: #C2C2E5; font-weight: bold;">swap</span> lookup <span style="color: #00fa9a; font-weight: bold;">execute</span>
</pre>
</div>

<pre class="example">

["foo"]
</pre>

<div class="org-src-container">
<pre class="src src-kcats">dictionary <span style="color: #696969; font-weight: bold;">[</span>assign spec<span style="color: #696969; font-weight: bold;">]</span> lookup 
</pre>
</div>

<pre class="example">

[[[type error] [reason "word is not defined"] [asked [fail]]] "Lookup attempted on non association value" [spec] assign]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> c<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>a b<span style="color: #696969; font-weight: bold;">]]</span> lookup
</pre>
</div>

<pre class="example">

[c]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>string <span style="color: #696969; font-weight: bold;">[</span>foo<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>string<span style="color: #696969; font-weight: bold;">]</span> lookup
</pre>
</div>
<pre class="example">

[[foo]]
</pre>


<p>
Experiment with whether we can easily determine the 'from' type so
that we can dispatch on both 'from' and 'to'.
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> type
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">
<span style="color: #696969; font-weight: bold;">[[[</span>reason <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">type mismatch</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>type error<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>unwound <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">count</span> 1 = <span style="color: #696969; font-weight: bold;">[[</span>+<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> <span style="color: #C2C2E5; font-weight: bold;">evert</span> <span style="color: #E5E57E; font-weight: bold;">first</span> <span style="color: #696969; font-weight: bold;">[[[</span><span style="color: #E5E57E; font-weight: bold;">first</span> <span style="color: #696969; font-weight: bold;">[</span>type<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">first</span> <span style="color: #E5E57E; font-weight: bold;">second</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">first</span> <span style="color: #E5E57E; font-weight: bold;">first</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[]]]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> <span style="color: #00fa9a; font-weight: bold;">branch</span> <span style="color: #696969; font-weight: bold;">[[[[</span><span style="color: #E5E57E; font-weight: bold;">count</span> 1 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5E57E; font-weight: bold;">first</span> <span style="color: #696969; font-weight: bold;">[</span>type<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">first</span> <span style="color: #E5E57E; font-weight: bold;">second</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">first</span> <span style="color: #E5E57E; font-weight: bold;">first</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[]]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span> +<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> <span style="color: #C2C2E5; font-weight: bold;">evert</span> <span style="color: #E5E57E; font-weight: bold;">first</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> discard <span style="color: #696969; font-weight: bold;">[[[[</span>association<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[[]]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> or <span style="color: #696969; font-weight: bold;">[[[[</span><span style="color: #E5C2E5; font-weight: bold;">nothing</span>?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span>or<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shielddown</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shielddown</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> or<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">recur</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">execute</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> discard <span style="color: #C2C2E5; font-weight: bold;">swap</span> discard<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>asked <span style="color: #696969; font-weight: bold;">[</span>list<span style="color: #696969; font-weight: bold;">]]]</span> +<span style="color: #696969; font-weight: bold;">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #696969; font-weight: bold;">[</span>discard <span style="color: #696969; font-weight: bold;">[</span>default<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">if</span>
</pre>
</div>

<pre class="example">

[default]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>bar 12<span style="color: #696969; font-weight: bold;">]]</span>
<span style="color: #696969; font-weight: bold;">[</span>
<span style="color: #696969; font-weight: bold;">[[</span>foo<span style="color: #696969; font-weight: bold;">]</span> lookup<span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #696969; font-weight: bold;">[[</span>bar<span style="color: #696969; font-weight: bold;">]</span> lookup<span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #696969; font-weight: bold;">[</span>5<span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #696969; font-weight: bold;">[</span>6<span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">nothing</span>?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span>
<span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5E57E; font-weight: bold;">take</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #00fa9a; font-weight: bold;">execute</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">nothing</span>?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">loop</span>
<span style="color: #AD9292;">;;</span><span style="color: #AD9292;">sink discard discard</span>
</pre>
</div>

<pre class="example">

[[[bar 12]] [[[foo] lookup] [[bar] lookup] [5] [6]]]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>bar 12<span style="color: #696969; font-weight: bold;">]]</span>
<span style="color: #696969; font-weight: bold;">[[[</span>foo<span style="color: #696969; font-weight: bold;">]</span> lookup<span style="color: #696969; font-weight: bold;">]</span>
 <span style="color: #696969; font-weight: bold;">[[</span>bar<span style="color: #696969; font-weight: bold;">]</span> lookup<span style="color: #696969; font-weight: bold;">]]</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> any?
</pre>
</div>

<pre class="example">

[12 [[bar 12]]]
</pre>


<div class="org-src-container">
<pre class="src src-kcats">1 2 or
</pre>
</div>

<pre class="example">

[1]
</pre>


<p>
Now that we have a fairly reliable <code>type</code> implementation, we can
dispatch on both <code>to</code> and <code>from</code> types for <code>derive</code>.
</p>

<pre class="example">

</pre>
</div>
</div>
<div id="outline-container-org2ac7ee7" class="outline-4">
<h4 id="org2ac7ee7"><span class="section-number-4">1.5.13.</span> <span class="done DONE">DONE</span> Change boolean operators to retain values</h4>
<div class="outline-text-4" id="text-1-5-13">
<p>
<code>or</code> and <code>and</code> should return the actual value if it is truthy, instead
of <code>true</code>. But neither should ever return <code>[]</code>, but use <code>false</code>
instead.
</p>
<div class="org-src-container">
<pre class="src src-kcats">2 <span style="color: #696969; font-weight: bold;">[]</span> or
</pre>
</div>

<pre class="example">
2
</pre>


<div class="org-src-container">
<pre class="src src-kcats">1 10 inc 1 range <span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">step</span>
</pre>
</div>

<pre class="example">
3628800
</pre>


<p>
This does bring up the question of whether the boolean type is really
needed. It may be possible to use <code>[]</code> as <code>false</code> and anything else as
<code>true</code> (<code>1</code> for example, or maybe the bare word <code>true</code> which then
wouldn't carry any other meaning). Or possible use some other word
than <code>true</code>, eg <code>something</code>.
</p>

<p>
Does this make sense when applied to boolean logic?
</p>

<pre class="example" id="orge3f5922">
something or nothing = something ?
something and something = something ?

"sky is blue" or "moon is made of cheese" = true
</pre>

<p>
I think it doesn't make sense.
</p>

<p>
Maybe yes/no?
</p>

<pre class="example" id="orgffb1550">
yes or no = yes ?
</pre>
<div class="org-src-container">
<pre class="src src-kcats">5 3 =
</pre>
</div>

<pre class="example">

[[]]
</pre>


<div class="org-src-container">
<pre class="src src-kcats">5 <span style="color: #696969; font-weight: bold;">[[[</span>3 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">three</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span>
                         <span style="color: #696969; font-weight: bold;">[[</span>5 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">five</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span>
                         <span style="color: #696969; font-weight: bold;">[[</span>7 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">seven</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span>
                         <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">something else</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]]</span>
                      decide
</pre>
</div>

<pre class="example">

["five" 5]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>3 5 7<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>even?<span style="color: #696969; font-weight: bold;">]</span> any? <span style="color: #E5C2E5; font-weight: bold;">false</span> =
</pre>
</div>

<pre class="example">

stack: [[[reason "word is not defined"] [type error] [asked [false]]] []]
expression: [false =]
</pre>
</div>
</div>
<div id="outline-container-org54c46b5" class="outline-4">
<h4 id="org54c46b5"><span class="section-number-4">1.5.14.</span> <span class="done DONE">DONE</span> 'recover' is broken</h4>
<div class="outline-text-4" id="text-1-5-14">
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #696969; font-weight: bold;">[</span>discard 1
 <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>discard 2 +<span style="color: #696969; font-weight: bold;">]</span>
 recover<span style="color: #696969; font-weight: bold;">]</span>
recover
</pre>
</div>

<pre class="example">

[3]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>expression <span style="color: #696969; font-weight: bold;">[[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>3<span style="color: #696969; font-weight: bold;">]</span> recover<span style="color: #696969; font-weight: bold;">]]]</span> environment advance advance
eval-<span style="color: #E5E57E; font-weight: bold;">step</span>
advance
advance
advance
advance
advance
eval-<span style="color: #E5E57E; font-weight: bold;">step</span>
advance
advance
advance
</pre>
</div>

<pre class="example">
Env: [List([List([])]), Word(0x5a56c7a6c3c0 : "unwrap"), List([List([List([Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7a73ca0 : "association?", examples: Some([List([List([List([List([Word(0x5a56c7a66700 : "a"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a66d90 : "c"), Word(0x5a56c7a73d60 : "d")])]), Word(0x5a56c7a73ca0 : "association?")]), List([Word(0x5a56c7a56b40 : "true")])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })]), List([Word(0x5a56c7a65c40 : "something?")])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), Word(0x5a56c7a8c8c0 : "shield"), List([Entry(Entry { word: 0x5a56c7a7ddf0 : "take", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a7ddf0 : "take")]), List([List([String("b"), String("c")]), String("a")])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), List([Entry(Entry { word: 0x5a56c7a73c80 : "++lookup", examples: None, spec: Some([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a56d50 : "item")])]), serialize: false, definition: Builtin })]), Entry(Entry { word: 0x5a56c7a668b0 : "dip", examples: Some([List([List([Int(1), Int(8), List([Word(0x5a56c7a570f0 : "inc")]), Word(0x5a56c7a668b0 : "dip")]), List([Int(2), Int(8)])]), List([List([Int(1), Int(2), List([Word(0x5a56c7a621b0 : "dec")]), Word(0x5a56c7a6c3c0 : "unwrap"), List([Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a668b0 : "dip")]), List([Int(3), Word(0x5a56c7a621b0 : "dec")])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program"), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin }), List([List([List([Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7a73ca0 : "association?", examples: Some([List([List([List([List([Word(0x5a56c7a66700 : "a"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a66d90 : "c"), Word(0x5a56c7a73d60 : "d")])]), Word(0x5a56c7a73ca0 : "association?")]), List([Word(0x5a56c7a56b40 : "true")])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })]), List([Word(0x5a56c7a65c40 : "something?")])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), Word(0x5a56c7a8c8c0 : "shield")]), Word(0x5a56c7a79bd0 : "loop"), List([Word(0x5a56c7a65c40 : "something?")]), List([String("Lookup attempted on non association value"), Entry(Entry { word: 0x5a56c7a55850 : "fail", examples: None, spec: Some([List([Word(0x5a56c7a66340 : "string")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: [] })]), List([Entry(Entry { word: 0x5a56c7a66740 : "discard", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2)])]), List([List([Int(1), Int(2), Int(3), List([Word(0x5a56c7a66700 : "a"), Word(0x5a56c7a669d0 : "b"), Word(0x5a56c7a66d90 : "c")]), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2), Int(3)])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a89c10 : "if"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin }), List([List([Env({ stack: [], expression: [[+] [3] recover] })])]), Word(0x5a56c7a6c3c0 : "unwrap"), Entry(Entry { word: 0x5a56c7a7bf60 : "evert", examples: Some([List([List([Int(1), Int(2), Int(3), List([Int(4), Int(5), Int(6)]), Word(0x5a56c7a7bf60 : "evert")]), List([Int(6), Int(5), Int(4), List([Int(3), Int(2), Int(1)])])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a66c70 : "list"), Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7a88e20 : "first", examples: Some([List([List([List([Int(4), Int(5), Int(6)]), Word(0x5a56c7a88e20 : "first")]), List([Int(4)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a56d50 : "item")])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), List([List([List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin }), List([List([Word(0x5a56c7a96e20 : "positive?")]), List([Entry(Entry { word: 0x5a56c7a54660 : "&lt;=", examples: None, spec: Some([List([Word(0x5a56c7a54a90 : "number"), Word(0x5a56c7a54a90 : "number")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([List([Entry(Entry { word: 0x5a56c7a803a0 : "errored?", examples: None, spec: Some([List([Word(0x5a56c7a8c780 : "environment")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a87e60 : "not", examples: Some([List([List([Int(1), Word(0x5a56c7a62500 : "even?"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56780 : "false"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56b40 : "true"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56780 : "false")])]), List([List([List([]), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([Entry(Entry { word: 0x5a56c7a73e00 : "eval-step", examples: Some([List([List([List([List([Word(0x5a56c7a73dc0 : "expression"), List([Int(1), Word(0x5a56c7a570f0 : "inc")])])]), Word(0x5a56c7a8c780 : "environment"), Word(0x5a56c7a73e00 : "eval-step"), Word(0x5a56c7a73e00 : "eval-step"), List([Word(0x5a56c7a73d80 : "stack")]), Word(0x5a56c7a945e0 : "lookup")]), List([List([Int(2)])])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a72d80 : "while"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7a66740 : "discard", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2)])]), List([List([Int(1), Int(2), Int(3), List([Word(0x5a56c7a66700 : "a"), Word(0x5a56c7a669d0 : "b"), Word(0x5a56c7a66d90 : "c")]), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2), Int(3)])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7ad0140 : "advance", examples: None, spec: Some([List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })])]), serialize: false, definition: [List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), List([List([List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin }), List([List([Word(0x5a56c7a96e20 : "positive?")]), List([Entry(Entry { word: 0x5a56c7a54660 : "&lt;=", examples: None, spec: Some([List([Word(0x5a56c7a54a90 : "number"), Word(0x5a56c7a54a90 : "number")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([List([Entry(Entry { word: 0x5a56c7a803a0 : "errored?", examples: None, spec: Some([List([Word(0x5a56c7a8c780 : "environment")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a87e60 : "not", examples: Some([List([List([Int(1), Word(0x5a56c7a62500 : "even?"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56780 : "false"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56b40 : "true"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56780 : "false")])]), List([List([List([]), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([Entry(Entry { word: 0x5a56c7a73e00 : "eval-step", examples: Some([List([List([List([List([Word(0x5a56c7a73dc0 : "expression"), List([Int(1), Word(0x5a56c7a570f0 : "inc")])])]), Word(0x5a56c7a8c780 : "environment"), Word(0x5a56c7a73e00 : "eval-step"), Word(0x5a56c7a73e00 : "eval-step"), List([Word(0x5a56c7a73d80 : "stack")]), Word(0x5a56c7a945e0 : "lookup")]), List([List([Int(2)])])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a72d80 : "while"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7a66740 : "discard", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2)])]), List([List([Int(1), Int(2), Int(3), List([Word(0x5a56c7a66700 : "a"), Word(0x5a56c7a669d0 : "b"), Word(0x5a56c7a66d90 : "c")]), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2), Int(3)])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([])]), serialize: false, definition: Builtin })] }), Entry(Entry { word: 0x5a56c7a73e00 : "eval-step", examples: Some([List([List([List([List([Word(0x5a56c7a73dc0 : "expression"), List([Int(1), Word(0x5a56c7a570f0 : "inc")])])]), Word(0x5a56c7a8c780 : "environment"), Word(0x5a56c7a73e00 : "eval-step"), Word(0x5a56c7a73e00 : "eval-step"), List([Word(0x5a56c7a73d80 : "stack")]), Word(0x5a56c7a945e0 : "lookup")]), List([List([Int(2)])])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7ad0140 : "advance", examples: None, spec: Some([List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })])]), serialize: false, definition: [List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), List([List([List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin }), List([List([Word(0x5a56c7a96e20 : "positive?")]), List([Entry(Entry { word: 0x5a56c7a54660 : "&lt;=", examples: None, spec: Some([List([Word(0x5a56c7a54a90 : "number"), Word(0x5a56c7a54a90 : "number")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([List([Entry(Entry { word: 0x5a56c7a803a0 : "errored?", examples: None, spec: Some([List([Word(0x5a56c7a8c780 : "environment")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a87e60 : "not", examples: Some([List([List([Int(1), Word(0x5a56c7a62500 : "even?"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56780 : "false"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56b40 : "true"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56780 : "false")])]), List([List([List([]), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([Entry(Entry { word: 0x5a56c7a73e00 : "eval-step", examples: Some([List([List([List([List([Word(0x5a56c7a73dc0 : "expression"), List([Int(1), Word(0x5a56c7a570f0 : "inc")])])]), Word(0x5a56c7a8c780 : "environment"), Word(0x5a56c7a73e00 : "eval-step"), Word(0x5a56c7a73e00 : "eval-step"), List([Word(0x5a56c7a73d80 : "stack")]), Word(0x5a56c7a945e0 : "lookup")]), List([List([Int(2)])])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a72d80 : "while"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7a66740 : "discard", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2)])]), List([List([Int(1), Int(2), Int(3), List([Word(0x5a56c7a66700 : "a"), Word(0x5a56c7a669d0 : "b"), Word(0x5a56c7a66d90 : "c")]), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2), Int(3)])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([])]), serialize: false, definition: Builtin })] }), Entry(Entry { word: 0x5a56c7ad0140 : "advance", examples: None, spec: Some([List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })])]), serialize: false, definition: [List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), List([List([List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin }), List([List([Word(0x5a56c7a96e20 : "positive?")]), List([Entry(Entry { word: 0x5a56c7a54660 : "&lt;=", examples: None, spec: Some([List([Word(0x5a56c7a54a90 : "number"), Word(0x5a56c7a54a90 : "number")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([List([Entry(Entry { word: 0x5a56c7a803a0 : "errored?", examples: None, spec: Some([List([Word(0x5a56c7a8c780 : "environment")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a87e60 : "not", examples: Some([List([List([Int(1), Word(0x5a56c7a62500 : "even?"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56780 : "false"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56b40 : "true"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56780 : "false")])]), List([List([List([]), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([Entry(Entry { word: 0x5a56c7a73e00 : "eval-step", examples: Some([List([List([List([List([Word(0x5a56c7a73dc0 : "expression"), List([Int(1), Word(0x5a56c7a570f0 : "inc")])])]), Word(0x5a56c7a8c780 : "environment"), Word(0x5a56c7a73e00 : "eval-step"), Word(0x5a56c7a73e00 : "eval-step"), List([Word(0x5a56c7a73d80 : "stack")]), Word(0x5a56c7a945e0 : "lookup")]), List([List([Int(2)])])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a72d80 : "while"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7a66740 : "discard", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2)])]), List([List([Int(1), Int(2), Int(3), List([Word(0x5a56c7a66700 : "a"), Word(0x5a56c7a669d0 : "b"), Word(0x5a56c7a66d90 : "c")]), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2), Int(3)])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([])]), serialize: false, definition: Builtin })] }), Entry(Entry { word: 0x5a56c7ad0140 : "advance", examples: None, spec: Some([List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })])]), serialize: false, definition: [List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), List([List([List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin }), List([List([Word(0x5a56c7a96e20 : "positive?")]), List([Entry(Entry { word: 0x5a56c7a54660 : "&lt;=", examples: None, spec: Some([List([Word(0x5a56c7a54a90 : "number"), Word(0x5a56c7a54a90 : "number")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([List([Entry(Entry { word: 0x5a56c7a803a0 : "errored?", examples: None, spec: Some([List([Word(0x5a56c7a8c780 : "environment")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a87e60 : "not", examples: Some([List([List([Int(1), Word(0x5a56c7a62500 : "even?"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56780 : "false"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56b40 : "true"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56780 : "false")])]), List([List([List([]), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([Entry(Entry { word: 0x5a56c7a73e00 : "eval-step", examples: Some([List([List([List([List([Word(0x5a56c7a73dc0 : "expression"), List([Int(1), Word(0x5a56c7a570f0 : "inc")])])]), Word(0x5a56c7a8c780 : "environment"), Word(0x5a56c7a73e00 : "eval-step"), Word(0x5a56c7a73e00 : "eval-step"), List([Word(0x5a56c7a73d80 : "stack")]), Word(0x5a56c7a945e0 : "lookup")]), List([List([Int(2)])])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a72d80 : "while"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7a66740 : "discard", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2)])]), List([List([Int(1), Int(2), Int(3), List([Word(0x5a56c7a66700 : "a"), Word(0x5a56c7a669d0 : "b"), Word(0x5a56c7a66d90 : "c")]), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2), Int(3)])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([])]), serialize: false, definition: Builtin })] }), Entry(Entry { word: 0x5a56c7ad0140 : "advance", examples: None, spec: Some([List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })])]), serialize: false, definition: [List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), List([List([List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin }), List([List([Word(0x5a56c7a96e20 : "positive?")]), List([Entry(Entry { word: 0x5a56c7a54660 : "&lt;=", examples: None, spec: Some([List([Word(0x5a56c7a54a90 : "number"), Word(0x5a56c7a54a90 : "number")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([List([Entry(Entry { word: 0x5a56c7a803a0 : "errored?", examples: None, spec: Some([List([Word(0x5a56c7a8c780 : "environment")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a87e60 : "not", examples: Some([List([List([Int(1), Word(0x5a56c7a62500 : "even?"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56780 : "false"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56b40 : "true"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56780 : "false")])]), List([List([List([]), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([Entry(Entry { word: 0x5a56c7a73e00 : "eval-step", examples: Some([List([List([List([List([Word(0x5a56c7a73dc0 : "expression"), List([Int(1), Word(0x5a56c7a570f0 : "inc")])])]), Word(0x5a56c7a8c780 : "environment"), Word(0x5a56c7a73e00 : "eval-step"), Word(0x5a56c7a73e00 : "eval-step"), List([Word(0x5a56c7a73d80 : "stack")]), Word(0x5a56c7a945e0 : "lookup")]), List([List([Int(2)])])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a72d80 : "while"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7a66740 : "discard", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2)])]), List([List([Int(1), Int(2), Int(3), List([Word(0x5a56c7a66700 : "a"), Word(0x5a56c7a669d0 : "b"), Word(0x5a56c7a66d90 : "c")]), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2), Int(3)])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([])]), serialize: false, definition: Builtin })] }), Entry(Entry { word: 0x5a56c7ad0140 : "advance", examples: None, spec: Some([List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })])]), serialize: false, definition: [List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), List([List([List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin }), List([List([Word(0x5a56c7a96e20 : "positive?")]), List([Entry(Entry { word: 0x5a56c7a54660 : "&lt;=", examples: None, spec: Some([List([Word(0x5a56c7a54a90 : "number"), Word(0x5a56c7a54a90 : "number")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([List([Entry(Entry { word: 0x5a56c7a803a0 : "errored?", examples: None, spec: Some([List([Word(0x5a56c7a8c780 : "environment")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a87e60 : "not", examples: Some([List([List([Int(1), Word(0x5a56c7a62500 : "even?"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56780 : "false"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56b40 : "true"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56780 : "false")])]), List([List([List([]), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([Entry(Entry { word: 0x5a56c7a73e00 : "eval-step", examples: Some([List([List([List([List([Word(0x5a56c7a73dc0 : "expression"), List([Int(1), Word(0x5a56c7a570f0 : "inc")])])]), Word(0x5a56c7a8c780 : "environment"), Word(0x5a56c7a73e00 : "eval-step"), Word(0x5a56c7a73e00 : "eval-step"), List([Word(0x5a56c7a73d80 : "stack")]), Word(0x5a56c7a945e0 : "lookup")]), List([List([Int(2)])])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a72d80 : "while"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7a66740 : "discard", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2)])]), List([List([Int(1), Int(2), Int(3), List([Word(0x5a56c7a66700 : "a"), Word(0x5a56c7a669d0 : "b"), Word(0x5a56c7a66d90 : "c")]), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2), Int(3)])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([])]), serialize: false, definition: Builtin })] }), Entry(Entry { word: 0x5a56c7a73e00 : "eval-step", examples: Some([List([List([List([List([Word(0x5a56c7a73dc0 : "expression"), List([Int(1), Word(0x5a56c7a570f0 : "inc")])])]), Word(0x5a56c7a8c780 : "environment"), Word(0x5a56c7a73e00 : "eval-step"), Word(0x5a56c7a73e00 : "eval-step"), List([Word(0x5a56c7a73d80 : "stack")]), Word(0x5a56c7a945e0 : "lookup")]), List([List([Int(2)])])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7ad0140 : "advance", examples: None, spec: Some([List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })])]), serialize: false, definition: [List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), List([List([List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin }), List([List([Word(0x5a56c7a96e20 : "positive?")]), List([Entry(Entry { word: 0x5a56c7a54660 : "&lt;=", examples: None, spec: Some([List([Word(0x5a56c7a54a90 : "number"), Word(0x5a56c7a54a90 : "number")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([List([Entry(Entry { word: 0x5a56c7a803a0 : "errored?", examples: None, spec: Some([List([Word(0x5a56c7a8c780 : "environment")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a87e60 : "not", examples: Some([List([List([Int(1), Word(0x5a56c7a62500 : "even?"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56780 : "false"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56b40 : "true"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56780 : "false")])]), List([List([List([]), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([Entry(Entry { word: 0x5a56c7a73e00 : "eval-step", examples: Some([List([List([List([List([Word(0x5a56c7a73dc0 : "expression"), List([Int(1), Word(0x5a56c7a570f0 : "inc")])])]), Word(0x5a56c7a8c780 : "environment"), Word(0x5a56c7a73e00 : "eval-step"), Word(0x5a56c7a73e00 : "eval-step"), List([Word(0x5a56c7a73d80 : "stack")]), Word(0x5a56c7a945e0 : "lookup")]), List([List([Int(2)])])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a72d80 : "while"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7a66740 : "discard", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2)])]), List([List([Int(1), Int(2), Int(3), List([Word(0x5a56c7a66700 : "a"), Word(0x5a56c7a669d0 : "b"), Word(0x5a56c7a66d90 : "c")]), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2), Int(3)])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([])]), serialize: false, definition: Builtin })] }), Entry(Entry { word: 0x5a56c7ad0140 : "advance", examples: None, spec: Some([List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })])]), serialize: false, definition: [List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), List([List([List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin }), List([List([Word(0x5a56c7a96e20 : "positive?")]), List([Entry(Entry { word: 0x5a56c7a54660 : "&lt;=", examples: None, spec: Some([List([Word(0x5a56c7a54a90 : "number"), Word(0x5a56c7a54a90 : "number")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([List([Entry(Entry { word: 0x5a56c7a803a0 : "errored?", examples: None, spec: Some([List([Word(0x5a56c7a8c780 : "environment")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a87e60 : "not", examples: Some([List([List([Int(1), Word(0x5a56c7a62500 : "even?"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56780 : "false"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56b40 : "true"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56780 : "false")])]), List([List([List([]), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([Entry(Entry { word: 0x5a56c7a73e00 : "eval-step", examples: Some([List([List([List([List([Word(0x5a56c7a73dc0 : "expression"), List([Int(1), Word(0x5a56c7a570f0 : "inc")])])]), Word(0x5a56c7a8c780 : "environment"), Word(0x5a56c7a73e00 : "eval-step"), Word(0x5a56c7a73e00 : "eval-step"), List([Word(0x5a56c7a73d80 : "stack")]), Word(0x5a56c7a945e0 : "lookup")]), List([List([Int(2)])])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a72d80 : "while"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7a66740 : "discard", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2)])]), List([List([Int(1), Int(2), Int(3), List([Word(0x5a56c7a66700 : "a"), Word(0x5a56c7a669d0 : "b"), Word(0x5a56c7a66d90 : "c")]), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2), Int(3)])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([])]), serialize: false, definition: Builtin })] }), Entry(Entry { word: 0x5a56c7ad0140 : "advance", examples: None, spec: Some([List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), List([Entry(Entry { word: 0x5a56c7a8c780 : "environment", examples: None, spec: Some([List([Word(0x5a56c7a572d0 : "association")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })])]), serialize: false, definition: [List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), List([List([List([List([Word(0x5a56c7a73dc0 : "expression")]), Word(0x5a56c7a945e0 : "lookup"), Entry(Entry { word: 0x5a56c7a8c4f0 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x5a56c7a8c4f0 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a54a90 : "number")])]), serialize: false, definition: Builtin }), List([List([Word(0x5a56c7a96e20 : "positive?")]), List([Entry(Entry { word: 0x5a56c7a54660 : "&lt;=", examples: None, spec: Some([List([Word(0x5a56c7a54a90 : "number"), Word(0x5a56c7a54a90 : "number")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([List([Entry(Entry { word: 0x5a56c7a803a0 : "errored?", examples: None, spec: Some([List([Word(0x5a56c7a8c780 : "environment")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a8c8c0 : "shield"), Entry(Entry { word: 0x5a56c7a87e60 : "not", examples: Some([List([List([Int(1), Word(0x5a56c7a62500 : "even?"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56780 : "false"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])]), List([List([Word(0x5a56c7a56b40 : "true"), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56780 : "false")])]), List([List([List([]), Word(0x5a56c7a87e60 : "not")]), List([Word(0x5a56c7a56b40 : "true")])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([Word(0x5a56c7a56970 : "boolean")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x5a56c7a69bc0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x5a56c7a540c0 : "+")]), Word(0x5a56c7a69bc0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x5a56c7a540c0 : "+")]), Int(4), Word(0x5a56c7a66d70 : "swap"), Word(0x5a56c7a69bc0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x5a56c7a66db0 : "program")]), List([Word(0x5a56c7a54830 : "*")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a5e2b0 : "every?")]), List([Entry(Entry { word: 0x5a56c7a73e00 : "eval-step", examples: Some([List([List([List([List([Word(0x5a56c7a73dc0 : "expression"), List([Int(1), Word(0x5a56c7a570f0 : "inc")])])]), Word(0x5a56c7a8c780 : "environment"), Word(0x5a56c7a73e00 : "eval-step"), Word(0x5a56c7a73e00 : "eval-step"), List([Word(0x5a56c7a73d80 : "stack")]), Word(0x5a56c7a945e0 : "lookup")]), List([List([Int(2)])])])]), spec: Some([List([Word(0x5a56c7a66c70 : "list")]), List([Word(0x5a56c7a66c70 : "list")])]), serialize: false, definition: Builtin })]), Word(0x5a56c7a72d80 : "while"), Entry(Entry { word: 0x5a56c7a66d70 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66d70 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")])]), List([List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a669d0 : "b")]), List([Word(0x5a56c7a56d50 : "item"), Word(0x5a56c7a66700 : "a")])])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5a56c7a66740 : "discard", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2)])]), List([List([Int(1), Int(2), Int(3), List([Word(0x5a56c7a66700 : "a"), Word(0x5a56c7a669d0 : "b"), Word(0x5a56c7a66d90 : "c")]), Word(0x5a56c7a66740 : "discard")]), List([Int(1), Int(2), Int(3)])])]), spec: Some([List([Word(0x5a56c7a56d50 : "item")]), List([])]), serialize: false, definition: Builtin })] })]
handle is Word(0x5a56c7a5eab0 : "handle") Word(0x5a56c7a5eab0 : "handle")
expr contains handle? false
unhandled err!

stack: [[[type error] [asked [association (unfinished tryfrom impl)]] [reason "type mismatch"]]]
expression: [[[]] unwrap [[[swap association?] [something?]] [execute] every?] shield [take swap [++lookup] dip [[[swap association?] [something?]] [execute] every?] shield] loop [something?] ["Lookup attempted on non association value" fail] [discard] if count [[[[stack []] [expression [[+] [3] recover]]]]] unwrap evert first swap [[[[expression] lookup count [[positive?] [&lt;=]] [execute] every?] [[errored?] shield not]] [execute] every?] [eval-step] while swap discard advance eval-step advance advance advance advance advance eval-step advance advance advance]
</pre>
</div>
</div>
<div id="outline-container-org4c3a32b" class="outline-4">
<h4 id="org4c3a32b"><span class="section-number-4">1.5.15.</span> <span class="done DONE">DONE</span> Fix handle in nested env</h4>
<div class="outline-text-4" id="text-1-5-15">
<p>
<code>handle</code> doesn't work properly in a nested environment. That is
because <code>eval</code> has some logic to check for uncaught exceptions, but
the <code>advance</code> self-hosted evaluator doesn't.
</p>

<div class="org-src-container">
<pre class="src src-kcats">1 + handle error?
</pre>
</div>

<pre class="example">
Env: [Word(0x5d29b8fb5b00 : "handle"), Entry(Entry { word: 0x5d29b8fc2600 : "error?", examples: None, spec: Some([List([Word(0x5d29b8fb6c00 : "item")]), List([Word(0x5d29b8fb6820 : "boolean")])]), serialize: false, definition: Builtin })]
handle is Word(0x5d29b8fb5b00 : "handle") Word(0x5d29b8fb5b00 : "handle")
expr contains handle? true
Word(0x5d29b8fb5b00 : "handle") vs Word(0x5d29b8fb5b00 : "handle")

[true 1]
</pre>


<div class="org-src-container">
<pre class="src src-kcats">+ handle type
</pre>
</div>

<pre class="example" id="org119fcec">
Env: [Word(0x577eb3e95b00 : "handle"), Entry(Entry { word: 0x577eb3ea5000 : "type", examples: Some([List([List([List([List([Word(0x577eb3ed46b0 : "foo"), Int(1)])]), Word(0x577eb3ea5000 : "type")]), List([List([Word(0x577eb3ed46b0 : "foo")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([Int(1)]), List([List([Word(0x577eb3e94940 : "number")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([Float(1.0)]), List([List([Word(0x577eb3e94940 : "number")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([List([])]), List([List([Entry(Entry { word: 0x577eb3eb5060 : "nothing", examples: None, spec: Some([List([]), List([Word(0x577eb3e96c00 : "item")])]), serialize: false, definition: [List([])] })]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([String("foo"), Entry(Entry { word: 0x577eb3ecac50 : "bytes", examples: None, spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3ecac50 : "bytes")])]), serialize: false, definition: Builtin })]), List([List([Entry(Entry { word: 0x577eb3ecac50 : "bytes", examples: None, spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3ecac50 : "bytes")])]), serialize: false, definition: Builtin })]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([String("foo")]), List([List([Entry(Entry { word: 0x577eb3ea6420 : "string", examples: Some([List([List([Int(1), Word(0x577eb3ea6420 : "string")]), List([String("1")])]), List([List([List([Int(1), Int(2), Int(3)]), Word(0x577eb3ea6420 : "string")]), List([String("[1 2 3]")])]), List([List([List([]), Word(0x577eb3ea6420 : "string")]), List([String("[]")])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3ea6420 : "string")])]), serialize: false, definition: Builtin })]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([List([List([Word(0x577eb3ea5000 : "type"), Word(0x577eb3ed46b0 : "foo")])]), List([List([Word(0x577eb3ed46b0 : "foo")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])])]), List([List([List([List([Word(0x577eb3ea5000 : "type"), Word(0x577eb3ed46b0 : "foo")]), List([Word(0x577eb3f20780 : "attr"), String("blah")])]), List([List([Word(0x577eb3ed46b0 : "foo")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])])]), List([List([List([List([Word(0x577eb3f20570 : "attr1"), Word(0x577eb3ed46b0 : "foo")]), List([Word(0x577eb3f20640 : "attr2"), String("blah")])]), List([List([Entry(Entry { word: 0x577eb3e97180 : "association", examples: Some([List([List([List([List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")]), List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")])]), Word(0x577eb3e97180 : "association"), List([List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")]), List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")])]), Word(0x577eb3e97180 : "association"), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")]), List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")])]), List([List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")]), List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")])]), Word(0x577eb3e97180 : "association"), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e96630 : "false")])]), List([List([List([List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")]), List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")])]), List([List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")]), List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")])]), Word(0x577eb3e97180 : "association"), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e96630 : "false")])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e97180 : "association")])]), serialize: false, definition: Builtin })]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])])]), List([List([List([List([Word(0x577eb3ed46b0 : "foo"), Int(1)])]), List([List([Word(0x577eb3ed46b0 : "foo")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])])]), List([List([List([List([Word(0x577eb3ea5000 : "type"), Word(0x577eb3f202d0 : "url")]), List([Word(0x577eb3edb6e0 : "value"), String("http://foo.com")])]), Word(0x577eb3ea5000 : "type")]), List([List([Word(0x577eb3f202d0 : "url")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96c00 : "item")])]), serialize: false, definition: [List([List([List([Word(0x577eb3ed0c80 : "nothing?")]), List([List([Entry(Entry { word: 0x577eb3eb5060 : "nothing", examples: None, spec: Some([List([]), List([Word(0x577eb3e96c00 : "item")])]), serialize: false, definition: [List([])] })]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([Entry(Entry { word: 0x577eb3eb3c80 : "association?", examples: Some([List([List([List([List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")]), List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")])]), Word(0x577eb3eb3c80 : "association?")]), List([Word(0x577eb3e969f0 : "true")])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([List([List([Word(0x577eb3ea5000 : "type")]), Word(0x577eb3ed4460 : "lookup")]), List([List([Entry(Entry { word: 0x577eb3ecca20 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x577eb3ecca20 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e94940 : "number")])]), serialize: false, definition: Builtin }), Int(1), Entry(Entry { word: 0x577eb3e95ef0 : "=", examples: Some([List([List([Int(1), Int(2), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([Int(1), Int(1), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([]), List([]), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([Int(1)]), List([]), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([List([Int(1), List([Word(0x577eb3e96630 : "false")])]), List([Int(1), List([Word(0x577eb3e96630 : "false")])]), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([Float(1.0), List([String("foo")])]), List([Float(1.0), List([String("foo")])]), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([String("hi"), String("hi"), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([String("hi"), String("there"), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([List([]), Word(0x577eb3e969f0 : "true"), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([List([Float(1.0), List([String("foo")])]), List([Float(1.0), List([String("bar")])]), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([List([List([]), List([]), Word(0x577eb3e97180 : "association"), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])])])]), spec: Some([List([Word(0x577eb3e96c00 : "item"), Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([Entry(Entry { word: 0x577eb3ecc6d0 : "first", examples: Some([List([List([List([Int(4), Int(5), Int(6)]), Word(0x577eb3ecc6d0 : "first")]), List([Int(4)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e96c00 : "item")])]), serialize: false, definition: Builtin }), List([Word(0x577eb3ea5000 : "type")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x577eb3e95ef0 : "=", examples: Some([List([List([Int(1), Int(2), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([Int(1), Int(1), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([]), List([]), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([Int(1)]), List([]), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([List([Int(1), List([Word(0x577eb3e96630 : "false")])]), List([Int(1), List([Word(0x577eb3e96630 : "false")])]), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([Float(1.0), List([String("foo")])]), List([Float(1.0), List([String("foo")])]), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([String("hi"), String("hi"), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([String("hi"), String("there"), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([List([]), Word(0x577eb3e969f0 : "true"), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([List([Float(1.0), List([String("foo")])]), List([Float(1.0), List([String("bar")])]), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([List([List([]), List([]), Word(0x577eb3e97180 : "association"), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])])])]), spec: Some([List([Word(0x577eb3e96c00 : "item"), Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([Entry(Entry { word: 0x577eb3ecc6d0 : "first", examples: Some([List([List([List([Int(4), Int(5), Int(6)]), Word(0x577eb3ecc6d0 : "first")]), List([Int(4)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e96c00 : "item")])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x577eb3ebdf40 : "second", examples: Some([List([List([List([Int(4), Int(5), Int(6)]), Word(0x577eb3ebdf40 : "second")]), List([Int(5)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e96c00 : "item")])]), serialize: false, definition: Builtin })]), List([Entry(Entry { word: 0x577eb3ecc6d0 : "first", examples: Some([List([List([List([Int(4), Int(5), Int(6)]), Word(0x577eb3ecc6d0 : "first")]), List([Int(4)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e96c00 : "item")])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x577eb3ecc6d0 : "first", examples: Some([List([List([List([Int(4), Int(5), Int(6)]), Word(0x577eb3ecc6d0 : "first")]), List([Int(4)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e96c00 : "item")])]), serialize: false, definition: Builtin })]), Word(0x577eb3ea2e60 : "if")]), List([List([])]), Word(0x577eb3ea2e60 : "if")]), List([List([Entry(Entry { word: 0x577eb3e97180 : "association", examples: Some([List([List([List([List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")]), List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")])]), Word(0x577eb3e97180 : "association"), List([List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")]), List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")])]), Word(0x577eb3e97180 : "association"), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")]), List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")])]), List([List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")]), List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")])]), Word(0x577eb3e97180 : "association"), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e96630 : "false")])]), List([List([List([List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")]), List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")])]), List([List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")]), List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")])]), Word(0x577eb3e97180 : "association"), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e96630 : "false")])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e97180 : "association")])]), serialize: false, definition: Builtin })]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x577eb3ea9ba0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x577eb3e93f70 : "+")]), Word(0x577eb3ea9ba0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x577eb3e93f70 : "+")]), Int(4), Word(0x577eb3ea6df0 : "swap"), Word(0x577eb3ea9ba0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x577eb3ea6a70 : "program")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })]), Word(0x577eb3ee54c0 : "any?")])]), List([List([Entry(Entry { word: 0x577eb3ea22b0 : "list?", examples: Some([List([List([List([Int(1)]), Word(0x577eb3ea22b0 : "list?")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([]), Word(0x577eb3ea22b0 : "list?")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([Int(5), Word(0x577eb3ea22b0 : "list?")]), List([Word(0x577eb3e96630 : "false")])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([Word(0x577eb3ea6cf0 : "list")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([Entry(Entry { word: 0x577eb3ea4130 : "number?", examples: Some([List([List([List([Int(1)]), Word(0x577eb3ea4130 : "number?")]), List([Word(0x577eb3e96630 : "false")])]), List([List([List([]), Word(0x577eb3ea4130 : "number?")]), List([Word(0x577eb3e96630 : "false")])]), List([List([Int(5), Word(0x577eb3ea4130 : "number?")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([Float(5.01), Word(0x577eb3ea4130 : "number?")]), List([Word(0x577eb3e969f0 : "true")])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([Word(0x577eb3e94940 : "number")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([Entry(Entry { word: 0x577eb3ed46f0 : "word?", examples: Some([List([List([Word(0x577eb3ed46b0 : "foo"), Word(0x577eb3ed46f0 : "word?")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([Word(0x577eb3ed46b0 : "foo")]), Word(0x577eb3eac3a0 : "unwrap"), Word(0x577eb3ed46f0 : "word?")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([Word(0x577eb3e969f0 : "true"), Word(0x577eb3ed46f0 : "word?")]), List([Word(0x577eb3e96630 : "false")])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([Word(0x577eb3ea4170 : "word")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([Entry(Entry { word: 0x577eb3ecac30 : "bytes?", examples: None, spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([Entry(Entry { word: 0x577eb3ecac50 : "bytes", examples: None, spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3ecac50 : "bytes")])]), serialize: false, definition: Builtin })]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([Entry(Entry { word: 0x577eb3ec8d40 : "string?", examples: Some([List([List([String("hi"), Word(0x577eb3ec8d40 : "string?")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([String(""), Word(0x577eb3ec8d40 : "string?")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([String("hi")]), Word(0x577eb3ec8d40 : "string?")]), List([Word(0x577eb3e96630 : "false")])]), List([List([Word(0x577eb3e969f0 : "true"), Word(0x577eb3ec8d40 : "string?")]), List([Word(0x577eb3e96630 : "false")])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([Entry(Entry { word: 0x577eb3ea6420 : "string", examples: Some([List([List([Int(1), Word(0x577eb3ea6420 : "string")]), List([String("1")])]), List([List([List([Int(1), Int(2), Int(3)]), Word(0x577eb3ea6420 : "string")]), List([String("[1 2 3]")])]), List([List([List([]), Word(0x577eb3ea6420 : "string")]), List([String("[]")])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3ea6420 : "string")])]), serialize: false, definition: Builtin })]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([Entry(Entry { word: 0x577eb3ecc550 : "pipe?", examples: None, spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([Word(0x577eb3edd950 : "pipe")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([Entry(Entry { word: 0x577eb3ea2600 : "error?", examples: None, spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([Word(0x577eb3f08630 : "error")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])])]), Entry(Entry { word: 0x577eb3ede4f0 : "decide", examples: Some([List([List([Int(5), List([List([List([Int(3), Word(0x577eb3e95ef0 : "=")]), List([String("three")])]), List([List([Int(5), Word(0x577eb3e95ef0 : "=")]), List([String("five")])]), List([List([Int(7), Word(0x577eb3e95ef0 : "=")]), List([String("seven")])]), List([List([Word(0x577eb3e969f0 : "true")]), List([String("something else")])])]), Word(0x577eb3ede4f0 : "decide")]), List([Int(5), String("five")])]), List([List([Int(9), List([List([List([Int(3), Word(0x577eb3e95ef0 : "=")]), List([String("three")])]), List([List([Int(5), Word(0x577eb3e95ef0 : "=")]), List([String("five")])]), List([List([Int(7), Word(0x577eb3e95ef0 : "=")]), List([String("seven")])]), List([List([Word(0x577eb3e969f0 : "true")]), List([String("something else")])])]), Word(0x577eb3ede4f0 : "decide")]), List([Int(9), String("something else")])]), List([List([Int(9), List([List([List([Int(3), Word(0x577eb3e95ef0 : "=")]), List([String("three")])]), List([List([Int(5), Word(0x577eb3e95ef0 : "=")]), List([String("five")])]), List([List([Int(7), Word(0x577eb3e95ef0 : "=")]), List([String("seven")])])]), Word(0x577eb3ede4f0 : "decide")]), List([Int(9), List([])])])]), spec: Some([List([List([Word(0x577eb3e97180 : "association"), Word(0x577eb3ede280 : "test-expr-pairs")])]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x577eb3ea6df0 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x577eb3ea6df0 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x577eb3e96c00 : "item"), Word(0x577eb3ea63c0 : "a")]), List([Word(0x577eb3e96c00 : "item"), Word(0x577eb3ea6a50 : "b")])]), List([List([Word(0x577eb3e96c00 : "item"), Word(0x577eb3ea6a50 : "b")]), List([Word(0x577eb3e96c00 : "item"), Word(0x577eb3ea63c0 : "a")])])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x577eb3ea67c0 : "discard", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x577eb3ea67c0 : "discard")]), List([Int(1), Int(2)])]), List([List([Int(1), Int(2), Int(3), List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b"), Word(0x577eb3ea6e10 : "c")]), Word(0x577eb3ea67c0 : "discard")]), List([Int(1), Int(2), Int(3)])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([])]), serialize: false, definition: Builtin })] })]
handle is Word(0x577eb3e95b00 : "handle") Word(0x577eb3e95b00 : "handle")
expr contains handle? true
Word(0x577eb3e95b00 : "handle") vs Word(0x577eb3e95b00 : "handle")
Env: [List([List([List([Word(0x577eb3ed0c80 : "nothing?")]), List([List([Entry(Entry { word: 0x577eb3eb5060 : "nothing", examples: None, spec: Some([List([]), List([Word(0x577eb3e96c00 : "item")])]), serialize: false, definition: [List([])] })]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([Entry(Entry { word: 0x577eb3eb3c80 : "association?", examples: Some([List([List([List([List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")]), List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")])]), Word(0x577eb3eb3c80 : "association?")]), List([Word(0x577eb3e969f0 : "true")])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([List([List([Word(0x577eb3ea5000 : "type")]), Word(0x577eb3ed4460 : "lookup")]), List([List([Entry(Entry { word: 0x577eb3ecca20 : "count", examples: Some([List([List([List([String("a"), String("b"), String("c")]), Word(0x577eb3ecca20 : "count")]), List([Int(3)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e94940 : "number")])]), serialize: false, definition: Builtin }), Int(1), Entry(Entry { word: 0x577eb3e95ef0 : "=", examples: Some([List([List([Int(1), Int(2), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([Int(1), Int(1), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([]), List([]), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([Int(1)]), List([]), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([List([Int(1), List([Word(0x577eb3e96630 : "false")])]), List([Int(1), List([Word(0x577eb3e96630 : "false")])]), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([Float(1.0), List([String("foo")])]), List([Float(1.0), List([String("foo")])]), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([String("hi"), String("hi"), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([String("hi"), String("there"), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([List([]), Word(0x577eb3e969f0 : "true"), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([List([Float(1.0), List([String("foo")])]), List([Float(1.0), List([String("bar")])]), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([List([List([]), List([]), Word(0x577eb3e97180 : "association"), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])])])]), spec: Some([List([Word(0x577eb3e96c00 : "item"), Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([Entry(Entry { word: 0x577eb3ecc6d0 : "first", examples: Some([List([List([List([Int(4), Int(5), Int(6)]), Word(0x577eb3ecc6d0 : "first")]), List([Int(4)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e96c00 : "item")])]), serialize: false, definition: Builtin }), List([Word(0x577eb3ea5000 : "type")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x577eb3e95ef0 : "=", examples: Some([List([List([Int(1), Int(2), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([Int(1), Int(1), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([]), List([]), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([Int(1)]), List([]), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([List([Int(1), List([Word(0x577eb3e96630 : "false")])]), List([Int(1), List([Word(0x577eb3e96630 : "false")])]), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([Float(1.0), List([String("foo")])]), List([Float(1.0), List([String("foo")])]), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([String("hi"), String("hi"), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([String("hi"), String("there"), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([List([]), Word(0x577eb3e969f0 : "true"), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([List([Float(1.0), List([String("foo")])]), List([Float(1.0), List([String("bar")])]), Word(0x577eb3e95ef0 : "=")]), List([List([])])]), List([List([List([List([]), List([]), Word(0x577eb3e97180 : "association"), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])])])]), spec: Some([List([Word(0x577eb3e96c00 : "item"), Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([Entry(Entry { word: 0x577eb3ecc6d0 : "first", examples: Some([List([List([List([Int(4), Int(5), Int(6)]), Word(0x577eb3ecc6d0 : "first")]), List([Int(4)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e96c00 : "item")])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x577eb3ebdf40 : "second", examples: Some([List([List([List([Int(4), Int(5), Int(6)]), Word(0x577eb3ebdf40 : "second")]), List([Int(5)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e96c00 : "item")])]), serialize: false, definition: Builtin })]), List([Entry(Entry { word: 0x577eb3ecc6d0 : "first", examples: Some([List([List([List([Int(4), Int(5), Int(6)]), Word(0x577eb3ecc6d0 : "first")]), List([Int(4)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e96c00 : "item")])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x577eb3ecc6d0 : "first", examples: Some([List([List([List([Int(4), Int(5), Int(6)]), Word(0x577eb3ecc6d0 : "first")]), List([Int(4)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e96c00 : "item")])]), serialize: false, definition: Builtin })]), Word(0x577eb3ea2e60 : "if")]), List([List([])]), Word(0x577eb3ea2e60 : "if")]), List([List([Entry(Entry { word: 0x577eb3e97180 : "association", examples: Some([List([List([List([List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")]), List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")])]), Word(0x577eb3e97180 : "association"), List([List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")]), List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")])]), Word(0x577eb3e97180 : "association"), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")]), List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")])]), List([List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")]), List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")])]), Word(0x577eb3e97180 : "association"), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e96630 : "false")])]), List([List([List([List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")]), List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")])]), List([List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b")]), List([Word(0x577eb3ea6e10 : "c"), Word(0x577eb3eb3d40 : "d")])]), Word(0x577eb3e97180 : "association"), Word(0x577eb3e95ef0 : "=")]), List([Word(0x577eb3e96630 : "false")])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e97180 : "association")])]), serialize: false, definition: Builtin })]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([Entry(Entry { word: 0x577eb3ea9ba0 : "execute", examples: Some([List([List([List([Int(1), Int(2), Word(0x577eb3e93f70 : "+")]), Word(0x577eb3ea9ba0 : "execute")]), List([Int(3)])]), List([List([Int(2), List([Word(0x577eb3e93f70 : "+")]), Int(4), Word(0x577eb3ea6df0 : "swap"), Word(0x577eb3ea9ba0 : "execute")]), List([Int(6)])])]), spec: Some([List([Word(0x577eb3ea6a70 : "program")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })]), Word(0x577eb3ee54c0 : "any?")])]), List([List([Entry(Entry { word: 0x577eb3ea22b0 : "list?", examples: Some([List([List([List([Int(1)]), Word(0x577eb3ea22b0 : "list?")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([]), Word(0x577eb3ea22b0 : "list?")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([Int(5), Word(0x577eb3ea22b0 : "list?")]), List([Word(0x577eb3e96630 : "false")])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([Word(0x577eb3ea6cf0 : "list")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([Entry(Entry { word: 0x577eb3ea4130 : "number?", examples: Some([List([List([List([Int(1)]), Word(0x577eb3ea4130 : "number?")]), List([Word(0x577eb3e96630 : "false")])]), List([List([List([]), Word(0x577eb3ea4130 : "number?")]), List([Word(0x577eb3e96630 : "false")])]), List([List([Int(5), Word(0x577eb3ea4130 : "number?")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([Float(5.01), Word(0x577eb3ea4130 : "number?")]), List([Word(0x577eb3e969f0 : "true")])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([Word(0x577eb3e94940 : "number")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([Entry(Entry { word: 0x577eb3ed46f0 : "word?", examples: Some([List([List([Word(0x577eb3ed46b0 : "foo"), Word(0x577eb3ed46f0 : "word?")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([Word(0x577eb3ed46b0 : "foo")]), Word(0x577eb3eac3a0 : "unwrap"), Word(0x577eb3ed46f0 : "word?")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([Word(0x577eb3e969f0 : "true"), Word(0x577eb3ed46f0 : "word?")]), List([Word(0x577eb3e96630 : "false")])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([Word(0x577eb3ea4170 : "word")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([Entry(Entry { word: 0x577eb3ecac30 : "bytes?", examples: None, spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([Entry(Entry { word: 0x577eb3ecac50 : "bytes", examples: None, spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3ecac50 : "bytes")])]), serialize: false, definition: Builtin })]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([Entry(Entry { word: 0x577eb3ec8d40 : "string?", examples: Some([List([List([String("hi"), Word(0x577eb3ec8d40 : "string?")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([String(""), Word(0x577eb3ec8d40 : "string?")]), List([Word(0x577eb3e969f0 : "true")])]), List([List([List([String("hi")]), Word(0x577eb3ec8d40 : "string?")]), List([Word(0x577eb3e96630 : "false")])]), List([List([Word(0x577eb3e969f0 : "true"), Word(0x577eb3ec8d40 : "string?")]), List([Word(0x577eb3e96630 : "false")])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([Entry(Entry { word: 0x577eb3ea6420 : "string", examples: Some([List([List([Int(1), Word(0x577eb3ea6420 : "string")]), List([String("1")])]), List([List([List([Int(1), Int(2), Int(3)]), Word(0x577eb3ea6420 : "string")]), List([String("[1 2 3]")])]), List([List([List([]), Word(0x577eb3ea6420 : "string")]), List([String("[]")])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3ea6420 : "string")])]), serialize: false, definition: Builtin })]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([Entry(Entry { word: 0x577eb3ecc550 : "pipe?", examples: None, spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([Word(0x577eb3edd950 : "pipe")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])]), List([List([Entry(Entry { word: 0x577eb3ea2600 : "error?", examples: None, spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([Word(0x577eb3e96820 : "boolean")])]), serialize: false, definition: Builtin })]), List([List([Word(0x577eb3f08630 : "error")]), Entry(Entry { word: 0x577eb3eac3a0 : "unwrap", examples: Some([List([List([List([Int(1)]), Word(0x577eb3eac3a0 : "unwrap")]), List([Int(1)])])]), spec: Some([List([Word(0x577eb3ea6cf0 : "list")]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin })])])]), Entry(Entry { word: 0x577eb3ede4f0 : "decide", examples: Some([List([List([Int(5), List([List([List([Int(3), Word(0x577eb3e95ef0 : "=")]), List([String("three")])]), List([List([Int(5), Word(0x577eb3e95ef0 : "=")]), List([String("five")])]), List([List([Int(7), Word(0x577eb3e95ef0 : "=")]), List([String("seven")])]), List([List([Word(0x577eb3e969f0 : "true")]), List([String("something else")])])]), Word(0x577eb3ede4f0 : "decide")]), List([Int(5), String("five")])]), List([List([Int(9), List([List([List([Int(3), Word(0x577eb3e95ef0 : "=")]), List([String("three")])]), List([List([Int(5), Word(0x577eb3e95ef0 : "=")]), List([String("five")])]), List([List([Int(7), Word(0x577eb3e95ef0 : "=")]), List([String("seven")])]), List([List([Word(0x577eb3e969f0 : "true")]), List([String("something else")])])]), Word(0x577eb3ede4f0 : "decide")]), List([Int(9), String("something else")])]), List([List([Int(9), List([List([List([Int(3), Word(0x577eb3e95ef0 : "=")]), List([String("three")])]), List([List([Int(5), Word(0x577eb3e95ef0 : "=")]), List([String("five")])]), List([List([Int(7), Word(0x577eb3e95ef0 : "=")]), List([String("seven")])])]), Word(0x577eb3ede4f0 : "decide")]), List([Int(9), List([])])])]), spec: Some([List([List([Word(0x577eb3e97180 : "association"), Word(0x577eb3ede280 : "test-expr-pairs")])]), List([Word(0x577eb3e946e0 : "*")])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x577eb3ea6df0 : "swap", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x577eb3ea6df0 : "swap")]), List([Int(1), Int(3), Int(2)])])]), spec: Some([List([List([Word(0x577eb3e96c00 : "item"), Word(0x577eb3ea63c0 : "a")]), List([Word(0x577eb3e96c00 : "item"), Word(0x577eb3ea6a50 : "b")])]), List([List([Word(0x577eb3e96c00 : "item"), Word(0x577eb3ea6a50 : "b")]), List([Word(0x577eb3e96c00 : "item"), Word(0x577eb3ea63c0 : "a")])])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x577eb3ea67c0 : "discard", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x577eb3ea67c0 : "discard")]), List([Int(1), Int(2)])]), List([List([Int(1), Int(2), Int(3), List([Word(0x577eb3ea63c0 : "a"), Word(0x577eb3ea6a50 : "b"), Word(0x577eb3ea6e10 : "c")]), Word(0x577eb3ea67c0 : "discard")]), List([Int(1), Int(2), Int(3)])])]), spec: Some([List([Word(0x577eb3e96c00 : "item")]), List([])]), serialize: false, definition: Builtin })]
handle is Word(0x577eb3e95b00 : "handle") Word(0x577eb3e95b00 : "handle")
expr contains handle? false
unhandled err!

stack: [[[reason "not enough items on stack"] [asked [consume]] [type error]]]
expression: [[[[nothing?] [[nothing] unwrap]] [[association?] [[[[type] lookup] [[count 1 =] [[first [type] unwrap =] [first second] [first first] if] [[]] if] [[association] unwrap]] [execute] any?]] [[list?] [[list] unwrap]] [[number?] [[number] unwrap]] [[word?] [[word] unwrap]] [[bytes?] [[bytes] unwrap]] [[string?] [[string] unwrap]] [[pipe?] [[pipe] unwrap]] [[error?] [[error] unwrap]]] decide swap discard]
</pre>

<p>
Looks like the word <code>error?</code> is shadowed - there's a builtin that's
overwritten by a definition that depends on the builtin (via calling
<code>type</code>, which expects the builtin version of <code>error?</code>).
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>expression <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]]]</span> environment eval-<span style="color: #E5E57E; font-weight: bold;">step</span> 
</pre>
</div>

<pre class="example">

[[[stack [[[asked [consume]] [reason "not enough items on stack"] [type error]]]] [expression []]]]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>expression <span style="color: #696969; font-weight: bold;">[</span>1 +<span style="color: #696969; font-weight: bold;">]]]</span> environment advance advance advance 
</pre>
</div>

<pre class="example">

[[[stack [[[asked [consume]] [reason "not enough items on stack"] [type error]] 1]] [expression [+]]]]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>expression <span style="color: #696969; font-weight: bold;">[[[</span>3<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>+ handle<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]]]</span> environment advance advance advance
</pre>
</div>

<pre class="example">

[[[stack [[[asked [+_handle]] [reason "word is not defined"] [type error]]]] [expression [+_handle [[[3]]] unwrap]]]]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>expression <span style="color: #696969; font-weight: bold;">[</span>+ handle<span style="color: #696969; font-weight: bold;">]]]</span> environment eval-<span style="color: #E5E57E; font-weight: bold;">step</span> eval-<span style="color: #E5E57E; font-weight: bold;">step</span>
</pre>
</div>

<pre class="example">
{ stack: [], expression: [[[expression [+ handle]]] environment eval-step eval-step] }
{ stack: [[[expression [+ handle]]]], expression: [environment eval-step eval-step] }
{ stack: [[[stack []] [expression [+ handle]]]], expression: [eval-step eval-step] }
{ stack: [], expression: [+ handle] }
{ stack: [[[stack [[[asked [consume]] [type error] [reason "not enough items on stack"]]]] [expression [+ handle]]]], expression: [eval-step] }
{ stack: [[[asked [consume]] [type error] [reason "not enough items on stack"]]], expression: [+ handle] }

[[[stack [[[reason "not enough items on stack"] [type error] [asked [consume]]] [[asked [consume]] [type error] [reason "not enough items on stack"]]]] [expression [+ handle]]]]
</pre>


<p>
There is a problem in the design where an error (with no <code>handle</code>) is
supposed to halt execution, but later we want to do things with the
environment (like examine objects etc). For example, if we're
executing a nested env and it has an error, we can't even natively
examine it, because as soon as we retrieve it from the inner env, it
is an unhandled error on ToS and it halts the outer env. This is not
what I intended.
</p>

<p>
A possible solution is to have whatever <code>eval</code> we're using halt but
remove the <code>halt</code> bit (in the current design it's the <code>is_handled</code>
field of the error) on its way out. So that whatever executes next is
presumed to be after some manual intervention has taken place.
</p>

<p>
Also for nested envs we need several words to help deal with errors:
</p>

<ul class="org-ul">
<li>a word that tells whether the env will halt: that there's an error
on ToS with halt bit set, and <code>handle</code> does not appear in the
expression. The word can efficiently return <code>false</code> if ToS isn't an
Error.</li>

<li>A word that removes the halt bit - as the last thing to do before
exiting.</li>
</ul>

<p>
So what about the word <code>advance</code> that completely executes a word -
let's say the word errors out and halts. We removed the halt bit first
but how do we know what happened? In <code>eval</code> it's pretty obvious if we
halted on error - the expression isn't empty (that's the only other
reason to stop). We could see in <code>advance</code> that the expression got
longer, but isn't very obvious in many cases.
</p>

<p>
Another possibility is letting the expression unwind until it's empty,
which would also halt execution. That's not ideal because we're giving
up the possibility of manually fixing it and continuing. On the other
hand, real programs are probably not going to have universal error
handlers (eg like java's 'catch Exception e'. In other words, the
<code>recover</code> is often going to examine the error, see that it's not one
that it knows how to deal with, and re-throw it hoping there's a
recovery further down the expression that will know what to do. But
there may not be, and the end result is a major unwind of the
expression, at least, all the way to the deepest <code>recover</code>. At that
point it's likely too far unwound to do any manual
interventions. We're just not going to know at 'throw time' whether
any of the recoveries can really help. It's possible they'll all look
at the error and pass it on. 
</p>

<p>
But there's no denying that halting when there's no recovery, is
better than unwinding everything - you find out what went wrong <b>and</b>
you get the possibility of continuing. It's just a matter of providing
this feature without making other things more difficult.
</p>

<p>
Maybe another possibility is unwinding the expression <b><b>into</b></b> the
error object. In other words, whatever expression items we lop off, we
save them in the error object, in a field named, say, <code>unwound</code> or
something like that. Then the runtime can just exit with the error on
ToS, and if the user wants to manually intervene they can copy the
expression from that field. This doesn't solve the problem of 'just
examining an error causes unwind' but it saves us from having to
special case unhandlable errors. Perhaps we could have a word called
<code>rewind</code> or something, that restores the expression from the error on
ToS and clears the halt bit.
</p>

<p>
I like this idea more and more - it opens up the possibility of
common-lisp's retry, where you can catch an error thrown from deep
within nested code, twiddle the stack a bit and retry the code
again. We already retain the expression item that threw the error so
we would still have it to retry. I'm thinking syntax like this:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 1<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> retry<span style="color: #696969; font-weight: bold;">]</span> recover
</pre>
</div>

<p>
In this case we try to add, but there's no numbers on the stack. So we
enter the recovery program that finds the env like this:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>stack <span style="color: #696969; font-weight: bold;">[[[</span>type error<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>asked <span style="color: #696969; font-weight: bold;">[</span>consume<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>unwound <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]]]]</span>
 <span style="color: #696969; font-weight: bold;">[</span>expression <span style="color: #696969; font-weight: bold;">[[</span>1 1<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> retry<span style="color: #696969; font-weight: bold;">]]]]</span>
</pre>
</div>

<p>
So we <code>dip</code> the numbers underneath the error, then calling <code>retry</code> on
an error will extract the <code>unwound</code> field (discarding the rest of the
error) and <code>execute</code> it. So then we end up with <code>1 1 +</code>.
</p>

<p>
Ok i actually implemented this (and I don't think it was difficult)
but i don't know what I did with it. I know it worked quite well and I
wanted to keep it. Need to do it again.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #AD9292;">;; </span><span style="color: #AD9292;">there needs to be 3 numbers here to add/mult but we forgot!</span>
+ * 1 2 3
handle <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">catch the error here, stack is empty except the error</span>
<span style="color: #696969; font-weight: bold;">[</span>5 6 7<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">put numbers underneath</span>
retry <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">rerun what failed before</span>
</pre>
</div>

<pre class="example">

[3 2 1 65]
</pre>


<p>
Now put it together using the higher-level <code>recover</code>
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>+ *<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>5 6 7<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> retry<span style="color: #696969; font-weight: bold;">]</span> recover
</pre>
</div>

<pre class="example">

[65]
</pre>
</div>
</div>

<div id="outline-container-org1b5eca4" class="outline-4">
<h4 id="org1b5eca4"><span class="section-number-4">1.5.16.</span> <span class="done DONE">DONE</span> Lots of association-like objects that aren't</h4>
<div class="outline-text-4" id="text-1-5-16">
<p>
Environment and Error, for example. We can't just treat it like an
assoc, even though it is. I'm not quite sure how to solve this. I
don't think I can make a trait <b>and</b> make the trait object part of the
Item enum.
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">trait</span> <span style="color: #C2E5C2;">Foo</span> {};

<span style="color: #E5C2E5; font-weight: bold;">struct</span> <span style="color: #C2E5C2;">Quux</span> { }

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Foo</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Quux</span> {}

<span style="color: #E5C2E5; font-weight: bold;">enum</span> <span style="color: #C2E5C2;">Bar</span> { <span style="color: #C2E5C2;">Int</span>(<span style="color: #C2E5C2;">i32</span>), <span style="color: #C2E5C2;">Foo</span>(<span style="color: #C2E5C2;">Box</span>&lt;<span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Foo</span>&gt;), <span style="color: #C2E5C2;">Quux</span>(<span style="color: #C2E5C2;">Quux</span>) }
</pre>
</div>

<p>
Rust doesn't complain if you have an object that can match the enum in
more than one way. I think that's because one is boxed and the other isn't.
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #E5C2E5; font-weight: bold;">trait</span> <span style="color: #C2E5C2;">Foo</span> {};

<span style="color: #E5C2E5; font-weight: bold;">struct</span> <span style="color: #C2E5C2;">Quux</span> { }

<span style="color: #E5C2E5; font-weight: bold;">impl</span> <span style="color: #C2E5C2;">Foo</span> <span style="color: #E5C2E5; font-weight: bold;">for</span> <span style="color: #C2E5C2;">Quux</span> {}

<span style="color: #E5C2E5; font-weight: bold;">enum</span> <span style="color: #C2E5C2;">Bar</span>&lt;'<span style="color: #E5E5A0; font-weight: bold;">a</span>&gt; { <span style="color: #C2E5C2;">Int</span>(<span style="color: #C2E5C2;">i32</span>), <span style="color: #C2E5C2;">Foo</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span>'<span style="color: #E5E5A0; font-weight: bold;">a</span> <span style="color: #E5C2E5; font-weight: bold;">dyn</span> <span style="color: #C2E5C2;">Foo</span>), <span style="color: #C2E5C2;">Quux</span>(<span style="color: #ffffff; background-color: #000000;">&amp;</span>'<span style="color: #E5E5A0; font-weight: bold;">a</span> <span style="color: #C2E5C2;">Quux</span>) }
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">dictionary <span style="color: #696969; font-weight: bold;">[</span>advance definition<span style="color: #696969; font-weight: bold;">]</span> lookup
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">
<span style="color: #696969; font-weight: bold;">[[[[</span>expression<span style="color: #696969; font-weight: bold;">]</span> lookup <span style="color: #E5E57E; font-weight: bold;">count</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[[</span>expression<span style="color: #696969; font-weight: bold;">]</span> lookup <span style="color: #E5E57E; font-weight: bold;">count</span> <span style="color: #696969; font-weight: bold;">[[</span>positive?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>&lt;=<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> every?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>eval-<span style="color: #E5E57E; font-weight: bold;">step</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">while</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> discard<span style="color: #696969; font-weight: bold;">]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>expression <span style="color: #696969; font-weight: bold;">[</span>1 1 +<span style="color: #696969; font-weight: bold;">]]]</span> environment eval-<span style="color: #E5E57E; font-weight: bold;">step</span> <span style="color: #696969; font-weight: bold;">[</span>stack<span style="color: #696969; font-weight: bold;">]</span> lookup
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>1<span style="color: #696969; font-weight: bold;">]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[]</span> environment association?
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #E5C2E5; font-weight: bold;">true</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">dictionary <span style="color: #696969; font-weight: bold;">[</span>fail<span style="color: #696969; font-weight: bold;">]</span> lookup
</pre>
</div>

<pre class="example">
[[spec [[string] [*]]] [definition []]]
</pre>
</div>
</div>

<div id="outline-container-orgc33ce18" class="outline-4">
<h4 id="orgc33ce18"><span class="section-number-4">1.5.17.</span> <span class="done DONE">DONE</span> scoping of dictionary entries</h4>
<div class="outline-text-4" id="text-1-5-17">
<p>
The original design was to have the dictionary be a single atomic data
structure that code could modify basically at will, with words like
<code>inscribe</code> (to add words) etc.
</p>

<p>
However I think a better design would be something like this:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>add1 <span style="color: #696969; font-weight: bold;">[</span>1 +<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>3 add1<span style="color: #696969; font-weight: bold;">]</span> augment
</pre>
</div>

<p>
Where the word <code>augment</code> takes an association (more specifically, a
dictionary) and overlays that on top of the builtin dictionary. Then
those new words become accessible just as if they were built in, then
the 2nd argument (a program) is executed as usual. After execution,
the learned words are no longer accessible.
</p>

<p>
It would be possible to nest calls to <code>augment</code> (where the program has
its own call to <code>augment</code>).
</p>

<p>
As for implementation, it may be possible to do a kcats-only impl, but
I don't think it's going to perform well. This is going to be the
normal mode of execution. Very few programs will run with only the
builtin words. In fact, it may be a good idea to break up the lexicon
into components - have pipes be a separate library that has to be
loaded with <code>augment</code>.
</p>

<p>
There is some overlap in functionality here, between <code>decide</code> and
<code>augment</code> - both are designed to provide context. Maybe <code>decide</code> provides
context on how a given word (whose overall meaning doesn't change)
applies to a given piece of data. And <code>augment</code> provides completely new
words, or provides a new meaning. Probably it's not going to be common
to replace meanings - maybe for security reasons. For example, when
running untrusted code, you may want to eliminate certain words (like
those that have side effects like writing to disk or the
network). That brings up the possible feature of not just merging new
items into the dictionary but doing arbitrary combinators, where <code>join</code>
is just a common use case. In that case, maybe <code>augment</code> isn't the right
word because you might be actually restricting the dictionary. So we
need a more generic term for "changing the language". Garble? babel?
I like <code>babel</code> - it captures the fact that we're moving from one
language (the set of builtin words) to lots of different languages. I also like <code>lingo</code>.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span> *<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>square<span style="color: #696969; font-weight: bold;">]</span> assign<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">operate on the dictionary - add word 'square'</span>
<span style="color: #696969; font-weight: bold;">[</span>3 square<span style="color: #696969; font-weight: bold;">]</span>
lingo
</pre>
</div>

<p>
would print 9.
</p>

<p>
The idea here is to have local lingo, possibly down to quite small
pieces of code. I'm thinking on the order of 10 words is probably
enough to have certain words added or changed.
</p>

<p>
Special care will need to be taken, if you want to change the meaning
of the word, but re-use the old meaning as part of the new
meaning. You can't just overwrite the definition with a new one that
contains the word itself, expecting <b>that</b> word to refer to the old
meaning. You'll have to capture the old definition and incorporate
it. <code>update</code> should help.
</p>
</div>
<div id="outline-container-org5e6e369" class="outline-5">
<h5 id="org5e6e369"><span class="section-number-5">1.5.17.1.</span> What to call this word</h5>
<div class="outline-text-5" id="text-1-5-17-1">
<ul class="org-ul">
<li>learn (but unlearn after?)</li>
<li>specialize</li>
<li>extend</li>
<li>adapt</li>
<li>augment</li>
<li>refine</li>
<li>supplement</li>
<li>babel</li>
<li>lingo &lt;= front runner.</li>
</ul>
</div>
</div>
<div id="outline-container-org31cc55d" class="outline-5">
<h5 id="org31cc55d"><span class="section-number-5">1.5.17.2.</span> Implementation</h5>
<div class="outline-text-5" id="text-1-5-17-2">
<p>
It seems viable that we could use the stack to hold dictionary changes.
</p>

<p>
We'd have to retain a copy of the original dictionary to restore later.
</p>

<p>
An axiom word like <code>definitions</code> or something that sets the dictionary
to ToS would help. I think the rest could be pure kcats.
</p>

<p>
it'd be something like:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>square<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span> *<span style="color: #696969; font-weight: bold;">]]</span>
          <span style="color: #AD9292;">; </span><span style="color: #AD9292;">[word square]</span>
           <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]]</span> assign<span style="color: #696969; font-weight: bold;">]</span><span style="color: #AD9292;">;; </span><span style="color: #AD9292;">ops-dict</span>
<span style="color: #696969; font-weight: bold;">[</span>9 square<span style="color: #696969; font-weight: bold;">]</span><span style="color: #AD9292;">;; </span><span style="color: #AD9292;">program-to-run</span>
dictionary <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">fetch the dictionary</span>
<span style="color: #C2C2E5; font-weight: bold;">sink</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">p o d</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dipdown</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">p o d d</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">n=new-dict p n d</span>
<span style="color: #C2C2E5; font-weight: bold;">float</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">d p n</span>
<span style="color: #C2C2E5; font-weight: bold;">swapdown</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">d n p</span>
<span style="color: #696969; font-weight: bold;">[</span>redefine <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">p</span>
 <span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">d</span>
redefine
</pre>
</div>

<pre class="example">
81
</pre>


<p>
A few problems remaining above:
</p>
<ul class="org-ul">
<li class="on"><code>[X]</code> Need to specify the word inside the definition.</li>
<li class="on"><code>[X]</code> Need to explicitly convert the definition to an association.</li>
</ul>

<p>
But I think this proves the concept.
</p>

<p>
Probably want to eventually make a rust implementation.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>square<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span> *<span style="color: #696969; font-weight: bold;">]]</span>
          <span style="color: #AD9292;">; </span><span style="color: #AD9292;">[word square]</span>
           <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]]</span> assign<span style="color: #696969; font-weight: bold;">]</span><span style="color: #AD9292;">;; </span><span style="color: #AD9292;">ops-dict</span>
<span style="color: #696969; font-weight: bold;">[</span>9 square<span style="color: #696969; font-weight: bold;">]</span><span style="color: #AD9292;">;; </span><span style="color: #AD9292;">program-to-run</span>
dictionary <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">fetch the dictionary</span>
<span style="color: #C2C2E5; font-weight: bold;">sink</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">p o d</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dipdown</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">p o d d</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">n=new-dict p n d</span>
<span style="color: #C2C2E5; font-weight: bold;">float</span>
<span style="color: #C2C2E5; font-weight: bold;">swapdown</span>
<span style="color: #696969; font-weight: bold;">[</span>redefine<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> dictionary <span style="color: #696969; font-weight: bold;">[</span>square<span style="color: #696969; font-weight: bold;">]</span> lookup

</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>square<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span> *<span style="color: #696969; font-weight: bold;">]]</span>
          <span style="color: #AD9292;">; </span><span style="color: #AD9292;">[word square]</span>
           <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]]</span> assign<span style="color: #696969; font-weight: bold;">]</span><span style="color: #AD9292;">;; </span><span style="color: #AD9292;">ops-dict</span>
<span style="color: #696969; font-weight: bold;">[</span>9 square<span style="color: #696969; font-weight: bold;">]</span><span style="color: #AD9292;">;; </span><span style="color: #AD9292;">program-to-run</span>
lingo 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">dictionary <span style="color: #696969; font-weight: bold;">[</span>square<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span> *<span style="color: #696969; font-weight: bold;">]]</span>
                     <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]]</span> assign
<span style="color: #696969; font-weight: bold;">[</span>square<span style="color: #696969; font-weight: bold;">]</span> lookup
</pre>
</div>

<pre class="example">
Warning, failed to insert into dictionary: List([List([Word(0x5dcc4c2878e0 : "definition"), List([Entry(Entry { word: 0x5dcc4c26dea0 : "clone", examples: Some([List([List([Int(1), Int(2), Int(3), Word(0x5dcc4c26dea0 : "clone")]), List([Int(1), Int(2), Int(3), Int(3)])])]), spec: Some([List([List([Word(0x5dcc4c25ad70 : "item"), Word(0x5dcc4c26d4d0 : "a")])]), List([List([Word(0x5dcc4c25ad70 : "item"), Word(0x5dcc4c26d4d0 : "a")]), List([Word(0x5dcc4c25ad70 : "item"), Word(0x5dcc4c26d4d0 : "a")])])]), serialize: false, definition: Builtin }), Entry(Entry { word: 0x5dcc4c2579c0 : "*", examples: None, spec: Some([List([Word(0x5dcc4c258ab0 : "number"), Word(0x5dcc4c258ab0 : "number")]), List([Word(0x5dcc4c258ab0 : "number")])]), serialize: false, definition: Builtin })])]), List([Word(0x5dcc4c25a6a0 : "spec"), List([List([Word(0x5dcc4c258ab0 : "number")]), List([Word(0x5dcc4c258ab0 : "number")])])])])
[]
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb51c839" class="outline-4">
<h4 id="orgb51c839"><span class="section-number-4">1.5.18.</span> <span class="done DONE">DONE</span> Move environment stuff into own module</h4>
<div class="outline-text-4" id="text-1-5-18">
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>expression <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]]]</span> environment 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">{ stack: <span style="color: #696969; font-weight: bold;">[]</span>, expression: <span style="color: #696969; font-weight: bold;">[[[</span>expression <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]]]</span> environment<span style="color: #696969; font-weight: bold;">]</span> }
{ stack: <span style="color: #696969; font-weight: bold;">[[[</span>expression <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]]]]</span>, expression: <span style="color: #696969; font-weight: bold;">[</span>environment<span style="color: #696969; font-weight: bold;">]</span> }

<span style="color: #696969; font-weight: bold;">[[[</span>stack <span style="color: #696969; font-weight: bold;">[]]</span> <span style="color: #696969; font-weight: bold;">[</span>expression <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]]]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">1 2 +
</pre>
</div>

<pre class="example">

[3]
</pre>
</div>
</div>

<div id="outline-container-org537110f" class="outline-4">
<h4 id="org537110f"><span class="section-number-4">1.5.19.</span> <span class="done DONE">DONE</span> When printing results, don't wrap the stack</h4>
<div class="outline-text-4" id="text-1-5-19">
<p>
Evaling <code>1 1 +</code> should print <code>2</code>, not <code>[2]</code>. We don't have to wrap the
input, so why wrap the output.
</p>
</div>
</div>

<div id="outline-container-org438184f" class="outline-4">
<h4 id="org438184f"><span class="section-number-4">1.5.20.</span> <span class="done DONE">DONE</span> Update pipes to use enums instead of traits</h4>
<div class="outline-text-4" id="text-1-5-20">
<p>
It's worked out well for everything else, and I don't think anyone
else will be implementing these traits.
</p>

<p>
Looking at this I am not in that big a hurry to change it, with traits
at least I can spread out the impls into different modules. with enums
that'd be awkward.
</p>
</div>
</div>

<div id="outline-container-org0fa0a69" class="outline-4">
<h4 id="org0fa0a69"><span class="section-number-4">1.5.21.</span> <span class="done CANCELED">CANCELED</span> Recover clears the stack built up in the try program</h4>
<div class="outline-text-4" id="text-1-5-21">
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>2 3 <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">four</span><span style="color: #DDB579; font-weight: bold;">"</span> * +<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]</span> recover
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>reason <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">type mismatch</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>unwound <span style="color: #696969; font-weight: bold;">[</span>* +<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>type error<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>asked <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]</span>
</pre>
</div>

<p>
Apparently this was my design. I am not so sure about it now, that we
have <code>retry</code>. If an error occurs in the middle of a program, what do we
do with the stack? If the recovery is meant to be "try something else
instead of the entire program" then restoring the stack makes
sense. However then that breaks use of <code>retry</code> because the recovery
can't pick up where the program left off.
</p>

<p>
Maybe <code>recover</code> and <code>retry</code> are mutually exclusive.
</p>

<p>
We could also use <code>retry</code> with <code>handle</code>:
</p>

<div class="org-src-container">
<pre class="src src-kcats">2 3 <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">four</span><span style="color: #DDB579; font-weight: bold;">"</span> * + handle <span style="color: #696969; font-weight: bold;">[</span>discard 4<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> retry
</pre>
</div>

<pre class="example">
14
</pre>


<p>
To make this work you have to know which item is the potential problem.
</p>

<p>
Specifying alternates seems useful, such that it will keep retrying
until it hits an empty alternates object or the program finishes. Each
time an alternate is tried it is removed from the list.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>2 3 <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">four</span><span style="color: #DDB579; font-weight: bold;">"</span> 4<span style="color: #696969; font-weight: bold;">]</span> alternates * +<span style="color: #696969; font-weight: bold;">]</span> retry 
</pre>
</div>
</div>
</div>

<div id="outline-container-org55af8fb" class="outline-4">
<h4 id="org55af8fb"><span class="section-number-4">1.5.22.</span> <span class="done DONE">DONE</span> List access and update by index</h4>
<div class="outline-text-4" id="text-1-5-22">
<p>
I think re-using <code>lookup</code> and <code>assign</code> for lists, using their index, makes sense here:
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>5 10 15 20<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1<span style="color: #696969; font-weight: bold;">]</span> lookup
</pre>
</div>
<p>
should print 10.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>5 10 15 20<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1<span style="color: #696969; font-weight: bold;">]</span> 30 assign
</pre>
</div>

<pre class="example">
[5 30 15 20]
</pre>


<p>
would leave <code>[5 30 15 20]</code>.
</p>

<p>
The problem here is that this is ambiguous:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>0<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>d e<span style="color: #696969; font-weight: bold;">]</span> assign

<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">is it (assigned as a hashmap by key)</span>
<span style="color: #AD9292;">;;</span><span style="color: #AD9292;">[[a b] [c d] [0 [d e]]]</span>

<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">or is it (assigned as a vector by index)</span>
<span style="color: #AD9292;">;;</span><span style="color: #AD9292;">[[d e] [c d]]</span>
</pre>
</div>

<pre class="example">
[[d e] [c d]]
</pre>


<p>
We could clear up the ambiguity by saying that int keys on a list mean
vector behavior. If you want the other you have to specify <code>association</code>
first.
</p>

<p>
lets check some corner cases - creating nested lists
</p>
<div class="org-src-container">
<pre class="src src-kcats">  <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 0 0<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> assign
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">should be [1 [[foo]] 3]</span>
</pre>
</div>

<pre class="example">
[1 [["foo"]] 3]
</pre>


<p>
What do we do when we're requested to assign beyond the end of the
list? We can extend the list and pad it with <code>Nothing</code>, although this
seems maybe going a bit too far to honor the user's request that maybe
doesn't make sense.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 2<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> assign
</pre>
</div>

<pre class="example">
[1 [[] [] "foo"] 3]
</pre>


<p>
Now let's test mixed list/assoc
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 foo baz 0<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">bar</span><span style="color: #DDB579; font-weight: bold;">"</span> assign
</pre>
</div>

<pre class="example">
[1 [[foo [[baz [[0 "bar"]]]]]] 3]
</pre>


<p>
Note that here, the last 0 index inserts as a map key because the
object is already an assoc. The contract is basically that once you're
in assoc-land you stay there.
</p>

<p>
Now check the changes for <code>lookup</code>
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>1 4 <span style="color: #696969; font-weight: bold;">[</span>34 6 45<span style="color: #696969; font-weight: bold;">]</span> 99 23<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>2 2<span style="color: #696969; font-weight: bold;">]</span> lookup
</pre>
</div>

<pre class="example">
45
</pre>


<p>
make sure update works too
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>1 4 <span style="color: #696969; font-weight: bold;">[</span>34 6 45<span style="color: #696969; font-weight: bold;">]</span> 99 23<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>2 2<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>inc<span style="color: #696969; font-weight: bold;">]</span> update
</pre>
</div>

<pre class="example">
[1 4 [34 6 46] 99 23]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #E5C2E5; font-weight: bold;">true</span> not
</pre>
</div>

<pre class="example">
[]
</pre>
</div>
</div>

<div id="outline-container-org18bdc0a" class="outline-4">
<h4 id="org18bdc0a"><span class="section-number-4">1.5.23.</span> <span class="done DONE">DONE</span> write 'let'</h4>
<div class="outline-text-4" id="text-1-5-23">
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>a <span style="color: #696969; font-weight: bold;">[</span>1 1 1<span style="color: #696969; font-weight: bold;">]]</span>
 <span style="color: #696969; font-weight: bold;">[</span>b <span style="color: #696969; font-weight: bold;">[</span>6 7 *<span style="color: #696969; font-weight: bold;">]]]</span>
<span style="color: #696969; font-weight: bold;">[</span>a b +<span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">wrap</span>
 <span style="color: #696969; font-weight: bold;">[[[</span>1<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">shield</span>
        <span style="color: #E5E57E; font-weight: bold;">wrap</span>
        <span style="color: #696969; font-weight: bold;">[[[</span>spec <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]]</span>
         <span style="color: #696969; font-weight: bold;">[</span>definition<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span>
        assign<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">build a full entry</span>
   update<span style="color: #696969; font-weight: bold;">]</span>
  <span style="color: #E5E57E; font-weight: bold;">map</span> association <span style="color: #E5E57E; font-weight: bold;">join</span><span style="color: #696969; font-weight: bold;">]</span>
 <span style="color: #E5E57E; font-weight: bold;">join</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span>
lingo
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">43
</pre>
</div>

<p>
i am not sure if just taking the top value is correct here.
</p>


<div class="org-src-container">
<pre class="src src-kcats">dictionary
<span style="color: #696969; font-weight: bold;">[[</span>a <span style="color: #696969; font-weight: bold;">[</span>1 1 1<span style="color: #696969; font-weight: bold;">]]</span>
 <span style="color: #696969; font-weight: bold;">[</span>b <span style="color: #696969; font-weight: bold;">[</span>6 7 *<span style="color: #696969; font-weight: bold;">]]]</span>
<span style="color: #696969; font-weight: bold;">[[</span>1<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">shield</span><span style="color: #696969; font-weight: bold;">]</span> update<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">map</span> association <span style="color: #E5E57E; font-weight: bold;">join</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>reason <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">type mismatch</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>type error<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>unwound <span style="color: #696969; font-weight: bold;">[</span>lingo<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>asked <span style="color: #696969; font-weight: bold;">[</span>program<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>a b +<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>- <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>2 1 -<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>1.1 2.2 -<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>-1.1<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>2.2 1 -<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1.2<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>read <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>string<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">[1 [2] 3]</span><span style="color: #DDB579; font-weight: bold;">"</span> read<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 <span style="color: #696969; font-weight: bold;">[</span>2<span style="color: #696969; font-weight: bold;">]</span> 3<span style="color: #696969; font-weight: bold;">]]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">first</span> <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span>4 5 6<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">first</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>4<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>close <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>pipe p<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>pipe p<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">if</span> <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #00fa9a; font-weight: bold;">shield</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dipdown</span> <span style="color: #00fa9a; font-weight: bold;">branch</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>program <span style="color: #E5C2E5; font-weight: bold;">false</span>-<span style="color: #00fa9a; font-weight: bold;">branch</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>program <span style="color: #E5C2E5; font-weight: bold;">true</span>-<span style="color: #00fa9a; font-weight: bold;">branch</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>program condition<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>5 <span style="color: #696969; font-weight: bold;">[</span>5 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>3 *<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>4 +<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>15<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>6 <span style="color: #696969; font-weight: bold;">[</span>5 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>3 *<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>4 +<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>10<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>assemble <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #696969; font-weight: bold;">[[</span>closed? not<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #00fa9a; font-weight: bold;">while</span> discard<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>pipe program<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 8 <span style="color: #696969; font-weight: bold;">[</span>inc<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>2 8<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 2 <span style="color: #696969; font-weight: bold;">[</span>dec<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>3 dec<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program <span style="color: #696969; font-weight: bold;">[</span>item a<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>item a<span style="color: #696969; font-weight: bold;">]</span> *<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">nothing</span>? <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[[]</span> <span style="color: #E5C2E5; font-weight: bold;">nothing</span>?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 <span style="color: #E5C2E5; font-weight: bold;">nothing</span>?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5C2E5; font-weight: bold;">false</span> <span style="color: #E5C2E5; font-weight: bold;">nothing</span>?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[]</span> =<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>sqrt <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>lookup <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>a<span style="color: #696969; font-weight: bold;">]</span> lookup<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>e<span style="color: #696969; font-weight: bold;">]</span> lookup<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[]]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>outer <span style="color: #696969; font-weight: bold;">[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>outer c<span style="color: #696969; font-weight: bold;">]</span> lookup<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>d<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>list keys<span style="color: #696969; font-weight: bold;">]</span> list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[[[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span> list?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>something?<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> every?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span>++lookup<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">while</span> <span style="color: #696969; font-weight: bold;">[</span>something?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[[</span>type error<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>asked <span style="color: #696969; font-weight: bold;">[</span>association<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>reason <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">Lookup attempted on non-associative value</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> fail<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>filled <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>pipe<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>assign <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>item value<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>list keys<span style="color: #696969; font-weight: bold;">]</span> association<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>association<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>a<span style="color: #696969; font-weight: bold;">]</span> 5 assign<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[[</span>a 5<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]</span> association<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>e<span style="color: #696969; font-weight: bold;">]</span> 5 assign<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>e 5<span style="color: #696969; font-weight: bold;">]]</span> association<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c <span style="color: #696969; font-weight: bold;">[[</span>d e<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]</span> 5 assign<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c <span style="color: #696969; font-weight: bold;">[[</span>d 5<span style="color: #696969; font-weight: bold;">]]]]</span> association<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c <span style="color: #696969; font-weight: bold;">[[</span>d e<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>1 0<span style="color: #696969; font-weight: bold;">]</span> 5 assign<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c <span style="color: #696969; font-weight: bold;">[</span>5<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 0 0<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> assign<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> 3<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 2<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> assign<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> 3<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 foo baz 0<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">bar</span><span style="color: #DDB579; font-weight: bold;">"</span> assign<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 <span style="color: #696969; font-weight: bold;">[[</span>foo <span style="color: #696969; font-weight: bold;">[[</span>baz <span style="color: #696969; font-weight: bold;">[[</span>0 <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">bar</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]]]]]</span> 3<span style="color: #696969; font-weight: bold;">]]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>pipe-out <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>pipe<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[[[</span>type <span style="color: #696969; font-weight: bold;">[</span>file<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>value file-out<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>type <span style="color: #696969; font-weight: bold;">[</span>ip-port<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #696969; font-weight: bold;">[</span>address<span style="color: #696969; font-weight: bold;">]</span> lookup <span style="color: #696969; font-weight: bold;">[[</span>port<span style="color: #696969; font-weight: bold;">]</span> lookup<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> serversocket<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>list?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>+kcats.pipe/-&gt;filled<span style="color: #696969; font-weight: bold;">]]]</span> decide<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>association <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>association<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]</span> association <span style="color: #696969; font-weight: bold;">[[</span>c d<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>a b<span style="color: #696969; font-weight: bold;">]]</span> association =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>c d<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>a b<span style="color: #696969; font-weight: bold;">]]</span> association =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]</span> association =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">shield</span> <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #C2C2E5; font-weight: bold;">snapshot</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #00fa9a; font-weight: bold;">inject</span> <span style="color: #E5E57E; font-weight: bold;">first</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3 <span style="color: #696969; font-weight: bold;">[</span>=<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 2 3 <span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>&lt; <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>pair <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 2 pair<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 2<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">hi</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">there</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> pair<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">hi</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">there</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>list<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5E57E; font-weight: bold;">wrap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>buffer <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>integer<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>pipe<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swapdown</span> <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3 <span style="color: #C2C2E5; font-weight: bold;">swapdown</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>2 1 3<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>item a<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item c<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>item a<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item c<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item b<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>string <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 string<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">1</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> string<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">[1 2 3]</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[]</span> string<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">[]</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>string<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>eval-<span style="color: #E5E57E; font-weight: bold;">step</span> <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[[[</span>expression <span style="color: #696969; font-weight: bold;">[</span>1 inc<span style="color: #696969; font-weight: bold;">]]]</span> environment eval-<span style="color: #E5E57E; font-weight: bold;">step</span> eval-<span style="color: #E5E57E; font-weight: bold;">step</span> <span style="color: #696969; font-weight: bold;">[</span>stack<span style="color: #696969; font-weight: bold;">]</span> lookup<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>2<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>list<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">inject</span> <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3 <span style="color: #696969; font-weight: bold;">[</span>4 5 6<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>* +<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">inject</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 2 3 <span style="color: #696969; font-weight: bold;">[</span>26<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #C2C2E5; font-weight: bold;">evert</span> <span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">evert</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>list<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>association? <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]</span> association?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>b 42<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>serversocket <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>string integer<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>pipe<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>every? <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program list<span style="color: #696969; font-weight: bold;">]</span> boolean<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #00fa9a; font-weight: bold;">shielddown</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> prepend <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> not<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">dip</span> or<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #696969; font-weight: bold;">[[[</span><span style="color: #E5C2E5; font-weight: bold;">nothing</span>?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span>or<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shielddown</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>not<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">recur</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> discard<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span>2 4 6<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>even?<span style="color: #696969; font-weight: bold;">]</span> every?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[</span>2 4 5<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>even?<span style="color: #696969; font-weight: bold;">]</span> every?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[]</span> <span style="color: #696969; font-weight: bold;">[</span>even?<span style="color: #696969; font-weight: bold;">]</span> every?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[</span>2 4 6<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]</span> every?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>11 <span style="color: #696969; font-weight: bold;">[</span>2 4 6<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>+ odd?<span style="color: #696969; font-weight: bold;">]</span> every?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span> 11<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>12 <span style="color: #696969; font-weight: bold;">[[</span>even?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>positive?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>3 rem 0 =<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> every?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span> 12<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>both? <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">sink</span> pair <span style="color: #C2C2E5; font-weight: bold;">swap</span> every?<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 2 <span style="color: #696969; font-weight: bold;">[</span>odd?<span style="color: #696969; font-weight: bold;">]</span> both?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 3 <span style="color: #696969; font-weight: bold;">[</span>odd?<span style="color: #696969; font-weight: bold;">]</span> both?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program item item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">filter</span> <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #C2C2E5; font-weight: bold;">snapshot</span> <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dipdown</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #C2C2E5; font-weight: bold;">swapdown</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #00fa9a; font-weight: bold;">inject</span> <span style="color: #E5E57E; font-weight: bold;">first</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>discard<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #00fa9a; font-weight: bold;">branch</span> <span style="color: #C2C2E5; font-weight: bold;">swapdown</span> <span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #E5E57E; font-weight: bold;">step</span> discard<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>odd?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">filter</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 3<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[[[</span>2 4 6<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>odd?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">filter</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[]]]</span> <span style="color: #696969; font-weight: bold;">[[</span>33 <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>+ odd?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">filter</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>2<span style="color: #696969; font-weight: bold;">]</span> 33<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>list<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>file-in <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>string<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>pipe<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>shielddowndown <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">shield</span> <span style="color: #696969; font-weight: bold;">[</span>discard discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>program p<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item consumed<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item consumed<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>item result<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3 <span style="color: #696969; font-weight: bold;">[</span>+ +<span style="color: #696969; font-weight: bold;">]</span> shielddowndown<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 6<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">snapshot</span> <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3 <span style="color: #C2C2E5; font-weight: bold;">snapshot</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 2 3 <span style="color: #696969; font-weight: bold;">[</span>3 2 1<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #C2C2E5; font-weight: bold;">snapshot</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #696969; font-weight: bold;">[</span>list<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #C2C2E5; font-weight: bold;">evert</span> <span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #C2C2E5; font-weight: bold;">evert</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>* <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>dictionary <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #696969; font-weight: bold;">[</span>list<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>word? <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>foo word?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[</span>foo<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> word?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5C2E5; font-weight: bold;">true</span> word?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item <span style="color: #696969; font-weight: bold;">[</span>pipe in<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>pipe in<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>max <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>positive? <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[</span>0 &gt;<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">float</span> <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3 <span style="color: #C2C2E5; font-weight: bold;">float</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>2 3 1<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>item a<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item c<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>item c<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item a<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item b<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>zip <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span>a b c<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> zip<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[[</span>a 1<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>b 2<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c 3<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>list values<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>list keys<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>association<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[[]]</span> <span style="color: #00fa9a; font-weight: bold;">dipdown</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #E5E57E; font-weight: bold;">wrap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">step</span> discard<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>quot <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">reverse</span> <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>list<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">reverse</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>3 2 1<span style="color: #696969; font-weight: bold;">]]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>string? <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">hi</span><span style="color: #DDB579; font-weight: bold;">"</span> string?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #DDB579; font-weight: bold;">""</span> string?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">hi</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> string?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5C2E5; font-weight: bold;">true</span> string?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>disassemble <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">nothing</span>? not<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #00fa9a; font-weight: bold;">while</span> discard<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program item <span style="color: #696969; font-weight: bold;">[</span>pipe in<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>pipe in<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">step</span> <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 <span style="color: #696969; font-weight: bold;">[</span>2 3 4<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">step</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>24<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">step</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 <span style="color: #E5E57E; font-weight: bold;">wrap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>1<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[[[</span>1 2<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">wrap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[[</span>1 2<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>list<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>&gt; <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>2 1 &gt;<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>1.1 2.2 &gt;<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>2.2 1 &gt;<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>zero? <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[</span>0 =<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>0 zero?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>0 zero?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>-0.00001 zero?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>1.1 zero?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>addmethod <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>pair condition<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>program combinator<span style="color: #696969; font-weight: bold;">]</span> word<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">float</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">wrap</span> dictionary <span style="color: #C2C2E5; font-weight: bold;">swap</span> lookup<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dipdown</span> <span style="color: #C2C2E5; font-weight: bold;">float</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">float</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #00fa9a; font-weight: bold;">inject</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> inscribe<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>lingo <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[</span>dictionary <span style="color: #C2C2E5; font-weight: bold;">sink</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dipdown</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">float</span> <span style="color: #C2C2E5; font-weight: bold;">swapdown</span> <span style="color: #696969; font-weight: bold;">[</span>redefine <span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> redefine<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[[</span>square<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span> *<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]]</span> assign<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>9 square<span style="color: #696969; font-weight: bold;">]</span> lingo<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>81<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>program enriched-lexicon<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>program dictionary-modifier<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>redefine <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>association<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>unassign <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>item key<span style="color: #696969; font-weight: bold;">]</span> association<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>association<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>a<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> unassign<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[[</span>c d<span style="color: #696969; font-weight: bold;">]]</span> association<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>e<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> unassign<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]</span> association<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3 <span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 3 2<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>item a<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item b<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>item b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item a<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>prepend <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>list<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span>1 2<span style="color: #696969; font-weight: bold;">]</span> 3 prepend<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>3 1 2<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">join</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spawn <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">recur</span> <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>program rec2<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>program rec1<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>program <span style="color: #E5C2E5; font-weight: bold;">true</span>-<span style="color: #00fa9a; font-weight: bold;">branch</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>program pred<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>3 <span style="color: #696969; font-weight: bold;">[</span>1 &lt;=<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span> dec<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span> *<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">recur</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>6<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>closed? <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>pipe<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">sink</span> <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>item a<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item c<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>item b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item c<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item a<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3 <span style="color: #C2C2E5; font-weight: bold;">sink</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>3 1 2<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>negative? <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[</span>0 &lt;<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>evaluate <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[[[</span>expression <span style="color: #696969; font-weight: bold;">[</span>1 2 3 4 + *<span style="color: #696969; font-weight: bold;">]]]</span> environment evaluate <span style="color: #696969; font-weight: bold;">[</span>stack<span style="color: #696969; font-weight: bold;">]</span> lookup<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>14 1<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>list<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>not <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 even? not<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5C2E5; font-weight: bold;">false</span> not<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5C2E5; font-weight: bold;">true</span> not<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[]</span> not<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>timeout <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>integer<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>pipe<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>environment <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[[[</span>expression <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]]]</span> environment eval-<span style="color: #E5E57E; font-weight: bold;">step</span> <span style="color: #696969; font-weight: bold;">[</span>stack<span style="color: #696969; font-weight: bold;">]</span> lookup<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>1<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>association<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>list<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>bytes? <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>update <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[[[</span>a 1<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>b 2<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>inc<span style="color: #696969; font-weight: bold;">]</span> update<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[[</span>a 1<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>b 3<span style="color: #696969; font-weight: bold;">]]</span> association<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>a <span style="color: #696969; font-weight: bold;">[[</span>c 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>d 5<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>b 2<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>a c<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>inc<span style="color: #696969; font-weight: bold;">]</span> update<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[[</span>a <span style="color: #696969; font-weight: bold;">[[</span>c 4<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>d 5<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>b 2<span style="color: #696969; font-weight: bold;">]]</span> association<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>a <span style="color: #696969; font-weight: bold;">[[</span>c 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>d 5<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>b 2<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>a c<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>discard 10 15<span style="color: #696969; font-weight: bold;">]</span> update<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[[</span>a <span style="color: #696969; font-weight: bold;">[[</span>c 15<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>d 5<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>b 2<span style="color: #696969; font-weight: bold;">]]</span> association<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>a 1<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>b 2<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>d<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>5<span style="color: #696969; font-weight: bold;">]</span> update<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[[</span>a 1<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>b 2<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>d 5<span style="color: #696969; font-weight: bold;">]]</span> association<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>a <span style="color: #696969; font-weight: bold;">[[</span>c 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>d 5<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>b 2<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>a e<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>5 6 +<span style="color: #696969; font-weight: bold;">]</span> update<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[[</span>a <span style="color: #696969; font-weight: bold;">[[</span>c 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>d 5<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>e 11<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>b 2<span style="color: #696969; font-weight: bold;">]]</span> association<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[[</span>lookup<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #00fa9a; font-weight: bold;">shielddown</span> assign<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program <span style="color: #696969; font-weight: bold;">[</span>list keys<span style="color: #696969; font-weight: bold;">]</span> association<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>association<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>tunnel <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[[[[</span>type <span style="color: #696969; font-weight: bold;">[</span>ip-port<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #696969; font-weight: bold;">[</span>port<span style="color: #696969; font-weight: bold;">]</span> lookup <span style="color: #696969; font-weight: bold;">[[</span>address<span style="color: #696969; font-weight: bold;">]</span> lookup<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> !**java.net.Socket.<span style="color: #696969; font-weight: bold;">]]]</span> decide<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>pipe<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>number? <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span>1<span style="color: #696969; font-weight: bold;">]</span> number?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[]</span> number?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>5 number?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>5.01 number?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">loop</span> <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program <span style="color: #696969; font-weight: bold;">[</span>item flag<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>10 <span style="color: #E5C2E5; font-weight: bold;">true</span> <span style="color: #696969; font-weight: bold;">[</span>-2 * <span style="color: #C2C2E5; font-weight: bold;">clone</span> 50 &lt;<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">loop</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>160<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>select <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>list pipes<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>item pipe <span style="color: #696969; font-weight: bold;">[</span>list pipes<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">evert</span> <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>list *<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3 <span style="color: #696969; font-weight: bold;">[</span>4 5 6<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">evert</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>6 5 4 <span style="color: #696969; font-weight: bold;">[</span>3 2 1<span style="color: #696969; font-weight: bold;">]]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>advance <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>environment<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>environment<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[[</span>expression<span style="color: #696969; font-weight: bold;">]</span> lookup <span style="color: #E5E57E; font-weight: bold;">count</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[[</span>expression<span style="color: #696969; font-weight: bold;">]</span> lookup <span style="color: #E5E57E; font-weight: bold;">count</span> <span style="color: #696969; font-weight: bold;">[[</span>positive?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>&lt;=<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> every?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>eval-<span style="color: #E5E57E; font-weight: bold;">step</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">while</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> discard<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">dipdown</span> <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program <span style="color: #696969; font-weight: bold;">[</span>item a<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item b<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>item a<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item b<span style="color: #696969; font-weight: bold;">]</span> *<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3 <span style="color: #696969; font-weight: bold;">[</span>inc<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dipdown</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>2 2 3<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">map</span> <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>list<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>inc<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">map</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>2 3 4<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">map</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>2 3 4<span style="color: #696969; font-weight: bold;">]</span> 1<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>7 9 <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>+ *<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">map</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>70 77 84<span style="color: #696969; font-weight: bold;">]</span> 9 7<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>7 9 <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #E5E57E; font-weight: bold;">map</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>+<span style="color: #696969; font-weight: bold;">]</span> 9 7<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #C2C2E5; font-weight: bold;">snapshot</span> <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dipdown</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #C2C2E5; font-weight: bold;">float</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">join</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #00fa9a; font-weight: bold;">inject</span> <span style="color: #E5E57E; font-weight: bold;">first</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #E5E57E; font-weight: bold;">step</span> discard<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>primrec <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>5 <span style="color: #696969; font-weight: bold;">[</span>1<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]</span> primrec<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>120<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>program rec1<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>program exit<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number data<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #696969; font-weight: bold;">[[</span>discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">join</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #696969; font-weight: bold;">[[</span>zero?<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #00fa9a; font-weight: bold;">dipdown</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span> dec<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #00fa9a; font-weight: bold;">recur</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span> <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span>1 2 +<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>3<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>2 <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> 4 <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>6<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3 <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 2 3 3<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>item a<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>item a<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item a<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>or <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 odd? 3 even? or<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 2 or<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[]</span> 2 or<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>2<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[]</span> <span style="color: #696969; font-weight: bold;">[]</span> or<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>= <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 2 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[]]]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 1 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[]</span> <span style="color: #696969; font-weight: bold;">[]</span> =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[</span>1<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]</span> =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[]]]</span> <span style="color: #696969; font-weight: bold;">[[[</span>1 <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>1 <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]</span> =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[</span>1 <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>1 <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">hi</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">hi</span><span style="color: #DDB579; font-weight: bold;">"</span> =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">hi</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">there</span><span style="color: #DDB579; font-weight: bold;">"</span> =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[]]]</span> <span style="color: #696969; font-weight: bold;">[[[]</span> <span style="color: #E5C2E5; font-weight: bold;">true</span> =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[]]]</span> <span style="color: #696969; font-weight: bold;">[[[</span>1 <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>1 <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">bar</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[]]]</span> <span style="color: #696969; font-weight: bold;">[[[[]</span> <span style="color: #696969; font-weight: bold;">[]</span> association =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>pipe out<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>item <span style="color: #696969; font-weight: bold;">[</span>pipe out<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>something? <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">nothing</span>? not<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 something?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5C2E5; font-weight: bold;">false</span> something?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[]</span> something?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>type <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[[[</span>foo 1<span style="color: #696969; font-weight: bold;">]]</span> type<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>foo<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>1<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>1<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5C2E5; font-weight: bold;">nothing</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>bytes<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>string<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>type foo<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>foo<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>type foo<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>attr <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">blah</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>foo<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>attr1 foo<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>attr2 <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">blah</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>association<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>foo 1<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>foo<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>type url<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>value <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">http://foo.com</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> type<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>url<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[[[</span><span style="color: #E5C2E5; font-weight: bold;">nothing</span>?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5C2E5; font-weight: bold;">nothing</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>association?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>type<span style="color: #696969; font-weight: bold;">]</span> lookup<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5E57E; font-weight: bold;">count</span> 1 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5E57E; font-weight: bold;">first</span> <span style="color: #696969; font-weight: bold;">[</span>type<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">first</span> <span style="color: #E5E57E; font-weight: bold;">second</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">first</span> <span style="color: #E5E57E; font-weight: bold;">first</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[]]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>association<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> any?<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>list?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>number?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>word?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>word<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>bytes?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>bytes<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>string?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>string<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>pipe?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>pipe<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>error?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>error<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]]]</span> decide <span style="color: #C2C2E5; font-weight: bold;">swap</span> discard<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>fail <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>association<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>decide <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>5 <span style="color: #696969; font-weight: bold;">[[[</span>3 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">three</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>5 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">five</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>7 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">seven</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">something else</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]]</span> decide<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>5 <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">five</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>9 <span style="color: #696969; font-weight: bold;">[[[</span>3 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">three</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>5 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">five</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>7 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">seven</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">something else</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]]</span> decide<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>9 <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">something else</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>9 <span style="color: #696969; font-weight: bold;">[[[</span>3 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">three</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>5 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">five</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>7 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">seven</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]]</span> decide<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>9 <span style="color: #696969; font-weight: bold;">[]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>association test-expr-pairs<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>break <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>environment <span style="color: #696969; font-weight: bold;">[</span>program condition<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>environment <span style="color: #696969; font-weight: bold;">[</span>program condition<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[[[[</span>expression<span style="color: #696969; font-weight: bold;">]</span> lookup something?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #00fa9a; font-weight: bold;">execute</span> not<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> every?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>eval-<span style="color: #E5E57E; font-weight: bold;">step</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">while</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">unwrap</span> <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span>1<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>handoff <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #696969; font-weight: bold;">[</span>pipe<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>even? <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>assert <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">snapshot</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">shield</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span>discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>string <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">assertion failed </span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #E5E57E; font-weight: bold;">join</span> fail<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">branch</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">rest</span> <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>list<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">rest</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>2 3<span style="color: #696969; font-weight: bold;">]]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span> <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">nothing</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>pump <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program <span style="color: #696969; font-weight: bold;">[</span>pipe in<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>pipe out<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>pipe in<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>pipe out<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">shield</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #C2C2E5; font-weight: bold;">sink</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swapdown</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #696969; font-weight: bold;">[[</span>closed?<span style="color: #696969; font-weight: bold;">]</span> any?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">branch</span> <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>5 <span style="color: #E5C2E5; font-weight: bold;">true</span> <span style="color: #696969; font-weight: bold;">[</span>3 *<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>4 +<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">branch</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>15<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>6 <span style="color: #E5C2E5; font-weight: bold;">false</span> <span style="color: #696969; font-weight: bold;">[</span>3 *<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>4 +<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">branch</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>10<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>program <span style="color: #E5C2E5; font-weight: bold;">false</span>-<span style="color: #00fa9a; font-weight: bold;">branch</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>program <span style="color: #E5C2E5; font-weight: bold;">true</span>-<span style="color: #00fa9a; font-weight: bold;">branch</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item condition<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>rem <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>/ <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>value <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5E57E; font-weight: bold;">count</span> 1 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">first</span> <span style="color: #E5E57E; font-weight: bold;">second</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>value<span style="color: #696969; font-weight: bold;">]</span> lookup<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[[</span>foo 1<span style="color: #696969; font-weight: bold;">]]</span> value<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[[</span>type url<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>value <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">http://foo.com</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> value<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">http://foo.com</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>association<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>dec <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>any? <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program list<span style="color: #696969; font-weight: bold;">]</span> boolean<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #00fa9a; font-weight: bold;">shielddown</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> prepend <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">dip</span> or<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #696969; font-weight: bold;">[[[</span><span style="color: #E5C2E5; font-weight: bold;">nothing</span>?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span>or<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shielddown</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">recur</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> discard<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span>2 4 6<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>even?<span style="color: #696969; font-weight: bold;">]</span> any?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[</span>3 5 7<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>even?<span style="color: #696969; font-weight: bold;">]</span> any?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[]</span> <span style="color: #696969; font-weight: bold;">[</span>even?<span style="color: #696969; font-weight: bold;">]</span> any?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[</span>2 4 6<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]</span> any?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>2<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>11 <span style="color: #696969; font-weight: bold;">[</span>3 5 6<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>+ odd?<span style="color: #696969; font-weight: bold;">]</span> any?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span> 11<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>-15 <span style="color: #696969; font-weight: bold;">[[</span>even?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>positive?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>3 rem 0 =<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> any?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span> -15<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>and <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 odd? 2 even? and<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>pipe-in <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>pipe<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[[[</span>type <span style="color: #696969; font-weight: bold;">[</span>file<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>value file-in<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>type <span style="color: #696969; font-weight: bold;">[</span>stdout<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>stdout<span style="color: #696969; font-weight: bold;">]]]</span> decide<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">nothing</span> <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[[]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>range <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 5 range<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 2 3 4<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>integer integer<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>list<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item list<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">a</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">b</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">c</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">take</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">b</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">c</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">a</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">count</span> <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">a</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">b</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">c</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">count</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>3<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>list? <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span>1<span style="color: #696969; font-weight: bold;">]</span> list?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[[]</span> list?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>5 list?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>retry <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>error<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>2 3 <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">four</span><span style="color: #DDB579; font-weight: bold;">"</span> * + handle <span style="color: #696969; font-weight: bold;">[</span>discard 4<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> retry<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>14<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[</span>unwound<span style="color: #696969; font-weight: bold;">]</span> lookup <span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>min <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spit <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[[</span>pipe-in<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> bytes <span style="color: #E5E57E; font-weight: bold;">put</span> close discard<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item <span style="color: #696969; font-weight: bold;">[</span>item target<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>ceil <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>integer<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>atom <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>pipe<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">a</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">b</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">c</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">d</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">a</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">b</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">c</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">d</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">ab</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">cd</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #E5E57E; font-weight: bold;">join</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">abcd</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">ab</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">cd</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">abcd</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>odd? <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>file-out <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>string<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>pipe<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>discard <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3 discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 2<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 2 3 <span style="color: #696969; font-weight: bold;">[</span>a b c<span style="color: #696969; font-weight: bold;">]</span> discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>tos <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[[[</span>stack <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>expression <span style="color: #696969; font-weight: bold;">[[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">step</span><span style="color: #696969; font-weight: bold;">]]]</span> tos<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[</span>stack<span style="color: #696969; font-weight: bold;">]</span> lookup <span style="color: #E5E57E; font-weight: bold;">first</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>environment<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>+ <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 2 +<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>3<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>1.1 2.2 +<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>3.3<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 2.2 +<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>3.2<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">second</span> <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span>4 5 6<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">second</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>5<span style="color: #696969; font-weight: bold;">]]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>recover <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>discard 1 <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>discard 2 +<span style="color: #696969; font-weight: bold;">]</span> recover<span style="color: #696969; font-weight: bold;">]</span> recover<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>3<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>5 <span style="color: #696969; font-weight: bold;">[</span>1 2 <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">oh fudge</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>discard discard<span style="color: #696969; font-weight: bold;">]</span> recover<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">map</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>5 <span style="color: #696969; font-weight: bold;">[</span>6 7 5<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> recover<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[[</span>handle<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">snapshot</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dipdown</span> <span style="color: #C2C2E5; font-weight: bold;">sink</span> <span style="color: #00fa9a; font-weight: bold;">inject</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">first</span> error?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">first</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">evert</span> discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program program<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>inc <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 inc<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>2<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>-1 inc<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>0<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>99 inc<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>100<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[[]</span> 1 <span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>1<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> 4 <span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>1 2 3 4<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes 32 <span style="color: #E5E57E; font-weight: bold;">put</span> string<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo </span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item list<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>list<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span> <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #696969; font-weight: bold;">[</span>word<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>pipe? <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>error? <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>bytes <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>bytes<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>a 1<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">while</span> <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>3 <span style="color: #696969; font-weight: bold;">[</span>0 &gt;<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span> dec<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">while</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>3 2 1 0<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>program body<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>program pred<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">shield</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #00fa9a; font-weight: bold;">dipdown</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #00fa9a; font-weight: bold;">loop</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>&gt;= <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">shielddown</span> <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[</span>1 2 3 <span style="color: #696969; font-weight: bold;">[</span>=<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shielddown</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 2 <span style="color: #E5C2E5; font-weight: bold;">false</span><span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">shield</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> discard<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>program item<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>derivations <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[[]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">times</span> <span style="color: #696969; font-weight: bold;">[[</span>definition <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span>dec<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #696969; font-weight: bold;">[</span>0 &gt;<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #00fa9a; font-weight: bold;">while</span> discard<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[[</span>integer howmany<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>program body<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>++lookup <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>item association<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>mod <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>&lt;= <span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>number number<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>boolean<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>toe <span style="color: #696969; font-weight: bold;">[[</span>examples <span style="color: #696969; font-weight: bold;">[[[[[</span>stack <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>expression <span style="color: #696969; font-weight: bold;">[[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">step</span><span style="color: #696969; font-weight: bold;">]]]</span> toe<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>+<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[[</span>expression<span style="color: #696969; font-weight: bold;">]</span> lookup <span style="color: #E5E57E; font-weight: bold;">first</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>spec <span style="color: #696969; font-weight: bold;">[[</span>environment<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]]]]</span>
</pre>
</div>

<p>
Need a way of converting an item to an entry that just pushes that item.
</p>

<div class="org-src-container">
<pre class="src src-kcats">1 <span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #696969; font-weight: bold;">[[[</span>spec <span style="color: #696969; font-weight: bold;">[[[]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> assign 
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[[]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[</span>1<span style="color: #696969; font-weight: bold;">]]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">dictionary
<span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]</span>
 <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[</span>23<span style="color: #696969; font-weight: bold;">]]]</span>
<span style="color: #696969; font-weight: bold;">[</span>fooptoopy<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> assign
<span style="color: #696969; font-weight: bold;">[</span>fooptoopy<span style="color: #696969; font-weight: bold;">]</span> lookup
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>spec <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #696969; font-weight: bold;">[</span>item<span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span>definition <span style="color: #696969; font-weight: bold;">[</span>23<span style="color: #696969; font-weight: bold;">]]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>a <span style="color: #696969; font-weight: bold;">[</span>1 1 1<span style="color: #696969; font-weight: bold;">]]</span>
 <span style="color: #696969; font-weight: bold;">[</span>b <span style="color: #696969; font-weight: bold;">[</span>6 7 *<span style="color: #696969; font-weight: bold;">]]]</span>
<span style="color: #696969; font-weight: bold;">[</span>a b +<span style="color: #696969; font-weight: bold;">]</span> let
</pre>
</div>
</div>
</div>

<div id="outline-container-org6098803" class="outline-4">
<h4 id="org6098803"><span class="section-number-4">1.5.24.</span> <span class="todo TODO">TODO</span> Error should have actual struct fields&#xa0;&#xa0;&#xa0;<span class="tag"><span class="optimization">optimization</span></span></h4>
<div class="outline-text-4" id="text-1-5-24">
<p>
It's still implemented as generic Hashmap data field. 
</p>
</div>
</div>

<div id="outline-container-org2871994" class="outline-4">
<h4 id="org2871994"><span class="section-number-4">1.5.25.</span> <span class="todo TODO">TODO</span> Script</h4>
<div class="outline-text-4" id="text-1-5-25">
</div>
<div id="outline-container-orgcb1574e" class="outline-5">
<h5 id="orgcb1574e"><span class="section-number-5">1.5.25.1.</span> <span class="done DONE">DONE</span> Cryptographic primitives</h5>
<div class="outline-text-5" id="text-1-5-25-1">
</div>
<ol class="org-ol">
<li><a id="org4345100"></a><span class="done DONE">DONE</span> SHA256<br />
<div class="outline-text-6" id="text-1-5-25-1-1">
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes hash <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">fop</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes hash =
</pre>
</div>

<pre class="example">
[]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes key<span style="color: #696969; font-weight: bold;">]</span> 2 <span style="color: #00fa9a; font-weight: bold;">times</span> =
</pre>
</div>

<pre class="example">
true
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes key
</pre>
</div>

<pre class="example">
[[public #b64 "NNJledu0Vmk+VAZyz5IvUt3g1lMuNb8GvgE6fFMvIOA="] [type elliptic-curve-key] [secret #b64 "LCa0a2j/xo/5m0U8HTBBNBNCLXBkg7+g+YpeiGJm564="]]
</pre>
</div>
</li>

<li><a id="orga840016"></a><span class="done DONE">DONE</span> Signing<br />
<div class="outline-text-6" id="text-1-5-25-1-2">
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes key <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">we attack at dawn</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes <span style="color: #696969; font-weight: bold;">[</span>sign<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span> verify
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #E5C2E5; font-weight: bold;">true</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes key <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">we attack at dawn</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes <span style="color: #696969; font-weight: bold;">[</span>sign<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">now change the message</span>
<span style="color: #696969; font-weight: bold;">[</span>discard <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">we attack at sunset</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span>
verify
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[]</span>
</pre>
</div>
</div>
</li>

<li><a id="org5235adc"></a><span class="todo TODO">TODO</span> AES Encryption<br /></li>
<li><a id="org1eeb029"></a><span class="todo TODO">TODO</span> Random<br /></li>
</ol>
</div>
<div id="outline-container-org7511af6" class="outline-5">
<h5 id="org7511af6"><span class="section-number-5">1.5.25.2.</span> <span class="done DONE">DONE</span> Pure functional env</h5>
<div class="outline-text-5" id="text-1-5-25-2">
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>pipe-in pipe-out channel timeout handoff file-in file-out timestamps standard serversocket animate future spit tunnel <span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">wrap</span> unassign<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">step</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 2 <span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> lingo
</pre>
</div>

<pre class="example">
1 2
</pre>
</div>
</div>
<div id="outline-container-org27a53f1" class="outline-5">
<h5 id="org27a53f1"><span class="section-number-5">1.5.25.3.</span> <span class="todo TODO">TODO</span> Infinite loop protection</h5>
<div class="outline-text-5" id="text-1-5-25-3">
<p>
We need to prevent an attacker presenting <code>true [clone] loop</code> as their
identity proof, which would never halt. It may be easiest to just
remove all the looping words from the dictionary, but that seems
overly restrictive, when the point is just to limit the resources an
attacker can consume, and we already have a direct solution for that:
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>expression <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">true</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">loop</span><span style="color: #696969; font-weight: bold;">]]]</span> environment
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org151259c" class="outline-4">
<h4 id="org151259c"><span class="section-number-4">1.5.26.</span> <span class="done DONE">DONE</span> Multithreading</h4>
<div class="outline-text-4" id="text-1-5-26">
</div>
<div id="outline-container-org968a19a" class="outline-5">
<h5 id="org968a19a"><span class="section-number-5">1.5.26.1.</span> Overview</h5>
<div class="outline-text-5" id="text-1-5-26-1">
<p>
There are a few major components here:
</p>
<ul class="org-ul">
<li>Be able to tell whether an environment can advance. It's basically
"if there's nothing in the expression, it's done, otherwise it can
run unless it's currently putting/taking from a pipe"</li>
</ul>
</div>
</div>
<div id="outline-container-orgccb98d6" class="outline-5">
<h5 id="orgccb98d6"><span class="section-number-5">1.5.26.2.</span> Pipes</h5>
<div class="outline-text-5" id="text-1-5-26-2">
<p>
It's not clear to me what to do about pipes. As soon as we call <code>take</code>
(for example) we're going to block the rust thread. In order to use
lightweight "threads" we're going to need a non-blocking check to see
if something can come out (or fit in) the pipe. For things like files
and sockets, it looks like we will need <code>tokio</code>.
</p>

<p>
tokio has Task which can manage this. It looks like tokio has file io
and network io that will automatically yield and allow other tasks to
run.
</p>

<p>
So then another question is, how to use something like <code>select</code> in
kcats. It might be possible to pass in a list of pipes to select and
then return the item that came out (along with the pipe itself i
guess). But this is advanced functionality that probably isn't a high
priority.
</p>

<p>
I think the basic design here is that each environment is a single
"thread" of execution, and that will map to a tokio Task. Pipe
operations within an env will call the async functions but will
immediately <code>await</code>. That should yield to allow other envs to run.
</p>

<p>
It looks like the <code>async</code> will creep all the way up to <code>axiom::eval</code>. If
the criteria is that anything we want to be able to pre-empt (if it's
waiting on i/o) needs to be labeled async, then everything up to <code>eval</code>
is going to be <code>async</code>.
</p>

<p>
I think that means fns like <code>f_stack1</code> etc will need to be async because
the <code>f</code> it calls can potentially call i/o. Actually it's probably best
to make new async versions of these so we don't have to make all the
Item fns async too.
</p>

<p>
We'll also need to think about what to do about dangling
environments - let's say we have the main env, and it spawns env e,
which will feed values back to main. But let's say main is done and
doesn't want any more values from e. Is the entire program done and we
can garbage collect e? My first instinct here is to blow everything
away as soon as main is done. If we don't want to exit we should be
taking from a pipe that won't produce anything until we're ready to
exit. So we're not going to <code>join</code> with other environment's tasks.
</p>
</div>
</div>
<div id="outline-container-orgd06ad28" class="outline-5">
<h5 id="orgd06ad28"><span class="section-number-5">1.5.26.3.</span> <span class="done DONE">DONE</span> Add tokio as dep</h5>
</div>
<div id="outline-container-orgb07853d" class="outline-5">
<h5 id="orgb07853d"><span class="section-number-5">1.5.26.4.</span> <span class="done DONE">DONE</span> Prepare for multithreading</h5>
<div class="outline-text-5" id="text-1-5-26-4">
</div>
<ol class="org-ol">
<li><a id="org190bdbb"></a><span class="done DONE">DONE</span> Use Arc instead of Rc<br />
<div class="outline-text-6" id="text-1-5-26-4-1">
<p>
Does Arc have <code>make_mut</code>?  Yes! So hopefully it will be a drop-in
replacement.
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-org4c15c21" class="outline-5">
<h5 id="org4c15c21"><span class="section-number-5">1.5.26.5.</span> <span class="done DONE">DONE</span> Update pipe types for fs and net to use tokio calls</h5>
<div class="outline-text-5" id="text-1-5-26-5">
<p>
One problem here is that we don't have a trivial way to mix step
functions that are pure vs involving pipes.
</p>

<p>
If we don't know until runtime what it is, we have to assume async and
there's probably a huge performance hit.
</p>

<p>
Maybe one way to proceed is to make an <code>Item</code> variant <code>Future</code>. So if
we're taking from a pipe, we can just put the <code>Future</code> on the stack and
continue. Of course, very soon we'll need to access the value and call
<code>await</code> on it. 
</p>

<p>
What then, do we do about <code>put</code>? Let's say the pipe is full and the put
needs to wait. We can return the Env but we still need to await sometime.
</p>

<p>
Maybe in eval-step, we can check if the top item is a Future. If so,
await it. If it returns another Item, replace it. If it returns Unit,
just discard it. Somewhere we'd need a type <code>Option&lt;Item&gt;</code> for what the
futures return (None if we're just waiting on a value to put into a
pipe, Item if we're taking)
</p>

<p>
So will this work in nested envs? I am not sure but I can't think of
why it wouldn't.
</p>

<p>
If this works then only eval/eval-step will need <code>async</code>.
</p>
</div>
</div>
<div id="outline-container-orgd47caf4" class="outline-5">
<h5 id="orgd47caf4"><span class="section-number-5">1.5.26.6.</span> <span class="done DONE">DONE</span> Use channel type to implement handoff pipe</h5>
<div class="outline-text-5" id="text-1-5-26-6">
</div>
<ol class="org-ol">
<li><a id="org4bbe95e"></a><span class="done DONE">DONE</span> Use crossbeam channels<br />
<div class="outline-text-6" id="text-1-5-26-6-1">
<p>
mpsc doesn't allow us to clone the receiver (Out) end of the pipe, and
that would seem like a rather sharp corner to users of kcats who
generally aren't too performance sensitive and want simple programs to
"just work".
</p>

<div class="org-src-container">
<pre class="src src-kcats">handoff <span style="color: #C2C2E5; font-weight: bold;">clone</span>
<span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #696969; font-weight: bold;">[</span>5 <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">hello</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span>
<span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[[</span>expression<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> assign environment animate <span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">take</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">5 <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">hello</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #696969; font-weight: bold;">[[</span>type pipe<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>handoff todo: id-or-hash here<span style="color: #696969; font-weight: bold;">]]</span>
</pre>
</div>

<pre class="example">

</pre>


<p>
One issue here is that we accidentally made a bidirectional channel. I
don't know if that should be the default mode of operation. When we
create a handoff maybe we should really create two stack items: the in
and out. 
</p>

<p>
The question is, what should be a tunnel? I am not sure single stack
items really should allow both put and take.
</p>

<p>
The problem with splitting them is it can exascerbate the already
difficult problem of stack manipulation (if indeed you actually need
to read from a file and then write to the same spot&#x2026; is that
common?)
</p>

<p>
The benefit is that a process that's supposed to be reading can't
accidentally write, if it doesn't have the In part of the pipe.
</p>

<p>
For now I think I'm inclined to leave it as-is and see how it goes.
</p>
</div>
</li>
<li><a id="orgb52f1ff"></a><span class="todo TODO">TODO</span> Nonblocking eval-step (for inner envs)<br />
<div class="outline-text-6" id="text-1-5-26-6-2">
<p>
It would be nice if calling eval-step on an inner env and having it
block, wouldn't block the outer env (or at least it would be nice if
it were an option not to wait). Maybe <code>try_eval_step</code> which tries to
make progress immediately and if it can't, just returns as-is.
</p>

<p>
There's probably a way to do this by polling the future. using <code>select!</code>
with a short timeout future would do it but there's probably a better
way.
</p>
</div>
</li>
<li><a id="org3da88f8"></a><span class="todo TODO">TODO</span> Combine implementations for net and fs<br />
<div class="outline-text-6" id="text-1-5-26-6-3">
<p>
They're both using AsyncReadExt and AsyncWriteExt methods. The only
difference between them is how the pipes are created. It would be
easier to make pipes for stdin/stdout this way.  I tried it but the
compiler complained about not being able to make trait objects out of
them. Will revisit later.
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-org6d65253" class="outline-5">
<h5 id="org6d65253"><span class="section-number-5">1.5.26.7.</span> <span class="done DONE">DONE</span> Implement 'spawn' or equavalent</h5>
<div class="outline-text-5" id="text-1-5-26-7">
<p>
Can probably think of a better name. What we're doing is taking an
environment that's a local piece of data on the stack and spitting it
out to make it its own autonomous thing.
<code>animate</code> seems rather fitting.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>expression <span style="color: #696969; font-weight: bold;">[</span>+ 1 1<span style="color: #696969; font-weight: bold;">]]]</span> environment animate 
</pre>
</div>

<pre class="example">

</pre>
</div>
</div>
<div id="outline-container-orged1c5b4" class="outline-5">
<h5 id="orged1c5b4"><span class="section-number-5">1.5.26.8.</span> <span class="done DONE">DONE</span> Implement 'future' or equivalent</h5>
<div class="outline-text-5" id="text-1-5-26-8">
<p>
The idea here is to take an expression and run it in its own spawned
env, and when it's done, snapshot the stack and put it into a
pipe and close it. The original env gets the other end of the pipe.
</p>

<p>
I think the new env should probably inherit the current env's stack.
</p>
<div class="org-src-container">
<pre class="src src-kcats">1 2 <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> 
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">make a pipe</span>
handoff <span style="color: #C2C2E5; font-weight: bold;">swap</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">save the stack, including pipe</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">snapshot</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">prepare the program for the new env</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">end up with [[+ snapshot] dip swap put]</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">snapshot</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span> discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span>
<span style="color: #AD9292;">; </span><span style="color: #AD9292;">;; now we have expr stack</span>
pair
<span style="color: #696969; font-weight: bold;">[</span>stack expression<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> zip environment
animate <span style="color: #E5E57E; font-weight: bold;">take</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>type pipe<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>handoff todo: id-or-hash here<span style="color: #696969; font-weight: bold;">]]</span> 2 1
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">1 <span style="color: #696969; font-weight: bold;">[</span>2 +<span style="color: #696969; font-weight: bold;">]</span> future <span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> discard
</pre>
</div>

<pre class="example">
[3] 1
</pre>
</div>
</div>
</div>
<div id="outline-container-org8069032" class="outline-4">
<h4 id="org8069032"><span class="section-number-4">1.5.27.</span> <span class="todo TODO">TODO</span> retry should have opposite argument order&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span>&#xa0;<span class="consistency">consistency</span></span></h4>
<div class="outline-text-4" id="text-1-5-27">
<p>
Currently it expects an error on ToS and then a program beneath. But
it seems like we'd nearly always have to <code>dip</code> the program beneath the
error. I think it would be better if <code>retry</code> expected the program to fix
the issue on top, and the error beneath.
</p>
</div>
</div>
<div id="outline-container-orgc4603a5" class="outline-4">
<h4 id="orgc4603a5"><span class="section-number-4">1.5.28.</span> <span class="todo INPROGRESS">INPROGRESS</span> Support Kademlia DHT</h4>
<div class="outline-text-4" id="text-1-5-28">
</div>
<div id="outline-container-orgeb3a22e" class="outline-5">
<h5 id="orgeb3a22e"><span class="section-number-5">1.5.28.1.</span> <span class="done DONE">DONE</span> XOR</h5>
<div class="outline-text-5" id="text-1-5-28-1">
<p>
We have a node id (maybe just the i2p destination address?) and we
want to calculate the distance to another node as the XOR
</p>
</div>
</div>
<div id="outline-container-org38a8780" class="outline-5">
<h5 id="org38a8780"><span class="section-number-5">1.5.28.2.</span> <span class="todo INPROGRESS">INPROGRESS</span> Simple API server</h5>
<div class="outline-text-5" id="text-1-5-28-2">
<p>
Construct a socket listener, and serve something from a trivial local
database. Disable exploitable words.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #AD9292;">;; </span><span style="color: #AD9292;">create an API service</span>
<span style="color: #AD9292;">;; </span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">Takes from the stack:</span>
<span style="color: #AD9292;">;; </span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">* a Database (can be a regular data structure for read-only apis),</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">or a pipe to an actual (sql or other) database that accepts queries for</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">read/write ops</span>
<span style="color: #AD9292;">;;</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">* a program that modifies the dictionary that clients can</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">access. It should add words to make interaction easier (for</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">example, you might provide a word 'customers' that gets the customers</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">db table). It should also remove words that the clients should not be able</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">to use - for example, they shouldn't be able to create file or network pipes. </span>
<span style="color: #AD9292;">;;</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">* a server socket pipe to serve from</span>
<span style="color: #AD9292;">;;</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">The client sends a program to run in a fresh environment where he</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">can expect to find:</span>
<span style="color: #AD9292;">;;</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">* The database (either a pipe or data structure)</span>
<span style="color: #AD9292;">;;</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">His program runs and then the resulting stack is returned to him.</span>
<span style="color: #AD9292;">;; </span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">socket listener</span>
<span style="color: #696969; font-weight: bold;">[[</span>type ip-port<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>port 12121<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>address <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">127.0.0.1</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> pipe-out

<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">sample local db - list of people and their game high</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">scores</span>
<span style="color: #696969; font-weight: bold;">[[[</span>name <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">joe</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>age 25<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>score 1000<span style="color: #696969; font-weight: bold;">]]</span>
 <span style="color: #696969; font-weight: bold;">[[</span>name <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">jane</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>age 35<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>score 1100<span style="color: #696969; font-weight: bold;">]]</span>
 <span style="color: #696969; font-weight: bold;">[[</span>name <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">tommy</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>age 9<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>score 870<span style="color: #696969; font-weight: bold;">]]</span>
 <span style="color: #696969; font-weight: bold;">[[</span>name <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">carter</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>age 59<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>score 670<span style="color: #696969; font-weight: bold;">]]]</span>
<span style="color: #696969; font-weight: bold;">[</span>association<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">map</span>

<span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">dictionary modifications </span>

<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">API Server code begins here</span>

dictionary <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #00fa9a; font-weight: bold;">execute</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">-&gt; new-dict db sock</span>

<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">start building the environment</span>
<span style="color: #696969; font-weight: bold;">[[</span>expression <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">the request as bytes (todo: know when the request ends) -&gt; req pipe db</span>
              <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">we want the pipe on top so we can dip the user's program under it -&gt; pipe req db</span>
              <span style="color: #696969; font-weight: bold;">[</span>string <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">translate to a string -&gt; req-str db</span>
               read <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">the request program into a data structure -&gt; prog db</span>
               <span style="color: #00fa9a; font-weight: bold;">execute</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">the program -&gt; items*</span>
               <span style="color: #C2C2E5; font-weight: bold;">snapshot</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">under the pipe so the user's code has no access</span>
              <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">-&gt; response pipe</span>
              emit <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">-&gt; response-str pipe</span>
              bytes <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">-&gt; response-bytes pipe</span>
              <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">the response into the pipe</span>
              discard <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">close the connection</span>
             <span style="color: #696969; font-weight: bold;">]]]</span> environment <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">-&gt; env new-dict db sock </span>
<span style="color: #696969; font-weight: bold;">[</span>dictionary<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">float</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">-&gt; new-dict [dictionary] env db sock</span>
assign  <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">-&gt; env db sock</span>

<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">now just need to assign the stack, which is [pipe db] </span>
<span style="color: #C2C2E5; font-weight: bold;">float</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">-&gt; sock env db</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">loop to accept connections and start new env with the db and a pipe</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">to take requests and reply</span>
<span style="color: #696969; font-weight: bold;">[[</span><span style="color: #C2C2E5; font-weight: bold;">float</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">-&gt; pipe db env</span>
  pair <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">-&gt; stack env</span>
  <span style="color: #696969; font-weight: bold;">[</span>stack<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">-&gt; stack ks env</span>
  assign <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">-&gt; env</span>
  environment
  animate <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">let it fly  </span>
 <span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shielddown</span>  <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">shielded so as not to consume the db each time</span>
 discard <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">drop whatever the result is of this iteration, we don't need it</span>
<span style="color: #696969; font-weight: bold;">]</span>

<span style="color: #E5E57E; font-weight: bold;">step</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">accepts incoming connections until killed</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org8a94ca8" class="outline-5">
<h5 id="org8a94ca8"><span class="section-number-5">1.5.28.3.</span> <span class="todo TODO">TODO</span> Kademlia functions</h5>
</div>
</div>
<div id="outline-container-orgeef602f" class="outline-4">
<h4 id="orgeef602f"><span class="section-number-4">1.5.29.</span> <span class="done DONE">DONE</span> Implement print (opposite of read)</h4>
<div class="outline-text-4" id="text-1-5-29">
<p>
We don't have a way to convert objects to their string serialization
Completed as the word emit
</p>
</div>
</div>
<div id="outline-container-org8037a62" class="outline-4">
<h4 id="org8037a62"><span class="section-number-4">1.5.30.</span> <span class="todo TODO">TODO</span> read and emit don't have quite the same semantics&#xa0;&#xa0;&#xa0;<span class="tag"><span class="consistency">consistency</span></span></h4>
<div class="outline-text-4" id="text-1-5-30">
<p>
read will read all the bytes and return however many objects were read.
emit will take an object and return its serialization.
</p>

<p>
There should be some way of round tripping here, maybe a word <code>read1</code> or
something that just reads one object. 
</p>
</div>
</div>
<div id="outline-container-orgef0e5ac" class="outline-4">
<h4 id="orgef0e5ac"><span class="section-number-4">1.5.31.</span> <span class="todo TODO">TODO</span> Inconsistent stack handling when encountering error&#xa0;&#xa0;&#xa0;<span class="tag"><span class="consistency">consistency</span></span></h4>
<div class="outline-text-4" id="text-1-5-31">
<p>
Some words pop the arguments off the stack, then if an error is
encountered, throws the error without the args on the stack. Others
leave the args intact. This needs to be consistent.
</p>

<p>
I would lean towards leaving the args intact so that <code>retry</code> is easily applied.
</p>
</div>
<div id="outline-container-orgd3c045c" class="outline-5">
<h5 id="orgd3c045c"><span class="section-number-5">1.5.31.1.</span> <span class="todo TODO">TODO</span> 'read' on invalid edn consumes the string argument</h5>
<div class="outline-text-5" id="text-1-5-31-1">
<p>
It should attempt to parse before popping the item off the stack.
</p>
</div>
</div>
<div id="outline-container-org5653171" class="outline-5">
<h5 id="org5653171"><span class="section-number-5">1.5.31.2.</span> <span class="todo TODO">TODO</span> Division by zero consumes stack items</h5>
<div class="outline-text-5" id="text-1-5-31-2">
<p>
<code>5 0 /</code> shouldn't consume the <code>5</code> and <code>0</code> - compare to <code>1 "2" +</code> behavior
(which leaves items on stack).
</p>
</div>
</div>
</div>

<div id="outline-container-org08c98a9" class="outline-4">
<h4 id="org08c98a9"><span class="section-number-4">1.5.32.</span> <span class="done DONE">DONE</span> logical enum hierarchy</h4>
<div class="outline-text-4" id="text-1-5-32">
</div>
<div id="outline-container-orga303b9f" class="outline-5">
<h5 id="orga303b9f"><span class="section-number-5">1.5.32.1.</span> <span class="done DONE">DONE</span> Collection hierarchy</h5>
<div class="outline-text-5" id="text-1-5-32-1">
<p>
There are read (peek/first) and write operations (pack/put/conj).
</p>

<p>
Then there are read/write ops like (take/unpack) that mutate the coll
and also return a value.
</p>

<p>
An In pipe supports only write. An Out pipe supports only
read-write. Pipes in general do not support peeking.
</p>

<p>
Collections (lists, maps, sets etc) support all of them.
</p>

<p>
It's not clear how to support overlapping functionality in an enum.
</p>
</div>
</div>
<div id="outline-container-org035e294" class="outline-5">
<h5 id="org035e294"><span class="section-number-5">1.5.32.2.</span> <span class="done DONE">DONE</span> pipe as list-like thing</h5>
<div class="outline-text-5" id="text-1-5-32-2">
<p>
Are both words <code>put</code> and <code>pack</code> needed (similarly <code>take</code> and <code>unpack</code>)? Seems
like the former should be all that's needed. That starts to address
that pack/unpack aren't inverse (they shouldn't be because it's really
put/take, and whether you get the last item back or not depends on the
underlying impl - a stack you would, a queue you wouldn't).
</p>

<p>
Also take in other langs takes a number arg (how many to take). You
could do this as <code>[take] 5 times</code>, but that's less efficient. Could
maybe create a new word like <code>split</code> or <code>unload</code> or something.
</p>

<p>
The possibility that these words might block, and you don't know
except by the argument type, is a bit off-putting, and maybe these
should be different words? I don't know, the contract is to "take
thing out of other thing" and sometimes that's instant and sometimes
it isn't. (You can ask if the object is a pipe before taking)
</p>

<p>
<code>step</code> should work on pipes. It continues until the pipe closes. How do
we write step in terms of take? The problem is we don't know when to
stop. We know if a collection is empty, but we need to know if a pipe
is closed. The way pipes work now is that if something goes wrong, it
produces an error from the pipe. That's ok for pipes, where we're ok
with the limitation that you can't tell whether the error was
generated during the take or was the actual data sent. However when
dealing with lists, errors are never generated, they're always the
item in the list. We want step to treat both errors and <code>nothing</code> as
actual items and not a flag value for error conditions
</p>

<p>
OK here's a plan: Result&lt;Option&lt;Item&gt;&gt;.  If the pipe is closed, return
Ok(None), if error return Err. The way we differentiate between Errors
in a list and Errors that just happened, is already implemented: via
the 'handled' field of the Error. So if there's a error in the list,
it'll have handled=true and it won't cause the expression to
unwind. If it's an actual error reading from the underlying data,
it'll have handled=false and unwind. This will also allow us to
support Nothing in lists and pipes, we won't reserve it as a sentinel
value.
</p>
</div>
</div>
<div id="outline-container-org0e5730a" class="outline-5">
<h5 id="org0e5730a"><span class="section-number-5">1.5.32.3.</span> <span class="done DONE">DONE</span> Step accepts pipes</h5>
</div>
<div id="outline-container-orgce8bdc6" class="outline-5">
<h5 id="orgce8bdc6"><span class="section-number-5">1.5.32.4.</span> <span class="done DONE">DONE</span> Set close = discard</h5>
</div>
<div id="outline-container-orgaa52342" class="outline-5">
<h5 id="orgaa52342"><span class="section-number-5">1.5.32.5.</span> <span class="done DONE">DONE</span> Remove closed?</h5>
<div class="outline-text-5" id="text-1-5-32-5">
</div>
<ol class="org-ol">
<li><a id="orgd2dc7ab"></a><span class="done DONE">DONE</span> Write assemble in terms of step<br />
<div class="outline-text-6" id="text-1-5-32-5-1">
<p>
I don't think we actually need assemble anymore, since this is just a
regular <code>step</code> (same as reducing any other iterable).
</p>
</div>
</li>
<li><a id="orgdd64113"></a><span class="done DONE">DONE</span> Do something with network pipes<br />
<div class="outline-text-6" id="text-1-5-32-5-2">
<p>
I think this does have a notion of closing.
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-orged81bc0" class="outline-5">
<h5 id="orged81bc0"><span class="section-number-5">1.5.32.6.</span> <span class="done DONE">DONE</span> make a polymorphic 'join'</h5>
<div class="outline-text-5" id="text-1-5-32-6">
<p>
The problem is that it's not symmetrical. If you have two different
types, whose semantics do you use? Sometimes it's obvious regardless
of order. Other times I suppose it's ok to use the first one (the
deeper in the stack).
</p>

<ul class="org-ul">
<li>list assoc -&gt; list</li>
<li>assoc list -&gt; list</li>
<li>list string -&gt; list</li>
<li>assoc string -&gt; error</li>
<li><p>
assoc assoc -&gt; assoc (merge top into 2nd)
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[[</span>e f<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #E5E57E; font-weight: bold;">join</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>e f<span style="color: #696969; font-weight: bold;">]]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>a b<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]</span> association <span style="color: #696969; font-weight: bold;">[[</span>a f<span style="color: #696969; font-weight: bold;">]]</span> association <span style="color: #E5E57E; font-weight: bold;">join</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>a f<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>c d<span style="color: #696969; font-weight: bold;">]]</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgd97015f" class="outline-5">
<h5 id="orgd97015f"><span class="section-number-5">1.5.32.7.</span> <span class="done DONE">DONE</span> Update spec types to be more abstract</h5>
<div class="outline-text-5" id="text-1-5-32-7">
<p>
For example, <code>step</code> now accepts not only lists but also out-pipes. So
really the spec type for this argument should be <code>iterable</code> or
something.
</p>

<p>
For ideas of what to call these types, how about <code>in</code> and <code>out</code>? So eg
step takes a program and an out. <code>put</code> takes an <code>in</code>, <code>take</code> takes an <code>out</code>. I
am not sure if the <code>tunnel</code> concept will be necessary.
</p>
</div>
</div>
</div>
<div id="outline-container-orgd3366e5" class="outline-4">
<h4 id="orgd3366e5"><span class="section-number-4">1.5.33.</span> <span class="done DONE">DONE</span> Support char type</h4>
<div class="outline-text-4" id="text-1-5-33">
<p>
If we don't support char, that breaks the abstraction of a String as a
sort of collection. A collection of what? Characters, not 1-length
strings.
</p>

<p>
Might have to do something similar with byte, but a byte array can
also be thought of as an array of ints (8 bit unsigned), and we
already have an integer type (even though it holds more bits).
</p>
</div>
</div>
<div id="outline-container-org3d6f772" class="outline-4">
<h4 id="org3d6f772"><span class="section-number-4">1.5.34.</span> <span class="todo TODO">TODO</span> implement sleep&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></h4>
<div class="outline-text-4" id="text-1-5-34">
<p>
helps with debugging multithreading
</p>
</div>
</div>
<div id="outline-container-org2064453" class="outline-4">
<h4 id="org2064453"><span class="section-number-4">1.5.35.</span> <span class="done DONE">DONE</span> handoff tests</h4>
<div class="outline-text-4" id="text-1-5-35">
<p>
This should block, not error
</p>
<div class="org-src-container">
<pre class="src src-kcats">handoff <span style="color: #E5E57E; font-weight: bold;">take</span>
</pre>
</div>

<pre class="example">
[[reason "type mismatch"] [unwound [unpack]] [type error] [asked [list]] [actual [[type pipe] [handoff todo: id-or-hash here]]] [handled true]] [[handoff todo: id-or-hash here] [type pipe]]
</pre>


<div class="org-src-container">
<pre class="src src-kcats">handoff <span style="color: #696969; font-weight: bold;">[</span>1 2 +<span style="color: #696969; font-weight: bold;">]</span> future <span style="color: #E5E57E; font-weight: bold;">take</span> 
</pre>
</div>

<pre class="example">
[3 [[type pipe] [handoff todo: id-or-hash here]]] [[handoff todo: id-or-hash here] [type pipe]] [[handoff todo: id-or-hash here] [type pipe]]
</pre>


<div class="org-src-container">
<pre class="src src-kcats">handoff <span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">snapshot</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span>1 <span style="color: #E5E57E; font-weight: bold;">put</span> 2 <span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #696969; font-weight: bold;">[</span>expression<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> assign environment animate <span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">take</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> +
</pre>
</div>

<pre class="example">
3 [[type pipe] [handoff todo: id-or-hash here]] [[type pipe] [handoff todo: id-or-hash here]]
</pre>


<p>
Should make a word that creates an inner env with access to a handoff also present in the outer env.
</p>
<div class="org-src-container">
<pre class="src src-kcats">  <span style="color: #696969; font-weight: bold;">[[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">step</span> close<span style="color: #696969; font-weight: bold;">]</span> handoff <span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #AD9292;">; </span><span style="color: #AD9292;">p h h</span>
  <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #696969; font-weight: bold;">[</span>expression<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> assign environment animate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span>
  0 <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">step</span>
<span style="color: #AD9292;">;;</span><span style="color: #AD9292;">[snapshot] dip swap  join [[] [expression]] dip assign environment animate take [take] dip +</span>
</pre>
</div>

<pre class="example">
6
</pre>


<div class="org-src-container">
<pre class="src src-kcats">  <span style="color: #696969; font-weight: bold;">[[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">step</span> close<span style="color: #696969; font-weight: bold;">]</span> handoff <span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #AD9292;">; </span><span style="color: #AD9292;">p h h</span>
  <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #696969; font-weight: bold;">[</span>expression<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> assign environment animate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span>
  0 <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">step</span>
<span style="color: #AD9292;">;;</span><span style="color: #AD9292;">[snapshot] dip swap  join [[] [expression]] dip assign environment animate take [take] dip +</span>
</pre>
</div>

<p>
Read from one file and write to another 
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>file <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">/tmp/bar</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> pipe-in
<span style="color: #696969; font-weight: bold;">[[</span>file <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">/tmp/foo</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]</span> pipe-out 
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">step</span>
</pre>
</div>

<pre class="example">
[[type pipe] [file "/tmp/bar"]]
</pre>


<p>
As a library function
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">/tmp/bar</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">/tmp/foo</span><span style="color: #DDB579; font-weight: bold;">"</span> file-out <span style="color: #696969; font-weight: bold;">[</span>file-in<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">step</span> close
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">Closing In
<span style="color: #696969; font-weight: bold;">[[</span>file <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">/tmp/bar</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>type pipe<span style="color: #696969; font-weight: bold;">]]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge12b87f" class="outline-4">
<h4 id="orge12b87f"><span class="section-number-4">1.5.36.</span> <span class="todo TODO">TODO</span> Performance optimizations&#xa0;&#xa0;&#xa0;<span class="tag"><span class="optimization">optimization</span></span></h4>
<div class="outline-text-4" id="text-1-5-36">
</div>
<div id="outline-container-orge511386" class="outline-5">
<h5 id="orge511386"><span class="section-number-5">1.5.36.1.</span> <span class="todo TODO">TODO</span> Compile programs</h5>
<div class="outline-text-5" id="text-1-5-36-1">
<p>
Here is how it could maybe be done. We already have a type StepFn
(which takes an env and returns a new one, in a future).
</p>

<p>
So let's say we have a program [1 2 +], and we want to convert that
into a StepFn. We could have a function <code>compose</code> and another
<code>self_insert</code>, and then call compose([self<sub>insert</sub>(1), self<sub>insert</sub>(2),
plus]), which would return a StepFn.
</p>

<p>
Let's look at something more complex:
</p>

<p>
<code>1 2 3 4 [+ *] dip</code>
</p>

<p>
In this case, the program is the composition of the 5 self-inserts and
dip. But what is self-inserted as the 5th item in this case could be
compiled because we know <code>dip</code> follows it. How we know in advance a list
can be compiled is difficult.
</p>

<p>
Let's try this:
</p>

<p>
<code>0 1 [2 3 4] [[+] dip] step</code>
</p>

<p>
In this case, the program for <code>step</code> is easy to spot, and in turn <code>dip</code>.
</p>

<p>
How about this:
</p>

<p>
<code>[+ *] [2 3 4] swap join execute</code>
</p>

<p>
We can't know the first two programs can be compiled until later on,
unless we look ahead in the expression. Even then we can only know
what arguments end up being passed to join and execute by examining
the words' specs, and even that is not foolproof, as we have wildcard
specs like dip where the stack change is arbitrary.
</p>

<p>
One major issue with this optimization is that it will stop the
debugger from working properly, unless special care is taken: with the
debugger we can go step by step, but if the function composition is
bundled up, we can only "step over" that function and not "into" it. I
am not sure if it's possible to build this such that we preserve
stepping ability and increase performance substantially.
</p>
</div>
</div>
<div id="outline-container-orgff58107" class="outline-5">
<h5 id="orgff58107"><span class="section-number-5">1.5.36.2.</span> <span class="todo TODO">TODO</span> Programs as their own immutable type</h5>
<div class="outline-text-5" id="text-1-5-36-2">
<p>
Programs executing in a loop are generally not modified (exception -
the <code>recur</code> word, which can modify but usually just calls <code>execute</code>)- so
when we execute a program with <code>loop</code> we don't want to have to clone it
each time through the loop.
</p>

<p>
Instead we'll do the following: when <code>loop</code> places a program into the
expression, instead of joining it, it's just going to put it right on
top as a <code>program</code> - we may need to differentiate programs that are
active vs meant to be run later. When <code>eval-step</code> runs, it sees an
active program on the top of the expression, so it calls <code>next</code> and gets
a reference to the next word (or None if it's at the end, drop the
program). Then we lookup that word. If it's an axiom, we call it. If
it's derived, we place a new program on the top of the expression,
with its PC set to 0. The actual programs are immutable, and behind an
Rc. Each "copy" of the program is just an Rc and a counter. Then all
programs are references except the counter.
</p>


<p>
example expression:
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>flip discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;;</span><span style="color: #AD9292;">0 </span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">float</span> <span style="color: #C2C2E5; font-weight: bold;">swapdown</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>flip discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">0 1</span>
</pre>
</div>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">pc 0</span>
<span style="color: #696969; font-weight: bold;">[[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">pc 1 </span>
<span style="color: #696969; font-weight: bold;">[[</span><span style="color: #C2C2E5; font-weight: bold;">snapshot</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #00fa9a; font-weight: bold;">inject</span> <span style="color: #E5E57E; font-weight: bold;">first</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">pc 0 1</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">etc</span>
</pre>
</div>

<p>
So when printing out the expression, we could cheat and only show the
remaining program (instead of a stack of partially executed programs).
</p>
</div>
</div>
</div>


<div id="outline-container-org68edd2f" class="outline-4">
<h4 id="org68edd2f"><span class="section-number-4">1.5.37.</span> <span class="todo TODO">TODO</span> Debugging method for animated envs&#xa0;&#xa0;&#xa0;<span class="tag"><span class="tools">tools</span></span></h4>
<div class="outline-text-4" id="text-1-5-37">
<p>
When we <code>animate</code> an env, we lose all contact with it if anything goes
wrong. It's supposed to send stuff back via pipes, but if it doesn't,
how do we know what went wrong? 
</p>
</div>
</div>
<div id="outline-container-orgbc93d78" class="outline-4">
<h4 id="orgbc93d78"><span class="section-number-4">1.5.38.</span> <span class="todo INPROGRESS">INPROGRESS</span> Generators&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></h4>
<div class="outline-text-4" id="text-1-5-38">
</div>
<div id="outline-container-org5ed4b5c" class="outline-5">
<h5 id="org5ed4b5c"><span class="section-number-5">1.5.38.1.</span> <span class="done DONE">DONE</span> Basic functionality and generators</h5>
<div class="outline-text-5" id="text-1-5-38-1">
<p>
There's the concept of "lazy sequence" that I think maps nicely to
pipes - you can keep calling 'take' and it keeps calculating new
values. Everything it needs is contained in the object, it's not like
a network or filesystem pipe where the data is coming from somewhere
external. But it acts like a pipe.
</p>

<div class="org-src-container">
<pre class="src src-kcats">0 <span style="color: #696969; font-weight: bold;">[]</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">the producer - infinite seq of integers</span>
<span style="color: #696969; font-weight: bold;">[[</span>inc <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">-&gt; [1] 1</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">the filter condition</span>
<span style="color: #696969; font-weight: bold;">[</span>3 mod 0 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">divisible by 3</span>

<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">filter-xf</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">pop</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span>  

<span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">[generation filtration] [] 0 </span>
<span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #AD9292;">;;</span><span style="color: #AD9292;">generate ;; [3]</span>
<span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #AD9292;">;;</span><span style="color: #AD9292;">generate ;; [3]</span>
<span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #AD9292;">;;</span><span style="color: #AD9292;">generate ;; [3]</span>
<span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #AD9292;">;;</span><span style="color: #AD9292;">generate ;; [3]</span>
</pre>
</div>

<p>
The problem above is <code>generate</code> will not produce a value until one
passes the filter. I think filter needs to keep calling <code>generate</code> on the xf below it?
</p>
<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>inc <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #E5E57E; font-weight: bold;">pop</span> <span style="color: #696969; font-weight: bold;">[</span>3 mod 0 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>3<span style="color: #696969; font-weight: bold;">]</span> 4
</pre>
</div>

<pre class="example">
1 [[unwound [[[[inc clone] dip swap put [pop [3 mod 0 =]] [put] [discard] if]] unwrap]] [type error] [asked [packable]] [actual 1] [reason "type mismatch"] [handled true]]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #AD9292;">;; </span><span style="color: #AD9292;">the impl of filter-xf</span>
<span style="color: #696969; font-weight: bold;">[</span>3 mod 0 =<span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">pop</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span>  
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">pop</span> <span style="color: #696969; font-weight: bold;">[</span>3 mod 0 =<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">0 <span style="color: #696969; font-weight: bold;">[</span>inc <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span>
discard <span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span>
</pre>
</div>

<pre class="example">
2 [inc clone] 2
</pre>


<div class="org-src-container">
<pre class="src src-kcats">0 <span style="color: #696969; font-weight: bold;">[</span>inc<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #696969; font-weight: bold;">[[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">]</span>
</pre>
</div>

<pre class="example">
[[generate] dip] [] [inc] 1
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>
<span style="color: #AD9292;">;;</span><span style="color: #AD9292;">[1 2 3 4 6 9] liberate ;; produce from list</span>
1 <span style="color: #696969; font-weight: bold;">[</span>2 * <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">infinite list</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">increment each</span>
<span style="color: #AD9292;">;;</span><span style="color: #AD9292;">[3 * 3 -] each</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">drop the first few</span>
5 dropper
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">limit the list</span>
10 taker
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">collect into list</span>
collect
<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>reason <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">type mismatch</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>unwound <span style="color: #696969; font-weight: bold;">[</span>positive? <span style="color: #696969; font-weight: bold;">[[[</span>2 * <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> 1<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> <span style="color: #C2C2E5; font-weight: bold;">evert</span> <span style="color: #E5E57E; font-weight: bold;">first</span> <span style="color: #696969; font-weight: bold;">[[</span>dec discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[]]]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> <span style="color: #00fa9a; font-weight: bold;">branch</span> <span style="color: #696969; font-weight: bold;">[[[</span>positive?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>dec discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[]]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[</span>8<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[[[</span>positive?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>dec <span style="color: #696969; font-weight: bold;">[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>discard <span style="color: #696969; font-weight: bold;">[]]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #696969; font-weight: bold;">[[[</span>generate <span style="color: #696969; font-weight: bold;">[[</span>3 * 3 -<span style="color: #696969; font-weight: bold;">]</span> bail<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shielddown</span><span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[[</span>generate <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">loop</span> <span style="color: #E5E57E; font-weight: bold;">pop</span> discard <span style="color: #696969; font-weight: bold;">[[]]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> <span style="color: #C2C2E5; font-weight: bold;">evert</span> <span style="color: #E5E57E; font-weight: bold;">first</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>type error<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>asked <span style="color: #696969; font-weight: bold;">[</span>number<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>actual <span style="color: #696969; font-weight: bold;">[</span>2 * <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>handled <span style="color: #E5C2E5; font-weight: bold;">true</span><span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>2 * <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> 1
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">0 <span style="color: #696969; font-weight: bold;">[</span>inc <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> generate
</pre>
</div>

<pre class="example">
1 [inc clone] 1
</pre>


<p>
Now express the debugger interface in terms of generated environment states!
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #AD9292;">;; </span><span style="color: #AD9292;">the steps of execution</span>
<span style="color: #696969; font-weight: bold;">[[</span>expression <span style="color: #696969; font-weight: bold;">[</span>0 0 10 1 range <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">step</span><span style="color: #696969; font-weight: bold;">]]]</span> environment
<span style="color: #696969; font-weight: bold;">[[[</span>expression<span style="color: #696969; font-weight: bold;">]</span> lookup something?<span style="color: #696969; font-weight: bold;">]</span>
 <span style="color: #696969; font-weight: bold;">[</span>eval-<span style="color: #E5E57E; font-weight: bold;">step</span> <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span>
 <span style="color: #696969; font-weight: bold;">[[]]</span>
 <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">the generator, which needs to emit 'nothing' once the expression is empty</span>
<span style="color: #696969; font-weight: bold;">[[</span>stack<span style="color: #696969; font-weight: bold;">]</span> lookup<span style="color: #696969; font-weight: bold;">]</span> each
50 taker
laster
generate
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>9<span style="color: #696969; font-weight: bold;">]</span> 36<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>generate <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span> discard <span style="color: #696969; font-weight: bold;">[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">while</span> discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>positive?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>dec <span style="color: #696969; font-weight: bold;">[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>discard <span style="color: #696969; font-weight: bold;">[]]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>generate <span style="color: #696969; font-weight: bold;">[[[</span>stack<span style="color: #696969; font-weight: bold;">]</span> lookup<span style="color: #696969; font-weight: bold;">]</span> bail<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shielddown</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[[</span>expression<span style="color: #696969; font-weight: bold;">]</span> lookup something?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>eval-<span style="color: #E5E57E; font-weight: bold;">step</span> <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[]]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[[</span>stack <span style="color: #696969; font-weight: bold;">[[</span>9<span style="color: #696969; font-weight: bold;">]</span> 36<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>expression <span style="color: #696969; font-weight: bold;">[[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">step</span><span style="color: #696969; font-weight: bold;">]]]</span>
</pre>
</div>

<p>
implement 'laster' which returns only the last in the seq
</p>
<div class="org-src-container">
<pre class="src src-kcats">0 100 1 range liberate
laster
generate
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> traversal <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">a generator for the list</span>
<span style="color: #696969; font-weight: bold;">[</span>inc<span style="color: #696969; font-weight: bold;">]</span> each
collect
</pre>
</div>
<pre class="example">
99 [generate [] swap [] [swap discard [generate] dip swap] while discard] liberate []
</pre>


<p>
Now implement 'keep' which returns only an item that passes the filter
</p>
<div class="org-src-container">
<pre class="src src-kcats">0 <span style="color: #696969; font-weight: bold;">[</span>inc <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> 
<span style="color: #696969; font-weight: bold;">[</span>odd?<span style="color: #696969; font-weight: bold;">]</span> keep
1 dropper
10 taker
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span> *<span style="color: #696969; font-weight: bold;">]</span> each
collect
</pre>
</div>

<pre class="example">
[9 25 49 81 121 169 225 289 361 441] [generate [[clone *] bail] shielddown] [[positive?] [dec [generate] dip swap] [discard []] if] [[[positive?] [[generate discard] dip dec] while [generate swap] dip swapdown swap] bail] 0 [clone [[generate] dip [discard generate] while] dip swap] [[[something?] [odd? not]] [execute] every?] [inc clone] 21
</pre>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>odd?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>something?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> pair <span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #696969; font-weight: bold;">[</span>every?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">[odd? not]</span>

</pre>
</div>

<pre class="example">
[[[something?] [odd?]] every?]
</pre>


<p>
dropper (almost got it, doesn't detect end of parent stream yet)
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>0 20 1 range liberate
 5 dropper
 10 taker
 <span style="color: #696969; font-weight: bold;">[</span>5 *<span style="color: #696969; font-weight: bold;">]</span> each
 <span style="color: #696969; font-weight: bold;">[</span>odd?<span style="color: #696969; font-weight: bold;">]</span> keep
 collect<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>25 35 45 55 65<span style="color: #696969; font-weight: bold;">]</span>
</pre>
</div>

<p>
Collect fix
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> liberate

generate <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">n</span>
<span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">n n r</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">r</span>
 <span style="color: #696969; font-weight: bold;">[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">r n</span>
 <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span>  <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">n n r </span>
<span style="color: #00fa9a; font-weight: bold;">loop</span> discard
</pre>
</div>

<pre class="example">
[1 2 3] liberate []
</pre>


<div class="org-src-container">
<pre class="src src-kcats">integers 10 taker collect <span style="color: #C2C2E5; font-weight: bold;">drop</span> generate 
</pre>
</div>

<pre class="example">
[] [[positive?] [dec [generate] dive] [[]] if] 0 [inc clone] 9
</pre>
</div>
</div>

<div id="outline-container-orgf6366f5" class="outline-5">
<h5 id="orgf6366f5"><span class="section-number-5">1.5.38.2.</span> <span class="done DONE">DONE</span> map</h5>
</div>
<div id="outline-container-org9bf7203" class="outline-5">
<h5 id="org9bf7203"><span class="section-number-5">1.5.38.3.</span> <span class="done DONE">DONE</span> filter</h5>
</div>
<div id="outline-container-org60bbefe" class="outline-5">
<h5 id="org60bbefe"><span class="section-number-5">1.5.38.4.</span> <span class="done DONE">DONE</span> take</h5>
</div>
<div id="outline-container-orgd75df45" class="outline-5">
<h5 id="orgd75df45"><span class="section-number-5">1.5.38.5.</span> <span class="done DONE">DONE</span> drop</h5>
<div class="outline-text-5" id="text-1-5-38-5">
<div class="org-src-container">
<pre class="src src-kcats">integers 15 taker 10 dropper <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> reduce
</pre>
</div>

<pre class="example">
60 [[[positive?] [[generate drop] dip dec] while [generate swap] dip float] bail] 0 [[positive?] [dec [generate] dive] [[]] if] 0 [inc clone] 14
</pre>
</div>
</div>

<div id="outline-container-org4126d9f" class="outline-5">
<h5 id="org4126d9f"><span class="section-number-5">1.5.38.6.</span> <span class="done CANCELED">CANCELED</span> last</h5>
</div>
<div id="outline-container-orgc9a41e9" class="outline-5">
<h5 id="orgc9a41e9"><span class="section-number-5">1.5.38.7.</span> <span class="todo TODO">TODO</span> distinct</h5>
<div class="outline-text-5" id="text-1-5-38-7">
<p>
depends on sets
</p>

<p>
The difference between this and just calling <code>set</code> is that the result is
still a list, and it preserves the original order, just removes
duplicates. Should be a similar impl to <code>keep</code>.
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>1 1 3<span style="color: #696969; font-weight: bold;">]</span> liberate
<span style="color: #696969; font-weight: bold;">[]</span> set <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">state</span>
<span style="color: #696969; font-weight: bold;">[[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dive</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">n seen g</span>

 <span style="color: #696969; font-weight: bold;">[</span>contains?<span style="color: #696969; font-weight: bold;">]</span>
 <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">seen g</span>
  <span style="color: #696969; font-weight: bold;">[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dive</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">n seen g</span>
 <span style="color: #00fa9a; font-weight: bold;">while</span>
<span style="color: #696969; font-weight: bold;">]</span>
collect
</pre>
</div>

<pre class="example">
[1 1 3] [[generate] dive [contains?] [put [generate] dive] while] [] [take] []
</pre>
</div>
</div>

<div id="outline-container-org5edabcd" class="outline-5">
<h5 id="org5edabcd"><span class="section-number-5">1.5.38.8.</span> <span class="todo TODO">TODO</span> partition</h5>
</div>
<div id="outline-container-orge9ae093" class="outline-5">
<h5 id="orge9ae093"><span class="section-number-5">1.5.38.9.</span> <span class="done DONE">DONE</span> joiner (aka catenate)</h5>
<div class="outline-text-5" id="text-1-5-38-9">
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>4 5 6<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>7 8 9<span style="color: #696969; font-weight: bold;">]]</span>
liberate
<span style="color: #696969; font-weight: bold;">[</span>generate <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span>
 <span style="color: #696969; font-weight: bold;">[]</span>
 <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">join</span>
  <span style="color: #696969; font-weight: bold;">[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> 
 <span style="color: #00fa9a; font-weight: bold;">while</span> discard<span style="color: #696969; font-weight: bold;">]</span> 
generate
</pre>
</div>

<pre class="example">
[1 2 3 4 5 6 7 8 9] [generate [] swap [] [join [generate] dip swap] while discard] [take] []
</pre>
</div>
</div>

<div id="outline-container-orge8628a4" class="outline-5">
<h5 id="orge8628a4"><span class="section-number-5">1.5.38.10.</span> <span class="todo TODO">TODO</span> groupby</h5>
<div class="outline-text-5" id="text-1-5-38-10">
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">bar</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">baaz</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">quux</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span>
liberate
<span style="color: #696969; font-weight: bold;">[]</span> association <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">state</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">f state</span>
<span style="color: #696969; font-weight: bold;">[[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dipdown</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">f state i</span>
 <span style="color: #C2C2E5; font-weight: bold;">swapdown</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">f i state</span>
 <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">k f v state</span>
 <span style="color: #C2C2E5; font-weight: bold;">sink</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">f v k state</span>
 <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">[v] k state</span>
  <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">join</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> pair <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">[[v] join] k state</span>
  <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">wrap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">[[v] join] [k] state</span>
  update<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span>
 <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">f state</span>

<span style="color: #696969; font-weight: bold;">]</span> generate
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">take</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> discard<span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #696969; font-weight: bold;">[[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dipdown</span> <span style="color: #C2C2E5; font-weight: bold;">swapdown</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span> <span style="color: #C2C2E5; font-weight: bold;">sink</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">wrap</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">join</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> pair <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">wrap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> update<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #696969; font-weight: bold;">[[</span>o <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">take</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">bar</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">baaz</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">quux</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org021a8f8" class="outline-5">
<h5 id="org021a8f8"><span class="section-number-5">1.5.38.11.</span> <span class="done CANCELED">CANCELED</span> Map/filter can't access lower stack items</h5>
<div class="outline-text-5" id="text-1-5-38-11">
</div>
<ol class="org-ol">
<li><a id="org7f27405"></a>Problem<br />
<div class="outline-text-6" id="text-1-5-38-11-1">
<p>
this doesn't work:
</p>

<div class="org-src-container">
<pre class="src src-kcats">10 <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> liberate <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> each
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>generate <span style="color: #696969; font-weight: bold;">[[</span>+<span style="color: #696969; font-weight: bold;">]</span> bail<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shielddown</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">take</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> 10
</pre>
</div>

<p>
We should get <code>[11 12 13]</code> but it errors out.
</p>

<p>
The reason is that when + runs, the generators are still on the stack,
in between this mapping function, and the original stack arguments.
</p>

<p>
We need a way to break out of the generation part of the stack and let
the mapping function access the arguments below it.
</p>

<p>
I can't immediately think of a good way to do it.
</p>

<p>
Actually I think that instead of recursively calling generate, and
passing the values back up the stack, there might be a way to build up
the program recursively, and then execute it in one swoop? 
</p>

<p>
Perhaps we can split each stage into several parts:
</p>

<ul class="org-ul">
<li>Generate from the layer below (in which case we obviously need the
layers below to get the next value)</li>
<li>dip underneath the layers to calculate the next value using lower stack items</li>
<li>swap the new value to the top of stack</li>
<li></li>
</ul>
</div>
</li>
<li><a id="org9e23797"></a>Debug session<br />
<div class="outline-text-6" id="text-1-5-38-11-2">
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>expression <span style="color: #696969; font-weight: bold;">[</span>10 <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> liberate <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> each generate<span style="color: #696969; font-weight: bold;">]]]</span> environment
advance advance advance advance eval-<span style="color: #E5E57E; font-weight: bold;">step</span> <span style="color: #696969; font-weight: bold;">[</span>advance<span style="color: #696969; font-weight: bold;">]</span> 5 <span style="color: #00fa9a; font-weight: bold;">times</span> eval-<span style="color: #E5E57E; font-weight: bold;">step</span>
<span style="color: #696969; font-weight: bold;">[</span>advance<span style="color: #696969; font-weight: bold;">]</span> 2 <span style="color: #00fa9a; font-weight: bold;">times</span> <span style="color: #696969; font-weight: bold;">[</span>eval-<span style="color: #E5E57E; font-weight: bold;">step</span><span style="color: #696969; font-weight: bold;">]</span> 99 <span style="color: #00fa9a; font-weight: bold;">times</span> 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">10 <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> liberate <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> each generate
</pre>
</div>

<pre class="example">
[[asked [number]] [reason "type mismatch"] [unwound [+ [[1 [take] [2 3] 10]] unwrap evert first swap discard [[generate [[+] bail] shielddown]] unwrap swap]] [actual [take]] [type error] [handled true]] 1 [take] [2 3] 10
</pre>



<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>expression <span style="color: #696969; font-weight: bold;">[[[</span>expression <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]]]</span> environment advance<span style="color: #696969; font-weight: bold;">]]]</span> environment advance advance eval-<span style="color: #E5E57E; font-weight: bold;">step</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>expression <span style="color: #696969; font-weight: bold;">[[[</span>expression<span style="color: #696969; font-weight: bold;">]</span> lookup <span style="color: #E5E57E; font-weight: bold;">count</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shield</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #696969; font-weight: bold;">[[</span>expression<span style="color: #696969; font-weight: bold;">]</span> lookup <span style="color: #E5E57E; font-weight: bold;">count</span> <span style="color: #696969; font-weight: bold;">[[</span>positive?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>&lt;=<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">execute</span><span style="color: #696969; font-weight: bold;">]</span> every?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>eval-<span style="color: #E5E57E; font-weight: bold;">step</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">while</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> discard<span style="color: #696969; font-weight: bold;">]]</span> <span style="color: #696969; font-weight: bold;">[</span>stack <span style="color: #696969; font-weight: bold;">[[[</span>stack <span style="color: #696969; font-weight: bold;">[]]</span> <span style="color: #696969; font-weight: bold;">[</span>expression <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]]]]]]</span>
</pre>
</div>
</div>
</li>
<li><a id="org22bb84e"></a>Resolution<br />
<div class="outline-text-6" id="text-1-5-38-11-3">
<p>
After thinking about this some more, my conclusion:
</p>

<p>
This is supporting multi-arity mapping functions, which did work in
the original map implementation but they are not supported in other
languages. The way you access multiple values there is by closing over
them. So the way you'd do it in kcats is like so:
</p>

<div class="org-src-container">
<pre class="src src-kcats">10 <span style="color: #696969; font-weight: bold;">[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">the extra arg and the list</span>
<span style="color: #696969; font-weight: bold;">[</span>-<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">the multi-arity map fn</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dipdown</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">clone the 10</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> prepend <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">prepend the word swap to the fn so that the 10 ends up beneath the list item</span>
<span style="color: #C2C2E5; font-weight: bold;">float</span> prepend <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">prepend the 10</span>
<span style="color: #E5E57E; font-weight: bold;">map</span>
</pre>
</div>

<pre class="example">
[9 8 7] 10
</pre>


<p>
In theory we could write a helper function called <code>capture1</code> or something that does this for us, so you can write
</p>

<pre class="example">
10 [1 2 3] [-] capture1 map
</pre>

<div class="org-src-container">
<pre class="src src-kcats">10 <span style="color: #696969; font-weight: bold;">[</span>1 2 3  4 5 6<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">the extra arg and the list</span>
<span style="color: #696969; font-weight: bold;">[</span>-<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">the multi-arity map fn</span>

<span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swapdown</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">f i</span>
 <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> prepend
 <span style="color: #C2C2E5; font-weight: bold;">swap</span> prepend<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">shielddown</span>
<span style="color: #696969; font-weight: bold;">[</span>liberate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> each collect
</pre>
</div>

<pre class="example">
[9 8 7] [generate [[10 swap -] bail] shielddown] [take] [] 10
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>1 2 <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">oh fudge</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #696969; font-weight: bold;">[[</span>5 +<span style="color: #696969; font-weight: bold;">]</span>
 <span style="color: #696969; font-weight: bold;">[</span>discard 5<span style="color: #696969; font-weight: bold;">]</span>
 recover<span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #E5E57E; font-weight: bold;">map</span>
</pre>
</div>

<pre class="example">
[6 7 5]
</pre>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgb117ec7" class="outline-5">
<h5 id="orgb117ec7"><span class="section-number-5">1.5.38.12.</span> <span class="done DONE">DONE</span> Reduce</h5>
<div class="outline-text-5" id="text-1-5-38-12">
<div class="org-src-container">
<pre class="src src-kcats">0 <span style="color: #696969; font-weight: bold;">[</span>inc <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> 30 taker <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #696969; font-weight: bold;">[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dive</span> <span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">acc acc f</span>
<span style="color: #AD9292;">;;</span><span style="color: #AD9292;">drop [generate] divedown [] [float execute clone] [] if</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">acc f g</span>
<span style="color: #696969; font-weight: bold;">[[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">divedown</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">i acc f g</span>
 <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">float</span> <span style="color: #00fa9a; font-weight: bold;">execute</span> <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span>  <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">acc acc f g</span>
<span style="color: #00fa9a; font-weight: bold;">loop</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">0 <span style="color: #696969; font-weight: bold;">[</span>inc <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> 10 taker 
generate <span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">acc acc </span>
<span style="color: #AD9292;">;;</span><span style="color: #AD9292;">drop [generate] divedown [] [float execute clone] [] if</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">acc g</span>
<span style="color: #696969; font-weight: bold;">[[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dive</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">i acc g</span>
 <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #696969; font-weight: bold;">[</span>+ <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span>  <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">acc acc f g</span>
<span style="color: #00fa9a; font-weight: bold;">loop</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">55 <span style="color: #696969; font-weight: bold;">[[</span>positive?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>dec <span style="color: #696969; font-weight: bold;">[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dive</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">drop</span> <span style="color: #696969; font-weight: bold;">[]]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>inc <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> 10
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">0 <span style="color: #696969; font-weight: bold;">[</span>inc <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> 3 taker
<span style="color: #696969; font-weight: bold;">[</span>*<span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">build the 'then' branch</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">-&gt; [+ clone]</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">build the loop body</span>
<span style="color: #696969; font-weight: bold;">[[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dive</span> <span style="color: #696969; font-weight: bold;">[]]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span> <span style="color: #696969; font-weight: bold;">[[]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span>
<span style="color: #AD9292;">;; </span><span style="color: #AD9292;">generate the first item under the loop body</span>
<span style="color: #696969; font-weight: bold;">[</span>generate <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span>
<span style="color: #00fa9a; font-weight: bold;">loop</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">6 <span style="color: #696969; font-weight: bold;">[[</span>positive?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>dec <span style="color: #696969; font-weight: bold;">[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dive</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">drop</span> <span style="color: #696969; font-weight: bold;">[]]</span> <span style="color: #00fa9a; font-weight: bold;">if</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>inc <span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> 3
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">1 2 3 4 <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">divedown</span>
</pre>
</div>

<pre class="example">
3 4 3
</pre>


<div class="org-src-container">
<pre class="src src-kcats">1 <span style="color: #E5C2E5; font-weight: bold;">true</span> <span style="color: #696969; font-weight: bold;">[</span> inc <span style="color: #C2C2E5; font-weight: bold;">clone</span> 5 &lt; <span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">loop</span>
</pre>
</div>

<pre class="example">
5
</pre>


<div class="org-src-container">
<pre class="src src-kcats">integers
1 dropper <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">start with 1</span>
1000 taker <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">take items</span>
<span style="color: #696969; font-weight: bold;">[</span>3 *<span style="color: #696969; font-weight: bold;">]</span> each
<span style="color: #696969; font-weight: bold;">[</span>odd?<span style="color: #696969; font-weight: bold;">]</span> keep
<span style="color: #696969; font-weight: bold;">[</span>+ 37 mod<span style="color: #696969; font-weight: bold;">]</span> reduce
</pre>
</div>

<pre class="example">
10 [clone [[generate] dip [drop generate] while] dive] [[[something?] [odd? not]] [execute] every?] [generate [[3 *] bail] shielddown] [[positive?] [dec [generate] dive] [drop []] if] [[[positive?] [[generate drop] dip dec] while [generate swap] dip float] bail] 0 [inc clone] 1000
</pre>


<div class="org-src-container">
<pre class="src src-kcats">1025 8 mod
</pre>
</div>

<pre class="example">
1
</pre>
</div>
</div>
</div>

<div id="outline-container-org22b6954" class="outline-4">
<h4 id="org22b6954"><span class="section-number-4">1.5.39.</span> <span class="done DONE">DONE</span> Investigate simpler map/filter impls</h4>
<div class="outline-text-4" id="text-1-5-39">
<div class="org-src-container">
<pre class="src src-kcats">7 8 <span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #C2C2E5; font-weight: bold;">sink</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">shielddown</span> <span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]</span> decorate <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> prepend <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #E5E57E; font-weight: bold;">step</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>+<span style="color: #696969; font-weight: bold;">]</span> 8 7
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats">3 <span style="color: #696969; font-weight: bold;">[</span>1 2 3 4 5 6<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>discard odd?<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #C2C2E5; font-weight: bold;">sink</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">shield</span> <span style="color: #00fa9a; font-weight: bold;">dip</span><span style="color: #696969; font-weight: bold;">]</span> decorate <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">unwrap</span> prepend <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">sink</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">put</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>discard<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">branch</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #E5E57E; font-weight: bold;">step</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>1 2 3 4 5 6<span style="color: #696969; font-weight: bold;">]</span> 3
</pre>
</div>
</div>
</div>

<div id="outline-container-org0a14aca" class="outline-4">
<h4 id="org0a14aca"><span class="section-number-4">1.5.40.</span> <span class="done DONE">DONE</span> Allow generator transforms to work on pipes</h4>
<div class="outline-text-4" id="text-1-5-40">
<p>
pipe + [take] = generator
</p>
</div>
</div>
<div id="outline-container-orgb134821" class="outline-4">
<h4 id="orgb134821"><span class="section-number-4">1.5.41.</span> <span class="todo INPROGRESS">INPROGRESS</span> Implement hashset&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></h4>
<div class="outline-text-4" id="text-1-5-41">
<p>
Once we have this, we can implement stuff like the <code>distinct</code> transform
function.
</p>
</div>

<div id="outline-container-org750789c" class="outline-5">
<h5 id="org750789c"><span class="section-number-5">1.5.41.1.</span> <span class="todo INPROGRESS">INPROGRESS</span> Implement set membership check</h5>
<div class="outline-text-5" id="text-1-5-41-1">
<p>
Could possibly piggyback on <code>lookup</code> here, but the semantics are a
little different (nested sets are not allowed, return value is the
same as the key argument).
</p>

<p>
Another option is to call it <code>contains?</code> and check for membership. The
implementation could accept any Sized type, but it's not obvious how
to handle map types - are we checking just for the key, or key/val
pair? I lean slightly toward just the key, but hard to say. For list
types do we convert or promote to set, or just do a (worst case) full
pass over the elements? Vec[Deque] has a contains method so I'm
inclined to just use that.
</p>
</div>

<ol class="org-ol">
<li><a id="org3eebe7e"></a><span class="todo TODO">TODO</span> Substring or subcollection<br />
<div class="outline-text-6" id="text-1-5-41-1-1">
<p>
Included as part of this should be substring and subarray checking. eg
<code>"foobar" "bar" contains?</code> should return <code>true</code>. It's a different behavior
when the member and collection are the same type vs different
types. Should probably error when it's two different collection types,
eg <code>[1 2 3] [2 3] set contains?</code> should error.
</p>
</div>
</li>
</ol>
</div>
</div>


<div id="outline-container-orgf21ecae" class="outline-4">
<h4 id="orgf21ecae"><span class="section-number-4">1.5.42.</span> <span class="done DONE">DONE</span> Implement until</h4>
<div class="outline-text-4" id="text-1-5-42">
<p>
like <code>while</code> but always runs the body once.
</p>

<div class="org-src-container">
<pre class="src src-kcats">64 <span style="color: #696969; font-weight: bold;">[</span>50 &gt;<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span> *<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">until</span>
<span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">pred body</span>
<span style="color: #696969; font-weight: bold;">[</span>not<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">reverse logic</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #00fa9a; font-weight: bold;">shield</span><span style="color: #696969; font-weight: bold;">]</span> decorate <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">add shield to the pred program -&gt; pred body</span>
<span style="color: #E5E57E; font-weight: bold;">join</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">[body ..  pred]</span>
<span style="color: #E5C2E5; font-weight: bold;">true</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">run at least once</span>
<span style="color: #00fa9a; font-weight: bold;">loop</span>
</pre>
</div>

<div class="org-src-container results">
<pre class="src src-kcats">4096
</pre>
</div>

<p>
use until in places I wish i'd had it:
laster:
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>1 2 3 4<span style="color: #696969; font-weight: bold;">]</span> liberate
<span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #696969; font-weight: bold;">[]</span>
<span style="color: #696969; font-weight: bold;">[[</span><span style="color: #E5C2E5; font-weight: bold;">nothing</span>?<span style="color: #696969; font-weight: bold;">]</span>
 <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">l sl</span>
 <span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">sl l</span>
  discard <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">l</span>
  <span style="color: #696969; font-weight: bold;">[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">sl l</span>
  <span style="color: #C2C2E5; font-weight: bold;">swap</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">l sl </span>
 <span style="color: #00fa9a; font-weight: bold;">until</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span>
 <span style="color: #696969; font-weight: bold;">[[]]</span> <span style="color: #00fa9a; font-weight: bold;">dipdown</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">replace the empty state</span>
collect
</pre>
</div>

<p>
joiner
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span>1 2 3<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>4 5 6<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span>7 8 9<span style="color: #696969; font-weight: bold;">]]</span> liberate
<span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #696969; font-weight: bold;">[]</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5C2E5; font-weight: bold;">nothing</span>?<span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #696969; font-weight: bold;">[</span>discard <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">r</span>
 <span style="color: #696969; font-weight: bold;">[</span>generate<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">r i</span>
 <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">i r</span>
 <span style="color: #C2C2E5; font-weight: bold;">clone</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">i i r</span>
 <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">join</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">dip</span> <span style="color: #AD9292;">;; </span><span style="color: #AD9292;">i r2</span>
<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #00fa9a; font-weight: bold;">until</span>  generate
</pre>
</div>
<div class="org-src-container results">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>1 2 3 4 5 6 7 8 9<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #E5E57E; font-weight: bold;">take</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>1 2 3 4<span style="color: #696969; font-weight: bold;">]</span> liberate generate
</pre>
</div>

<pre class="example">
1 [take] [2 3 4]
</pre>
</div>
</div>

<div id="outline-container-org632ba92" class="outline-4">
<h4 id="org632ba92"><span class="section-number-4">1.5.43.</span> <span class="todo TODO">TODO</span> Implement sorting&#xa0;&#xa0;&#xa0;<span class="tag"><span class="stdlib">stdlib</span></span></h4>
<div class="outline-text-4" id="text-1-5-43">
</div>
<div id="outline-container-orgc0a545a" class="outline-5">
<h5 id="orgc0a545a"><span class="section-number-5">1.5.43.1.</span> <span class="todo TODO">TODO</span> Implement partialord</h5>
<div class="outline-text-5" id="text-1-5-43-1">
<p>
Each type needs to be comparable to another.
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">b</span><span style="color: #DDB579; font-weight: bold;">"</span> 2<span style="color: #696969; font-weight: bold;">][</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">g</span><span style="color: #DDB579; font-weight: bold;">"</span> 5<span style="color: #696969; font-weight: bold;">][</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">a</span><span style="color: #DDB579; font-weight: bold;">"</span>, 1<span style="color: #696969; font-weight: bold;">][</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">d</span><span style="color: #DDB579; font-weight: bold;">"</span> 4<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">c</span><span style="color: #DDB579; font-weight: bold;">"</span> 3<span style="color: #696969; font-weight: bold;">]]</span> association ++sort
</pre>
</div>

<pre class="example">
[1 2 3 4 5]
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span>-2 10 -8 -12 8 0 1 20<span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #696969; font-weight: bold;">[</span>5 - abs<span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">join</span>
<span style="color: #696969; font-weight: bold;">[</span> pair<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span>
<span style="color: #E5E57E; font-weight: bold;">map</span>  ++sort 
</pre>
</div>

<pre class="example">
Pair is (Int(-2), Int(7))
Pair is (Int(10), Int(5))
Pair is (Int(-8), Int(13))
Pair is (Int(-12), Int(17))
Pair is (Int(8), Int(3))
Pair is (Int(0), Int(5))
Pair is (Int(1), Int(4))
Pair is (Int(20), Int(15))
[8 1 10 0 -2 -8 20 -12]
</pre>


<p>
UHOH
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">hi</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">there</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">what</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">is</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">your</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">birthdate</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">homeboy</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span>
<span style="color: #696969; font-weight: bold;">[]</span>
<span style="color: #696969; font-weight: bold;">[</span><span style="color: #C2C2E5; font-weight: bold;">clone</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #C2C2E5; font-weight: bold;">swap</span> <span style="color: #E5E57E; font-weight: bold;">join</span>
<span style="color: #696969; font-weight: bold;">[</span>pair<span style="color: #696969; font-weight: bold;">]</span> <span style="color: #E5E57E; font-weight: bold;">join</span>
<span style="color: #E5E57E; font-weight: bold;">map</span>  ++sort 
</pre>
</div>

<pre class="example">
Pair is (Iterable(Sized(String("hi"))), String("hi"))
Pair is (Iterable(Sized(String("there"))), String("there"))
Pair is (Iterable(Sized(String("what"))), String("what"))
Pair is (Iterable(Sized(String("is"))), String("is"))
Pair is (Iterable(Sized(String("your"))), String("your"))
Pair is (Iterable(Sized(String("birthdate"))), String("birthdate"))
Pair is (Iterable(Sized(String("homeboy"))), String("homeboy"))
["birthdate" "hi" "homeboy" "is" "there" "what" "your"]
</pre>


<div class="org-src-container">
<pre class="src src-kcats">8 5 - 
</pre>
</div>

<pre class="example">
3
</pre>


<div class="org-src-container">
<pre class="src src-kcats">1 2 <span style="color: #696969; font-weight: bold;">[</span>inc<span style="color: #696969; font-weight: bold;">]</span> both
</pre>
</div>

<pre class="example">
[[reason "word is not defined"] [unwound [both]] [type error] [asked [both]] [handled true]] [inc] 2 1
</pre>
</div>
</div>

<div id="outline-container-org4bc3ce9" class="outline-5">
<h5 id="org4bc3ce9"><span class="section-number-5">1.5.43.2.</span> <span class="todo TODO">TODO</span> Make floats hashable</h5>
<div class="outline-text-5" id="text-1-5-43-2">
<p>
This will allow floats to be added to the <code>KeyItem</code> enum. Floats are not
normally hashable, because mathematically identical numbers are not
always represented the same way in memory and wouldn't hash the
same. But for the purposes of kcats, I think this doesn't matter. We
can document that you can't expect (10.0 + 10.0) and (15.0 + 5.0) to
be the same map key.
</p>

<p>
This will then allow a list that contains floats, to be sorted, or be
able to use float values as a sort-by key.
</p>
</div>
</div>

<div id="outline-container-org6e14e70" class="outline-5">
<h5 id="org6e14e70"><span class="section-number-5">1.5.43.3.</span> <span class="todo TODO">TODO</span> Implement compare</h5>
<div class="outline-text-5" id="text-1-5-43-3">
<p>
Should expose Rust's comparison function. That will allow a native
sort function, for max flexibility (but not performance).
</p>

<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">a</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">b</span><span style="color: #DDB579; font-weight: bold;">"</span> compare
</pre>
</div>

<pre class="example">
less
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">a</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">a</span><span style="color: #DDB579; font-weight: bold;">"</span> compare
</pre>
</div>

<pre class="example">
equal
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">a</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">b</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> <span style="color: #696969; font-weight: bold;">[</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">a</span><span style="color: #DDB579; font-weight: bold;">"</span> <span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">c</span><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #696969; font-weight: bold;">]</span> compare
</pre>
</div>

<pre class="example">
less
</pre>


<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #DDB579; font-weight: bold;">"</span><span style="color: #DDC29A; font-weight: bold;">foo</span><span style="color: #DDB579; font-weight: bold;">"</span> bytes <span style="color: #696969; font-weight: bold;">[</span>1<span style="color: #696969; font-weight: bold;">]</span> compare
</pre>
</div>

<pre class="example">
less
</pre>


<p>
This should work - the empty set and map maybe can't be compared but Nothing should be in there.
</p>
<div class="org-src-container">
<pre class="src src-kcats"><span style="color: #696969; font-weight: bold;">[]</span> -1000 compare
</pre>
</div>

<pre class="example">
less
</pre>
</div>
</div>
</div>

<div id="outline-container-org5dc79a5" class="outline-4">
<h4 id="org5dc79a5"><span class="section-number-4">1.5.44.</span> <span class="todo INPROGRESS">INPROGRESS</span> CI on github&#xa0;&#xa0;&#xa0;<span class="tag"><span class="alpha">alpha</span></span></h4>
</div>

<div id="outline-container-org3db1505" class="outline-4">
<h4 id="org3db1505"><span class="section-number-4">1.5.45.</span> <span class="done DONE">DONE</span> Add a kcats logo to github project page&#xa0;&#xa0;&#xa0;<span class="tag"><span class="alpha">alpha</span></span></h4>
</div>

<div id="outline-container-org9c54e58" class="outline-4">
<h4 id="org9c54e58"><span class="section-number-4">1.5.46.</span> <span class="done DONE">DONE</span> Add a video snippet of repl interaction to github project page&#xa0;&#xa0;&#xa0;<span class="tag"><span class="alpha">alpha</span></span></h4>
</div>

<div id="outline-container-org815fafc" class="outline-4">
<h4 id="org815fafc"><span class="section-number-4">1.5.47.</span> <span class="todo INPROGRESS">INPROGRESS</span> Write an alpha release announcement&#xa0;&#xa0;&#xa0;<span class="tag"><span class="alpha">alpha</span></span></h4>
<div class="outline-text-4" id="text-1-5-47">
<div class="org-src-container">
<pre class="src src-fundamental">Announcing the Alpha Release of kcats: A Simple, Beginner-Friendly,
Stack-Based Programming Language

Hello everyone,

I'm excited to introduce the alpha release of kcats, a fresh take on
stack-based programming languages, inspired by the language Joy,
specifically designed with simplicity, learnability, and functionality
in mind.

Our aim with kcats is to make programming languages more accessible to
everyone. We believe that existing languages require learning too many
specialized tools and arcane symbols. kcats addresses these issues by
offering a streamlined, intuitive alternative.

Key features of kcats:

    Simplicity: kcats emphasizes fewer, general-purpose tools instead
    of a complex array of specialized ones. Its syntax uses simple
    words, numbers, and text, completely doing away with cryptic
    symbols - there are no periods, exclamation points, semicolons,
    equals, plusses, ampersands, or asterisks.

    Beginner-friendly: kcats is designed to be easy to learn and
    understand, even for beginner programmers. It uses simple
    programming concepts including stacks, primitive datatypes, lists,
    functions, and pipes.

    Effective Documentation: kcats documentation is crafted to be as
    intuitive as possible, focusing on clear examples rather than
    complex explanations.

    Powerful and Versatile: Despite its simplicity, kcats is designed
    to be a powerful tool capable of handling a wide range of
    programming tasks including API client/server, networking
    applications, and more.

    Interoperability: kcats is designed to interact effectively with
    other systems. It is built around the principle that everything
    should be a value and should be serializable.

    A Focus on Tooling: kcats intends to make tool development,
    including IDEs and debuggers, as easy as possible.

As this is the alpha release, we eagerly welcome all feedback,
contributions, and constructive criticisms from the community. While
the focus of kcats isn't on speed, there's no theoretical reason why
it must be slow, so over time, with your help, we can continue to
optimize and enhance it.

Join us in exploring this new language and contribute to making
programming more accessible to everyone. Your feedback is essential to
making it intuitive and easy to use!

Please check out our alpha release here: (link to the repository)

Happy coding!

Best, (Your Name)

</pre>
</div>
</div>
</div>

<div id="outline-container-org29e8cbf" class="outline-4">
<h4 id="org29e8cbf"><span class="section-number-4">1.5.48.</span> <span class="todo TODO">TODO</span> Post announcement on various forums&#xa0;&#xa0;&#xa0;<span class="tag"><span class="alpha">alpha</span></span></h4>
<div class="outline-text-4" id="text-1-5-48">
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> Hacker news</li>
<li class="off"><code>[&#xa0;]</code> Reddit r/concatenative</li>
<li class="off"><code>[&#xa0;]</code> Reddit r/programming</li>
<li class="off"><code>[&#xa0;]</code> r/learnprogramming</li>
<li class="off"><code>[&#xa0;]</code> r/coding</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Skyrod Vactai</p>
<p class="date">Created: 2023-08-06 Sun 19:39</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
